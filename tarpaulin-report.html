<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","cell.rs"],"content":"use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n/// Cell value representation\r\n#[derive(Debug, Clone, PartialEq)]\r\npub enum CellValue {\r\n    Integer(i32),\r\n    Error,\r\n}\r\n\r\npub fn parse_cell_reference(\r\n    sheet: \u0026Spreadsheet,\r\n    cell_ref: \u0026str,\r\n) -\u003e Result\u003c(i16, i16), CommandStatus\u003e {\r\n    let cell_ref = cell_ref.as_bytes();\r\n    if cell_ref.is_empty() {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Find column/row split point in one pass\r\n    let mut split_idx = 0;\r\n    let mut col_length = 0;\r\n\r\n    while split_idx \u003c cell_ref.len() \u0026\u0026 cell_ref[split_idx] \u003e= b'A' \u0026\u0026 cell_ref[split_idx] \u003c= b'Z' {\r\n        col_length += 1;\r\n        if col_length \u003e 3 {\r\n            return Err(CommandStatus::CmdUnrecognized);\r\n        }\r\n        split_idx += 1;\r\n    }\r\n\r\n    // Verify we have columns and rows\r\n    if col_length == 0 || split_idx == cell_ref.len() {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Verify remaining chars are digits\r\n    for i in split_idx..cell_ref.len() {\r\n        if !cell_ref[i].is_ascii_digit() {\r\n            return Err(CommandStatus::CmdUnrecognized);\r\n        }\r\n    }\r\n\r\n    // Get column reference as a string slice (no allocation)\r\n    let col_name =\r\n        std::str::from_utf8(\u0026cell_ref[0..split_idx]).map_err(|_| CommandStatus::CmdUnrecognized)?;\r\n\r\n    // Parse row directly from bytes (avoid string allocation)\r\n    let mut row: i16 = 0;\r\n    for \u0026byte in \u0026cell_ref[split_idx..] {\r\n        row = row * 10 + (byte - b'0') as i16;\r\n    }\r\n\r\n    // Convert to 0-based\r\n    let row = row - 1;\r\n\r\n    // Convert column name to index\r\n    let col = sheet.column_name_to_index(col_name);\r\n    // Check row and column bounds\r\n    if row \u003c 0 || col \u003c 0 || row \u003e 998 || col \u003e 18277 {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n    Ok((row, col))\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_cell_reference_valid() {\r\n        let sheet = create_test_spreadsheet(10, 10);\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"A1\"), Ok((0, 0)));\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"B2\"), Ok((1, 1)));\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"AA10\"), Ok((9, 26)));\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"ZZZ999\"), Ok((998, 18277)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_cell_reference_invalid() {\r\n        let sheet = create_test_spreadsheet(10, 10);\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"1A\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A1B\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"AAAA1\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_cell_reference_bounds() {\r\n        let sheet = create_test_spreadsheet(10, 10);\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A1000\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"ZZZ1000\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A0\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_cell_value_equality() {\r\n        assert_eq!(CellValue::Integer(42), CellValue::Integer(42));\r\n        assert_eq!(CellValue::Error, CellValue::Error);\r\n        assert_ne!(CellValue::Integer(42), CellValue::Error);\r\n    }\r\n}\r\n","traces":[{"line":10,"address":[177728],"length":1,"stats":{"Line":2}},{"line":14,"address":[177790],"length":1,"stats":{"Line":1}},{"line":15,"address":[177827],"length":1,"stats":{"Line":2}},{"line":16,"address":[177861],"length":1,"stats":{"Line":1}},{"line":20,"address":[177836],"length":1,"stats":{"Line":1}},{"line":21,"address":[177848],"length":1,"stats":{"Line":2}},{"line":23,"address":[179172,177859,177889,177923],"length":1,"stats":{"Line":5}},{"line":24,"address":[179092,178052,179073],"length":1,"stats":{"Line":2}},{"line":25,"address":[179080],"length":1,"stats":{"Line":1}},{"line":26,"address":[179131],"length":1,"stats":{"Line":1}},{"line":28,"address":[179177,179108,179164],"length":1,"stats":{"Line":3}},{"line":32,"address":[178113,177899],"length":1,"stats":{"Line":3}},{"line":33,"address":[178079],"length":1,"stats":{"Line":1}},{"line":37,"address":[178128,178331],"length":1,"stats":{"Line":3}},{"line":38,"address":[178352,178996],"length":1,"stats":{"Line":3}},{"line":39,"address":[179040],"length":1,"stats":{"Line":1}},{"line":44,"address":[178376,178477,178209],"length":1,"stats":{"Line":2}},{"line":48,"address":[178418],"length":1,"stats":{"Line":1}},{"line":49,"address":[178631,178556,178428,178965],"length":1,"stats":{"Line":4}},{"line":50,"address":[178652,178876,178970],"length":1,"stats":{"Line":2}},{"line":54,"address":[178706,178748,178606],"length":1,"stats":{"Line":4}},{"line":57,"address":[178714],"length":1,"stats":{"Line":1}},{"line":59,"address":[178740,178769,178806],"length":1,"stats":{"Line":7}},{"line":60,"address":[178775],"length":1,"stats":{"Line":1}},{"line":62,"address":[178833],"length":1,"stats":{"Line":3}}],"covered":25,"coverable":25},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","evaluator.rs"],"content":"use crate::cell::{CellValue, parse_cell_reference};\r\nuse crate::formula::parse_range;\r\nuse crate::formula::{eval_avg, eval_max, eval_min, eval_variance, sum_value};\r\nuse crate::graph::{add_children, remove_all_parents};\r\nuse crate::reevaluate_topo::{sleep_fn, toposort_reval_detect_cycle};\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet, MAX_DISPLAY};\r\nuse crate::formula::Range;\r\nuse crate::extensions::get_formula_string;\r\n\r\nfn resolve_cell_reference(sheet: \u0026Spreadsheet, s: \u0026str) -\u003e Result\u003c(i16, i16), CommandStatus\u003e {\r\n    if let Some(range) = sheet.named_ranges.get(s) {\r\n        if range.start_row == range.end_row \u0026\u0026 range.start_col == range.end_col {\r\n            Ok((range.start_row, range.start_col))\r\n        } else {\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        }\r\n    } else {\r\n        parse_cell_reference(sheet, s)\r\n    }\r\n}\r\n\r\npub fn handle_sleep(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    let cell_key = sheet.get_key(row, col);\r\n\r\n    // Handle cell reference case\r\n    if let Ok((target_row, target_col)) = parse_cell_reference(sheet, expr) {\r\n        // Get parent key before any borrowing\r\n        let pkey = sheet.get_key(target_row, target_col);\r\n\r\n        // Check for self-reference early (optimization)\r\n        if row == target_row \u0026\u0026 col == target_col {\r\n            return CommandStatus::CmdCircularRef;\r\n        }\r\n\r\n        // Remove parents and update cell in one block\r\n        remove_all_parents(sheet, row, col);\r\n\r\n        // Set up the new cell metadata\r\n        let meta = sheet.get_cell_meta(row, col);\r\n        meta.parent1 = pkey;\r\n        meta.parent2 = -1;\r\n        meta.formula = 102; // Custom formula code for sleep\r\n\r\n        // Add children and update sleep time\r\n        add_children(sheet, pkey, -1, 102, row, col);\r\n        // Add to sleep time if integer\r\n        // Get the value from parent cell\r\n        let parent_value = sheet.get_cell(target_row, target_col);\r\n        if let CellValue::Integer(val) = parent_value {\r\n            // Update cell value and sleep time\r\n            sleep_fn(sheet, row, col, *val, sleep_time);\r\n        } else {\r\n            *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n        }\r\n    }\r\n    // Handle numeric literal case\r\n    else if let Ok(val) = expr.parse::\u003ci32\u003e() {\r\n        // Remove all parents and update cell in one sequence\r\n        remove_all_parents(sheet, row, col);\r\n        // Update cell value and sleep_time\r\n        // Delete the cell meta entry\r\n        sheet.cell_meta.remove(\u0026cell_key);\r\n        sleep_fn(sheet, row, col, val, sleep_time);\r\n    } else {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn evaluate_arithmetic(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n) -\u003e CommandStatus {\r\n    let cell_key = sheet.get_key(row, col);\r\n\r\n    // Case 1: Integer literal\r\n    if let Ok(number) = expr.parse::\u003ci32\u003e() {\r\n        remove_all_parents(sheet, row, col);\r\n        // As no parents and formula remove the meta data from the set and map\r\n        // to avoid memory leaks\r\n        sheet.cell_meta.remove(\u0026cell_key);\r\n        *sheet.get_mut_cell(row, col) = CellValue::Integer(number);\r\n\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    // Case 2: Simple cell reference - check using bytes for better performance\r\n    let mut all_alnum = true;\r\n    for \u0026b in expr.as_bytes() {\r\n        if !(b.is_ascii_alphanumeric() || b == b'_') {\r\n            all_alnum = false;\r\n            break;\r\n        }\r\n    }\r\n\r\n    if all_alnum {\r\n        match resolve_cell_reference(sheet, expr) {\r\n            Ok((target_row, target_col)) =\u003e {\r\n                // Get reference cell key and value\r\n                let ref_cell_key = sheet.get_key(target_row, target_col);\r\n\r\n                // Remove old dependencies and set new ones\r\n                remove_all_parents(sheet, row, col);\r\n\r\n                // Update metadata\r\n                let meta = sheet.get_cell_meta(row, col);\r\n                meta.parent1 = ref_cell_key;\r\n                meta.parent2 = -1;\r\n                meta.formula = 82; // Code for simple cell reference\r\n\r\n                // Add dependency\r\n                add_children(sheet, ref_cell_key, -1, 82, row, col);\r\n\r\n                // Update cell value\r\n                *sheet.get_mut_cell(row, col) = match sheet.get_cell(target_row, target_col) {\r\n                    CellValue::Integer(val) =\u003e CellValue::Integer(*val),\r\n                    _ =\u003e CellValue::Error,\r\n                };\r\n\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Case 3: Binary arithmetic expression\r\n    // Find operator starting at index 1 (like C code, to handle leading minus sign)\r\n    let bytes = expr.as_bytes();\r\n    let mut op_idx = 0;\r\n    let mut op = 0u8;\r\n\r\n    // Start at index 1 to handle leading minus sign\r\n    for i in 1..bytes.len() {\r\n        match bytes[i] {\r\n            b'+' | b'-' | b'*' | b'/' =\u003e {\r\n                op = bytes[i];\r\n                op_idx = i;\r\n                break;\r\n            }\r\n            _ =\u003e {}\r\n        }\r\n    }\r\n\r\n    if op_idx == 0 {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Split into left and right parts\r\n    let left = \u0026expr[..op_idx];\r\n    let right = \u0026expr[op_idx + 1..];\r\n\r\n    if left.is_empty() || right.is_empty() {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Variables to track cell references and values\r\n    let mut left_val = 0;\r\n    let mut right_val = 0;\r\n    let mut left_is_cell = false;\r\n    let mut right_is_cell = false;\r\n    let mut error_found = false;\r\n    let mut left_cell_key = -1;\r\n    let mut right_cell_key = -1;\r\n\r\n    // Parse left operand\r\n    if let Ok(num) = left.parse::\u003ci32\u003e() {\r\n        left_val = num;\r\n    } else {\r\n        // Try as cell reference\r\n        match parse_cell_reference(sheet, left) {\r\n            Ok((left_row, left_col)) =\u003e {\r\n                left_is_cell = true;\r\n                left_cell_key = sheet.get_key(left_row, left_col);\r\n\r\n                // Get reference cell value\r\n                let left_cell = sheet.get_cell(left_row, left_col);\r\n                match left_cell {\r\n                    CellValue::Integer(val) =\u003e left_val = *val,\r\n                    _ =\u003e {\r\n                        error_found = true;\r\n                    }\r\n                }\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Parse right operand\r\n    if let Ok(num) = right.parse::\u003ci32\u003e() {\r\n        right_val = num;\r\n    } else {\r\n        // Try as cell reference\r\n        match parse_cell_reference(sheet, right) {\r\n            Ok((right_row, right_col)) =\u003e {\r\n                right_is_cell = true;\r\n                right_cell_key = sheet.get_key(right_row, right_col);\r\n\r\n                // Get reference cell value\r\n                let right_cell = sheet.get_cell(right_row, right_col);\r\n                match right_cell {\r\n                    CellValue::Integer(val) =\u003e right_val = *val,\r\n                    _ =\u003e {\r\n                        error_found = true;\r\n                    }\r\n                }\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Remove old dependencies\r\n    remove_all_parents(sheet, row, col);\r\n\r\n    // Determine formula type based on operator and operand types\r\n    let mut formula_type = match op {\r\n        b'+' =\u003e 10,\r\n        b'-' =\u003e 20,\r\n        b'*' =\u003e 40,\r\n        b'/' =\u003e 30,\r\n        _ =\u003e unreachable!(),\r\n    };\r\n\r\n    // Adjust formula type based on cell references (like C code)\r\n    if left_is_cell \u0026\u0026 right_is_cell {\r\n        formula_type += 0; // Both are cells, no adjustment needed\r\n    } else if left_is_cell {\r\n        formula_type += 2;\r\n    } else if right_is_cell {\r\n        formula_type += 3;\r\n    }\r\n\r\n    // Set metadata\r\n    let meta = sheet.get_cell_meta(row, col);\r\n    meta.formula = formula_type;\r\n    meta.parent1 = if left_is_cell {\r\n        left_cell_key\r\n    } else {\r\n        left_val\r\n    };\r\n    meta.parent2 = if right_is_cell {\r\n        right_cell_key\r\n    } else {\r\n        right_val\r\n    };\r\n\r\n    // Check for circular references\r\n\r\n    // Add dependencies\r\n    if left_is_cell \u0026\u0026 right_is_cell {\r\n        // Add dependencies for both cells\r\n        add_children(sheet, left_cell_key, right_cell_key, formula_type, row, col);\r\n    } else if left_is_cell {\r\n        // Ordering of Cells matters\r\n        add_children(sheet, left_cell_key, -1, formula_type, row, col);\r\n    } else if right_is_cell {\r\n        // Ordering of Cells matters\r\n        add_children(sheet, -1, right_cell_key, formula_type, row, col);\r\n    }\r\n\r\n    // Calculate result\r\n    let cell = sheet.get_mut_cell(row, col);\r\n\r\n    if error_found {\r\n        *cell = CellValue::Error;\r\n    } else {\r\n        match op {\r\n            b'+' =\u003e *cell = CellValue::Integer(left_val + right_val),\r\n            b'-' =\u003e *cell = CellValue::Integer(left_val - right_val),\r\n            b'*' =\u003e *cell = CellValue::Integer(left_val * right_val),\r\n            b'/' =\u003e {\r\n                if right_val == 0 {\r\n                    *cell = CellValue::Error;\r\n                } else {\r\n                    *cell = CellValue::Integer(left_val / right_val);\r\n                }\r\n            }\r\n            _ =\u003e unreachable!(),\r\n        }\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn evaluate_formula(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    // Fast fail for empty expression\r\n    if expr.is_empty() {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Optimize function checks by using bytes for prefix matching\r\n    let bytes = expr.as_bytes();\r\n\r\n    // Check for range-based functions with a single pass\r\n    let (is_formula, formula_type, prefix_len) = match bytes.get(0..3) {\r\n        Some(b\"AVG\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 6, 4),\r\n        Some(b\"MIN\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 7, 4),\r\n        Some(b\"MAX\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 8, 4),\r\n        Some(b\"SUM\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 5, 4),\r\n        Some(b\"SLE\")\r\n            if bytes.len() \u003e 5\r\n                \u0026\u0026 bytes[3] == b'E'\r\n                \u0026\u0026 bytes[4] == b'P'\r\n                \u0026\u0026 bytes.get(5) == Some(\u0026b'(') =\u003e\r\n        {\r\n            // Handle sleep function separately\r\n            if !expr.ends_with(')') {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n            return handle_sleep(sheet, row, col, \u0026expr[6..expr.len() - 1], sleep_time);\r\n        }\r\n        Some(b\"STD\")\r\n            if bytes.len() \u003e 5\r\n                \u0026\u0026 bytes[3] == b'E'\r\n                \u0026\u0026 bytes[4] == b'V'\r\n                \u0026\u0026 bytes.get(5) == Some(\u0026b'(') =\u003e\r\n        {\r\n            (true, 9, 6)\r\n        }\r\n        _ =\u003e (false, -1, 0),\r\n    };\r\n\r\n    if is_formula {\r\n        // Validate formula format\r\n        if !expr.ends_with(')') {\r\n            return CommandStatus::CmdUnrecognized;\r\n        }\r\n\r\n        // Extract the range string without allocating extra memory\r\n        let range_str: \u0026str = \u0026expr[prefix_len..expr.len() - 1];\r\n\r\n        // Parse range and validate early to avoid unnecessary work\r\n        let range: Range = if let Some(named_range) = sheet.named_ranges.get(range_str) {\r\n            named_range.clone()\r\n        } else {\r\n            match parse_range(sheet, range_str) {\r\n                Ok(r) =\u003e r,\r\n                Err(status) =\u003e return status,\r\n            }\r\n        };\r\n\r\n        // let cell_key = sheet.get_key(row, col);\r\n        let parent1 = sheet.get_key(range.start_row, range.start_col);\r\n        let parent2 = sheet.get_key(range.end_row, range.end_col);\r\n        remove_all_parents(sheet, row, col);\r\n        // Update metadata\r\n        let meta = sheet.get_cell_meta(row, col);\r\n        meta.parent1 = parent1;\r\n        meta.parent2 = parent2;\r\n        meta.formula = formula_type;\r\n\r\n        // Add children and evaluate the appropriate function\r\n        add_children(sheet, parent1, parent2, formula_type, row, col);\r\n\r\n        match formula_type {\r\n            9 =\u003e eval_variance(sheet, row, col, parent1, parent2),\r\n            8 =\u003e eval_max(sheet, row, col, parent1, parent2),\r\n            7 =\u003e eval_min(sheet, row, col, parent1, parent2),\r\n            6 =\u003e eval_avg(sheet, row, col, parent1, parent2),\r\n            _ =\u003e sum_value(sheet, row, col, parent1, parent2), // SUM case\r\n        }\r\n    } else {\r\n        // Handle arithmetic expressions\r\n        evaluate_arithmetic(sheet, row, col, expr)\r\n    }\r\n}\r\n\r\npub fn set_cell_value(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    if sheet.is_cell_locked(row, col) {\r\n        return CommandStatus::CmdLockedCell;\r\n    }\r\n    let cell_key = sheet.get_key(row, col);\r\n\r\n    // Save old state\r\n    let old_meta = sheet.cell_meta.get(\u0026cell_key).cloned();\r\n    let old_value = match sheet.get_cell(row, col) {\r\n        CellValue::Integer(val) =\u003e CellValue::Integer(*val),\r\n        _ =\u003e CellValue::Error,\r\n    };\r\n    let status: CommandStatus = evaluate_formula(sheet, row, col, expr, sleep_time);\r\n    if let CommandStatus::CmdOk = status {\r\n        // Reevaluate the cell dependents graphs i.e. all of its children\r\n        // Also at same time check for cycle in the graph as it will save time and memory\r\n        let has_cycle = toposort_reval_detect_cycle(sheet, row, col, sleep_time);\r\n        if has_cycle {\r\n            // If a cycle is detected, restore the old parents and formula\r\n            // Remove the new parents and formula\r\n            remove_all_parents(sheet, row, col);\r\n            // Restore the old value\r\n            *sheet.get_mut_cell(row, col) = old_value;\r\n            // Old meta\r\n            if let Some(old) = old_meta {\r\n                let (parent1, parent2, formula) = (old.parent1, old.parent2, old.formula);\r\n                sheet.cell_meta.insert(cell_key, old);\r\n                add_children(sheet, parent1, parent2, formula, row, col);\r\n            } else {\r\n                sheet.cell_meta.remove(\u0026cell_key);\r\n            }\r\n\r\n            return CommandStatus::CmdCircularRef;\r\n        } else {\r\n            // If no cycle, update the cell history with the old value\r\n            sheet.cell_history.entry(cell_key).or_insert_with(Vec::new).push(old_value);\r\n            sheet.set_last_edited(row, col);\r\n        }\r\n    }\r\n    status\r\n}\r\n\r\nfn set_cell_to_value(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    value: CellValue,\r\n    sleep_time: \u0026mut f64\r\n) -\u003e CommandStatus {\r\n    // Check if the cell is locked before setting the value\r\n        if sheet.is_cell_locked(row, col) {\r\n            return CommandStatus::CmdLockedCell;\r\n        }\r\n        // Check if the value is a valid integer\r\n        let cell_key = sheet.get_key(row, col);\r\n        // remove all parents and set the value                                             \r\n        remove_all_parents(sheet, row, col);\r\n        sheet.cell_meta.remove(\u0026cell_key);\r\n        *sheet.get_mut_cell(row, col) = value;\r\n        toposort_reval_detect_cycle(sheet, row, col, sleep_time);\r\n        sheet.set_last_edited(row, col);\r\n        CommandStatus::CmdOk\r\n}\r\n\r\npub fn handle_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    trimmed: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    // Fast path for single-character commands to avoid string comparisons\r\n    if trimmed.len() == 1 {\r\n        match trimmed.as_bytes()[0] {\r\n            b'w' | b'a' | b's' | b'd' =\u003e {\r\n                // We've already validated it's one byte, so this is safe\r\n                let direction = trimmed.chars().next().unwrap();\r\n                sheet.scroll_viewport(direction);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            b'q' =\u003e return CommandStatus::CmdOk, // Handle quit command if needed\r\n            _ =\u003e {}\r\n        }\r\n    }\r\n\r\n    // Use match for special commands for better branch prediction\r\n    match trimmed {\r\n        \"disable_output\" =\u003e {\r\n            sheet.output_enabled = false;\r\n            return CommandStatus::CmdOk;\r\n        }\r\n        \"enable_output\" =\u003e {\r\n            sheet.output_enabled = true;\r\n            return CommandStatus::CmdOk;\r\n        }\r\n        \"last_edit\" =\u003e {\r\n            sheet.scroll_to_last_edited();\r\n            return CommandStatus::CmdOk;\r\n        }\r\n        _ =\u003e {}\r\n    }\r\n\r\n    // Check for cell dependency visualization command\r\n    if trimmed.starts_with(\"visualize \") {\r\n        let cell_ref = \u0026trimmed[10..]; // Skip \"visualize \" prefix\r\n        match parse_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                return sheet.visualize_cell_relationships(row, col);\r\n            }\r\n            Err(status) =\u003e {\r\n                return status;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Check for scroll_to command with byte-based comparison\r\n    if trimmed.len() \u003e 10\r\n        \u0026\u0026 \u0026trimmed.as_bytes()[..9] == b\"scroll_to\"\r\n        \u0026\u0026 trimmed.as_bytes()[9] == b' '\r\n    {\r\n        let cell_ref = \u0026trimmed[10..];\r\n        return sheet.scroll_to_cell(cell_ref);\r\n    }\r\n\r\n    if trimmed.starts_with(\"display \") {\r\n        let num_str = trimmed.get(8..).unwrap_or(\"\").trim();\r\n        match num_str.parse::\u003ci16\u003e() {\r\n            Ok(num) if num \u003e 0 \u0026\u0026 num \u003c= MAX_DISPLAY =\u003e {\r\n                sheet.display_rows = num;\r\n                sheet.display_cols = num;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            _ =\u003e return CommandStatus::CmdUnrecognized,\r\n        }\r\n    }\r\n\r\n    if trimmed.starts_with(\"lock_cell \") {\r\n        let lock_target = trimmed.get(10..).unwrap_or(\"\").trim();\r\n        if lock_target.contains(':') {\r\n            match parse_range(sheet, lock_target) {\r\n                Ok(range) =\u003e {\r\n                    sheet.lock_range(range);\r\n                    return CommandStatus::CmdOk;\r\n                }\r\n                Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n            }\r\n        } else {\r\n            match resolve_cell_reference(sheet, lock_target) {\r\n                Ok((row, col)) =\u003e {\r\n                    let range = Range {\r\n                        start_row: row,\r\n                        start_col: col,\r\n                        end_row: row,\r\n                        end_col: col,\r\n                    };\r\n                    sheet.lock_range(range);\r\n                    return CommandStatus::CmdOk;\r\n                }\r\n                Err(status) =\u003e return status,\r\n            }\r\n        }\r\n    }\r\n\r\n    if trimmed.starts_with(\"name \") {\r\n        let parts: Vec\u003c\u0026str\u003e = trimmed[5..].split_whitespace().collect();\r\n        if parts.len() == 2 {\r\n            let target = parts[0];\r\n            let name = parts[1];\r\n            if let Ok(range) = parse_range(sheet, target) {\r\n                sheet.named_ranges.insert(name.to_string(), range);\r\n                return CommandStatus::CmdOk;\r\n            } else if let Ok((row, col)) = parse_cell_reference(sheet, target) {\r\n                let range = Range {\r\n                    start_row: row,\r\n                    start_col: col,\r\n                    end_row: row,\r\n                    end_col: col,\r\n                };\r\n                sheet.named_ranges.insert(name.to_string(), range);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    if trimmed.starts_with(\"history \") {\r\n        let cell_ref = trimmed[8..].trim();\r\n        return match resolve_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                let cell_key = sheet.get_key(row, col);\r\n                if let Some(history) = sheet.cell_history.get_mut(\u0026cell_key) {\r\n                    if let Some(prev_value) = history.pop() {\r\n                        set_cell_to_value(sheet, row, col, prev_value, sleep_time)\r\n                    } else {\r\n                        CommandStatus::CmdOk\r\n                    }\r\n                } else {\r\n                    CommandStatus::CmdOk\r\n                }\r\n            }\r\n            Err(status) =\u003e status,\r\n        };\r\n    }\r\n\r\n    if trimmed.starts_with(\"formula \") {\r\n        let cell_ref = trimmed[8..].trim();\r\n        match resolve_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                let formula_str = get_formula_string(sheet, row, col);\r\n                println!(\"{}\", formula_str);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Check for cell assignment using byte search for '='\r\n    let bytes = trimmed.as_bytes();\r\n    let mut eq_pos = None;\r\n\r\n    for (i, \u0026b) in bytes.iter().enumerate() {\r\n        if b == b'=' {\r\n            eq_pos = Some(i);\r\n            break;\r\n        }\r\n    }\r\n\r\n    if let Some(pos) = eq_pos {\r\n        // Use slice operations which are more efficient than split_at\r\n        let cell_ref = trimmed[..pos].trim();\r\n        let expr = trimmed[pos + 1..].trim();\r\n\r\n        // Parse the cell reference with direct result handling\r\n        return match parse_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                // All bounds checks in one condition\r\n                set_cell_value(sheet, row, col, expr, sleep_time)\r\n            }\r\n            Err(status) =\u003e status,\r\n        };\r\n    }\r\n    // No recognized command\r\n    CommandStatus::CmdUnrecognized\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_with_reference() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(5));\r\n        assert_eq!(sleep_time, 5.0);\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 102);\r\n        assert_eq!(meta.parent1, sheet.get_key(0, 0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_with_literal() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"3\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n        assert_eq!(sleep_time, 3.0);\r\n        assert!(!sheet.cell_meta.contains_key(\u0026sheet.get_key(1, 1)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_invalid() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"INVALID\", \u0026mut sleep_time),\r\n            CommandStatus::CmdUnrecognized\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_self_reference() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_literal() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 0, 0, \"42\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(42));\r\n        assert!(!sheet.cell_meta.contains_key(\u0026sheet.get_key(0, 0)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_cell_ref() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(10);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 1, 1, \"A1\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(10));\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 82);\r\n        assert_eq!(meta.parent1, sheet.get_key(0, 0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_binary_add() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 1, 1, \"A1+3\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(8));\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 12);\r\n        assert_eq!(meta.parent1, sheet.get_key(0, 0));\r\n        assert_eq!(meta.parent2, 3);\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_binary_div_zero() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 1, 1, \"A1/0\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_formula_sum() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            evaluate_formula(\u0026mut sheet, 1, 1, \"SUM(A1:B1)\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 5);\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_formula_invalid() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            evaluate_formula(\u0026mut sheet, 1, 1, \"SUM(A1)\", \u0026mut sleep_time),\r\n            CommandStatus::CmdUnrecognized\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_set_cell_value_with_cycle() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 0, 0, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_scroll() {\r\n        let mut sheet = create_test_spreadsheet(50, 50);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"s\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_row, 10);\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"d\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_col, 10);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_output_toggle() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"disable_output\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert!(!sheet.output_enabled);\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"enable_output\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert!(sheet.output_enabled);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_visualize() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"visualize A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"visualize Z9\", \u0026mut sleep_time),\r\n            CommandStatus::CmdInvalidCell\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_scroll_to() {\r\n        let mut sheet = create_test_spreadsheet(50, 50);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"scroll_to B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_row, 1);\r\n        assert_eq!(sheet.viewport_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_assignment() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"A1=42\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(42));\r\n    }\r\n\r\n    #[test]\r\n    fn test_set_cell_value_circular_ref() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 0, 0, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_last_edit() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        handle_command(\u0026mut sheet, \"B2=42\", \u0026mut sleep_time);\r\n        assert_eq!(sheet.last_edited, Some((1, 1)));\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"last_edit\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_row, 1);\r\n        assert_eq!(sheet.viewport_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_display() {\r\n        let mut sheet = create_test_spreadsheet(20, 20);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"display 5\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.display_rows, 5);\r\n        assert_eq!(sheet.display_cols, 5);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_lock_cell() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"lock_cell B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert!(sheet.is_cell_locked(1, 1));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_history() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"A2=2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"A2=3\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"history A2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 0), CellValue::Integer(2));\r\n        assert_eq!(sheet.last_edited, Some((1, 0)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_formula_max() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(3);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            evaluate_formula(\u0026mut sheet, 1, 1, \"MAX(A1:B1)\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(5));\r\n    }\r\n\r\n}\r\n","traces":[{"line":10,"address":[185360],"length":1,"stats":{"Line":2}},{"line":11,"address":[185394],"length":1,"stats":{"Line":2}},{"line":12,"address":[185536,185452],"length":1,"stats":{"Line":0}},{"line":13,"address":[185558],"length":1,"stats":{"Line":0}},{"line":15,"address":[185518],"length":1,"stats":{"Line":0}},{"line":18,"address":[185478],"length":1,"stats":{"Line":2}},{"line":22,"address":[185616],"length":1,"stats":{"Line":1}},{"line":29,"address":[185708],"length":1,"stats":{"Line":1}},{"line":32,"address":[185738],"length":1,"stats":{"Line":1}},{"line":34,"address":[185844],"length":1,"stats":{"Line":1}},{"line":37,"address":[185878,186129],"length":1,"stats":{"Line":3}},{"line":38,"address":[186138],"length":1,"stats":{"Line":1}},{"line":42,"address":[185964],"length":1,"stats":{"Line":1}},{"line":45,"address":[185990],"length":1,"stats":{"Line":1}},{"line":46,"address":[186032],"length":1,"stats":{"Line":1}},{"line":47,"address":[186034],"length":1,"stats":{"Line":1}},{"line":48,"address":[186041],"length":1,"stats":{"Line":1}},{"line":51,"address":[186047],"length":1,"stats":{"Line":1}},{"line":54,"address":[186085],"length":1,"stats":{"Line":1}},{"line":55,"address":[186170,186109],"length":1,"stats":{"Line":2}},{"line":57,"address":[186185],"length":1,"stats":{"Line":1}},{"line":59,"address":[186216],"length":1,"stats":{"Line":0}},{"line":63,"address":[185899,186280],"length":1,"stats":{"Line":2}},{"line":65,"address":[186295],"length":1,"stats":{"Line":1}},{"line":68,"address":[186311],"length":1,"stats":{"Line":1}},{"line":69,"address":[186354],"length":1,"stats":{"Line":1}},{"line":71,"address":[186367],"length":1,"stats":{"Line":1}},{"line":74,"address":[186248],"length":1,"stats":{"Line":1}},{"line":77,"address":[186384],"length":1,"stats":{"Line":1}},{"line":83,"address":[186484],"length":1,"stats":{"Line":1}},{"line":86,"address":[186518],"length":1,"stats":{"Line":1}},{"line":87,"address":[186614],"length":1,"stats":{"Line":1}},{"line":90,"address":[186633],"length":1,"stats":{"Line":1}},{"line":91,"address":[186689],"length":1,"stats":{"Line":1}},{"line":93,"address":[186737],"length":1,"stats":{"Line":1}},{"line":97,"address":[186763],"length":1,"stats":{"Line":3}},{"line":98,"address":[186771,186886,186820],"length":1,"stats":{"Line":9}},{"line":99,"address":[186903],"length":1,"stats":{"Line":3}},{"line":100,"address":[186930],"length":1,"stats":{"Line":2}},{"line":105,"address":[186870],"length":1,"stats":{"Line":1}},{"line":106,"address":[187069],"length":1,"stats":{"Line":1}},{"line":107,"address":[190018],"length":1,"stats":{"Line":1}},{"line":109,"address":[190060],"length":1,"stats":{"Line":1}},{"line":112,"address":[190108],"length":1,"stats":{"Line":1}},{"line":115,"address":[190143],"length":1,"stats":{"Line":1}},{"line":116,"address":[190194],"length":1,"stats":{"Line":1}},{"line":117,"address":[190196],"length":1,"stats":{"Line":1}},{"line":118,"address":[190203],"length":1,"stats":{"Line":1}},{"line":121,"address":[190209],"length":1,"stats":{"Line":1}},{"line":124,"address":[190380,190250],"length":1,"stats":{"Line":3}},{"line":125,"address":[190307],"length":1,"stats":{"Line":2}},{"line":126,"address":[190345],"length":1,"stats":{"Line":0}},{"line":129,"address":[190410],"length":1,"stats":{"Line":2}},{"line":131,"address":[190276],"length":1,"stats":{"Line":0}},{"line":137,"address":[186956],"length":1,"stats":{"Line":2}},{"line":138,"address":[186996],"length":1,"stats":{"Line":2}},{"line":139,"address":[187008],"length":1,"stats":{"Line":2}},{"line":142,"address":[187221,187016,187152],"length":1,"stats":{"Line":6}},{"line":143,"address":[187245],"length":1,"stats":{"Line":2}},{"line":145,"address":[187361,187421],"length":1,"stats":{"Line":2}},{"line":146,"address":[187392],"length":1,"stats":{"Line":2}},{"line":153,"address":[187193],"length":1,"stats":{"Line":2}},{"line":154,"address":[187437],"length":1,"stats":{"Line":0}},{"line":158,"address":[187466],"length":1,"stats":{"Line":2}},{"line":159,"address":[187635,187518],"length":1,"stats":{"Line":2}},{"line":161,"address":[187624,187664],"length":1,"stats":{"Line":4}},{"line":162,"address":[187675],"length":1,"stats":{"Line":0}},{"line":166,"address":[187704],"length":1,"stats":{"Line":2}},{"line":167,"address":[187715],"length":1,"stats":{"Line":2}},{"line":168,"address":[187726],"length":1,"stats":{"Line":2}},{"line":169,"address":[187734],"length":1,"stats":{"Line":2}},{"line":170,"address":[187742],"length":1,"stats":{"Line":2}},{"line":171,"address":[187750],"length":1,"stats":{"Line":2}},{"line":172,"address":[187761],"length":1,"stats":{"Line":2}},{"line":175,"address":[187772,187840],"length":1,"stats":{"Line":2}},{"line":176,"address":[187833],"length":1,"stats":{"Line":0}},{"line":179,"address":[187866],"length":1,"stats":{"Line":2}},{"line":180,"address":[188022],"length":1,"stats":{"Line":2}},{"line":181,"address":[188064],"length":1,"stats":{"Line":2}},{"line":182,"address":[188072],"length":1,"stats":{"Line":2}},{"line":185,"address":[188110],"length":1,"stats":{"Line":2}},{"line":186,"address":[188134],"length":1,"stats":{"Line":2}},{"line":187,"address":[188175],"length":1,"stats":{"Line":2}},{"line":188,"address":[188213],"length":1,"stats":{"Line":0}},{"line":189,"address":[188205],"length":1,"stats":{"Line":0}},{"line":193,"address":[188144],"length":1,"stats":{"Line":0}},{"line":198,"address":[187958,188239,188218],"length":1,"stats":{"Line":6}},{"line":199,"address":[188232],"length":1,"stats":{"Line":2}},{"line":202,"address":[188262],"length":1,"stats":{"Line":0}},{"line":203,"address":[188430],"length":1,"stats":{"Line":0}},{"line":204,"address":[188472],"length":1,"stats":{"Line":0}},{"line":205,"address":[188480],"length":1,"stats":{"Line":0}},{"line":208,"address":[188518],"length":1,"stats":{"Line":0}},{"line":209,"address":[188542],"length":1,"stats":{"Line":0}},{"line":210,"address":[188583],"length":1,"stats":{"Line":0}},{"line":211,"address":[188621],"length":1,"stats":{"Line":0}},{"line":212,"address":[188613],"length":1,"stats":{"Line":0}},{"line":216,"address":[188552],"length":1,"stats":{"Line":0}},{"line":221,"address":[188365],"length":1,"stats":{"Line":2}},{"line":224,"address":[188376],"length":1,"stats":{"Line":2}},{"line":225,"address":[188654],"length":1,"stats":{"Line":1}},{"line":226,"address":[188666],"length":1,"stats":{"Line":0}},{"line":227,"address":[188678],"length":1,"stats":{"Line":0}},{"line":228,"address":[188690],"length":1,"stats":{"Line":1}},{"line":233,"address":[188722,188988,188700],"length":1,"stats":{"Line":4}},{"line":234,"address":[188980,188732,188993],"length":1,"stats":{"Line":0}},{"line":235,"address":[188954,188710],"length":1,"stats":{"Line":4}},{"line":236,"address":[188959,188946,188777],"length":1,"stats":{"Line":4}},{"line":237,"address":[188923,188765],"length":1,"stats":{"Line":0}},{"line":238,"address":[188886,188925],"length":1,"stats":{"Line":0}},{"line":242,"address":[188834],"length":1,"stats":{"Line":2}},{"line":243,"address":[188858],"length":1,"stats":{"Line":2}},{"line":244,"address":[189044,189023,188870],"length":1,"stats":{"Line":4}},{"line":245,"address":[189025],"length":1,"stats":{"Line":2}},{"line":247,"address":[189009],"length":1,"stats":{"Line":0}},{"line":249,"address":[189098,189077,189053],"length":1,"stats":{"Line":6}},{"line":250,"address":[189079],"length":1,"stats":{"Line":0}},{"line":252,"address":[189063],"length":1,"stats":{"Line":2}},{"line":258,"address":[189130,189108],"length":1,"stats":{"Line":4}},{"line":260,"address":[189165],"length":1,"stats":{"Line":0}},{"line":261,"address":[189118],"length":1,"stats":{"Line":2}},{"line":263,"address":[189239],"length":1,"stats":{"Line":2}},{"line":264,"address":[189202],"length":1,"stats":{"Line":0}},{"line":266,"address":[189357],"length":1,"stats":{"Line":0}},{"line":270,"address":[189296],"length":1,"stats":{"Line":2}},{"line":272,"address":[189320,189469],"length":1,"stats":{"Line":2}},{"line":273,"address":[189439],"length":1,"stats":{"Line":0}},{"line":275,"address":[189392],"length":1,"stats":{"Line":2}},{"line":276,"address":[189624,189502],"length":1,"stats":{"Line":2}},{"line":277,"address":[189701,189531],"length":1,"stats":{"Line":0}},{"line":278,"address":[189765,189563],"length":1,"stats":{"Line":0}},{"line":280,"address":[189596,189855,189989],"length":1,"stats":{"Line":2}},{"line":281,"address":[189825],"length":1,"stats":{"Line":1}},{"line":283,"address":[189860,189994],"length":1,"stats":{"Line":0}},{"line":290,"address":[189679],"length":1,"stats":{"Line":1}},{"line":293,"address":[190432],"length":1,"stats":{"Line":1}},{"line":301,"address":[190555],"length":1,"stats":{"Line":1}},{"line":302,"address":[190678],"length":1,"stats":{"Line":0}},{"line":306,"address":[190580],"length":1,"stats":{"Line":1}},{"line":309,"address":[190737,191070,191292,190617,190996],"length":1,"stats":{"Line":7}},{"line":310,"address":[190691,190919],"length":1,"stats":{"Line":1}},{"line":311,"address":[191118],"length":1,"stats":{"Line":0}},{"line":312,"address":[191210],"length":1,"stats":{"Line":1}},{"line":313,"address":[191363],"length":1,"stats":{"Line":2}},{"line":315,"address":[191450],"length":1,"stats":{"Line":0}},{"line":316,"address":[191465],"length":1,"stats":{"Line":0}},{"line":317,"address":[191522],"length":1,"stats":{"Line":0}},{"line":318,"address":[191584],"length":1,"stats":{"Line":0}},{"line":321,"address":[191647],"length":1,"stats":{"Line":0}},{"line":322,"address":[191661],"length":1,"stats":{"Line":0}},{"line":324,"address":[191748,191687],"length":1,"stats":{"Line":0}},{"line":327,"address":[191841],"length":1,"stats":{"Line":0}},{"line":328,"address":[191856],"length":1,"stats":{"Line":0}},{"line":329,"address":[191913],"length":1,"stats":{"Line":0}},{"line":330,"address":[191975],"length":1,"stats":{"Line":0}},{"line":332,"address":[192022],"length":1,"stats":{"Line":0}},{"line":334,"address":[190702],"length":1,"stats":{"Line":3}},{"line":337,"address":[191057],"length":1,"stats":{"Line":3}},{"line":339,"address":[192136],"length":1,"stats":{"Line":3}},{"line":340,"address":[192150],"length":1,"stats":{"Line":0}},{"line":344,"address":[192179,192328],"length":1,"stats":{"Line":3}},{"line":347,"address":[192744,192344,192277],"length":1,"stats":{"Line":5}},{"line":348,"address":[192360],"length":1,"stats":{"Line":0}},{"line":350,"address":[192409],"length":1,"stats":{"Line":3}},{"line":351,"address":[192712],"length":1,"stats":{"Line":2}},{"line":352,"address":[192749],"length":1,"stats":{"Line":1}},{"line":357,"address":[192457],"length":1,"stats":{"Line":2}},{"line":358,"address":[192503],"length":1,"stats":{"Line":2}},{"line":359,"address":[192567],"length":1,"stats":{"Line":2}},{"line":361,"address":[192602],"length":1,"stats":{"Line":2}},{"line":362,"address":[192649],"length":1,"stats":{"Line":2}},{"line":363,"address":[192651],"length":1,"stats":{"Line":2}},{"line":364,"address":[192654],"length":1,"stats":{"Line":2}},{"line":367,"address":[192665],"length":1,"stats":{"Line":2}},{"line":369,"address":[192674],"length":1,"stats":{"Line":2}},{"line":370,"address":[192864],"length":1,"stats":{"Line":0}},{"line":371,"address":[192920],"length":1,"stats":{"Line":1}},{"line":372,"address":[192976],"length":1,"stats":{"Line":0}},{"line":373,"address":[193032],"length":1,"stats":{"Line":0}},{"line":374,"address":[192808],"length":1,"stats":{"Line":1}},{"line":378,"address":[192097],"length":1,"stats":{"Line":3}},{"line":382,"address":[193056],"length":1,"stats":{"Line":3}},{"line":389,"address":[193151],"length":1,"stats":{"Line":3}},{"line":390,"address":[193269],"length":1,"stats":{"Line":0}},{"line":392,"address":[193181],"length":1,"stats":{"Line":3}},{"line":395,"address":[193201],"length":1,"stats":{"Line":3}},{"line":396,"address":[193243],"length":1,"stats":{"Line":3}},{"line":397,"address":[193284],"length":1,"stats":{"Line":3}},{"line":398,"address":[193316],"length":1,"stats":{"Line":0}},{"line":400,"address":[193354],"length":1,"stats":{"Line":3}},{"line":401,"address":[193369],"length":1,"stats":{"Line":3}},{"line":404,"address":[193400],"length":1,"stats":{"Line":3}},{"line":405,"address":[193423],"length":1,"stats":{"Line":3}},{"line":408,"address":[193550],"length":1,"stats":{"Line":1}},{"line":410,"address":[193576],"length":1,"stats":{"Line":1}},{"line":412,"address":[193616],"length":1,"stats":{"Line":1}},{"line":413,"address":[193653],"length":1,"stats":{"Line":0}},{"line":414,"address":[193727],"length":1,"stats":{"Line":0}},{"line":415,"address":[193782],"length":1,"stats":{"Line":0}},{"line":417,"address":[193805],"length":1,"stats":{"Line":1}},{"line":420,"address":[193827],"length":1,"stats":{"Line":1}},{"line":423,"address":[193447],"length":1,"stats":{"Line":3}},{"line":424,"address":[193522],"length":1,"stats":{"Line":3}},{"line":427,"address":[193429],"length":1,"stats":{"Line":3}},{"line":430,"address":[193856],"length":1,"stats":{"Line":1}},{"line":438,"address":[193926],"length":1,"stats":{"Line":1}},{"line":439,"address":[194136],"length":1,"stats":{"Line":0}},{"line":442,"address":[193960],"length":1,"stats":{"Line":1}},{"line":444,"address":[193992],"length":1,"stats":{"Line":1}},{"line":445,"address":[194008],"length":1,"stats":{"Line":1}},{"line":446,"address":[194042],"length":1,"stats":{"Line":1}},{"line":447,"address":[194092],"length":1,"stats":{"Line":1}},{"line":448,"address":[194118],"length":1,"stats":{"Line":1}},{"line":449,"address":[194129],"length":1,"stats":{"Line":1}},{"line":452,"address":[194160,197150],"length":1,"stats":{"Line":5}},{"line":458,"address":[194269],"length":1,"stats":{"Line":5}},{"line":459,"address":[194380,194296],"length":1,"stats":{"Line":2}},{"line":462,"address":[194495],"length":1,"stats":{"Line":1}},{"line":463,"address":[194560],"length":1,"stats":{"Line":1}},{"line":464,"address":[194565],"length":1,"stats":{"Line":1}},{"line":466,"address":[194575],"length":1,"stats":{"Line":0}},{"line":473,"address":[194342],"length":1,"stats":{"Line":5}},{"line":474,"address":[194645],"length":1,"stats":{"Line":1}},{"line":475,"address":[194652],"length":1,"stats":{"Line":1}},{"line":477,"address":[194614],"length":1,"stats":{"Line":5}},{"line":478,"address":[194709],"length":1,"stats":{"Line":1}},{"line":479,"address":[194716],"length":1,"stats":{"Line":1}},{"line":481,"address":[194678],"length":1,"stats":{"Line":5}},{"line":482,"address":[194776],"length":1,"stats":{"Line":1}},{"line":483,"address":[194781],"length":1,"stats":{"Line":1}},{"line":489,"address":[194745],"length":1,"stats":{"Line":5}},{"line":490,"address":[194846],"length":1,"stats":{"Line":1}},{"line":491,"address":[194890],"length":1,"stats":{"Line":1}},{"line":492,"address":[198681],"length":1,"stats":{"Line":1}},{"line":493,"address":[198713],"length":1,"stats":{"Line":1}},{"line":495,"address":[198736],"length":1,"stats":{"Line":0}},{"line":496,"address":[198750],"length":1,"stats":{"Line":0}},{"line":502,"address":[194810],"length":1,"stats":{"Line":5}},{"line":503,"address":[195035],"length":1,"stats":{"Line":1}},{"line":504,"address":[195124],"length":1,"stats":{"Line":1}},{"line":506,"address":[195219],"length":1,"stats":{"Line":1}},{"line":507,"address":[195263],"length":1,"stats":{"Line":1}},{"line":510,"address":[194989],"length":1,"stats":{"Line":4}},{"line":511,"address":[195342],"length":1,"stats":{"Line":1}},{"line":512,"address":[195405],"length":1,"stats":{"Line":1}},{"line":513,"address":[198562,198616],"length":1,"stats":{"Line":2}},{"line":514,"address":[198646],"length":1,"stats":{"Line":1}},{"line":515,"address":[198653],"length":1,"stats":{"Line":1}},{"line":516,"address":[198660],"length":1,"stats":{"Line":1}},{"line":518,"address":[198598],"length":1,"stats":{"Line":0}},{"line":522,"address":[195296],"length":1,"stats":{"Line":4}},{"line":523,"address":[195517],"length":1,"stats":{"Line":1}},{"line":524,"address":[195596],"length":1,"stats":{"Line":1}},{"line":525,"address":[198303],"length":1,"stats":{"Line":0}},{"line":526,"address":[198491],"length":1,"stats":{"Line":0}},{"line":527,"address":[198507],"length":1,"stats":{"Line":0}},{"line":528,"address":[198536],"length":1,"stats":{"Line":0}},{"line":530,"address":[198549],"length":1,"stats":{"Line":0}},{"line":533,"address":[198200],"length":1,"stats":{"Line":1}},{"line":534,"address":[198351],"length":1,"stats":{"Line":1}},{"line":541,"address":[198415],"length":1,"stats":{"Line":1}},{"line":542,"address":[198444],"length":1,"stats":{"Line":1}},{"line":544,"address":[198457],"length":1,"stats":{"Line":0}},{"line":549,"address":[195474],"length":1,"stats":{"Line":3}},{"line":550,"address":[195678],"length":1,"stats":{"Line":0}},{"line":551,"address":[195756,197548],"length":1,"stats":{"Line":0}},{"line":552,"address":[197554,197603],"length":1,"stats":{"Line":0}},{"line":553,"address":[197636],"length":1,"stats":{"Line":0}},{"line":554,"address":[197732],"length":1,"stats":{"Line":0}},{"line":555,"address":[197791,197852],"length":1,"stats":{"Line":0}},{"line":556,"address":[197899],"length":1,"stats":{"Line":0}},{"line":557,"address":[197835,197930],"length":1,"stats":{"Line":0}},{"line":564,"address":[198085],"length":1,"stats":{"Line":0}},{"line":565,"address":[198163],"length":1,"stats":{"Line":0}},{"line":568,"address":[197585],"length":1,"stats":{"Line":0}},{"line":571,"address":[195635],"length":1,"stats":{"Line":3}},{"line":572,"address":[195836],"length":1,"stats":{"Line":1}},{"line":573,"address":[195891],"length":1,"stats":{"Line":1}},{"line":574,"address":[197180],"length":1,"stats":{"Line":1}},{"line":575,"address":[197222],"length":1,"stats":{"Line":1}},{"line":576,"address":[197248,197403,197333],"length":1,"stats":{"Line":2}},{"line":577,"address":[197349,197434,197495],"length":1,"stats":{"Line":2}},{"line":578,"address":[197464],"length":1,"stats":{"Line":1}},{"line":580,"address":[197487],"length":1,"stats":{"Line":0}},{"line":583,"address":[197395],"length":1,"stats":{"Line":0}},{"line":586,"address":[197307],"length":1,"stats":{"Line":0}},{"line":590,"address":[195790],"length":1,"stats":{"Line":3}},{"line":591,"address":[196140],"length":1,"stats":{"Line":0}},{"line":592,"address":[196195],"length":1,"stats":{"Line":0}},{"line":593,"address":[196919,196938],"length":1,"stats":{"Line":0}},{"line":594,"address":[196930,196911,196962],"length":1,"stats":{"Line":0}},{"line":595,"address":[196980,197053],"length":1,"stats":{"Line":0}},{"line":596,"address":[197124],"length":1,"stats":{"Line":0}},{"line":598,"address":[196987],"length":1,"stats":{"Line":0}},{"line":603,"address":[195990],"length":1,"stats":{"Line":3}},{"line":604,"address":[196017],"length":1,"stats":{"Line":3}},{"line":606,"address":[196029,196352,196278],"length":1,"stats":{"Line":8}},{"line":607,"address":[196393],"length":1,"stats":{"Line":3}},{"line":608,"address":[196405],"length":1,"stats":{"Line":3}},{"line":613,"address":[196336,196475],"length":1,"stats":{"Line":6}},{"line":615,"address":[196496],"length":1,"stats":{"Line":3}},{"line":616,"address":[196559,196619,196780],"length":1,"stats":{"Line":6}},{"line":619,"address":[196704],"length":1,"stats":{"Line":3}},{"line":620,"address":[196822],"length":1,"stats":{"Line":3}},{"line":622,"address":[196854],"length":1,"stats":{"Line":3}},{"line":624,"address":[196877],"length":1,"stats":{"Line":0}},{"line":628,"address":[196582],"length":1,"stats":{"Line":0}}],"covered":213,"coverable":307},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","extensions.rs"],"content":"use crate::spreadsheet::Spreadsheet;\n\npub fn get_formula_string(sheet: \u0026Spreadsheet, row: i16, col: i16) -\u003e String {\n    let meta = sheet.get_cell_meta_ref(row, col);\n    if meta.formula == -1 {\n        return \"No formula\".to_string();\n    }\n    let rem = meta.formula % 10;\n    let msb = meta.formula / 10;\n    let parent1 = meta.parent1;\n    let parent2 = meta.parent2;\n\n    match rem {\n        0 =\u003e {\n            let (left, right) = {\n                    let (left_row, left_col) = sheet.get_row_col(parent1);\n                    let (right_row, right_col) = sheet.get_row_col(parent2);\n                    let left_name = sheet.get_cell_name(left_row, left_col);\n                    let right_name = sheet.get_cell_name(right_row, right_col);\n                    (left_name, right_name)\n            };\n            match msb {\n                1 =\u003e format!(\"{} + {}\", left, right),\n                2 =\u003e format!(\"{} - {}\", left, right),\n                3 =\u003e format!(\"{} / {}\", left, right),\n                _ =\u003e format!(\"{} * {}\", left, right),\n            }\n        }\n        2 =\u003e {\n            let (left, right) = {\n                let (left_row, left_col) = sheet.get_row_col(parent1);\n                let left_name = sheet.get_cell_name(left_row, left_col);\n                (left_name, parent2.to_string())\n            };\n            match msb {\n                1 =\u003e format!(\"{} + {}\", left, right),\n                2 =\u003e format!(\"{} - {}\", left, right),\n                4 =\u003e format!(\"{} * {}\", left, right),\n                3 =\u003e format!(\"{} / {}\", left, right),\n                8 =\u003e format!(\"{}\", left),\n                _ =\u003e format!(\"SLEEP({})\", left),\n            }\n        }\n        3 =\u003e {\n            let (left, right) = {\n                let (right_row, right_col) = sheet.get_row_col(parent2);\n                let right_name = sheet.get_cell_name(right_row, right_col);\n                (parent1.to_string(), right_name)\n            };\n            match msb {\n                1 =\u003e format!(\"{} + {}\", left, right),\n                2 =\u003e format!(\"{} - {}\", left, right),\n                3 =\u003e format!(\"{} / {}\", left, right),\n                _ =\u003e format!(\"{} * {}\", left, right),\n            }\n        }\n        5 =\u003e {\n            let (start_row, start_col) = sheet.get_row_col(parent1);\n            let (end_row, end_col) = sheet.get_row_col(parent2);\n            let start_name = sheet.get_cell_name(start_row, start_col);\n            let end_name = sheet.get_cell_name(end_row, end_col);\n            format!(\"SUM({}:{})\", start_name, end_name)\n        }\n        6 =\u003e {\n            let (start_row, start_col) = sheet.get_row_col(parent1);\n            let (end_row, end_col) = sheet.get_row_col(parent2);\n            let start_name = sheet.get_cell_name(start_row, start_col);\n            let end_name = sheet.get_cell_name(end_row, end_col);\n            format!(\"AVG({}:{})\", start_name, end_name)\n        }\n        7 =\u003e {\n            let (start_row, start_col) = sheet.get_row_col(parent1);\n            let (end_row, end_col) = sheet.get_row_col(parent2);\n            let start_name = sheet.get_cell_name(start_row, start_col);\n            let end_name = sheet.get_cell_name(end_row, end_col);\n            format!(\"MIN({}:{})\", start_name, end_name)\n        }\n        8 =\u003e {\n            let (start_row, start_col) = sheet.get_row_col(parent1);\n            let (end_row, end_col) = sheet.get_row_col(parent2);\n            let start_name = sheet.get_cell_name(start_row, start_col);\n            let end_name = sheet.get_cell_name(end_row, end_col);\n            format!(\"MAX({}:{})\", start_name, end_name)\n        }\n        9 =\u003e {\n            let (start_row, start_col) = sheet.get_row_col(parent1);\n            let (end_row, end_col) = sheet.get_row_col(parent2);\n            let start_name = sheet.get_cell_name(start_row, start_col);\n            let end_name = sheet.get_cell_name(end_row, end_col);\n            format!(\"STDEV({}:{})\", start_name, end_name)\n        }\n        _ =\u003e \"Unknown formula\".to_string()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::spreadsheet::Spreadsheet;\n\n    #[test]\n    fn test_get_formula_string_basic_operations() {\n        let mut sheet = Spreadsheet::create(10, 10).unwrap();\n        \n        // Test subtraction (A1 - B2)\n        let a1_pos = sheet.get_key(0, 0);\n        let b2_pos = sheet.get_key(1, 1);\n        let meta = sheet.get_cell_meta(0, 1);\n        meta.formula = 20; // 2 (subtraction) * 10 + 0 (both are cell refs)\n        meta.parent1 = a1_pos;\n        meta.parent2 = b2_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 0, 1), \"A1 - B2\");\n\n        // Test multiplication (A1 * 5)\n        let meta = sheet.get_cell_meta(0, 2);\n        meta.formula = 43; // 4 (multiplication) * 10 + 3 (first is cell, second is literal)\n        meta.parent1 = 5;\n        meta.parent2 = a1_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 0, 2), \"5 * A1\");\n\n        // Test division (10 / B2)\n        let meta = sheet.get_cell_meta(0, 3);\n        meta.formula = 32; // 3 (division) * 10 + 2 (first is literal, second is cell)\n        meta.parent1 = b2_pos;\n        meta.parent2 = 10;\n        assert_eq!(get_formula_string(\u0026sheet, 0, 3), \"B2 / 10\");\n    }\n\n    #[test]\n    fn test_get_formula_string_functions() {\n        let mut sheet = Spreadsheet::create(10, 10).unwrap();\n        \n        let a1_pos = sheet.get_key(0, 0);\n        let c3_pos = sheet.get_key(2, 2);\n        \n        // Test SUM function\n        let meta = sheet.get_cell_meta(1, 1);\n        meta.formula = 5; // Range function with code 5 for SUM\n        meta.parent1 = a1_pos;\n        meta.parent2 = c3_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 1, 1), \"SUM(A1:C3)\");\n        \n        // Test AVG function\n        let meta = sheet.get_cell_meta(1, 2);\n        meta.formula = 6; // Range function with code 6 for AVG\n        meta.parent1 = a1_pos;\n        meta.parent2 = c3_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 1, 2), \"AVG(A1:C3)\");\n        \n        // Test MIN function\n        let meta = sheet.get_cell_meta(1, 3);\n        meta.formula = 7; // Range function with code 7 for MIN\n        meta.parent1 = a1_pos;\n        meta.parent2 = c3_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 1, 3), \"MIN(A1:C3)\");\n        \n        // Test MAX function\n        let meta = sheet.get_cell_meta(1, 4);\n        meta.formula = 8; // Range function with code 8 for MAX\n        meta.parent1 = a1_pos;\n        meta.parent2 = c3_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 1, 4), \"MAX(A1:C3)\");\n        \n        // Test STDEV function\n        let meta = sheet.get_cell_meta(1, 5);\n        meta.formula = 9; // Range function with code 9 for STDEV\n        meta.parent1 = a1_pos;\n        meta.parent2 = c3_pos;\n        assert_eq!(get_formula_string(\u0026sheet, 1, 5), \"STDEV(A1:C3)\");\n    }\n\n    #[test]\n    fn test_get_formula_string_special_cases() {\n        let mut sheet = Spreadsheet::create(10, 10).unwrap();\n        \n        let a1_pos = sheet.get_key(0, 0);\n        \n        // Test cell reference\n        let meta = sheet.get_cell_meta(2, 0);\n        meta.formula = 82; // Special formula for cell reference\n        meta.parent1 = a1_pos;\n        meta.parent2 = -1;\n        assert_eq!(get_formula_string(\u0026sheet, 2, 0), \"A1\");\n        \n        // Test SLEEP function\n        let meta = sheet.get_cell_meta(2, 1);\n        meta.formula = 102; // Special formula for SLEEP\n        meta.parent1 = a1_pos;\n        meta.parent2 = -1;\n        assert_eq!(get_formula_string(\u0026sheet, 2, 1), \"SLEEP(A1)\");\n        \n        // Test direct SLEEP function with code 102\n        let meta = sheet.get_cell_meta(2, 2);\n        meta.formula = 102;\n        meta.parent1 = a1_pos;\n        meta.parent2 = -1;\n        assert_eq!(get_formula_string(\u0026sheet, 2, 2), \"SLEEP(A1)\");\n    }\n\n    #[test]\n    fn test_get_formula_string_invalid_cases() {\n        let mut sheet = Spreadsheet::create(10, 10).unwrap();\n        \n        // Test no formula\n        let meta = sheet.get_cell_meta(3, 0);\n        meta.formula = -1;\n        meta.parent1 = -1;\n        meta.parent2 = -1;\n        assert_eq!(get_formula_string(\u0026sheet, 3, 0), \"No formula\");\n    }\n}","traces":[{"line":3,"address":[472400,474925],"length":1,"stats":{"Line":1}},{"line":4,"address":[472458],"length":1,"stats":{"Line":1}},{"line":5,"address":[472482],"length":1,"stats":{"Line":4}},{"line":6,"address":[472494],"length":1,"stats":{"Line":1}},{"line":8,"address":[472560,472611,472518],"length":1,"stats":{"Line":6}},{"line":9,"address":[472722,472587,472642],"length":1,"stats":{"Line":4}},{"line":10,"address":[472674],"length":1,"stats":{"Line":3}},{"line":11,"address":[472680],"length":1,"stats":{"Line":3}},{"line":13,"address":[472687],"length":1,"stats":{"Line":3}},{"line":15,"address":[474048],"length":1,"stats":{"Line":1}},{"line":16,"address":[472770],"length":1,"stats":{"Line":1}},{"line":17,"address":[472810],"length":1,"stats":{"Line":1}},{"line":18,"address":[472863],"length":1,"stats":{"Line":1}},{"line":19,"address":[472897],"length":1,"stats":{"Line":1}},{"line":20,"address":[473946],"length":1,"stats":{"Line":1}},{"line":22,"address":[474116],"length":1,"stats":{"Line":1}},{"line":23,"address":[474307,474192],"length":1,"stats":{"Line":0}},{"line":24,"address":[474463,474215],"length":1,"stats":{"Line":2}},{"line":25,"address":[474604,474241],"length":1,"stats":{"Line":0}},{"line":26,"address":[474745,474166],"length":1,"stats":{"Line":0}},{"line":30,"address":[475057],"length":1,"stats":{"Line":1}},{"line":31,"address":[472926],"length":1,"stats":{"Line":1}},{"line":32,"address":[472962],"length":1,"stats":{"Line":1}},{"line":33,"address":[474955,472981],"length":1,"stats":{"Line":1}},{"line":35,"address":[475125],"length":1,"stats":{"Line":1}},{"line":36,"address":[475377,475207],"length":1,"stats":{"Line":0}},{"line":37,"address":[475233,475533],"length":1,"stats":{"Line":0}},{"line":38,"address":[475259,475674],"length":1,"stats":{"Line":0}},{"line":39,"address":[475285,475815],"length":1,"stats":{"Line":2}},{"line":40,"address":[475311,475940],"length":1,"stats":{"Line":2}},{"line":41,"address":[476036,475181],"length":1,"stats":{"Line":2}},{"line":45,"address":[476341],"length":1,"stats":{"Line":1}},{"line":46,"address":[473043],"length":1,"stats":{"Line":1}},{"line":47,"address":[473079],"length":1,"stats":{"Line":1}},{"line":48,"address":[473111,476239],"length":1,"stats":{"Line":2}},{"line":50,"address":[476409],"length":1,"stats":{"Line":1}},{"line":51,"address":[476485,476600],"length":1,"stats":{"Line":0}},{"line":52,"address":[476508,476756],"length":1,"stats":{"Line":0}},{"line":53,"address":[476897,476534],"length":1,"stats":{"Line":0}},{"line":54,"address":[476459,477038],"length":1,"stats":{"Line":2}},{"line":58,"address":[473126],"length":1,"stats":{"Line":1}},{"line":59,"address":[473166],"length":1,"stats":{"Line":1}},{"line":60,"address":[473219],"length":1,"stats":{"Line":1}},{"line":61,"address":[473253],"length":1,"stats":{"Line":1}},{"line":62,"address":[477277,477337],"length":1,"stats":{"Line":2}},{"line":65,"address":[473282],"length":1,"stats":{"Line":1}},{"line":66,"address":[473322],"length":1,"stats":{"Line":1}},{"line":67,"address":[473375],"length":1,"stats":{"Line":1}},{"line":68,"address":[473409],"length":1,"stats":{"Line":1}},{"line":69,"address":[477542,477602],"length":1,"stats":{"Line":2}},{"line":72,"address":[473438],"length":1,"stats":{"Line":1}},{"line":73,"address":[473478],"length":1,"stats":{"Line":1}},{"line":74,"address":[473531],"length":1,"stats":{"Line":1}},{"line":75,"address":[473565],"length":1,"stats":{"Line":1}},{"line":76,"address":[477867,477807],"length":1,"stats":{"Line":2}},{"line":79,"address":[473594],"length":1,"stats":{"Line":1}},{"line":80,"address":[473634],"length":1,"stats":{"Line":1}},{"line":81,"address":[473687],"length":1,"stats":{"Line":1}},{"line":82,"address":[473721],"length":1,"stats":{"Line":1}},{"line":83,"address":[478132,478072],"length":1,"stats":{"Line":2}},{"line":86,"address":[473750],"length":1,"stats":{"Line":1}},{"line":87,"address":[473790],"length":1,"stats":{"Line":1}},{"line":88,"address":[473843],"length":1,"stats":{"Line":1}},{"line":89,"address":[473877],"length":1,"stats":{"Line":1}},{"line":90,"address":[478397,478337],"length":1,"stats":{"Line":2}},{"line":92,"address":[472743],"length":1,"stats":{"Line":0}}],"covered":56,"coverable":66},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","formula.rs"],"content":"use crate::cell::{CellValue, parse_cell_reference};\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n#[derive(Debug, PartialEq, Clone)]\r\npub struct Range {\r\n    pub start_row: i16,\r\n    pub start_col: i16,\r\n    pub end_row: i16,\r\n    pub end_col: i16,\r\n}\r\n\r\n// Optimize the sum_value function for large ranges\r\npub fn sum_value(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let mut sum = 0;\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    // For smaller ranges, use the original approach\r\n    for i in start_row..=end_row {\r\n        for j in start_col..=end_col {\r\n            let ref_cell_value = sheet.get_cell(i, j);\r\n            if let CellValue::Integer(value) = ref_cell_value {\r\n                sum += value;\r\n            } else {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Now set the result\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(sum);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Add variance evaluation function\r\npub fn eval_variance(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    let count = ((end_row - start_row + 1) as i32) * ((end_col - start_col + 1) as i32);\r\n    sum_value(sheet, row, col, parent1, parent2);\r\n    // Check if sum_value was successful\r\n    let cell_value = sheet.get_mut_cell(row, col);\r\n    let mean_value;\r\n    if let CellValue::Integer(value) = cell_value {\r\n        let val = *value / count;\r\n        *cell_value = CellValue::Integer(val);\r\n        mean_value = val as f64;\r\n    } else {\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    let mut variance = 0.0;\r\n\r\n    for i in start_row..=end_row {\r\n        for j in start_col..=end_col {\r\n            if let CellValue::Integer(value) = *sheet.get_cell(i, j) {\r\n                variance += ((value as f64) - (mean_value)).powi(2);\r\n            }\r\n        }\r\n    }\r\n\r\n    variance /= count as f64;\r\n    let std_dev = (variance.sqrt() + 0.5) as i32;\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(std_dev);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn eval_min(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let mut min_value = i32::MAX;\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    // First collect all values (immutable borrows)\r\n    for r in start_row..=end_row {\r\n        for c in start_col..=end_col {\r\n            if let CellValue::Integer(value) = sheet.get_cell(r, c) {\r\n                min_value = std::cmp::min(min_value, *value);\r\n            } else {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Now get the mutable cell and set its value (mutable borrow)\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(min_value);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Fix eval_max implementation\r\npub fn eval_max(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let mut max_value = i32::MIN;\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    // First collect all values (immutable borrows)\r\n    for r in start_row..=end_row {\r\n        for c in start_col..=end_col {\r\n            if let CellValue::Integer(value) = sheet.get_cell(r, c) {\r\n                max_value = std::cmp::max(max_value, *value);\r\n            } else {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Now get the mutable cell and set its value (mutable borrow)\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(max_value);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn eval_avg(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    let count = ((end_row - start_row + 1) as i32) * ((end_col - start_col + 1) as i32);\r\n    match sum_value(sheet, row, col, parent1, parent2) {\r\n        CommandStatus::CmdOk =\u003e {\r\n            let cell_value = sheet.get_mut_cell(row, col);\r\n            if let CellValue::Integer(value) = cell_value {\r\n                *cell_value = CellValue::Integer(*value / count);\r\n            }\r\n        }\r\n        _ =\u003e return CommandStatus::CmdOk,\r\n    }\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Keep the Range struct and parse_range function\r\npub fn parse_range(spreadsheet: \u0026Spreadsheet, range_str: \u0026str) -\u003e Result\u003cRange, CommandStatus\u003e {\r\n    // Check for minimum valid range pattern length (like \"A1:A1\")\r\n    if range_str.len() \u003c 3 {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Find the colon index using bytes to avoid UTF-8 decoding\r\n    let bytes = range_str.as_bytes();\r\n    let mut colon_index = 0;\r\n\r\n    for (i, \u0026b) in bytes.iter().enumerate() {\r\n        if b == b':' {\r\n            colon_index = i;\r\n            break;\r\n        }\r\n    }\r\n\r\n    // Validate colon position (must exist and have chars on both sides)\r\n    if colon_index == 0 || colon_index + 1 \u003e= range_str.len() {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Avoid creating new strings by using slices\r\n    let start_cell = \u0026range_str[..colon_index];\r\n    let end_cell = \u0026range_str[colon_index + 1..];\r\n\r\n    // Parse cell references and validate them in one step\r\n    let (start_row, start_col) = parse_cell_reference(spreadsheet, start_cell)?;\r\n    let (end_row, end_col) = parse_cell_reference(spreadsheet, end_cell)?;\r\n\r\n    // Ensure coordinates are valid and range is properly ordered\r\n    if start_row \u003c 0\r\n        || start_col \u003c 0\r\n        || end_row \u003c 0\r\n        || end_col \u003c 0\r\n        || start_row \u003e end_row\r\n        || start_col \u003e end_col\r\n    {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Construct the Range directly\r\n    Ok(Range {\r\n        start_row,\r\n        start_col,\r\n        end_row,\r\n        end_col,\r\n    })\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_sum_value() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            sum_value(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_sum_value_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Error;\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            sum_value(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_variance() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(2);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(4);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_variance(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(1));\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_variance_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Error;\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(4);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_variance(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_min() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(3);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_min(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(1));\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_max() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(3);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_max(\u0026mut sheet, 1, 2, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 2), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_min_max_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Error;\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_min(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n        assert_eq!(\r\n            eval_max(\u0026mut sheet, 1, 2, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 2), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_avg() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(2);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(4);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_avg(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_range_valid() {\r\n        let sheet = create_test_spreadsheet(5, 5);\r\n        let range = parse_range(\u0026sheet, \"A1:B2\").unwrap();\r\n        assert_eq!(range.start_row, 0);\r\n        assert_eq!(range.start_col, 0);\r\n        assert_eq!(range.end_row, 1);\r\n        assert_eq!(range.end_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_range_invalid() {\r\n        let sheet = create_test_spreadsheet(5, 5);\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \"A\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \"A1:\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \":A1\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \"B2:A1\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n    }\r\n}\r\n","traces":[{"line":13,"address":[304960],"length":1,"stats":{"Line":1}},{"line":20,"address":[305036],"length":1,"stats":{"Line":1}},{"line":21,"address":[305044],"length":1,"stats":{"Line":1}},{"line":22,"address":[305087],"length":1,"stats":{"Line":1}},{"line":24,"address":[305398,305121],"length":1,"stats":{"Line":2}},{"line":25,"address":[305601,305416],"length":1,"stats":{"Line":2}},{"line":26,"address":[305659],"length":1,"stats":{"Line":1}},{"line":27,"address":[305683],"length":1,"stats":{"Line":1}},{"line":28,"address":[305708],"length":1,"stats":{"Line":1}},{"line":30,"address":[305742],"length":1,"stats":{"Line":1}},{"line":31,"address":[305774],"length":1,"stats":{"Line":1}},{"line":37,"address":[305338],"length":1,"stats":{"Line":1}},{"line":38,"address":[305378],"length":1,"stats":{"Line":1}},{"line":42,"address":[305792],"length":1,"stats":{"Line":2}},{"line":49,"address":[305871],"length":1,"stats":{"Line":2}},{"line":50,"address":[305911],"length":1,"stats":{"Line":1}},{"line":51,"address":[306230,305947],"length":1,"stats":{"Line":1}},{"line":52,"address":[306170],"length":1,"stats":{"Line":1}},{"line":54,"address":[306196],"length":1,"stats":{"Line":1}},{"line":56,"address":[306220,306255],"length":1,"stats":{"Line":2}},{"line":57,"address":[306302,306270,306614],"length":1,"stats":{"Line":2}},{"line":58,"address":[306380],"length":1,"stats":{"Line":1}},{"line":59,"address":[306407],"length":1,"stats":{"Line":1}},{"line":61,"address":[306284],"length":1,"stats":{"Line":1}},{"line":64,"address":[306426],"length":1,"stats":{"Line":1}},{"line":66,"address":[306851,306630,306435],"length":1,"stats":{"Line":3}},{"line":67,"address":[307087,306872],"length":1,"stats":{"Line":2}},{"line":68,"address":[307235,307160],"length":1,"stats":{"Line":2}},{"line":69,"address":[307205],"length":1,"stats":{"Line":1}},{"line":74,"address":[306681],"length":1,"stats":{"Line":1}},{"line":75,"address":[306701],"length":1,"stats":{"Line":1}},{"line":76,"address":[306783],"length":1,"stats":{"Line":1}},{"line":77,"address":[306831],"length":1,"stats":{"Line":1}},{"line":80,"address":[307248],"length":1,"stats":{"Line":2}},{"line":87,"address":[307318],"length":1,"stats":{"Line":2}},{"line":88,"address":[307326],"length":1,"stats":{"Line":1}},{"line":89,"address":[307369],"length":1,"stats":{"Line":1}},{"line":91,"address":[307403,307680],"length":1,"stats":{"Line":2}},{"line":92,"address":[307999,307883,307698],"length":1,"stats":{"Line":3}},{"line":93,"address":[307941],"length":1,"stats":{"Line":1}},{"line":94,"address":[307983],"length":1,"stats":{"Line":1}},{"line":96,"address":[308016],"length":1,"stats":{"Line":1}},{"line":97,"address":[308048],"length":1,"stats":{"Line":1}},{"line":103,"address":[307620],"length":1,"stats":{"Line":1}},{"line":104,"address":[307660],"length":1,"stats":{"Line":1}},{"line":108,"address":[308064],"length":1,"stats":{"Line":1}},{"line":115,"address":[308134],"length":1,"stats":{"Line":1}},{"line":116,"address":[308142],"length":1,"stats":{"Line":1}},{"line":117,"address":[308185],"length":1,"stats":{"Line":1}},{"line":119,"address":[308219,308496],"length":1,"stats":{"Line":2}},{"line":120,"address":[308514,308815,308699],"length":1,"stats":{"Line":3}},{"line":121,"address":[308757],"length":1,"stats":{"Line":1}},{"line":122,"address":[308799],"length":1,"stats":{"Line":1}},{"line":124,"address":[308832],"length":1,"stats":{"Line":1}},{"line":125,"address":[308864],"length":1,"stats":{"Line":1}},{"line":131,"address":[308436],"length":1,"stats":{"Line":1}},{"line":132,"address":[308476],"length":1,"stats":{"Line":1}},{"line":135,"address":[308880],"length":1,"stats":{"Line":1}},{"line":142,"address":[308941],"length":1,"stats":{"Line":1}},{"line":143,"address":[308975],"length":1,"stats":{"Line":1}},{"line":144,"address":[309000,309248],"length":1,"stats":{"Line":1}},{"line":145,"address":[309220],"length":1,"stats":{"Line":1}},{"line":147,"address":[309279],"length":1,"stats":{"Line":1}},{"line":148,"address":[309329,309300,309452],"length":1,"stats":{"Line":3}},{"line":149,"address":[309454,309370,309341],"length":1,"stats":{"Line":2}},{"line":152,"address":[309310],"length":1,"stats":{"Line":0}},{"line":154,"address":[309355],"length":1,"stats":{"Line":1}},{"line":158,"address":[309488],"length":1,"stats":{"Line":3}},{"line":160,"address":[309560],"length":1,"stats":{"Line":3}},{"line":161,"address":[309712],"length":1,"stats":{"Line":1}},{"line":165,"address":[309585],"length":1,"stats":{"Line":2}},{"line":166,"address":[309612],"length":1,"stats":{"Line":2}},{"line":168,"address":[309800,309621,309732],"length":1,"stats":{"Line":6}},{"line":169,"address":[309838],"length":1,"stats":{"Line":2}},{"line":170,"address":[309847],"length":1,"stats":{"Line":2}},{"line":176,"address":[309790,309885],"length":1,"stats":{"Line":4}},{"line":177,"address":[309859],"length":1,"stats":{"Line":1}},{"line":181,"address":[309960],"length":1,"stats":{"Line":2}},{"line":182,"address":[310003,310294],"length":1,"stats":{"Line":2}},{"line":185,"address":[310325,310573,310106],"length":1,"stats":{"Line":4}},{"line":186,"address":[310682,310612,310383],"length":1,"stats":{"Line":4}},{"line":189,"address":[310669],"length":1,"stats":{"Line":2}},{"line":190,"address":[310721],"length":1,"stats":{"Line":2}},{"line":191,"address":[310759],"length":1,"stats":{"Line":2}},{"line":192,"address":[310770],"length":1,"stats":{"Line":2}},{"line":193,"address":[310785],"length":1,"stats":{"Line":2}},{"line":194,"address":[310800],"length":1,"stats":{"Line":2}},{"line":196,"address":[310732],"length":1,"stats":{"Line":1}},{"line":200,"address":[310829],"length":1,"stats":{"Line":2}}],"covered":88,"coverable":89},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","graph.rs"],"content":"use crate::spreadsheet::Spreadsheet;\r\n\r\npub fn add_children(\r\n    sheet: \u0026mut Spreadsheet,\r\n    cell1: i32,\r\n    cell2: i32,\r\n    formula: i16,\r\n    row: i16,\r\n    col: i16,\r\n) {\r\n    if formula == -1 {\r\n        return;\r\n    }\r\n    let rem = formula % 10;\r\n    let child_key = sheet.get_key(row, col);\r\n    if rem == 0 {\r\n        sheet.add_child(\u0026cell1, \u0026child_key);\r\n        sheet.add_child(\u0026cell2, \u0026child_key);\r\n    } else if rem == 2 {\r\n        sheet.add_child(\u0026cell1, \u0026child_key);\r\n    } else if rem == 3 {\r\n        sheet.add_child(\u0026cell2, \u0026child_key);\r\n    } else {\r\n        // For range operations, use the optimized range_children structure\r\n        sheet.add_range_child(cell1, cell2, child_key);\r\n    }\r\n}\r\n\r\npub fn remove_all_parents(sheet: \u0026mut Spreadsheet, row: i16, col: i16) {\r\n    // This removes the child row, col from its parent cells\r\n    let child_key = sheet.get_key(row, col);\r\n\r\n    let meta = match sheet.cell_meta.get(\u0026child_key) {\r\n        Some(meta) =\u003e meta,\r\n        None =\u003e return, // No metadata, no parents to remove\r\n    };\r\n\r\n    if meta.formula == -1 {\r\n        return;\r\n    }\r\n\r\n    let rem: i16 = (meta.formula % 10) as i16;\r\n\r\n    if rem \u003e= 5 \u0026\u0026 rem \u003c= 9 {\r\n        // Use the optimized range_children removal for range operations\r\n        sheet.remove_range_child(child_key);\r\n    } else if rem == 0 {\r\n        let parent1 = meta.parent1;\r\n        let parent2 = meta.parent2;\r\n        sheet.remove_child(parent1, child_key);\r\n        sheet.remove_child(parent2, child_key);\r\n    } else if rem == 2 {\r\n        sheet.remove_child(meta.parent1, child_key);\r\n    } else if rem == 3 {\r\n        sheet.remove_child(meta.parent2, child_key);\r\n    }\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::spreadsheet::Spreadsheet;\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_children_both_parents() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        let child = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, parent2, 0, 1, 1); // Formula type 0\r\n        assert!(sheet.get_cell_children(parent1).unwrap().contains(\u0026child));\r\n        assert!(sheet.get_cell_children(parent2).unwrap().contains(\u0026child));\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_children_single_parent() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let child = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, -1, 2, 1, 1); // Formula type 2\r\n        assert!(sheet.get_cell_children(parent1).unwrap().contains(\u0026child));\r\n        assert!(sheet.get_cell_children(-1).is_none());\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_children_range() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, parent2, 5, 2, 2); // Formula type 5 (SUM)\r\n    }\r\n\r\n    #[test]\r\n    fn test_remove_all_parents_no_meta() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        remove_all_parents(\u0026mut sheet, 1, 1);\r\n        assert!(!sheet.cell_meta.contains_key(\u0026sheet.get_key(1, 1)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_remove_all_parents_single_parent() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let child = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, -1, 2, 1, 1);\r\n        let meta = sheet.get_cell_meta(1, 1);\r\n        meta.parent1 = parent1;\r\n        meta.formula = 2;\r\n        remove_all_parents(\u0026mut sheet, 1, 1);\r\n        let children = sheet.get_cell_children(parent1);\r\n        assert!(children.is_none() || !children.unwrap().contains(\u0026child));\r\n    }\r\n\r\n    #[test]\r\n    fn test_remove_all_parents_range() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, parent2, 5, 2, 2); // adds range child\r\n        let meta = sheet.get_cell_meta(2, 2);\r\n        meta.parent1 = parent1;\r\n        meta.parent2 = parent2;\r\n        meta.formula = 5;\r\n        remove_all_parents(\u0026mut sheet, 2, 2);\r\n    }\r\n}\r\n","traces":[{"line":3,"address":[378896],"length":1,"stats":{"Line":1}},{"line":11,"address":[378977],"length":1,"stats":{"Line":1}},{"line":14,"address":[378993,379073],"length":1,"stats":{"Line":1}},{"line":15,"address":[379045],"length":1,"stats":{"Line":1}},{"line":16,"address":[379065],"length":1,"stats":{"Line":1}},{"line":17,"address":[379094],"length":1,"stats":{"Line":1}},{"line":18,"address":[379114],"length":1,"stats":{"Line":1}},{"line":19,"address":[379139],"length":1,"stats":{"Line":1}},{"line":20,"address":[379150],"length":1,"stats":{"Line":1}},{"line":21,"address":[379175],"length":1,"stats":{"Line":2}},{"line":22,"address":[379186],"length":1,"stats":{"Line":0}},{"line":25,"address":[379211],"length":1,"stats":{"Line":2}},{"line":29,"address":[379248],"length":1,"stats":{"Line":1}},{"line":31,"address":[379278],"length":1,"stats":{"Line":1}},{"line":33,"address":[379298],"length":1,"stats":{"Line":1}},{"line":34,"address":[379348],"length":1,"stats":{"Line":1}},{"line":38,"address":[379363],"length":1,"stats":{"Line":1}},{"line":42,"address":[379429,379375],"length":1,"stats":{"Line":1}},{"line":44,"address":[379463,379421],"length":1,"stats":{"Line":2}},{"line":46,"address":[379474],"length":1,"stats":{"Line":1}},{"line":47,"address":[379450],"length":1,"stats":{"Line":1}},{"line":48,"address":[379498],"length":1,"stats":{"Line":0}},{"line":49,"address":[379504],"length":1,"stats":{"Line":0}},{"line":50,"address":[379515],"length":1,"stats":{"Line":0}},{"line":51,"address":[379533],"length":1,"stats":{"Line":0}},{"line":52,"address":[379552],"length":1,"stats":{"Line":1}},{"line":53,"address":[379568],"length":1,"stats":{"Line":1}},{"line":54,"address":[379589],"length":1,"stats":{"Line":0}},{"line":55,"address":[379609],"length":1,"stats":{"Line":0}}],"covered":22,"coverable":29},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","main.rs"],"content":"mod cell;\r\nmod evaluator;\r\nmod formula;\r\nmod graph;\r\nmod reevaluate_topo;\r\nmod spreadsheet;\r\nmod vim_mode;\r\nmod visualize_cells;\r\nmod extensions;\r\nuse std::env;\r\nuse std::io::{self, Write};\r\nuse std::process;\r\nuse std::thread::sleep;\r\nuse std::time::{Duration, Instant};\r\nuse evaluator::handle_command;\r\nuse spreadsheet::CommandStatus;\r\nuse spreadsheet::Spreadsheet;\r\nconst DEFAULT_FILENAME: \u0026str = \"untitled.sheet\";\r\n\r\nfn main() {\r\n    let args: Vec\u003cString\u003e = env::args().collect();\r\n    let mut vim_mode_enabled = false;\r\n    let mut rows_arg_index = 1;\r\n    let mut cols_arg_index = 2;\r\n\r\n    if args.len() \u003e 1 \u0026\u0026 args[1] == \"--vim\" {\r\n        vim_mode_enabled = true;\r\n        rows_arg_index = 2;\r\n        cols_arg_index = 3;\r\n    }\r\n\r\n    // else if args.len() != 3 {\r\n    //     eprintln!(\"Usage: {} \u003crows\u003e \u003ccolumns\u003e\", args[0]);\r\n    //     process::exit(1);\r\n    // }\r\n\r\n    let rows: i16 = args[rows_arg_index].parse().unwrap_or_else(|_| {\r\n        eprintln!(\"Invalid number for rows\");\r\n        process::exit(1);\r\n    });\r\n\r\n    let cols: i16 = args[cols_arg_index].parse().unwrap_or_else(|_| {\r\n        eprintln!(\"Invalid number for columns\");\r\n        process::exit(1);\r\n    });\r\n\r\n    let mut sleep_time = 0.0; // Initialize sleep time\r\n    let start = Instant::now();\r\n\r\n    let mut sheet = match Spreadsheet::create(rows, cols) {\r\n        Some(s) =\u003e s,\r\n        None =\u003e {\r\n            eprintln!(\r\n                \"Failed to create spreadsheet with dimensions {}x{}\",\r\n                rows, cols\r\n            );\r\n            eprintln!(\"Please try smaller dimensions.\");\r\n            process::exit(1);\r\n        }\r\n    };\r\n    if vim_mode_enabled {\r\n        let filename = Some(DEFAULT_FILENAME.to_string());\r\n        vim_mode::run_editor(\u0026mut sheet, filename);\r\n    } else {\r\n        let mut command_time = start.elapsed().as_secs_f64();\r\n        let mut last_time = command_time; // Update last_time with the command time\r\n\r\n        let mut last_status = \"ok\"; // Placeholder for last status\r\n        let mut input = String::with_capacity(128);\r\n\r\n        // Main loop for command input\r\n        loop {\r\n            sheet.print_spreadsheet();\r\n            print!(\"[{:.1}] ({}) \u003e \", last_time, last_status);\r\n            io::stdout().flush().unwrap(); // Ensure the prompt is shown\r\n\r\n            input.clear();\r\n            if io::stdin().read_line(\u0026mut input).unwrap() == 0 {\r\n                break; // End of input\r\n            }\r\n\r\n            let trimmed = input.trim(); // Remove any newline characters\r\n            if trimmed == \"q\" {\r\n                break;\r\n            }\r\n\r\n            // Process the command and measure execution time\r\n            let start = Instant::now();\r\n            // Pass by reference instead of cloning\r\n            let status = handle_command(\u0026mut sheet, trimmed, \u0026mut sleep_time);\r\n            command_time = start.elapsed().as_secs_f64();\r\n\r\n            if sleep_time \u003c= command_time {\r\n                sleep_time = 0.0;\r\n            } else {\r\n                sleep_time -= command_time;\r\n            }\r\n            last_time = command_time + sleep_time;\r\n            if sleep_time \u003e 0.0 {\r\n                sleep(Duration::from_secs_f64(sleep_time));\r\n            }\r\n            sleep_time = 0.0;\r\n\r\n            // Update last_status based on the current command status\r\n            last_status = match status {\r\n                CommandStatus::CmdOk =\u003e \"ok\",\r\n                CommandStatus::CmdUnrecognized =\u003e \"unrecognized_cmd\",\r\n                CommandStatus::CmdCircularRef =\u003e \"circular_ref\",\r\n                CommandStatus::CmdInvalidCell =\u003e \"invalid_cell\",\r\n                CommandStatus::CmdLockedCell =\u003e \"locked_cell\",\r\n            };\r\n        }\r\n    }\r\n}\r\n","traces":[{"line":20,"address":[256944,259740,259829],"length":1,"stats":{"Line":0}},{"line":21,"address":[256951],"length":1,"stats":{"Line":0}},{"line":22,"address":[257013],"length":1,"stats":{"Line":0}},{"line":23,"address":[257021],"length":1,"stats":{"Line":0}},{"line":24,"address":[257033],"length":1,"stats":{"Line":0}},{"line":26,"address":[257261,257152,257045,257108],"length":1,"stats":{"Line":0}},{"line":27,"address":[257229],"length":1,"stats":{"Line":0}},{"line":28,"address":[257237],"length":1,"stats":{"Line":0}},{"line":29,"address":[257249],"length":1,"stats":{"Line":0}},{"line":37,"address":[225136],"length":1,"stats":{"Line":0}},{"line":38,"address":[225147],"length":1,"stats":{"Line":0}},{"line":39,"address":[225187],"length":1,"stats":{"Line":0}},{"line":42,"address":[225216],"length":1,"stats":{"Line":0}},{"line":43,"address":[225227],"length":1,"stats":{"Line":0}},{"line":44,"address":[225267],"length":1,"stats":{"Line":0}},{"line":47,"address":[257600],"length":1,"stats":{"Line":0}},{"line":48,"address":[257612],"length":1,"stats":{"Line":0}},{"line":50,"address":[257668],"length":1,"stats":{"Line":0}},{"line":51,"address":[257757],"length":1,"stats":{"Line":0}},{"line":53,"address":[257844,257750],"length":1,"stats":{"Line":0}},{"line":57,"address":[257936],"length":1,"stats":{"Line":0}},{"line":58,"address":[257981],"length":1,"stats":{"Line":0}},{"line":61,"address":[257809],"length":1,"stats":{"Line":0}},{"line":62,"address":[258033,259749],"length":1,"stats":{"Line":0}},{"line":63,"address":[259799],"length":1,"stats":{"Line":0}},{"line":65,"address":[258118,257999],"length":1,"stats":{"Line":0}},{"line":66,"address":[258175],"length":1,"stats":{"Line":0}},{"line":68,"address":[258193],"length":1,"stats":{"Line":0}},{"line":69,"address":[258233],"length":1,"stats":{"Line":0}},{"line":72,"address":[259720],"length":1,"stats":{"Line":0}},{"line":73,"address":[258250],"length":1,"stats":{"Line":0}},{"line":74,"address":[258313],"length":1,"stats":{"Line":0}},{"line":75,"address":[258777],"length":1,"stats":{"Line":0}},{"line":77,"address":[258869],"length":1,"stats":{"Line":0}},{"line":78,"address":[258876],"length":1,"stats":{"Line":0}},{"line":82,"address":[259032],"length":1,"stats":{"Line":0}},{"line":83,"address":[259108],"length":1,"stats":{"Line":0}},{"line":88,"address":[259148],"length":1,"stats":{"Line":0}},{"line":90,"address":[259192],"length":1,"stats":{"Line":0}},{"line":91,"address":[259246],"length":1,"stats":{"Line":0}},{"line":93,"address":[259334,259389],"length":1,"stats":{"Line":0}},{"line":94,"address":[259391],"length":1,"stats":{"Line":0}},{"line":96,"address":[259358],"length":1,"stats":{"Line":0}},{"line":98,"address":[259404],"length":1,"stats":{"Line":0}},{"line":99,"address":[259431],"length":1,"stats":{"Line":0}},{"line":100,"address":[259496],"length":1,"stats":{"Line":0}},{"line":102,"address":[259450],"length":1,"stats":{"Line":0}},{"line":105,"address":[259462,259688],"length":1,"stats":{"Line":0}},{"line":106,"address":[259545],"length":1,"stats":{"Line":0}},{"line":107,"address":[259574],"length":1,"stats":{"Line":0}},{"line":108,"address":[259603],"length":1,"stats":{"Line":0}},{"line":109,"address":[259632],"length":1,"stats":{"Line":0}},{"line":110,"address":[259661],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":53},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","reevaluate_topo.rs"],"content":"use crate::cell::CellValue;\r\nuse crate::formula::{eval_avg, eval_max, eval_min, eval_variance, sum_value};\r\nuse crate::spreadsheet::Spreadsheet;\r\nuse std::collections::HashSet;\r\n\r\npub fn sleep_fn(sheet: \u0026mut Spreadsheet, row: i16, col: i16, value: i32, sleep_val: \u0026mut f64) {\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(value);\r\n    if value \u003c 0 {\r\n        return;\r\n    }\r\n    *sleep_val += value as f64;\r\n}\r\n\r\npub fn reevaluate_formula(sheet: \u0026mut Spreadsheet, row: i16, col: i16, sleep_val: \u0026mut f64) {\r\n    let cell_meta = sheet.get_cell_meta(row, col);\r\n    let rem = cell_meta.formula % 10;\r\n    let msb = cell_meta.formula / 10;\r\n    let parent1 = cell_meta.parent1;\r\n    let parent2 = cell_meta.parent2;\r\n\r\n    match rem {\r\n        0 =\u003e {\r\n            let par1 = sheet.get_key_cell(parent1);\r\n            let par2 = sheet.get_key_cell(parent2);\r\n            if CellValue::Error == *par1 || CellValue::Error == *par2 {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return;\r\n            }\r\n            if let CellValue::Integer(p1_value) = par1 {\r\n                if let CellValue::Integer(p2_value) = par2 {\r\n                    match msb {\r\n                        1 =\u003e {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value + p2_value);\r\n                        }\r\n                        2 =\u003e {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value - p2_value);\r\n                        }\r\n                        4 =\u003e {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value * p2_value);\r\n                        }\r\n                        _ =\u003e {\r\n                            if *p2_value == 0 {\r\n                                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                            } else {\r\n                                *sheet.get_mut_cell(row, col) =\r\n                                    CellValue::Integer(p1_value / p2_value);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        2 =\u003e {\r\n            let par1 = sheet.get_key_cell(parent1);\r\n            if CellValue::Error == *par1 {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return;\r\n            }\r\n            if let CellValue::Integer(p1_value) = par1 {\r\n                match msb {\r\n                    1 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value + parent2);\r\n                    }\r\n                    2 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value - parent2);\r\n                    }\r\n                    4 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value * parent2);\r\n                    }\r\n                    3 =\u003e {\r\n                        if parent2 == 0 {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                        } else {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value / parent2);\r\n                        }\r\n                    }\r\n                    8 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(*p1_value);\r\n                    }\r\n                    _ =\u003e {\r\n                        sleep_fn(sheet, row, col, *p1_value, sleep_val);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        3 =\u003e {\r\n            let par2 = sheet.get_key_cell(parent2);\r\n            if CellValue::Error == *par2 {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return;\r\n            }\r\n            if let CellValue::Integer(p2_value) = par2 {\r\n                match msb {\r\n                    1 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 + p2_value);\r\n                    }\r\n                    2 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 - p2_value);\r\n                    }\r\n                    4 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 * p2_value);\r\n                    }\r\n                    _ =\u003e {\r\n                        if *p2_value == 0 {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                        } else {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 / p2_value);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        5 =\u003e {\r\n            sum_value(sheet, row, col, parent1, parent2);\r\n        }\r\n        6 =\u003e {\r\n            eval_avg(sheet, row, col, parent1, parent2);\r\n        }\r\n        7 =\u003e {\r\n            eval_min(sheet, row, col, parent1, parent2);\r\n        }\r\n        8 =\u003e {\r\n            eval_max(sheet, row, col, parent1, parent2);\r\n        }\r\n        _ =\u003e {\r\n            eval_variance(sheet, row, col, parent1, parent2);\r\n        }\r\n    }\r\n}\r\n\r\n// rustdoc this function\r\n/// Performs a topological sort on the spreadsheet to reevaluate cells in the correct order.\r\n/// This function also detects cycles in the dependency graph. If a cycle is detected, it returns true.\r\n\r\npub fn toposort_reval_detect_cycle(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    sleep_val: \u0026mut f64,\r\n) -\u003e bool {\r\n    let cell_key = sheet.get_key(row, col);\r\n    // These collections will be used for the topological sort and cycle detection\r\n    let mut fully_visited: HashSet\u003ci32\u003e = HashSet::new();\r\n    let mut result: Vec\u003ci32\u003e = Vec::new();\r\n    let mut dfs_stack: Vec\u003c(i32, bool)\u003e = Vec::new();\r\n    let mut in_current_path: HashSet\u003ci32\u003e = HashSet::new();\r\n\r\n    // Helper to push all dependents (both direct and range-based) for a given cell key\r\n    fn push_dependents(\r\n        cell_key: i32,\r\n        sheet: \u0026Spreadsheet,\r\n        stack: \u0026mut Vec\u003c(i32, bool)\u003e,\r\n        fully_visited: \u0026HashSet\u003ci32\u003e,\r\n    ) {\r\n        // Direct children from standard dependencies\r\n        if let Some(children) = sheet.get_cell_children(cell_key) {\r\n            for child in children {\r\n                if !fully_visited.contains(child) {\r\n                    stack.push((*child, false));\r\n                }\r\n            }\r\n        }\r\n\r\n        for range_child in \u0026sheet.range_children {\r\n            if !fully_visited.contains(\u0026range_child.child_key)\r\n                \u0026\u0026 sheet.is_cell_in_range(cell_key, range_child.start_key, range_child.end_key)\r\n            {\r\n                stack.push((range_child.child_key, false));\r\n            }\r\n        }\r\n    }\r\n\r\n    // Start from all direct children and range-based children of the updated cell\r\n    push_dependents(cell_key, sheet, \u0026mut dfs_stack, \u0026fully_visited);\r\n\r\n    while let Some((current, expanded)) = dfs_stack.pop() {\r\n        if expanded {\r\n            // If we're processing a fully expanded node:\r\n            in_current_path.remove(\u0026current);\r\n            if !result.contains(\u0026current) {\r\n                result.push(current);\r\n            }\r\n            fully_visited.insert(current);\r\n        } else {\r\n            // If we haven't expanded this node yet:\r\n            if in_current_path.contains(\u0026current) {\r\n                // Cycle detected\r\n                // Debugging output\r\n                // println!(\"Cycle detected at cell: {}\", current);\r\n                // Uncomment the following line to see the cycle path\r\n                // println!(\"Cycle path: {:?}\", in_current_path);\r\n                return true;\r\n            }\r\n\r\n            // Add back the current node as expanded\r\n            dfs_stack.push((current, true));\r\n            in_current_path.insert(current);\r\n\r\n            // Process all its dependents (both direct and range-based)\r\n            push_dependents(current, sheet, \u0026mut dfs_stack, \u0026fully_visited);\r\n        }\r\n    }\r\n\r\n    // Reverse the result to get the correct topological order\r\n    result.reverse();\r\n\r\n    // Now reevaluate all cells in the topological order\r\n    for key in result {\r\n        if key \u003e= 0 {\r\n            let (row, col) = sheet.get_row_col(key);\r\n            reevaluate_formula(sheet, row, col, sleep_val);\r\n        }\r\n    }\r\n\r\n    false // No cycle detected\r\n}\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n    use crate::evaluator::set_cell_value;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_sleep_fn_positive() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        sleep_fn(\u0026mut sheet, 0, 0, 5, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(5));\r\n        assert_eq!(sleep_time, 5.0);\r\n    }\r\n\r\n    #[test]\r\n    fn test_sleep_fn_negative() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        sleep_fn(\u0026mut sheet, 0, 0, -5, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(-5));\r\n        assert_eq!(sleep_time, 0.0);\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_arithmetic() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(3);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        {\r\n            let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n            meta.formula = 10; // Addition\r\n        }\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(5));\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_arithmetic_div_zero() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(0);\r\n        let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n        meta.formula = 30; // Division\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Error;\r\n        let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n        meta.formula = 10; // Addition\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_sum() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n        meta.formula = 5; // SUM\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_cycle_prevention() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 1, 1, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 0, 0, \"B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n        assert!(!toposort_reval_detect_cycle(\r\n            \u0026mut sheet,\r\n            0,\r\n            0,\r\n            \u0026mut sleep_time\r\n        ));\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(1)); // A1 unchanged\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(1)); // B2 still references A1\r\n    }\r\n\r\n    #[test]\r\n    fn test_toposort_reval_no_cycle() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        let mut sleep_time = 0.0;\r\n        set_cell_value(\u0026mut sheet, 1, 1, \"A1\", \u0026mut sleep_time);\r\n        assert!(!toposort_reval_detect_cycle(\r\n            \u0026mut sheet,\r\n            1,\r\n            1,\r\n            \u0026mut sleep_time\r\n        ));\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_div_by_zero() {\r\n        let mut sheet: Spreadsheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(0);\r\n        let parent1_key = sheet.get_key(0, 0);\r\n        let parent2_key = sheet.get_key(0, 1);\r\n        let meta = sheet.get_cell_meta(1, 1);\r\n        meta.parent1 = parent1_key;\r\n        meta.parent2 = parent2_key;\r\n        meta.formula = 30; // Division\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n    \r\n}\r\n","traces":[{"line":6,"address":[199040],"length":1,"stats":{"Line":1}},{"line":7,"address":[199086],"length":1,"stats":{"Line":1}},{"line":8,"address":[199126],"length":1,"stats":{"Line":1}},{"line":11,"address":[199140],"length":1,"stats":{"Line":1}},{"line":14,"address":[199168],"length":1,"stats":{"Line":5}},{"line":15,"address":[199237],"length":1,"stats":{"Line":5}},{"line":16,"address":[199355,199264],"length":1,"stats":{"Line":5}},{"line":17,"address":[199389,199327,199483],"length":1,"stats":{"Line":10}},{"line":18,"address":[199421],"length":1,"stats":{"Line":5}},{"line":19,"address":[199434],"length":1,"stats":{"Line":5}},{"line":21,"address":[199448],"length":1,"stats":{"Line":5}},{"line":23,"address":[199548],"length":1,"stats":{"Line":4}},{"line":24,"address":[199575],"length":1,"stats":{"Line":4}},{"line":25,"address":[199898,199598],"length":1,"stats":{"Line":7}},{"line":26,"address":[199931],"length":1,"stats":{"Line":1}},{"line":29,"address":[199979],"length":1,"stats":{"Line":3}},{"line":30,"address":[200014,200040],"length":1,"stats":{"Line":6}},{"line":31,"address":[200057],"length":1,"stats":{"Line":3}},{"line":32,"address":[200205],"length":1,"stats":{"Line":1}},{"line":33,"address":[200128],"length":1,"stats":{"Line":1}},{"line":35,"address":[200297],"length":1,"stats":{"Line":0}},{"line":36,"address":[200220],"length":1,"stats":{"Line":0}},{"line":38,"address":[200389],"length":1,"stats":{"Line":0}},{"line":39,"address":[200312],"length":1,"stats":{"Line":0}},{"line":42,"address":[200450,200542,200104],"length":1,"stats":{"Line":4}},{"line":43,"address":[200409],"length":1,"stats":{"Line":2}},{"line":45,"address":[200512],"length":1,"stats":{"Line":0}},{"line":46,"address":[200465],"length":1,"stats":{"Line":0}},{"line":54,"address":[199632],"length":1,"stats":{"Line":1}},{"line":55,"address":[199653],"length":1,"stats":{"Line":1}},{"line":56,"address":[200580],"length":1,"stats":{"Line":0}},{"line":59,"address":[200552,200636],"length":1,"stats":{"Line":2}},{"line":60,"address":[200653],"length":1,"stats":{"Line":1}},{"line":61,"address":[200822],"length":1,"stats":{"Line":0}},{"line":62,"address":[200745],"length":1,"stats":{"Line":0}},{"line":64,"address":[200913],"length":1,"stats":{"Line":0}},{"line":65,"address":[200836],"length":1,"stats":{"Line":0}},{"line":67,"address":[201004],"length":1,"stats":{"Line":0}},{"line":68,"address":[200927],"length":1,"stats":{"Line":0}},{"line":71,"address":[201154,201245,201013],"length":1,"stats":{"Line":0}},{"line":72,"address":[201113],"length":1,"stats":{"Line":0}},{"line":74,"address":[201168],"length":1,"stats":{"Line":0}},{"line":77,"address":[201093],"length":1,"stats":{"Line":1}},{"line":78,"address":[201043],"length":1,"stats":{"Line":1}},{"line":81,"address":[200718],"length":1,"stats":{"Line":0}},{"line":87,"address":[199687],"length":1,"stats":{"Line":0}},{"line":88,"address":[199708],"length":1,"stats":{"Line":0}},{"line":89,"address":[201283],"length":1,"stats":{"Line":0}},{"line":92,"address":[201339,201255],"length":1,"stats":{"Line":0}},{"line":93,"address":[201355],"length":1,"stats":{"Line":0}},{"line":94,"address":[201496],"length":1,"stats":{"Line":0}},{"line":95,"address":[201419],"length":1,"stats":{"Line":0}},{"line":97,"address":[201586],"length":1,"stats":{"Line":0}},{"line":98,"address":[201509],"length":1,"stats":{"Line":0}},{"line":100,"address":[201676],"length":1,"stats":{"Line":0}},{"line":101,"address":[201599],"length":1,"stats":{"Line":0}},{"line":104,"address":[201397,201737,201827],"length":1,"stats":{"Line":0}},{"line":105,"address":[201696],"length":1,"stats":{"Line":0}},{"line":107,"address":[201750],"length":1,"stats":{"Line":0}},{"line":114,"address":[199757],"length":1,"stats":{"Line":1}},{"line":117,"address":[199797],"length":1,"stats":{"Line":0}},{"line":120,"address":[199837],"length":1,"stats":{"Line":0}},{"line":123,"address":[199877],"length":1,"stats":{"Line":0}},{"line":126,"address":[199523],"length":1,"stats":{"Line":0}},{"line":135,"address":[203093,203120,201840],"length":1,"stats":{"Line":3}},{"line":141,"address":[201899],"length":1,"stats":{"Line":3}},{"line":143,"address":[201936],"length":1,"stats":{"Line":3}},{"line":144,"address":[201949],"length":1,"stats":{"Line":3}},{"line":145,"address":[201993],"length":1,"stats":{"Line":3}},{"line":146,"address":[202062],"length":1,"stats":{"Line":3}},{"line":149,"address":[203136],"length":1,"stats":{"Line":3}},{"line":156,"address":[203205],"length":1,"stats":{"Line":3}},{"line":157,"address":[203254,203318],"length":1,"stats":{"Line":2}},{"line":158,"address":[203391],"length":1,"stats":{"Line":1}},{"line":159,"address":[203410],"length":1,"stats":{"Line":1}},{"line":164,"address":[203491,203291,203428],"length":1,"stats":{"Line":6}},{"line":165,"address":[203511],"length":1,"stats":{"Line":0}},{"line":166,"address":[203537],"length":1,"stats":{"Line":0}},{"line":168,"address":[203562],"length":1,"stats":{"Line":0}},{"line":174,"address":[202172,202128],"length":1,"stats":{"Line":6}},{"line":176,"address":[202182],"length":1,"stats":{"Line":3}},{"line":177,"address":[202277],"length":1,"stats":{"Line":1}},{"line":179,"address":[202354],"length":1,"stats":{"Line":1}},{"line":180,"address":[202557],"length":1,"stats":{"Line":1}},{"line":181,"address":[202661,202613],"length":1,"stats":{"Line":2}},{"line":183,"address":[202642,202663],"length":1,"stats":{"Line":2}},{"line":186,"address":[202368,202327],"length":1,"stats":{"Line":2}},{"line":192,"address":[202408],"length":1,"stats":{"Line":1}},{"line":196,"address":[202374],"length":1,"stats":{"Line":1}},{"line":197,"address":[202428],"length":1,"stats":{"Line":1}},{"line":200,"address":[202455],"length":1,"stats":{"Line":1}},{"line":205,"address":[202291,202678],"length":1,"stats":{"Line":6}},{"line":208,"address":[202927,202685,202885],"length":1,"stats":{"Line":7}},{"line":209,"address":[202945],"length":1,"stats":{"Line":1}},{"line":210,"address":[203022],"length":1,"stats":{"Line":1}},{"line":211,"address":[203075],"length":1,"stats":{"Line":1}},{"line":215,"address":[202955],"length":1,"stats":{"Line":3}}],"covered":59,"coverable":97},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","spreadsheet.rs"],"content":"use crate::cell::{CellValue, parse_cell_reference};\r\nuse crate::visualize_cells;\r\nuse std::cmp::min;\r\nuse std::collections::HashMap;\r\nuse std::collections::HashSet;\r\nuse crate::formula::Range;\r\n\r\n// Constants\r\nconst MAX_ROWS: i16 = 999; // Maximum number of rows in the spreadsheet   \r\nconst MAX_COLS: i16 = 18278; // Maximum number of columns in the spreadsheet\r\npub const MAX_DISPLAY: i16 = 15;\r\n\r\n// Structure to represent a range-based child relationship\r\n#[derive(Debug, Clone, PartialEq, Eq, Hash)]\r\npub struct RangeChild {\r\n    pub start_key: i32, // Range start cell key\r\n    pub end_key: i32,   // Range end cell key\r\n    pub child_key: i32, // Child cell key\r\n}\r\n\r\n#[derive(Debug, PartialEq)]\r\npub enum CommandStatus {\r\n    CmdOk,\r\n    CmdUnrecognized,\r\n    CmdCircularRef,\r\n    CmdInvalidCell,\r\n    CmdLockedCell,\r\n}\r\n\r\n// Modified CellMeta to remove children (they're now stored separately)\r\n#[derive(Debug, Clone)]\r\npub struct CellMeta {\r\n    pub formula: i16,\r\n    pub parent1: i32,\r\n    pub parent2: i32,\r\n}\r\n\r\nimpl CellMeta {\r\n    pub fn new() -\u003e Self {\r\n        CellMeta {\r\n            formula: -1,\r\n            parent1: -1,\r\n            parent2: -1,\r\n        }\r\n    }\r\n}\r\n\r\n// Spreadsheet structure with HashMap of boxed HashSets for children\r\npub struct Spreadsheet {\r\n    pub grid: Vec\u003cCellValue\u003e, // Vector of CellValues (contiguous in memory)\r\n    pub children: HashMap\u003ci32, Box\u003cHashSet\u003ci32\u003e\u003e\u003e, // Map from cell key to boxed HashSet of children\r\n    pub range_children: Vec\u003cRangeChild\u003e, // Vector of range-based child relationships\r\n    pub cell_meta: HashMap\u003ci32, CellMeta\u003e, // Map from cell key to metadata\r\n    pub rows: i16,\r\n    pub cols: i16,\r\n    pub viewport_row: i16,\r\n    pub viewport_col: i16,\r\n    pub output_enabled: bool,\r\n    pub display_rows: i16,\r\n    pub display_cols: i16,\r\n    pub locked_ranges: Vec\u003cRange\u003e,\r\n    pub named_ranges: HashMap\u003cString, Range\u003e,\r\n    pub cell_history: HashMap\u003ci32, Vec\u003cCellValue\u003e\u003e,\r\n    pub last_edited: Option\u003c(i16, i16)\u003e,\r\n}\r\n\r\nimpl Spreadsheet {\r\n    // Create a new spreadsheet with specified dimensions\r\n    pub fn create(rows: i16, cols: i16) -\u003e Option\u003cSpreadsheet\u003e {\r\n        if rows \u003c 1 || rows \u003e MAX_ROWS || cols \u003c 1 || cols \u003e MAX_COLS {\r\n            eprintln!(\"Invalid spreadsheet dimensions\");\r\n            return None;\r\n        }\r\n\r\n        // Create empty cells - initialize with Integer(0)\r\n        let total = rows as usize * cols as usize;\r\n        let grid = vec![CellValue::Integer(0); total];\r\n\r\n        Some(Spreadsheet {\r\n            grid,\r\n            children: HashMap::new(),\r\n            range_children: Vec::with_capacity(32), // Preallocate with initial size\r\n            cell_meta: HashMap::new(),\r\n            rows,\r\n            cols,\r\n            viewport_row: 0,\r\n            viewport_col: 0,\r\n            output_enabled: true,\r\n            display_rows: 10,\r\n            display_cols: 10,\r\n            locked_ranges: Vec::new(),\r\n            named_ranges: HashMap::new(),\r\n            cell_history: HashMap::new(),\r\n            last_edited: None,\r\n        })\r\n    }\r\n\r\n    // Helper to get cell key from coordinates\r\n    pub fn get_key(\u0026self, row: i16, col: i16) -\u003e i32 {\r\n        (row as i32 * self.cols as i32 + col as i32) as i32\r\n    }\r\n\r\n    // Helper to get coordinates from cell key\r\n    pub fn get_row_col(\u0026self, key: i32) -\u003e (i16, i16) {\r\n        let row = (key / (self.cols as i32)) as i16;\r\n        let col = (key % (self.cols as i32)) as i16;\r\n        (row, col)\r\n    }\r\n\r\n    // Helper to get index from row and column\r\n    pub fn get_index(\u0026self, row: i16, col: i16) -\u003e usize {\r\n        (row as usize) * (self.cols as usize) + (col as usize)\r\n    }\r\n\r\n    // Get cell metadata, creating it if it doesn't exist\r\n    pub fn get_cell_meta(\u0026mut self, row: i16, col: i16) -\u003e \u0026mut CellMeta {\r\n        let key = self.get_key(row, col);\r\n        self.cell_meta.entry(key).or_insert_with(CellMeta::new)\r\n    }\r\n\r\n    pub fn get_cell_meta_ref(\u0026self, row: i16, col: i16) -\u003e \u0026CellMeta {\r\n        let key = self.get_key(row, col);\r\n        self.cell_meta.get(\u0026key).unwrap_or(\u0026CellMeta {\r\n            formula: -1,\r\n            parent1: -1,\r\n            parent2: -1,\r\n        })\r\n    }\r\n\r\n    pub fn get_column_name(\u0026self, mut col: i16) -\u003e String {\r\n        // Pre-calculate the length needed for the string\r\n        let mut temp_col = col + 1; // Convert from 0-based to 1-based\r\n        let mut len = 0;\r\n        while temp_col \u003e 0 {\r\n            len += 1;\r\n            temp_col = (temp_col - 1) / 26;\r\n        }\r\n\r\n        // Add column letters directly in reverse order\r\n        col += 1; // Convert from 0-based to 1-based\r\n\r\n        // Handle special case for col = 0\r\n        if col == 0 {\r\n            return \"A\".to_string();\r\n        }\r\n\r\n        // Create a buffer of bytes to avoid repeated string operations\r\n        let mut buffer = vec![0; len];\r\n        let mut i = len;\r\n\r\n        while col \u003e 0 {\r\n            i -= 1;\r\n            buffer[i] = b'A' + ((col - 1) % 26) as u8;\r\n            col = (col - 1) / 26;\r\n        }\r\n\r\n        // Convert the byte buffer to a string in one operation\r\n        unsafe {\r\n            // This is safe because we know our bytes are valid ASCII from b'A' to b'Z'\r\n            String::from_utf8_unchecked(buffer)\r\n        }\r\n    }\r\n\r\n    pub fn column_name_to_index(\u0026self, name: \u0026str) -\u003e i16 {\r\n        let bytes = name.as_bytes();\r\n        let mut index: i16 = 0;\r\n        for \u0026b in bytes {\r\n            index = index * 26 + ((b - b'A') as i16 + 1);\r\n        }\r\n        index - 1 // Convert from 1-based to 0-based\r\n    }\r\n\r\n    pub fn get_cell(\u0026self, row: i16, col: i16) -\u003e \u0026CellValue {\r\n        let index = self.get_index(row, col);\r\n        \u0026self.grid[index]\r\n    }\r\n\r\n    pub fn get_key_cell(\u0026self, cell_key: i32) -\u003e \u0026CellValue {\r\n        \u0026self.grid[cell_key as usize]\r\n    }\r\n\r\n    pub fn get_mut_cell(\u0026mut self, row: i16, col: i16) -\u003e \u0026mut CellValue {\r\n        let index = self.get_index(row, col);\r\n        \u0026mut self.grid[index]\r\n    }\r\n\r\n    // Add a range-based child relationship\r\n    pub fn add_range_child(\u0026mut self, start_key: i32, end_key: i32, child_key: i32) {\r\n        self.range_children.push(RangeChild {\r\n            start_key,\r\n            end_key,\r\n            child_key,\r\n        });\r\n    }\r\n\r\n    // Remove range-based child relationships for a given child\r\n    pub fn remove_range_child(\u0026mut self, child_key: i32) {\r\n        self.range_children.retain(|rc| rc.child_key != child_key);\r\n    }\r\n\r\n    // Check if a cell is within a range\r\n    pub fn is_cell_in_range(\u0026self, cell_key: i32, start_key: i32, end_key: i32) -\u003e bool {\r\n        let (cell_row, cell_col) = self.get_row_col(cell_key);\r\n        let (start_row, start_col) = self.get_row_col(start_key);\r\n        let (end_row, end_col) = self.get_row_col(end_key);\r\n\r\n        cell_row \u003e= start_row \u0026\u0026 cell_row \u003c= end_row \u0026\u0026 cell_col \u003e= start_col \u0026\u0026 cell_col \u003c= end_col\r\n    }\r\n\r\n    // Add a child to a cell's dependents (modified for HashMap of boxed HashSets)\r\n    pub fn add_child(\u0026mut self, parent_key: \u0026i32, child_key: \u0026i32) {\r\n        self.children\r\n            .entry(*parent_key)\r\n            .or_insert_with(|| Box::new(HashSet::with_capacity(5)))\r\n            .insert(*child_key);\r\n    }\r\n\r\n    // Remove a child from a cell's dependents (modified for HashMap of boxed HashSets)\r\n    pub fn remove_child(\u0026mut self, parent_key: i32, child_key: i32) {\r\n        if let Some(children) = self.children.get_mut(\u0026parent_key) {\r\n            children.remove(\u0026child_key);\r\n\r\n            // If the hashset is now empty, remove it from the HashMap to save memory\r\n            if children.is_empty() {\r\n                self.children.remove(\u0026parent_key);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Get children for a cell (immutable) (modified for HashMap of boxed HashSets)\r\n    pub fn get_cell_children(\u0026self, key: i32) -\u003e Option\u003c\u0026HashSet\u003ci32\u003e\u003e {\r\n        self.children.get(\u0026key).map(|boxed_set| boxed_set.as_ref())\r\n    }\r\n\r\n    pub fn print_spreadsheet(\u0026self) {\r\n        if !self.output_enabled {\r\n            return;\r\n        }\r\n\r\n        let start_row = self.viewport_row;\r\n        let start_col = self.viewport_col;\r\n        let display_row = min(self.rows - start_row, 10); // Display only a portion of the spreadsheet\r\n        let display_col = min(self.cols - start_col, 10);\r\n\r\n        // Print column headers\r\n        print!(\"     \");\r\n        for i in 0..display_col {\r\n            print!(\"{:\u003c8} \", self.get_column_name(start_col + i));\r\n        }\r\n        println!();\r\n\r\n        // Print rows with data\r\n        for i in 0..display_row {\r\n            print!(\"{:\u003c4} \", start_row + i + 1); // Show 1-based row numbers\r\n            for j in 0..display_col {\r\n                let cell_value = self.get_cell(start_row + i, start_col + j);\r\n                match cell_value {\r\n                    CellValue::Integer(value) =\u003e print!(\"{:\u003c8} \", value),\r\n                    CellValue::Error =\u003e print!(\"{:\u003c8} \", \"ERR\"),\r\n                }\r\n            }\r\n            println!();\r\n        }\r\n    }\r\n\r\n    pub fn scroll_to_cell(\u0026mut self, cell: \u0026str) -\u003e CommandStatus {\r\n        match parse_cell_reference(self, cell) {\r\n            Ok((row, col)) =\u003e {\r\n                if row \u003e= 0 \u0026\u0026 row \u003c self.rows \u0026\u0026 col \u003e= 0 \u0026\u0026 col \u003c self.cols {\r\n                    self.viewport_row = row;\r\n                    self.viewport_col = col;\r\n                    return CommandStatus::CmdOk;\r\n                } else {\r\n                    return CommandStatus::CmdInvalidCell;\r\n                }\r\n            }\r\n            Err(_) =\u003e {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n    }\r\n\r\n    pub fn scroll_viewport(\u0026mut self, direction: char) {\r\n        const VIEWPORT_SIZE: i16 = 10;\r\n        match direction {\r\n            'w' =\u003e {\r\n                self.viewport_row = if self.viewport_row \u003e 10 {\r\n                    self.viewport_row - 10\r\n                } else {\r\n                    0\r\n                };\r\n            }\r\n            's' =\u003e {\r\n                if self.viewport_row + VIEWPORT_SIZE \u003c self.rows - 9 {\r\n                    self.viewport_row += 10;\r\n                } else {\r\n                    self.viewport_row = self.rows - VIEWPORT_SIZE;\r\n                }\r\n            }\r\n            'a' =\u003e {\r\n                self.viewport_col = if self.viewport_col \u003e 10 {\r\n                    self.viewport_col - 10\r\n                } else {\r\n                    0\r\n                };\r\n            }\r\n\r\n            'd' =\u003e {\r\n                if self.viewport_col + VIEWPORT_SIZE \u003c self.cols - 9 {\r\n                    self.viewport_col += 10;\r\n                } else {\r\n                    self.viewport_col = self.cols - VIEWPORT_SIZE;\r\n                }\r\n            }\r\n            _ =\u003e {} // Invalid direction, do nothing\r\n        }\r\n    }\r\n\r\n    pub fn visualize_cell_relationships(\u0026self, row: i16, col: i16) -\u003e CommandStatus {\r\n        // Check if the cell is valid\r\n        visualize_cells::visualize_cell_relationships(self, row, col)\r\n    }\r\n\r\n    pub fn lock_range(\u0026mut self, range: Range) {\r\n        self.locked_ranges.push(range);\r\n    }\r\n\r\n    pub fn is_cell_locked(\u0026self, row: i16, col: i16) -\u003e bool {\r\n        for range in \u0026self.locked_ranges {\r\n            if row \u003e= range.start_row \u0026\u0026 row \u003c= range.end_row \u0026\u0026 col \u003e= range.start_col \u0026\u0026 col \u003c= range.end_col {\r\n                return true;\r\n            }\r\n        }\r\n        false\r\n    }\r\n\r\n    pub fn set_last_edited(\u0026mut self, row: i16, col: i16) {\r\n        self.last_edited = Some((row, col));\r\n    }\r\n\r\n    pub fn scroll_to_last_edited(\u0026mut self) {\r\n        if let Some((row, col)) = self.last_edited {\r\n            self.viewport_row = row;\r\n            self.viewport_col = col;\r\n        }\r\n    }\r\n\r\n    pub fn get_cell_name(\u0026self, row: i16, col: i16) -\u003e String {\r\n        for (name, range) in \u0026self.named_ranges {\r\n            if range.start_row == row \u0026\u0026 range.start_col == col \u0026\u0026\r\n               range.end_row == row \u0026\u0026 range.end_col == col {\r\n                return name.clone();\r\n            }\r\n        }\r\n        let col_name = self.get_column_name(col);\r\n        format!(\"{}{}\", col_name, row + 1)\r\n    }\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n\r\n    #[test]\r\n    fn test_create_valid_dimensions() {\r\n        let sheet = Spreadsheet::create(5, 5).unwrap();\r\n        assert_eq!(sheet.rows, 5);\r\n        assert_eq!(sheet.cols, 5);\r\n        assert_eq!(sheet.grid.len(), 25);\r\n        assert_eq!(sheet.viewport_row, 0);\r\n        assert_eq!(sheet.viewport_col, 0);\r\n    }\r\n\r\n    #[test]\r\n    fn test_create_invalid_dimensions() {\r\n        assert!(Spreadsheet::create(0, 5).is_none());\r\n        assert!(Spreadsheet::create(5, 0).is_none());\r\n        assert!(Spreadsheet::create(MAX_ROWS + 1, 5).is_none());\r\n        assert!(Spreadsheet::create(5, MAX_COLS + 1).is_none());\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_column_name() {\r\n        let sheet = Spreadsheet::create(1, 1).unwrap();\r\n        assert_eq!(sheet.get_column_name(0), \"A\");\r\n        assert_eq!(sheet.get_column_name(25), \"Z\");\r\n        assert_eq!(sheet.get_column_name(26), \"AA\");\r\n        assert_eq!(sheet.get_column_name(51), \"AZ\");\r\n    }\r\n\r\n    #[test]\r\n    fn test_column_name_to_index() {\r\n        let sheet = Spreadsheet::create(1, 1).unwrap();\r\n        assert_eq!(sheet.column_name_to_index(\"A\"), 0);\r\n        assert_eq!(sheet.column_name_to_index(\"Z\"), 25);\r\n        assert_eq!(sheet.column_name_to_index(\"AA\"), 26);\r\n        assert_eq!(sheet.column_name_to_index(\"AZ\"), 51);\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_cell_and_get_mut_cell() {\r\n        let mut sheet = Spreadsheet::create(2, 2).unwrap();\r\n        let cell_value = sheet.get_mut_cell(0, 0);\r\n        *cell_value = CellValue::Integer(42);\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(42));\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_key_and_row_col() {\r\n        let sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let key = sheet.get_key(2, 3);\r\n        let (row, col) = sheet.get_row_col(key);\r\n        assert_eq!(row, 2);\r\n        assert_eq!(col, 3);\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_cell_meta() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let meta = sheet.get_cell_meta(1, 1);\r\n        assert_eq!(meta.formula, -1);\r\n        assert_eq!(meta.parent1, -1);\r\n        assert_eq!(meta.parent2, -1);\r\n        meta.formula = 10;\r\n        assert_eq!(sheet.get_cell_meta(1, 1).formula, 10);\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_remove_child() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let parent = sheet.get_key(0, 0);\r\n        let child = sheet.get_key(1, 1);\r\n        sheet.add_child(\u0026parent, \u0026child);\r\n        assert!(sheet.get_cell_children(parent).unwrap().contains(\u0026child));\r\n        sheet.remove_child(parent, child);\r\n        assert!(sheet.get_cell_children(parent).is_none());\r\n    }\r\n\r\n    #[test]\r\n    fn test_is_cell_in_range() {\r\n        let sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let cell_key = sheet.get_key(1, 1);\r\n        let start_key = sheet.get_key(0, 0);\r\n        let end_key = sheet.get_key(2, 2);\r\n        assert!(sheet.is_cell_in_range(cell_key, start_key, end_key));\r\n        assert!(!sheet.is_cell_in_range(cell_key, end_key, start_key));\r\n    }\r\n\r\n    #[test]\r\n    fn test_scroll_to_cell_valid() {\r\n        let mut sheet = Spreadsheet::create(20, 20).unwrap();\r\n        let status = sheet.scroll_to_cell(\"B2\");\r\n        assert_eq!(status, CommandStatus::CmdOk);\r\n        assert_eq!(sheet.viewport_row, 1);\r\n        assert_eq!(sheet.viewport_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_scroll_to_cell_invalid() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        assert_eq!(sheet.scroll_to_cell(\"F6\"), CommandStatus::CmdInvalidCell);\r\n        assert_eq!(sheet.scroll_to_cell(\"1A\"), CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    #[test]\r\n    fn test_scroll_viewport() {\r\n        let mut sheet = Spreadsheet::create(50, 50).unwrap();\r\n        sheet.scroll_viewport('s');\r\n        assert_eq!(sheet.viewport_row, 10);\r\n        sheet.scroll_viewport('d');\r\n        assert_eq!(sheet.viewport_col, 10);\r\n        sheet.scroll_viewport('w');\r\n        assert_eq!(sheet.viewport_row, 0);\r\n        sheet.scroll_viewport('a');\r\n        assert_eq!(sheet.viewport_col, 0);\r\n        sheet.viewport_row = 45;\r\n        sheet.scroll_viewport('s');\r\n        assert_eq!(sheet.viewport_row, 40);\r\n    }\r\n\r\n    #[test]\r\n    fn test_print_spreadsheet_disabled() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        sheet.output_enabled = false;\r\n        sheet.print_spreadsheet(); // Should not panic\r\n    }\r\n\r\n    #[test]\r\n    fn test_print_spreadsheet_with_values() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(42);\r\n        *sheet.get_mut_cell(1, 1) = CellValue::Error;\r\n        sheet.output_enabled = true;\r\n        sheet.print_spreadsheet(); // Should not panic\r\n    }\r\n}\r\n","traces":[{"line":39,"address":[295504],"length":1,"stats":{"Line":1}},{"line":69,"address":[296529,295536],"length":1,"stats":{"Line":13}},{"line":70,"address":[295659,295585],"length":1,"stats":{"Line":15}},{"line":71,"address":[295602],"length":1,"stats":{"Line":1}},{"line":72,"address":[295636],"length":1,"stats":{"Line":1}},{"line":76,"address":[295802,295686],"length":1,"stats":{"Line":1}},{"line":77,"address":[295718],"length":1,"stats":{"Line":13}},{"line":79,"address":[296140],"length":1,"stats":{"Line":1}},{"line":80,"address":[295759],"length":1,"stats":{"Line":15}},{"line":81,"address":[295795],"length":1,"stats":{"Line":14}},{"line":82,"address":[295858],"length":1,"stats":{"Line":1}},{"line":83,"address":[295930],"length":1,"stats":{"Line":14}},{"line":91,"address":[295982],"length":1,"stats":{"Line":1}},{"line":92,"address":[296034],"length":1,"stats":{"Line":14}},{"line":93,"address":[296086],"length":1,"stats":{"Line":1}},{"line":94,"address":[296130],"length":1,"stats":{"Line":14}},{"line":99,"address":[296560],"length":1,"stats":{"Line":1}},{"line":100,"address":[296660,296590],"length":1,"stats":{"Line":1}},{"line":104,"address":[296688],"length":1,"stats":{"Line":2}},{"line":105,"address":[296710,296819],"length":1,"stats":{"Line":2}},{"line":106,"address":[296801,296908,296843],"length":1,"stats":{"Line":4}},{"line":111,"address":[296928],"length":1,"stats":{"Line":5}},{"line":112,"address":[297036,296958],"length":1,"stats":{"Line":5}},{"line":116,"address":[297056],"length":1,"stats":{"Line":1}},{"line":117,"address":[297086],"length":1,"stats":{"Line":1}},{"line":118,"address":[297108],"length":1,"stats":{"Line":1}},{"line":121,"address":[297152],"length":1,"stats":{"Line":1}},{"line":122,"address":[297182],"length":1,"stats":{"Line":1}},{"line":123,"address":[297202],"length":1,"stats":{"Line":1}},{"line":130,"address":[297248,297964,297989],"length":1,"stats":{"Line":1}},{"line":132,"address":[297330,297281],"length":1,"stats":{"Line":1}},{"line":133,"address":[297319],"length":1,"stats":{"Line":1}},{"line":134,"address":[297328,298101,297346],"length":1,"stats":{"Line":3}},{"line":135,"address":[298030,297376,298003],"length":1,"stats":{"Line":2}},{"line":136,"address":[298051,298106,298008],"length":1,"stats":{"Line":2}},{"line":140,"address":[297409,297354,297424],"length":1,"stats":{"Line":2}},{"line":143,"address":[297414],"length":1,"stats":{"Line":1}},{"line":144,"address":[297445],"length":1,"stats":{"Line":0}},{"line":148,"address":[297464],"length":1,"stats":{"Line":1}},{"line":149,"address":[297496],"length":1,"stats":{"Line":1}},{"line":151,"address":[297521,297506,297938],"length":1,"stats":{"Line":3}},{"line":152,"address":[297579,297663,297690],"length":1,"stats":{"Line":2}},{"line":153,"address":[297668,297710],"length":1,"stats":{"Line":2}},{"line":154,"address":[297943,297858],"length":1,"stats":{"Line":1}},{"line":160,"address":[297534],"length":1,"stats":{"Line":1}},{"line":164,"address":[298128],"length":1,"stats":{"Line":1}},{"line":165,"address":[298173],"length":1,"stats":{"Line":1}},{"line":166,"address":[298194],"length":1,"stats":{"Line":3}},{"line":167,"address":[298201,298279,298472],"length":1,"stats":{"Line":5}},{"line":168,"address":[298477,298348,298294],"length":1,"stats":{"Line":4}},{"line":170,"address":[298328,298257],"length":1,"stats":{"Line":1}},{"line":173,"address":[298496],"length":1,"stats":{"Line":1}},{"line":174,"address":[298526],"length":1,"stats":{"Line":1}},{"line":175,"address":[298550],"length":1,"stats":{"Line":1}},{"line":178,"address":[298576],"length":1,"stats":{"Line":4}},{"line":179,"address":[298589],"length":1,"stats":{"Line":4}},{"line":182,"address":[298624],"length":1,"stats":{"Line":5}},{"line":183,"address":[298654],"length":1,"stats":{"Line":5}},{"line":184,"address":[298678],"length":1,"stats":{"Line":5}},{"line":188,"address":[298704],"length":1,"stats":{"Line":2}},{"line":189,"address":[298725],"length":1,"stats":{"Line":2}},{"line":197,"address":[298768],"length":1,"stats":{"Line":1}},{"line":198,"address":[298781],"length":1,"stats":{"Line":3}},{"line":202,"address":[298800],"length":1,"stats":{"Line":1}},{"line":203,"address":[298834],"length":1,"stats":{"Line":1}},{"line":204,"address":[298868],"length":1,"stats":{"Line":1}},{"line":205,"address":[298902],"length":1,"stats":{"Line":1}},{"line":207,"address":[298940],"length":1,"stats":{"Line":1}},{"line":211,"address":[299024],"length":1,"stats":{"Line":1}},{"line":212,"address":[299060,299054,299117,299127],"length":1,"stats":{"Line":3}},{"line":213,"address":[299058],"length":1,"stats":{"Line":1}},{"line":214,"address":[441888,441892],"length":1,"stats":{"Line":2}},{"line":215,"address":[299115],"length":1,"stats":{"Line":1}},{"line":219,"address":[299152],"length":1,"stats":{"Line":1}},{"line":220,"address":[299174],"length":1,"stats":{"Line":1}},{"line":221,"address":[299269,299308,299234],"length":1,"stats":{"Line":2}},{"line":224,"address":[299284,299328],"length":1,"stats":{"Line":2}},{"line":225,"address":[299360],"length":1,"stats":{"Line":1}},{"line":231,"address":[299408],"length":1,"stats":{"Line":3}},{"line":232,"address":[299421],"length":1,"stats":{"Line":5}},{"line":235,"address":[301592,299456],"length":1,"stats":{"Line":2}},{"line":236,"address":[299476],"length":1,"stats":{"Line":2}},{"line":240,"address":[299498],"length":1,"stats":{"Line":1}},{"line":241,"address":[299518],"length":1,"stats":{"Line":1}},{"line":242,"address":[299538,299628],"length":1,"stats":{"Line":1}},{"line":243,"address":[299737,299604,299649],"length":1,"stats":{"Line":2}},{"line":246,"address":[299675],"length":1,"stats":{"Line":1}},{"line":247,"address":[299869,299709,299753],"length":1,"stats":{"Line":3}},{"line":248,"address":[301211,299885],"length":1,"stats":{"Line":2}},{"line":250,"address":[299796],"length":1,"stats":{"Line":1}},{"line":253,"address":[299836,299909],"length":1,"stats":{"Line":2}},{"line":254,"address":[299982,300363],"length":1,"stats":{"Line":1}},{"line":255,"address":[300379,300472,300335],"length":1,"stats":{"Line":3}},{"line":256,"address":[300493,300603],"length":1,"stats":{"Line":1}},{"line":257,"address":[300590],"length":1,"stats":{"Line":1}},{"line":258,"address":[300624],"length":1,"stats":{"Line":1}},{"line":259,"address":[300919],"length":1,"stats":{"Line":1}},{"line":262,"address":[300422],"length":1,"stats":{"Line":1}},{"line":266,"address":[301616],"length":1,"stats":{"Line":1}},{"line":267,"address":[301640],"length":1,"stats":{"Line":1}},{"line":268,"address":[301693],"length":1,"stats":{"Line":1}},{"line":269,"address":[301723,301755],"length":1,"stats":{"Line":2}},{"line":270,"address":[301809],"length":1,"stats":{"Line":1}},{"line":271,"address":[301816],"length":1,"stats":{"Line":1}},{"line":272,"address":[301823],"length":1,"stats":{"Line":1}},{"line":274,"address":[301738],"length":1,"stats":{"Line":1}},{"line":278,"address":[301731],"length":1,"stats":{"Line":1}},{"line":283,"address":[301840],"length":1,"stats":{"Line":1}},{"line":285,"address":[301860],"length":1,"stats":{"Line":1}},{"line":286,"address":[302072],"length":1,"stats":{"Line":1}},{"line":287,"address":[302087,302060,301906,302023],"length":1,"stats":{"Line":3}},{"line":288,"address":[302082,302089,302030],"length":1,"stats":{"Line":0}},{"line":290,"address":[302016],"length":1,"stats":{"Line":1}},{"line":294,"address":[302110,301923,302261,302299],"length":1,"stats":{"Line":4}},{"line":295,"address":[302304,302219,302292],"length":1,"stats":{"Line":2}},{"line":297,"address":[302266,302254,302189],"length":1,"stats":{"Line":2}},{"line":300,"address":[302376],"length":1,"stats":{"Line":1}},{"line":301,"address":[301960,302364,302327,302391],"length":1,"stats":{"Line":3}},{"line":302,"address":[302393,302334,302386],"length":1,"stats":{"Line":0}},{"line":304,"address":[302320],"length":1,"stats":{"Line":1}},{"line":309,"address":[302565,302414,302603,301984],"length":1,"stats":{"Line":3}},{"line":310,"address":[302523,302596,302608],"length":1,"stats":{"Line":2}},{"line":312,"address":[302558,302493,302570],"length":1,"stats":{"Line":0}},{"line":319,"address":[302624],"length":1,"stats":{"Line":1}},{"line":321,"address":[302649],"length":1,"stats":{"Line":1}},{"line":324,"address":[302672],"length":1,"stats":{"Line":1}},{"line":325,"address":[302696],"length":1,"stats":{"Line":1}},{"line":328,"address":[302736],"length":1,"stats":{"Line":3}},{"line":329,"address":[302771,302843],"length":1,"stats":{"Line":5}},{"line":330,"address":[302858,302886],"length":1,"stats":{"Line":2}},{"line":331,"address":[302928],"length":1,"stats":{"Line":1}},{"line":334,"address":[302831],"length":1,"stats":{"Line":3}},{"line":337,"address":[302944],"length":1,"stats":{"Line":3}},{"line":338,"address":[302965],"length":1,"stats":{"Line":3}},{"line":341,"address":[303008],"length":1,"stats":{"Line":1}},{"line":342,"address":[303018],"length":1,"stats":{"Line":1}},{"line":343,"address":[303060],"length":1,"stats":{"Line":1}},{"line":344,"address":[303067],"length":1,"stats":{"Line":1}},{"line":348,"address":[303088,303609],"length":1,"stats":{"Line":1}},{"line":349,"address":[303150,303298],"length":1,"stats":{"Line":3}},{"line":350,"address":[303641,303340],"length":1,"stats":{"Line":0}},{"line":351,"address":[303661],"length":1,"stats":{"Line":0}},{"line":352,"address":[303701],"length":1,"stats":{"Line":0}},{"line":355,"address":[303252],"length":1,"stats":{"Line":3}},{"line":356,"address":[303399,303286],"length":1,"stats":{"Line":6}}],"covered":138,"coverable":145},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","vim_mode","commands.rs"],"content":"// vim_mode/commands.rs\r\nuse super::editor::{EditorMode, EditorState};\r\nuse crate::{evaluator, spreadsheet};\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\nuse std::cell;\r\nuse std::fs::{File, OpenOptions};\r\nuse std::io::{BufRead, BufReader, Write, BufWriter};\r\nuse std::path::Path;\r\nuse crate::cell::{parse_cell_reference, CellValue};\r\nuse crate::graph;\r\n\r\n\r\n// Handle vim-specific commands\r\npub fn handle_vim_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    input: \u0026str,\r\n    state: \u0026mut EditorState,\r\n) -\u003e CommandStatus {\r\n    if !input.trim().is_empty() {\r\n        state.add_to_history(input);\r\n    }\r\n    // Handle mode-specific input\r\n    match state.mode {\r\n        EditorMode::Normal =\u003e handle_normal_mode_command(sheet, input, state),\r\n        EditorMode::Insert =\u003e handle_insert_mode_command(sheet, input, state),\r\n       \r\n    \r\n\r\n    }\r\n}\r\n\r\n// Process commands in normal mode\r\nfn handle_normal_mode_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    input: \u0026str,\r\n    state: \u0026mut EditorState,\r\n) -\u003e CommandStatus {\r\n    // Single character commands\r\n    //store the input add_history \r\n    \r\n\r\n    if input.len() == 1 {\r\n        match input.chars().next().unwrap() {\r\n\r\n\r\n            // Movement commands\r\n            'h' | 'j' | 'k' | 'l' =\u003e {\r\n                state.move_cursor(input.chars().next().unwrap(), sheet);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            // Mode switching\r\n            'i' =\u003e {\r\n                state.mode = EditorMode::Insert;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            // Editing commands\r\n            'd' =\u003e return cut_cell(sheet, state),\r\n            'y' =\u003e return yank_cell(sheet, state),\r\n            'p' =\u003e return paste_cell(sheet, state),\r\n            'q' =\u003e {\r\n                state.should_quit = true;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            _ =\u003e {}\r\n        }\r\n    }\r\n\r\n    // File commands\r\n    if input.starts_with(':') {\r\n\r\n        let cmd = \u0026input[1..];\r\n\r\n        // :w - write file\r\n        if cmd.starts_with('w') \u0026\u0026 !cmd.starts_with(\"wq\") {\r\n            // Extract filename if provided\r\n            let filename = if cmd.len() \u003e 1 \u0026\u0026 cmd.chars().nth(1) == Some(' ') {\r\n                Some(cmd[2..].trim().to_string())\r\n            } else if cmd == \"w\" {\r\n                state.save_file.clone()\r\n            } else {\r\n                None\r\n            };\r\n\r\n            if let Some(file) = filename {\r\n                state.save_file = Some(file.clone());\r\n                return save_spreadsheet(sheet, \u0026file);\r\n            } else {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n\r\n        // :q - quit\r\n        if cmd == \"q\" {\r\n            state.should_quit = true;\r\n            return CommandStatus::CmdOk;\r\n        }\r\n\r\n        // :wq - write and quit\r\n        if cmd.starts_with(\"wq\") {\r\n            // Extract filename if provided (e.g., \":wq filename.csv\")\r\n            let filename = if cmd.len() \u003e 2 \u0026\u0026 cmd.chars().nth(2) == Some(' ') {\r\n                Some(cmd[3..].trim().to_string())\r\n            } else {\r\n                state.save_file.clone()\r\n            };\r\n\r\n            if let Some(file) = filename {\r\n                state.save_file = Some(file.clone());\r\n                let status = save_spreadsheet(sheet, \u0026file);\r\n                if status == CommandStatus::CmdOk {\r\n                    state.should_quit = true;\r\n                }\r\n                return status;\r\n            } else {\r\n                // No file specified\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n\r\n        // :!rm % - delete the current file\r\n        if cmd.trim() == \"!rm %\" {\r\n            if let Some(file) = \u0026state.save_file {\r\n                match std::fs::remove_file(file) {\r\n                    Ok(_) =\u003e {\r\n                        state.save_file = None;\r\n                        return CommandStatus::CmdOk;\r\n                    }\r\n                    Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n                }\r\n            } else {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n    }\r\n\r\n    // If not handled as a vim command, pass it to the standard command handler\r\n    let mut sleep_time = 0.0;\r\n    evaluator::handle_command(sheet, input, \u0026mut sleep_time);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Save spreadsheet to a file\r\npub fn save_spreadsheet(sheet: \u0026Spreadsheet, filename: \u0026str) -\u003e CommandStatus {\r\n    let path = Path::new(filename);\r\n    \r\n    // Open file for writing\r\n    let file = match OpenOptions::new()\r\n        .write(true)\r\n        .create(true)\r\n        .truncate(true)\r\n        .open(path)\r\n    {\r\n        Ok(file) =\u003e file,\r\n        Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n    };\r\n\r\n    // Create a buffered writer\r\n    let mut writer = BufWriter::new(file);\r\n\r\n    // Write header with dimensions\r\n    if let Err(_) = writeln!(writer, \"DIMS,{},{}\", sheet.rows, sheet.cols) {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Write cell data with formulas\r\n    for row in 0..sheet.rows {\r\n        for col in 0..sheet.cols {\r\n            let key = sheet.get_key(row, col);\r\n            let cell_value = sheet.get_cell(row, col);\r\n            \r\n            // Only write cells with non-zero values or formulas\r\n            let is_nonzero = match cell_value {\r\n                CellValue::Integer(0) =\u003e false,\r\n                _ =\u003e true,\r\n            };\r\n            \r\n            // Check if cell has formula metadata\r\n            let has_metadata = sheet.cell_meta.contains_key(\u0026key);\r\n            \r\n            if is_nonzero || has_metadata {\r\n                let cell_ref = format!(\"{}{}\", sheet.get_column_name(col), row + 1);\r\n                \r\n                // Write the cell value\r\n                match cell_value {\r\n                    CellValue::Integer(val) =\u003e {\r\n                        write!(writer, \"CELL,{},{}\", cell_ref, val).unwrap();\r\n                    },\r\n                    CellValue::Error =\u003e {\r\n                        write!(writer, \"CELL,{},ERR\", cell_ref).unwrap();\r\n                    },\r\n                }\r\n                \r\n                // If the cell has formula metadata, write it too\r\n                if let Some(meta) = sheet.cell_meta.get(\u0026key) {\r\n                    if meta.formula != -1 {\r\n                        // Get the parent cells as references\r\n                        let parent1_ref = if meta.parent1 != -1 {\r\n                            let (p1_row, p1_col) = sheet.get_row_col(meta.parent1);\r\n                            format!(\"{}{}\", sheet.get_column_name(p1_col), p1_row + 1)\r\n                        } else {\r\n                            String::from(\"\")\r\n                        };\r\n                        \r\n                        let parent2_ref = if meta.parent2 != -1 {\r\n                            let (p2_row, p2_col) = sheet.get_row_col(meta.parent2);\r\n                            format!(\"{}{}\", sheet.get_column_name(p2_col), p2_row + 1)\r\n                        } else {\r\n                            String::from(\"\")\r\n                        };\r\n                        \r\n                        write!(writer, \",FORMULA,{},{},{}\", \r\n                            meta.formula, parent1_ref, parent2_ref).unwrap();\r\n                    }\r\n                }\r\n                \r\n                // End the line\r\n                writeln!(writer, \"\").unwrap();\r\n            }\r\n        }\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Load a spreadsheet from a file\r\npub fn load_spreadsheet(sheet: \u0026mut Spreadsheet, filename: \u0026str) -\u003e CommandStatus {\r\n    let path = Path::new(filename);\r\n\r\n    // Open file for reading\r\n    let file = match File::open(path) {\r\n        Ok(file) =\u003e file,\r\n        Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n    };\r\n\r\n    // Create a buffered reader\r\n    let reader = BufReader::new(file);\r\n    \r\n    // Clear the existing spreadsheet\r\n    for row in 0..sheet.rows {\r\n        for col in 0..sheet.cols {\r\n            let key = sheet.get_key(row, col);\r\n            // Clear cell value\r\n            let index = sheet.get_index(row, col);\r\n            sheet.grid[index] = CellValue::Integer(0);\r\n            \r\n            // Clear metadata and dependencies\r\n            if sheet.cell_meta.contains_key(\u0026key) {\r\n                // Remove all parent-child relationships\r\n                graph::remove_all_parents(sheet, row, col);\r\n                sheet.cell_meta.remove(\u0026key);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Read and parse the file\r\n    for line_result in reader.lines() {\r\n        let line = match line_result {\r\n            Ok(line) =\u003e line,\r\n            Err(_) =\u003e continue,\r\n        };\r\n        \r\n        let parts: Vec\u003c\u0026str\u003e = line.split(',').collect();\r\n        if parts.is_empty() {\r\n            continue;\r\n        }\r\n        \r\n        // Process line based on type\r\n        match parts[0] {\r\n            \"DIMS\" =\u003e {\r\n                // Dimensions line: DIMS,rows,cols\r\n                if parts.len() \u003e= 3 {\r\n                    // We don't resize the sheet here, just validate dimensions\r\n                    let file_rows: i16 = parts[1].parse().unwrap_or(0);\r\n                    let file_cols: i16 = parts[2].parse().unwrap_or(0);\r\n                    \r\n                    if file_rows \u003e sheet.rows || file_cols \u003e sheet.cols {\r\n                        eprintln!(\"Warning: File contains a larger spreadsheet than current dimensions\");\r\n                    }\r\n                }\r\n            },\r\n            \"CELL\" =\u003e {\r\n                // Cell data line: CELL,ref,value[,FORMULA,formula_code,parent1,parent2]\r\n                if parts.len() \u003e= 3 {\r\n                    let cell_ref = parts[1];\r\n                    let value_str = parts[2];\r\n                    \r\n                    // Parse cell reference\r\n                    if let Ok((row, col)) = parse_cell_reference(sheet, cell_ref) {\r\n                        // Set cell value\r\n                        let cell_value = if value_str == \"ERR\" {\r\n                            CellValue::Error\r\n                        } else {\r\n                            match value_str.parse::\u003ci32\u003e() {\r\n                                Ok(val) =\u003e CellValue::Integer(val),\r\n                                Err(_) =\u003e continue,\r\n                            }\r\n                        };\r\n                        \r\n                        let index = sheet.get_index(row, col);\r\n                        sheet.grid[index] = cell_value;\r\n                        \r\n                        // If there's formula data, process it\r\n                        if parts.len() \u003e= 6 \u0026\u0026 parts[3] == \"FORMULA\" {\r\n                            let formula: i16 = parts[4].parse().unwrap_or(-1);\r\n                            let parent1_ref = parts[5];\r\n                            let parent2_ref = if parts.len() \u003e 6 { parts[6] } else { \"\" };\r\n                            \r\n                            if formula != -1 {\r\n                                // Get parent cell keys\r\n                                let parent1_key = if !parent1_ref.is_empty() {\r\n                                    if let Ok((p1_row, p1_col)) = parse_cell_reference(sheet, parent1_ref) {\r\n                                        sheet.get_key(p1_row, p1_col)\r\n                                    } else {\r\n                                        -1\r\n                                    }\r\n                                } else {\r\n                                    -1\r\n                                };\r\n                                \r\n                                let parent2_key = if !parent2_ref.is_empty() {\r\n                                    if let Ok((p2_row, p2_col)) = parse_cell_reference(sheet, parent2_ref) {\r\n                                        sheet.get_key(p2_row, p2_col)\r\n                                    } else {\r\n                                        -1\r\n                                    }\r\n                                } else {\r\n                                    -1\r\n                                };\r\n                                \r\n                                // Set cell metadata\r\n                                let key = sheet.get_key(row, col);\r\n                                let meta = sheet.cell_meta.entry(key).or_insert_with(|| crate::spreadsheet::CellMeta::new());\r\n                                meta.formula = formula;\r\n                                meta.parent1 = parent1_key;\r\n                                meta.parent2 = parent2_key;\r\n                                \r\n                                // Add dependencies\r\n                                graph::add_children(sheet, parent1_key, parent2_key, formula, row, col);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            _ =\u003e continue,\r\n        }\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n\r\n// Process commands in insert mode\r\nfn handle_insert_mode_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    input: \u0026str,\r\n    state: \u0026mut EditorState,\r\n) -\u003e CommandStatus {\r\n    // Check for Escape key to exit insert mode\r\n    if input == \"Esc\" || input == \"\\x1b\" {\r\n        state.mode = EditorMode::Normal;\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    // Directly set the value of the cell at the cursor\r\n    let status = state.set_cursor_cell_value(sheet, input);\r\n\r\n    // If successful, move cursor down (like vim behavior)\r\n    if status == CommandStatus::CmdOk {\r\n        state.move_cursor('j', sheet);\r\n    }\r\n\r\n    status\r\n}\r\n\r\n// Cut the current cell (copy + clear)\r\nfn cut_cell(sheet: \u0026mut Spreadsheet, state: \u0026mut EditorState) -\u003e CommandStatus {\r\n    // First copy the cell\r\n    let status = yank_cell(sheet, state);\r\n    if status != CommandStatus::CmdOk {\r\n        return status;\r\n    }\r\n    let row = state.cursor_row;\r\n    let col = state.cursor_col;\r\n\r\n\r\n\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(0);\r\n    \r\n    // Reset formula metadata\r\n    let cell_key = sheet.get_key(row, col);\r\n    if let Some(meta) = sheet.cell_meta.get_mut(\u0026cell_key) {\r\n        meta.formula = -1;  // No formula\r\n        meta.parent1 = -1;  // No parents\r\n        meta.parent2 = -1;\r\n    }\r\n    \r\n    // Also remove this cell from any dependency tracking\r\n    graph::remove_all_parents(sheet,row, col);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Copy (yank) the current cell\r\nfn yank_cell(sheet: \u0026mut Spreadsheet, state: \u0026mut EditorState) -\u003e CommandStatus {\r\n    // Get the cell reference string and value\r\n    let cell_value = sheet.get_cell(state.cursor_row, state.cursor_col).clone();\r\n\r\n    // Get the formula for the cell (if any)\r\n    let cell_key = sheet.get_key(state.cursor_row, state.cursor_col);\r\n    let formula = if let Some(meta) = sheet.cell_meta.get(\u0026cell_key) {\r\n        if meta.formula != -1 {\r\n            // Get the parent cells as references\r\n       //get the parents , and the formula code converted to the actual operation\r\n            let parent1_ref = if meta.parent1 != -1 {\r\n                let (p1_row, p1_col) = sheet.get_row_col(meta.parent1);\r\n                format!(\"{}{}\", sheet.get_column_name(p1_col), p1_row + 1)\r\n            } else {\r\n                String::from(\"\")\r\n            };\r\n            \r\n            let parent2_ref = if meta.parent2 != -1 {\r\n                let (p2_row, p2_col) = sheet.get_row_col(meta.parent2);\r\n                format!(\"{}{}\", sheet.get_column_name(p2_col), p2_row + 1)\r\n            } else {\r\n                String::from(\"\")\r\n            };\r\n            // Convert formula code to string\r\n            if meta.formula==10{\r\n                format!(\"{}+{}\", parent1_ref, parent2_ref)\r\n            } else if meta.formula==20{\r\n                format!(\"{}-{}\", parent1_ref, parent2_ref)\r\n            } else if meta.formula==40{\r\n                format!(\"{}*{}\", parent1_ref, parent2_ref)\r\n            } else if meta.formula==30{\r\n                format!(\"{}/{}\", parent1_ref, parent2_ref)\r\n            } else {\r\n                format!(\"{}\", meta.formula)\r\n            }\r\n            \r\n             \r\n        } else {\r\n            String::new()\r\n    }\r\n    } else {\r\n        String::new()\r\n    };\r\n\r\n\r\n    // Store in clipboard\r\n    state.clipboard = Some((state.cursor_row, state.cursor_col, cell_value, formula));\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n\r\n// Paste to the current cell\r\nfn paste_cell(sheet: \u0026mut Spreadsheet, state: \u0026mut EditorState) -\u003e CommandStatus {\r\n    if let Some((_row, _col, _value, formula)) = \u0026state.clipboard {\r\n        // Get the target cell reference\r\n        let cell_ref = state.cursor_to_cell_ref(sheet);\r\n\r\n        // If there's a formula, paste that\r\n        if !formula.is_empty() {\r\n            let command = format!(\"{}={}\", cell_ref, formula);\r\n            return evaluator::handle_command(sheet, \u0026command, \u0026mut 0.0);\r\n        } else {\r\n            // Otherwise paste the literal value\r\n            match _value {\r\n                crate::cell::CellValue::Integer(value) =\u003e {\r\n                    let command = format!(\"{}={}\", cell_ref, value);\r\n                    return evaluator::handle_command(sheet, \u0026command, \u0026mut 0.0);\r\n                }\r\n                crate::cell::CellValue::Error =\u003e {\r\n                    // Can't paste an error\r\n                    return CommandStatus::CmdUnrecognized;\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        // Nothing in clipboard\r\n        CommandStatus::CmdUnrecognized\r\n    }\r\n}\r\n","traces":[{"line":14,"address":[448208],"length":1,"stats":{"Line":0}},{"line":19,"address":[448276],"length":1,"stats":{"Line":0}},{"line":20,"address":[448311],"length":1,"stats":{"Line":0}},{"line":23,"address":[448321],"length":1,"stats":{"Line":0}},{"line":24,"address":[448358],"length":1,"stats":{"Line":0}},{"line":25,"address":[448389],"length":1,"stats":{"Line":0}},{"line":33,"address":[448416,449987],"length":1,"stats":{"Line":0}},{"line":42,"address":[448501],"length":1,"stats":{"Line":0}},{"line":43,"address":[448538],"length":1,"stats":{"Line":0}},{"line":48,"address":[448665],"length":1,"stats":{"Line":0}},{"line":49,"address":[448730],"length":1,"stats":{"Line":0}},{"line":53,"address":[448742],"length":1,"stats":{"Line":0}},{"line":54,"address":[448766],"length":1,"stats":{"Line":0}},{"line":57,"address":[448783],"length":1,"stats":{"Line":0}},{"line":58,"address":[448804],"length":1,"stats":{"Line":0}},{"line":59,"address":[448825],"length":1,"stats":{"Line":0}},{"line":61,"address":[448841],"length":1,"stats":{"Line":0}},{"line":62,"address":[448848],"length":1,"stats":{"Line":0}},{"line":69,"address":[448632],"length":1,"stats":{"Line":0}},{"line":71,"address":[448923],"length":1,"stats":{"Line":0}},{"line":74,"address":[448988,449083],"length":1,"stats":{"Line":0}},{"line":76,"address":[449244,449515,449152],"length":1,"stats":{"Line":0}},{"line":77,"address":[449367],"length":1,"stats":{"Line":0}},{"line":78,"address":[449211,449543],"length":1,"stats":{"Line":0}},{"line":79,"address":[449550],"length":1,"stats":{"Line":0}},{"line":81,"address":[449517],"length":1,"stats":{"Line":0}},{"line":84,"address":[449575],"length":1,"stats":{"Line":0}},{"line":85,"address":[449652,449734],"length":1,"stats":{"Line":0}},{"line":86,"address":[449886],"length":1,"stats":{"Line":0}},{"line":88,"address":[449679],"length":1,"stats":{"Line":0}},{"line":93,"address":[449050],"length":1,"stats":{"Line":0}},{"line":94,"address":[450123],"length":1,"stats":{"Line":0}},{"line":95,"address":[450130],"length":1,"stats":{"Line":0}},{"line":99,"address":[450047],"length":1,"stats":{"Line":0}},{"line":101,"address":[450238,450632],"length":1,"stats":{"Line":0}},{"line":102,"address":[450755],"length":1,"stats":{"Line":0}},{"line":104,"address":[450602],"length":1,"stats":{"Line":0}},{"line":107,"address":[450903],"length":1,"stats":{"Line":0}},{"line":108,"address":[451062,450980],"length":1,"stats":{"Line":0}},{"line":109,"address":[451214],"length":1,"stats":{"Line":0}},{"line":110,"address":[451268,451342],"length":1,"stats":{"Line":0}},{"line":111,"address":[451335],"length":1,"stats":{"Line":0}},{"line":113,"address":[451304],"length":1,"stats":{"Line":0}},{"line":116,"address":[451007],"length":1,"stats":{"Line":0}},{"line":121,"address":[450140],"length":1,"stats":{"Line":0}},{"line":122,"address":[450311],"length":1,"stats":{"Line":0}},{"line":123,"address":[450367],"length":1,"stats":{"Line":0}},{"line":125,"address":[450538,450436,450467],"length":1,"stats":{"Line":0}},{"line":126,"address":[450574],"length":1,"stats":{"Line":0}},{"line":128,"address":[450455],"length":1,"stats":{"Line":0}},{"line":131,"address":[450411],"length":1,"stats":{"Line":0}},{"line":137,"address":[448880],"length":1,"stats":{"Line":0}},{"line":138,"address":[448893],"length":1,"stats":{"Line":0}},{"line":139,"address":[448906],"length":1,"stats":{"Line":0}},{"line":143,"address":[454865,451424,454793],"length":1,"stats":{"Line":0}},{"line":144,"address":[451495],"length":1,"stats":{"Line":0}},{"line":147,"address":[451540],"length":1,"stats":{"Line":0}},{"line":153,"address":[451642],"length":1,"stats":{"Line":0}},{"line":154,"address":[451686],"length":1,"stats":{"Line":0}},{"line":158,"address":[451716],"length":1,"stats":{"Line":0}},{"line":161,"address":[451877,451810],"length":1,"stats":{"Line":0}},{"line":162,"address":[452035],"length":1,"stats":{"Line":0}},{"line":166,"address":[452257,452109],"length":1,"stats":{"Line":0}},{"line":167,"address":[452278,452336],"length":1,"stats":{"Line":0}},{"line":168,"address":[452455],"length":1,"stats":{"Line":0}},{"line":169,"address":[452501],"length":1,"stats":{"Line":0}},{"line":172,"address":[452532],"length":1,"stats":{"Line":0}},{"line":174,"address":[452563],"length":1,"stats":{"Line":0}},{"line":178,"address":[452579],"length":1,"stats":{"Line":0}},{"line":180,"address":[452615],"length":1,"stats":{"Line":0}},{"line":181,"address":[452651],"length":1,"stats":{"Line":0}},{"line":184,"address":[453018],"length":1,"stats":{"Line":0}},{"line":185,"address":[453031],"length":1,"stats":{"Line":0}},{"line":186,"address":[453059,453148],"length":1,"stats":{"Line":0}},{"line":189,"address":[453082,453306],"length":1,"stats":{"Line":0}},{"line":194,"address":[453282,453415],"length":1,"stats":{"Line":0}},{"line":195,"address":[453473],"length":1,"stats":{"Line":0}},{"line":197,"address":[453514],"length":1,"stats":{"Line":0}},{"line":198,"address":[453556,453615],"length":1,"stats":{"Line":0}},{"line":199,"address":[453639],"length":1,"stats":{"Line":0}},{"line":201,"address":[453536,453575],"length":1,"stats":{"Line":0}},{"line":204,"address":[453582],"length":1,"stats":{"Line":0}},{"line":205,"address":[454044,454151],"length":1,"stats":{"Line":0}},{"line":206,"address":[454175],"length":1,"stats":{"Line":0}},{"line":208,"address":[454104,454024],"length":1,"stats":{"Line":0}},{"line":211,"address":[454599,454111],"length":1,"stats":{"Line":0}},{"line":217,"address":[454818,453480],"length":1,"stats":{"Line":0}},{"line":222,"address":[452226],"length":1,"stats":{"Line":0}},{"line":226,"address":[454912,458749,459221],"length":1,"stats":{"Line":0}},{"line":227,"address":[454989],"length":1,"stats":{"Line":0}},{"line":230,"address":[455029],"length":1,"stats":{"Line":0}},{"line":231,"address":[455055],"length":1,"stats":{"Line":0}},{"line":232,"address":[455099],"length":1,"stats":{"Line":0}},{"line":236,"address":[455223,455129],"length":1,"stats":{"Line":0}},{"line":239,"address":[455231,455317,455488],"length":1,"stats":{"Line":0}},{"line":240,"address":[458810,455512],"length":1,"stats":{"Line":0}},{"line":241,"address":[458932],"length":1,"stats":{"Line":0}},{"line":243,"address":[458981],"length":1,"stats":{"Line":0}},{"line":244,"address":[459020],"length":1,"stats":{"Line":0}},{"line":247,"address":[459093],"length":1,"stats":{"Line":0}},{"line":249,"address":[459150],"length":1,"stats":{"Line":0}},{"line":250,"address":[459171],"length":1,"stats":{"Line":0}},{"line":256,"address":[455410,455708,455562,455658],"length":1,"stats":{"Line":0}},{"line":257,"address":[455756],"length":1,"stats":{"Line":0}},{"line":258,"address":[455835],"length":1,"stats":{"Line":0}},{"line":262,"address":[455911,456047],"length":1,"stats":{"Line":0}},{"line":263,"address":[456146,456085],"length":1,"stats":{"Line":0}},{"line":268,"address":[456152],"length":1,"stats":{"Line":0}},{"line":269,"address":[456212],"length":1,"stats":{"Line":0}},{"line":271,"address":[458232,456307],"length":1,"stats":{"Line":0}},{"line":273,"address":[458242],"length":1,"stats":{"Line":0}},{"line":274,"address":[458370],"length":1,"stats":{"Line":0}},{"line":276,"address":[458511],"length":1,"stats":{"Line":0}},{"line":277,"address":[458546],"length":1,"stats":{"Line":0}},{"line":281,"address":[456332,456266],"length":1,"stats":{"Line":0}},{"line":283,"address":[456349],"length":1,"stats":{"Line":0}},{"line":284,"address":[456396],"length":1,"stats":{"Line":0}},{"line":285,"address":[456478],"length":1,"stats":{"Line":0}},{"line":288,"address":[456568],"length":1,"stats":{"Line":0}},{"line":290,"address":[456796,456712],"length":1,"stats":{"Line":0}},{"line":291,"address":[456785],"length":1,"stats":{"Line":0}},{"line":293,"address":[456806,456754],"length":1,"stats":{"Line":0}},{"line":294,"address":[456852],"length":1,"stats":{"Line":0}},{"line":299,"address":[456908],"length":1,"stats":{"Line":0}},{"line":300,"address":[456953],"length":1,"stats":{"Line":0}},{"line":303,"address":[457038],"length":1,"stats":{"Line":0}},{"line":304,"address":[457151],"length":1,"stats":{"Line":0}},{"line":305,"address":[457300],"length":1,"stats":{"Line":0}},{"line":306,"address":[457390,457503],"length":1,"stats":{"Line":0}},{"line":308,"address":[457486],"length":1,"stats":{"Line":0}},{"line":310,"address":[457544,457612],"length":1,"stats":{"Line":0}},{"line":311,"address":[457622,457726,457759,457589,457707],"length":1,"stats":{"Line":0}},{"line":312,"address":[457699,457765,457718,457737],"length":1,"stats":{"Line":0}},{"line":314,"address":[457748],"length":1,"stats":{"Line":0}},{"line":317,"address":[457601],"length":1,"stats":{"Line":0}},{"line":320,"address":[457772,457856],"length":1,"stats":{"Line":0}},{"line":321,"address":[458003,457817,457970,457951,457866],"length":1,"stats":{"Line":0}},{"line":322,"address":[457943,457981,457962,458009],"length":1,"stats":{"Line":0}},{"line":324,"address":[457992],"length":1,"stats":{"Line":0}},{"line":327,"address":[457845],"length":1,"stats":{"Line":0}},{"line":331,"address":[458040],"length":1,"stats":{"Line":0}},{"line":332,"address":[229836,229824],"length":1,"stats":{"Line":0}},{"line":333,"address":[458162],"length":1,"stats":{"Line":0}},{"line":334,"address":[458167],"length":1,"stats":{"Line":0}},{"line":335,"address":[458176],"length":1,"stats":{"Line":0}},{"line":338,"address":[458186],"length":1,"stats":{"Line":0}},{"line":348,"address":[455796],"length":1,"stats":{"Line":0}},{"line":353,"address":[459280],"length":1,"stats":{"Line":0}},{"line":359,"address":[459313],"length":1,"stats":{"Line":0}},{"line":360,"address":[459362],"length":1,"stats":{"Line":0}},{"line":361,"address":[459380],"length":1,"stats":{"Line":0}},{"line":365,"address":[459396],"length":1,"stats":{"Line":0}},{"line":368,"address":[459415],"length":1,"stats":{"Line":0}},{"line":369,"address":[459455],"length":1,"stats":{"Line":0}},{"line":372,"address":[459436],"length":1,"stats":{"Line":0}},{"line":376,"address":[459488],"length":1,"stats":{"Line":0}},{"line":378,"address":[459512],"length":1,"stats":{"Line":0}},{"line":379,"address":[459521],"length":1,"stats":{"Line":0}},{"line":380,"address":[459717],"length":1,"stats":{"Line":0}},{"line":382,"address":[459556],"length":1,"stats":{"Line":0}},{"line":383,"address":[459573],"length":1,"stats":{"Line":0}},{"line":387,"address":[459590],"length":1,"stats":{"Line":0}},{"line":390,"address":[459650],"length":1,"stats":{"Line":0}},{"line":391,"address":[459670,459727],"length":1,"stats":{"Line":0}},{"line":392,"address":[459737],"length":1,"stats":{"Line":0}},{"line":393,"address":[459743],"length":1,"stats":{"Line":0}},{"line":394,"address":[459749],"length":1,"stats":{"Line":0}},{"line":398,"address":[459771],"length":1,"stats":{"Line":0}},{"line":399,"address":[459782],"length":1,"stats":{"Line":0}},{"line":403,"address":[459808,462114],"length":1,"stats":{"Line":0}},{"line":405,"address":[459844],"length":1,"stats":{"Line":0}},{"line":408,"address":[459908],"length":1,"stats":{"Line":0}},{"line":409,"address":[459939],"length":1,"stats":{"Line":0}},{"line":410,"address":[460002],"length":1,"stats":{"Line":0}},{"line":413,"address":[460040],"length":1,"stats":{"Line":0}},{"line":414,"address":[460255],"length":1,"stats":{"Line":0}},{"line":415,"address":[460297,460366],"length":1,"stats":{"Line":0}},{"line":417,"address":[460224],"length":1,"stats":{"Line":0}},{"line":420,"address":[460343],"length":1,"stats":{"Line":0}},{"line":421,"address":[460727,460822],"length":1,"stats":{"Line":0}},{"line":422,"address":[460846],"length":1,"stats":{"Line":0}},{"line":424,"address":[460710,460784],"length":1,"stats":{"Line":0}},{"line":427,"address":[460791],"length":1,"stats":{"Line":0}},{"line":428,"address":[461227,461311],"length":1,"stats":{"Line":0}},{"line":429,"address":[461239],"length":1,"stats":{"Line":0}},{"line":430,"address":[461464,461508],"length":1,"stats":{"Line":0}},{"line":431,"address":[461476],"length":1,"stats":{"Line":0}},{"line":432,"address":[461690,461646],"length":1,"stats":{"Line":0}},{"line":433,"address":[461658],"length":1,"stats":{"Line":0}},{"line":434,"address":[461878,461828],"length":1,"stats":{"Line":0}},{"line":436,"address":[462003,461840],"length":1,"stats":{"Line":0}},{"line":441,"address":[460023],"length":1,"stats":{"Line":0}},{"line":444,"address":[460011],"length":1,"stats":{"Line":0}},{"line":449,"address":[460067,462141],"length":1,"stats":{"Line":0}},{"line":451,"address":[462214],"length":1,"stats":{"Line":0}},{"line":456,"address":[462240,462788,463129],"length":1,"stats":{"Line":0}},{"line":457,"address":[462409,462273],"length":1,"stats":{"Line":0}},{"line":459,"address":[462383],"length":1,"stats":{"Line":0}},{"line":462,"address":[462455,462388],"length":1,"stats":{"Line":0}},{"line":463,"address":[462474,462516],"length":1,"stats":{"Line":0}},{"line":464,"address":[462647,462719],"length":1,"stats":{"Line":0}},{"line":467,"address":[462486],"length":1,"stats":{"Line":0}},{"line":468,"address":[462802],"length":1,"stats":{"Line":0}},{"line":469,"address":[462827,462857],"length":1,"stats":{"Line":0}},{"line":470,"address":[462988,463060],"length":1,"stats":{"Line":0}},{"line":474,"address":[462834],"length":1,"stats":{"Line":0}},{"line":480,"address":[462404],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":207},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","vim_mode","editor.rs"],"content":"// vim_mode/editor.rs\r\nuse crate::cell::CellValue;\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\nuse std::io::{self, Write};\r\n\r\n// Define editor modes\r\n#[derive(Debug, Clone, Copy, PartialEq)]\r\npub enum EditorMode {\r\n    Normal,\r\n    Insert,\r\n    \r\n}\r\n\r\n// Editor state structure\r\npub struct EditorState {\r\n    pub mode: EditorMode,\r\n    pub cursor_row: i16,\r\n    pub cursor_col: i16,\r\n    pub clipboard: Option\u003c(i16, i16, CellValue, String)\u003e, // (row, col, value, formula)\r\n    pub should_quit: bool,\r\n    pub save_file: Option\u003cString\u003e,\r\n    // Command history\r\n    pub command_history: Vec\u003cString\u003e,\r\n    pub history_position: usize,\r\n    pub current_input: String,\r\n    pub command_buffer: String,\r\n}\r\n\r\nimpl EditorState {\r\n    pub fn new() -\u003e Self {\r\n        EditorState {\r\n            mode: EditorMode::Normal,\r\n            cursor_row: 0,\r\n            cursor_col: 0,\r\n            clipboard: None,\r\n            should_quit: false,\r\n            save_file: None,\r\n            command_history: Vec::new(),\r\n            history_position: 0,\r\n            current_input: String::new(),\r\n            command_buffer: String::new(),\r\n        }\r\n    }\r\n\r\n    pub fn mode_display(\u0026self) -\u003e \u0026str {\r\n        match self.mode {\r\n            EditorMode::Normal =\u003e \"NORMAL\",\r\n            EditorMode::Insert =\u003e \"INSERT\",\r\n            \r\n        }\r\n    }\r\n\r\n  \r\n\r\n    // Move cursor in the specified direction\r\n    pub fn move_cursor(\u0026mut self, direction: char, sheet: \u0026mut Spreadsheet) {\r\n        match direction {\r\n            'h' =\u003e {\r\n                if self.cursor_col \u003e 0 {\r\n                    self.cursor_col -= 1\r\n                }\r\n            }\r\n            'j' =\u003e {\r\n                if self.cursor_row \u003c sheet.rows - 1 {\r\n                    self.cursor_row += 1\r\n                }\r\n            }\r\n            'k' =\u003e {\r\n                if self.cursor_row \u003e 0 {\r\n                    self.cursor_row -= 1\r\n                }\r\n            } // Fixed 'k' from 'u'\r\n            'l' =\u003e {\r\n                if self.cursor_col \u003c sheet.cols - 1 {\r\n                    self.cursor_col += 1\r\n                }\r\n            }\r\n            _ =\u003e {}\r\n        }\r\n\r\n        // Ensure viewport contains cursor\r\n        self.adjust_viewport(sheet);\r\n    }\r\n    pub fn add_to_history(\u0026mut self, command: \u0026str) {\r\n        // Don't add empty commands or duplicates of the most recent command\r\n        if command.trim().is_empty()\r\n            || (self\r\n                .command_history\r\n                .last()\r\n                .map_or(false, |last| last == command))\r\n        {\r\n            return;\r\n        }\r\n\r\n        self.command_history.push(command.to_string());\r\n        self.history_position = self.command_history.len();\r\n    }\r\n\r\n    // Navigate through command history\r\n    pub fn navigate_history(\u0026mut self, direction: \u0026str) -\u003e String {\r\n        // If navigating history for the first time, save current input\r\n        if self.history_position == self.command_history.len() \u0026\u0026 direction == \"up\" {\r\n            self.current_input = self.command_buffer.clone();\r\n        }\r\n\r\n        match direction {\r\n            \"up\" =\u003e {\r\n                if self.history_position \u003e 0 {\r\n                    self.history_position -= 1;\r\n                    self.command_history\r\n                        .get(self.history_position)\r\n                        .unwrap_or(\u0026String::new())\r\n                        .clone()\r\n                } else {\r\n                    self.command_history\r\n                        .get(0)\r\n                        .unwrap_or(\u0026String::new())\r\n                        .clone()\r\n                }\r\n            }\r\n            \"down\" =\u003e {\r\n                if self.history_position \u003c self.command_history.len() - 1 {\r\n                    self.history_position += 1;\r\n                    self.command_history\r\n                        .get(self.history_position)\r\n                        .unwrap_or(\u0026String::new())\r\n                        .clone()\r\n                } else {\r\n                    self.history_position = self.command_history.len();\r\n                    self.current_input.clone()\r\n                }\r\n            }\r\n            _ =\u003e String::new(),\r\n        }\r\n    }\r\n\r\n\r\n\r\n    // Adjust spreadsheet viewport to contain cursor\r\n    pub fn adjust_viewport(\u0026self, sheet: \u0026mut Spreadsheet) {\r\n        const VIEWPORT_SIZE: i16 = 10;\r\n\r\n        // Adjust viewport row if cursor is outside\r\n        if self.cursor_row \u003c sheet.viewport_row {\r\n            sheet.viewport_row = self.cursor_row;\r\n        } else if self.cursor_row \u003e= sheet.viewport_row + VIEWPORT_SIZE {\r\n            sheet.viewport_row = self.cursor_row - VIEWPORT_SIZE + 1;\r\n            if sheet.viewport_row \u003c 0 {\r\n                sheet.viewport_row = 0;\r\n            }\r\n        }\r\n\r\n        // Adjust viewport column if cursor is outside\r\n        if self.cursor_col \u003c sheet.viewport_col {\r\n            sheet.viewport_col = self.cursor_col;\r\n        } else if self.cursor_col \u003e= sheet.viewport_col + VIEWPORT_SIZE {\r\n            sheet.viewport_col = self.cursor_col - VIEWPORT_SIZE + 1;\r\n            if sheet.viewport_col \u003c 0 {\r\n                sheet.viewport_col = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Custom rendering function for vim mode\r\n    pub fn render_spreadsheet(\u0026self, sheet: \u0026Spreadsheet) {\r\n        // Clear screen\r\n        print!(\"\\x1B[2J\\x1B[1;1H\");\r\n\r\n        // Calculate visible area\r\n        let start_row = sheet.viewport_row;\r\n        let start_col = sheet.viewport_col;\r\n        let end_row = std::cmp::min(start_row + 10, sheet.rows);\r\n        let end_col = std::cmp::min(start_col + 10, sheet.cols);\r\n\r\n        // Print column headers only once\r\n        print!(\"     \");\r\n        for col in start_col..end_col {\r\n            print!(\"{:\u003c8} \", sheet.get_column_name(col));\r\n        }\r\n        println!();\r\n\r\n        // Print rows with data\r\n        for row in start_row..end_row {\r\n            print!(\"{:\u003c4} \", row + 1); // Show 1-based row numbers\r\n\r\n            for col in start_col..end_col {\r\n                let cell_value = sheet.get_cell(row, col);\r\n\r\n                // Highlight the cell under the cursor\r\n                if row == self.cursor_row \u0026\u0026 col == self.cursor_col {\r\n                    print!(\"\\x1B[7m\"); // Invert colors\r\n                    match cell_value {\r\n                        CellValue::Integer(value) =\u003e print!(\"{:\u003c8}\", value),\r\n                        CellValue::Error =\u003e print!(\"{:\u003c8}\", \"ERR\"),\r\n                    }\r\n                    print!(\"\\x1B[0m \"); // Reset colors\r\n                } else {\r\n                    match cell_value {\r\n                        CellValue::Integer(value) =\u003e print!(\"{:\u003c8} \", value),\r\n                        CellValue::Error =\u003e print!(\"{:\u003c8} \", \"ERR\"),\r\n                    }\r\n                }\r\n            }\r\n            println!();\r\n        }\r\n\r\n        // Display status bar\r\n        let col_letter = sheet.get_column_name(self.cursor_col);\r\n        let cell_ref = format!(\"{}{}\", col_letter, self.cursor_row + 1);\r\n\r\n        // Get formula for current cell (if exists)\r\n        let cell_key = sheet.get_key(self.cursor_row, self.cursor_col);\r\n        let formula_str = if let Some(meta) = sheet.cell_meta.get(\u0026cell_key) {\r\n            \r\n                if meta.formula != 0 {\r\n                    // Get the parent cells as references\r\n               //get the parents , and the formula code converted to the actual operation\r\n                    let parent1_ref = if meta.parent1 != -1 {\r\n                        let (p1_row, p1_col) = sheet.get_row_col(meta.parent1);\r\n                        format!(\"{}{}\", sheet.get_column_name(p1_col), p1_row + 1)\r\n                    } else {\r\n                        String::from(\"\")\r\n                    };\r\n                    \r\n                    let parent2_ref = if meta.parent2 != -1 {\r\n                        let (p2_row, p2_col) = sheet.get_row_col(meta.parent2);\r\n                        format!(\"{}{}\", sheet.get_column_name(p2_col), p2_row + 1)\r\n                    } else {\r\n                        String::from(\"\")\r\n                    };\r\n                    // Convert formula code to string\r\n                    if meta.formula==10{\r\n                        format!(\"{}+{}\", parent1_ref, parent2_ref)\r\n                    } else if meta.formula==20{\r\n                        format!(\"{}-{}\", parent1_ref, parent2_ref)\r\n                    } else if meta.formula==40{\r\n                        format!(\"{}*{}\", parent1_ref, parent2_ref)\r\n                    } else if meta.formula==30{\r\n                        format!(\"{}/{}\", parent1_ref, parent2_ref)\r\n                    } else {\r\n                        let (row, col) = sheet.get_row_col(cell_key);\r\n                        format!(\"{:?}\", sheet.get_cell(row,col))\r\n                    }\r\n                    \r\n        \r\n                \r\n            } else {\r\n                \"\".to_string()\r\n            }\r\n        } else {\r\n            \"\".to_string()\r\n        };\r\n\r\n        println!(\"\\nCursor at: {} - {}\", cell_ref, formula_str);\r\n\r\n        // Display mode\r\n        println!(\r\n            \"Mode: {} | Use hjkl to navigate, i to insert, Esc to exit insert mode\",\r\n            self.mode_display()\r\n        );\r\n\r\n        // If clipboard has content, show it\r\n        if let Some((_, _, value, formula)) = \u0026self.clipboard {\r\n            println!(\"Clipboard: {:?}\", value);\r\n            if !formula.is_empty() {\r\n                println!(\"Formula: {:?}\", formula);\r\n            }\r\n        }\r\n\r\n        io::stdout().flush().unwrap();\r\n    }\r\n\r\n    // Set the value of the cell at the cursor\r\n    pub fn set_cursor_cell_value(\u0026self, sheet: \u0026mut Spreadsheet, value: \u0026str) -\u003e CommandStatus {\r\n        let cell_ref = self.cursor_to_cell_ref(sheet);\r\n        let command = format!(\"{}={}\", cell_ref, value);\r\n        let mut sleep_time = 0.0;\r\n        crate::evaluator::handle_command(sheet, \u0026command, \u0026mut sleep_time)\r\n    }\r\n\r\n    // Convert cursor position to cell reference string (e.g., \"A1\")\r\n    pub fn cursor_to_cell_ref(\u0026self, sheet: \u0026Spreadsheet) -\u003e String {\r\n        let col_letter = sheet.get_column_name(self.cursor_col);\r\n        format!(\"{}{}\", col_letter, self.cursor_row + 1)\r\n    }\r\n}\r\n","traces":[{"line":30,"address":[230339,229920,230318],"length":1,"stats":{"Line":0}},{"line":38,"address":[229967],"length":1,"stats":{"Line":0}},{"line":40,"address":[230016],"length":1,"stats":{"Line":0}},{"line":41,"address":[230065],"length":1,"stats":{"Line":0}},{"line":45,"address":[230352],"length":1,"stats":{"Line":0}},{"line":46,"address":[230357],"length":1,"stats":{"Line":0}},{"line":47,"address":[230374],"length":1,"stats":{"Line":0}},{"line":48,"address":[230397],"length":1,"stats":{"Line":0}},{"line":56,"address":[230432],"length":1,"stats":{"Line":0}},{"line":57,"address":[230462],"length":1,"stats":{"Line":0}},{"line":59,"address":[230523,230710],"length":1,"stats":{"Line":0}},{"line":60,"address":[230715,230671],"length":1,"stats":{"Line":0}},{"line":64,"address":[230741,230549,230811],"length":1,"stats":{"Line":0}},{"line":65,"address":[230816,230772],"length":1,"stats":{"Line":0}},{"line":69,"address":[230876,230597],"length":1,"stats":{"Line":0}},{"line":70,"address":[230881,230837],"length":1,"stats":{"Line":0}},{"line":74,"address":[230623,230977,230907],"length":1,"stats":{"Line":0}},{"line":75,"address":[230938,230982],"length":1,"stats":{"Line":0}},{"line":82,"address":[230508],"length":1,"stats":{"Line":0}},{"line":84,"address":[231008],"length":1,"stats":{"Line":0}},{"line":86,"address":[231031],"length":1,"stats":{"Line":0}},{"line":87,"address":[231065],"length":1,"stats":{"Line":0}},{"line":90,"address":[487136,487150],"length":1,"stats":{"Line":0}},{"line":95,"address":[231107],"length":1,"stats":{"Line":0}},{"line":96,"address":[231152],"length":1,"stats":{"Line":0}},{"line":100,"address":[231184,231918],"length":1,"stats":{"Line":0}},{"line":102,"address":[231500,231241,231323],"length":1,"stats":{"Line":0}},{"line":103,"address":[231354],"length":1,"stats":{"Line":0}},{"line":107,"address":[231277],"length":1,"stats":{"Line":0}},{"line":108,"address":[231549],"length":1,"stats":{"Line":0}},{"line":109,"address":[232135,232015,232215],"length":1,"stats":{"Line":0}},{"line":110,"address":[232142,232203,232281,232165],"length":1,"stats":{"Line":0}},{"line":111,"address":[232158],"length":1,"stats":{"Line":0}},{"line":112,"address":[232188],"length":1,"stats":{"Line":0}},{"line":115,"address":[231945,231998,232096],"length":1,"stats":{"Line":0}},{"line":117,"address":[231983],"length":1,"stats":{"Line":0}},{"line":121,"address":[231505],"length":1,"stats":{"Line":0}},{"line":122,"address":[231648,231585],"length":1,"stats":{"Line":0}},{"line":123,"address":[231715,231826],"length":1,"stats":{"Line":0}},{"line":124,"address":[231814,231753,231889,231776],"length":1,"stats":{"Line":0}},{"line":125,"address":[231769],"length":1,"stats":{"Line":0}},{"line":126,"address":[231799],"length":1,"stats":{"Line":0}},{"line":129,"address":[231676],"length":1,"stats":{"Line":0}},{"line":130,"address":[231698],"length":1,"stats":{"Line":0}},{"line":133,"address":[231573],"length":1,"stats":{"Line":0}},{"line":140,"address":[232320],"length":1,"stats":{"Line":0}},{"line":144,"address":[232431,232344],"length":1,"stats":{"Line":0}},{"line":145,"address":[232417],"length":1,"stats":{"Line":0}},{"line":146,"address":[232370,232443],"length":1,"stats":{"Line":0}},{"line":147,"address":[232599,232506],"length":1,"stats":{"Line":0}},{"line":148,"address":[232584,232629],"length":1,"stats":{"Line":0}},{"line":149,"address":[232620],"length":1,"stats":{"Line":0}},{"line":154,"address":[232705,232476],"length":1,"stats":{"Line":0}},{"line":155,"address":[232691],"length":1,"stats":{"Line":0}},{"line":156,"address":[232644,232717],"length":1,"stats":{"Line":0}},{"line":157,"address":[232750,232840],"length":1,"stats":{"Line":0}},{"line":158,"address":[232870,232828],"length":1,"stats":{"Line":0}},{"line":159,"address":[232861],"length":1,"stats":{"Line":0}},{"line":165,"address":[236217,236948,232880],"length":1,"stats":{"Line":0}},{"line":167,"address":[232919],"length":1,"stats":{"Line":0}},{"line":170,"address":[232962],"length":1,"stats":{"Line":0}},{"line":171,"address":[232985],"length":1,"stats":{"Line":0}},{"line":172,"address":[233110,233008],"length":1,"stats":{"Line":0}},{"line":173,"address":[233085,233142,233253],"length":1,"stats":{"Line":0}},{"line":176,"address":[233173],"length":1,"stats":{"Line":0}},{"line":177,"address":[233408,233224,233269],"length":1,"stats":{"Line":0}},{"line":178,"address":[233400,233435,238788],"length":1,"stats":{"Line":0}},{"line":180,"address":[233312],"length":1,"stats":{"Line":0}},{"line":183,"address":[233576,233363,233466],"length":1,"stats":{"Line":0}},{"line":184,"address":[236969,237300,233600],"length":1,"stats":{"Line":0}},{"line":186,"address":[237271,237316,237415],"length":1,"stats":{"Line":0}},{"line":187,"address":[237436],"length":1,"stats":{"Line":0}},{"line":190,"address":[237479,237519],"length":1,"stats":{"Line":0}},{"line":191,"address":[237528],"length":1,"stats":{"Line":0}},{"line":192,"address":[237568],"length":1,"stats":{"Line":0}},{"line":193,"address":[238172],"length":1,"stats":{"Line":0}},{"line":194,"address":[238465],"length":1,"stats":{"Line":0}},{"line":196,"address":[238740],"length":1,"stats":{"Line":0}},{"line":198,"address":[237493],"length":1,"stats":{"Line":0}},{"line":199,"address":[237590],"length":1,"stats":{"Line":0}},{"line":200,"address":[237885],"length":1,"stats":{"Line":0}},{"line":204,"address":[237359],"length":1,"stats":{"Line":0}},{"line":208,"address":[233525],"length":1,"stats":{"Line":0}},{"line":209,"address":[233569,233675],"length":1,"stats":{"Line":0}},{"line":212,"address":[233973,233891],"length":1,"stats":{"Line":0}},{"line":213,"address":[233980],"length":1,"stats":{"Line":0}},{"line":215,"address":[234073],"length":1,"stats":{"Line":0}},{"line":218,"address":[234138],"length":1,"stats":{"Line":0}},{"line":219,"address":[234210,234269],"length":1,"stats":{"Line":0}},{"line":220,"address":[234293],"length":1,"stats":{"Line":0}},{"line":222,"address":[234190,234229],"length":1,"stats":{"Line":0}},{"line":225,"address":[234236],"length":1,"stats":{"Line":0}},{"line":226,"address":[234799,234698],"length":1,"stats":{"Line":0}},{"line":227,"address":[234823],"length":1,"stats":{"Line":0}},{"line":229,"address":[234758,234678],"length":1,"stats":{"Line":0}},{"line":232,"address":[234765],"length":1,"stats":{"Line":0}},{"line":233,"address":[235291,235207],"length":1,"stats":{"Line":0}},{"line":234,"address":[235219],"length":1,"stats":{"Line":0}},{"line":235,"address":[235494,235450],"length":1,"stats":{"Line":0}},{"line":236,"address":[235462],"length":1,"stats":{"Line":0}},{"line":237,"address":[235638,235682],"length":1,"stats":{"Line":0}},{"line":238,"address":[235650],"length":1,"stats":{"Line":0}},{"line":239,"address":[235826,235884],"length":1,"stats":{"Line":0}},{"line":241,"address":[235841,236030],"length":1,"stats":{"Line":0}},{"line":242,"address":[236046],"length":1,"stats":{"Line":0}},{"line":248,"address":[234126,234145],"length":1,"stats":{"Line":0}},{"line":251,"address":[234099,236226],"length":1,"stats":{"Line":0}},{"line":254,"address":[234163,236287],"length":1,"stats":{"Line":0}},{"line":257,"address":[236446],"length":1,"stats":{"Line":0}},{"line":263,"address":[236532],"length":1,"stats":{"Line":0}},{"line":264,"address":[236642,236616],"length":1,"stats":{"Line":0}},{"line":265,"address":[236713],"length":1,"stats":{"Line":0}},{"line":266,"address":[236758],"length":1,"stats":{"Line":0}},{"line":270,"address":[236846,236623],"length":1,"stats":{"Line":0}},{"line":274,"address":[239104,239489],"length":1,"stats":{"Line":0}},{"line":275,"address":[239161],"length":1,"stats":{"Line":0}},{"line":276,"address":[239236,239179],"length":1,"stats":{"Line":0}},{"line":277,"address":[239350],"length":1,"stats":{"Line":0}},{"line":278,"address":[239444,239367],"length":1,"stats":{"Line":0}},{"line":282,"address":[239520,239857],"length":1,"stats":{"Line":0}},{"line":283,"address":[239571],"length":1,"stats":{"Line":0}},{"line":284,"address":[239655,239606],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":122},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","vim_mode","mod.rs"],"content":"mod commands;\r\nmod editor;\r\n\r\nuse crate::spreadsheet::Spreadsheet;\r\nuse std::io::{self, Write};\r\n\r\npub fn run_editor(sheet: \u0026mut Spreadsheet, filename: Option\u003cString\u003e) {\r\n    // Initialize vim mode editor state\r\n    let mut editor_state = editor::EditorState::new();\r\n\r\n    // If a filename was provided, load it and set it as saved file\r\n    if let Some(file) = filename {\r\n        editor_state.save_file = Some(file.clone());\r\n        let _ = commands::load_spreadsheet(sheet, \u0026file);\r\n    }\r\n\r\n    // Main editor loop\r\n    loop {\r\n        // Render the spreadsheet with cursor\r\n        editor_state.render_spreadsheet(sheet);\r\n\r\n        // Show command prompt\r\n        print!(\"{} \u003e \", editor_state.mode_display());\r\n        io::stdout().flush().unwrap();\r\n\r\n        // Get user input\r\n        let mut input = String::with_capacity(128);\r\n        if io::stdin().read_line(\u0026mut input).unwrap() == 0 {\r\n            break; // End of input\r\n        }\r\n\r\n        let trimmed = input.trim();\r\n        \r\n        // Handle command history navigation keys\r\n        if trimmed == \"\\x10\" {  // Ctrl+P for previous command\r\n            if !editor_state.command_history.is_empty() {\r\n                let prev_cmd = editor_state.navigate_history(\"up\");\r\n                // Print the previous command on a new line for the user to see/copy\r\n                println!(\"\\n[history] {}\", prev_cmd);\r\n            }\r\n            continue;\r\n        } else if trimmed == \"\\x0e\" {  // Ctrl+N for next command\r\n            let next_cmd = editor_state.navigate_history(\"down\");\r\n            // Print the next command on a new line for the user to see/copy\r\n            println!(\"\\n[history] {}\", next_cmd);\r\n            continue;\r\n        } else {\r\n            // For regular commands, use the input as is\r\n            editor_state.command_buffer = trimmed.to_string();\r\n        }\r\n\r\n        // Handle special command to exit vim mode\r\n        if trimmed == \":q!\" {\r\n            break;\r\n        }\r\n\r\n        // Process the command - note that history is now handled inside handle_vim_command\r\n        let _ = commands::handle_vim_command(sheet, trimmed, \u0026mut editor_state);\r\n\r\n        // Handle special case for Esc key in terminal\r\n        if trimmed == \"\\x1b\" \u0026\u0026 editor_state.mode == editor::EditorMode::Insert {\r\n            editor_state.mode = editor::EditorMode::Normal;\r\n        }\r\n\r\n        // Check for quit command\r\n        if editor_state.should_quit {\r\n            break;\r\n        }\r\n    }\r\n}","traces":[{"line":7,"address":[215104,216547,214544],"length":1,"stats":{"Line":0}},{"line":9,"address":[214572],"length":1,"stats":{"Line":0}},{"line":12,"address":[214680],"length":1,"stats":{"Line":0}},{"line":13,"address":[214751,214841],"length":1,"stats":{"Line":0}},{"line":14,"address":[215007],"length":1,"stats":{"Line":0}},{"line":20,"address":[214791],"length":1,"stats":{"Line":0}},{"line":23,"address":[215121],"length":1,"stats":{"Line":0}},{"line":24,"address":[215258],"length":1,"stats":{"Line":0}},{"line":27,"address":[215343],"length":1,"stats":{"Line":0}},{"line":28,"address":[215350,215411],"length":1,"stats":{"Line":0}},{"line":32,"address":[215522],"length":1,"stats":{"Line":0}},{"line":35,"address":[215592],"length":1,"stats":{"Line":0}},{"line":36,"address":[215662,216344],"length":1,"stats":{"Line":0}},{"line":37,"address":[216350],"length":1,"stats":{"Line":0}},{"line":39,"address":[216401,216448],"length":1,"stats":{"Line":0}},{"line":42,"address":[215680,215628],"length":1,"stats":{"Line":0}},{"line":43,"address":[215717],"length":1,"stats":{"Line":0}},{"line":45,"address":[216189,216236],"length":1,"stats":{"Line":0}},{"line":49,"address":[215686,215755],"length":1,"stats":{"Line":0}},{"line":53,"address":[215879],"length":1,"stats":{"Line":0}},{"line":58,"address":[215924],"length":1,"stats":{"Line":0}},{"line":61,"address":[215955,216007,216067],"length":1,"stats":{"Line":0}},{"line":62,"address":[216043],"length":1,"stats":{"Line":0}},{"line":66,"address":[215991],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":24},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","visualize_cells.rs"],"content":"use crate::cell::CellValue;\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\nuse petgraph::{\r\n    dot::{Config, Dot},\r\n    graph::{DiGraph, NodeIndex},\r\n};\r\nuse std::collections::{HashMap, HashSet};\r\nuse std::{fs::File, io::Write, process::Command};\r\n\r\npub fn visualize_cell_relationships(\r\n    spreadsheet: \u0026Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n) -\u003e CommandStatus {\r\n    // ...move the entire body of the function from spreadsheet.rs here, replacing `spreadsheet` with `spreadsheet`...\r\n    if row \u003c 0 || row \u003e= spreadsheet.rows || col \u003c 0 || col \u003e= spreadsheet.cols {\r\n        return CommandStatus::CmdInvalidCell;\r\n    }\r\n\r\n    // Get the cell key\r\n    let cell_key = spreadsheet.get_key(row, col);\r\n\r\n    // Create a directed graph for visualization\r\n    let mut graph = DiGraph::\u003cString, \u0026str\u003e::new();\r\n    let mut node_indices = HashMap::new();\r\n\r\n    // Function to get formatted cell name\r\n    let get_cell_label = |key: i32| -\u003e String {\r\n        let (r, c) = spreadsheet.get_row_col(key);\r\n        let col_name = spreadsheet.get_column_name(c);\r\n        format!(\r\n            \"{}{} ({})\",\r\n            col_name,\r\n            r + 1,\r\n            match spreadsheet.grid[key as usize] {\r\n                CellValue::Integer(val) =\u003e val.to_string(),\r\n                CellValue::Error =\u003e \"ERROR\".to_string(),\r\n            }\r\n        )\r\n    };\r\n\r\n    // Add the target cell to the graph\r\n    let target_label = get_cell_label(cell_key);\r\n    let target_node = graph.add_node(target_label.clone());\r\n    node_indices.insert(cell_key, target_node);\r\n\r\n    // Helper function to process relationships\r\n    fn process_relationships(\r\n        spreadsheet: \u0026Spreadsheet,\r\n        start_key: i32,\r\n        is_parent_direction: bool,\r\n        processed: \u0026mut HashSet\u003ci32\u003e,\r\n        depth_limit: usize,\r\n        graph: \u0026mut DiGraph\u003cString, \u0026str\u003e,\r\n        node_indices: \u0026mut HashMap\u003ci32, NodeIndex\u003e,\r\n        get_cell_label: \u0026dyn Fn(i32) -\u003e String,\r\n    ) {\r\n        if !processed.insert(start_key) {\r\n            return; // Already processed this cell\r\n        }\r\n\r\n        // Add appropriate relationships based on direction\r\n        if is_parent_direction {\r\n            // Add parents - traverse up the dependency tree\r\n            if let Some(meta) = spreadsheet.cell_meta.get(\u0026start_key) {\r\n                for parent_key in [meta.parent1, meta.parent2].iter().filter(|\u0026\u0026k| k \u003e= 0) {\r\n                    // Create parent node if it doesn't exist\r\n                    let parent_idx = if let Some(\u0026idx) = node_indices.get(parent_key) {\r\n                        idx\r\n                    } else {\r\n                        let parent_label = get_cell_label(*parent_key);\r\n                        let idx = graph.add_node(parent_label);\r\n                        node_indices.insert(*parent_key, idx);\r\n                        idx\r\n                    };\r\n\r\n                    // Add edge from parent to child\r\n                    let child_idx = node_indices[\u0026start_key];\r\n                    graph.add_edge(parent_idx, child_idx, \"depends on\");\r\n\r\n                    // Recurse for this parent (up to the depth limit)\r\n                    if processed.len() \u003c depth_limit {\r\n                        process_relationships(\r\n                            spreadsheet,\r\n                            *parent_key,\r\n                            true,\r\n                            processed,\r\n                            depth_limit,\r\n                            graph,\r\n                            node_indices,\r\n                            get_cell_label,\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            // Add children - traverse down the dependency tree\r\n            if let Some(children) = spreadsheet.get_cell_children(start_key) {\r\n                for \u0026child_key in children {\r\n                    // Create child node if it doesn't exist\r\n                    let child_idx = if let Some(\u0026idx) = node_indices.get(\u0026child_key) {\r\n                        idx\r\n                    } else {\r\n                        let child_label = get_cell_label(child_key);\r\n                        let idx = graph.add_node(child_label);\r\n                        node_indices.insert(child_key, idx);\r\n                        idx\r\n                    };\r\n\r\n                    // Add edge from parent to child\r\n                    let parent_idx = node_indices[\u0026start_key];\r\n                    graph.add_edge(parent_idx, child_idx, \"used by\");\r\n\r\n                    // Recurse for this child (up to the depth limit)\r\n                    if processed.len() \u003c depth_limit {\r\n                        process_relationships(\r\n                            spreadsheet,\r\n                            child_key,\r\n                            false,\r\n                            processed,\r\n                            depth_limit,\r\n                            graph,\r\n                            node_indices,\r\n                            get_cell_label,\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Process parents (upward traversal)\r\n    let mut processed = HashSet::new();\r\n    // Mark target cell as processed\r\n    process_relationships(\r\n        spreadsheet,\r\n        cell_key,\r\n        true,\r\n        \u0026mut processed,\r\n        20,\r\n        \u0026mut graph,\r\n        \u0026mut node_indices,\r\n        \u0026get_cell_label,\r\n    );\r\n\r\n    // Process children (downward traversal)\r\n    let mut processed = HashSet::new();\r\n    // Mark target cell as processed\r\n    process_relationships(\r\n        spreadsheet,\r\n        cell_key,\r\n        false,\r\n        \u0026mut processed,\r\n        20,\r\n        \u0026mut graph,\r\n        \u0026mut node_indices,\r\n        \u0026get_cell_label,\r\n    );\r\n\r\n    // Generate DOT format\r\n    let dot = Dot::with_config(\u0026graph, \u0026[Config::EdgeNoLabel]);\r\n\r\n    // Save to temp file\r\n    let temp_file = format!(\"cell_{}_{}_relationships.dot\", row, col);\r\n    let mut file = match File::create(\u0026temp_file) {\r\n        Ok(file) =\u003e file,\r\n        Err(e) =\u003e {\r\n            eprintln!(\"Failed to create dot file: {}\", e);\r\n            return CommandStatus::CmdOk;\r\n        }\r\n    };\r\n\r\n    if let Err(e) = writeln!(file, \"{:?}\", dot) {\r\n        eprintln!(\"Failed to write to dot file: {}\", e);\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    println!(\"Cell relationships saved to {}\", temp_file);\r\n\r\n    // Attempt to render with Graphviz if available\r\n    let output_file = format!(\"cell_{}_{}_relationships.png\", row, col);\r\n    match Command::new(\"dot\")\r\n        .args([\"-Tpng\", \u0026temp_file, \"-o\", \u0026output_file])\r\n        .output()\r\n    {\r\n        Ok(_) =\u003e {\r\n            println!(\"Cell relationship diagram generated as {}\", output_file);\r\n            // Try to open the image with the default viewer\r\n            #[cfg(target_os = \"windows\")]\r\n            let _ = Command::new(\"cmd\").args([\"/C\", \u0026output_file]).spawn();\r\n\r\n            #[cfg(target_os = \"macos\")]\r\n            let _ = Command::new(\"open\").arg(\u0026output_file).spawn();\r\n\r\n            #[cfg(target_os = \"linux\")]\r\n            let _ = Command::new(\"xdg-open\").arg(\u0026output_file).spawn();\r\n        }\r\n        Err(_) =\u003e {\r\n            println!(\"Graphviz not found. You can manually convert the .dot file to an image.\");\r\n            println!(\"For instance: dot -Tpng {} -o {}\", temp_file, output_file);\r\n        }\r\n    }\r\n\r\n    // Print textual representation of the relationships\r\n    println!(\"\\nCell {}{}:\", spreadsheet.get_column_name(col), row + 1);\r\n\r\n    // Show parents\r\n    if let Some(meta) = spreadsheet.cell_meta.get(\u0026cell_key) {\r\n        println!(\"  Parents:\");\r\n        let mut has_parents = false;\r\n\r\n        for parent_key in [meta.parent1, meta.parent2].iter().filter(|\u0026\u0026k| k \u003e= 0) {\r\n            has_parents = true;\r\n            let (r, c) = spreadsheet.get_row_col(*parent_key);\r\n            println!(\r\n                \"    - {}{}: {}\",\r\n                spreadsheet.get_column_name(c),\r\n                r + 1,\r\n                match spreadsheet.grid[*parent_key as usize] {\r\n                    CellValue::Integer(val) =\u003e val.to_string(),\r\n                    CellValue::Error =\u003e \"ERROR\".to_string(),\r\n                }\r\n            );\r\n        }\r\n\r\n        if !has_parents {\r\n            println!(\"    (none)\");\r\n        }\r\n    }\r\n\r\n    // Show children\r\n    println!(\"  Children:\");\r\n    if let Some(children) = spreadsheet.get_cell_children(cell_key) {\r\n        if !children.is_empty() {\r\n            for \u0026child_key in children {\r\n                let (r, c) = spreadsheet.get_row_col(child_key);\r\n                println!(\r\n                    \"    - {}{}: {}\",\r\n                    spreadsheet.get_column_name(c),\r\n                    r + 1,\r\n                    match spreadsheet.grid[child_key as usize] {\r\n                        CellValue::Integer(val) =\u003e val.to_string(),\r\n                        CellValue::Error =\u003e \"ERROR\".to_string(),\r\n                    }\r\n                );\r\n            }\r\n        } else {\r\n            println!(\"    (none)\");\r\n        }\r\n    } else {\r\n        println!(\"    (none)\");\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n","traces":[{"line":10,"address":[172113,175885,170640],"length":1,"stats":{"Line":1}},{"line":16,"address":[170685,170734],"length":1,"stats":{"Line":2}},{"line":17,"address":[170721],"length":1,"stats":{"Line":1}},{"line":21,"address":[170778],"length":1,"stats":{"Line":1}},{"line":24,"address":[170814],"length":1,"stats":{"Line":1}},{"line":25,"address":[170827],"length":1,"stats":{"Line":1}},{"line":28,"address":[170882],"length":1,"stats":{"Line":2}},{"line":29,"address":[260064],"length":1,"stats":{"Line":1}},{"line":30,"address":[260107],"length":1,"stats":{"Line":1}},{"line":31,"address":[260234,260141,260405,260388],"length":1,"stats":{"Line":3}},{"line":34,"address":[260241,260190],"length":1,"stats":{"Line":1}},{"line":35,"address":[260270],"length":1,"stats":{"Line":1}},{"line":36,"address":[260310,260370],"length":1,"stats":{"Line":2}},{"line":37,"address":[260395,260343],"length":1,"stats":{"Line":0}},{"line":43,"address":[170890],"length":1,"stats":{"Line":1}},{"line":44,"address":[171037,170957],"length":1,"stats":{"Line":2}},{"line":45,"address":[171065],"length":1,"stats":{"Line":1}},{"line":48,"address":[175904],"length":1,"stats":{"Line":1}},{"line":58,"address":[176048],"length":1,"stats":{"Line":1}},{"line":63,"address":[176073],"length":1,"stats":{"Line":1}},{"line":65,"address":[176137,176644],"length":1,"stats":{"Line":1}},{"line":66,"address":[260698,260688],"length":1,"stats":{"Line":0}},{"line":68,"address":[176815,176881],"length":1,"stats":{"Line":0}},{"line":69,"address":[176874],"length":1,"stats":{"Line":0}},{"line":71,"address":[176898],"length":1,"stats":{"Line":0}},{"line":72,"address":[176916],"length":1,"stats":{"Line":0}},{"line":73,"address":[176952],"length":1,"stats":{"Line":0}},{"line":74,"address":[176963],"length":1,"stats":{"Line":0}},{"line":78,"address":[176975],"length":1,"stats":{"Line":0}},{"line":79,"address":[177006],"length":1,"stats":{"Line":0}},{"line":82,"address":[177036],"length":1,"stats":{"Line":0}},{"line":85,"address":[177095],"length":1,"stats":{"Line":0}},{"line":98,"address":[176084,176197],"length":1,"stats":{"Line":1}},{"line":99,"address":[176213],"length":1,"stats":{"Line":0}},{"line":101,"address":[176402,176328],"length":1,"stats":{"Line":0}},{"line":102,"address":[176395],"length":1,"stats":{"Line":0}},{"line":104,"address":[176414],"length":1,"stats":{"Line":0}},{"line":105,"address":[176437],"length":1,"stats":{"Line":0}},{"line":106,"address":[176468],"length":1,"stats":{"Line":0}},{"line":107,"address":[176484],"length":1,"stats":{"Line":0}},{"line":111,"address":[176496],"length":1,"stats":{"Line":0}},{"line":112,"address":[176527],"length":1,"stats":{"Line":0}},{"line":115,"address":[176557],"length":1,"stats":{"Line":0}},{"line":133,"address":[171095],"length":1,"stats":{"Line":1}},{"line":147,"address":[171236],"length":1,"stats":{"Line":1}},{"line":161,"address":[171366],"length":1,"stats":{"Line":1}},{"line":164,"address":[171417],"length":1,"stats":{"Line":1}},{"line":165,"address":[171622,171575],"length":1,"stats":{"Line":2}},{"line":166,"address":[171635],"length":1,"stats":{"Line":1}},{"line":167,"address":[171679],"length":1,"stats":{"Line":0}},{"line":168,"address":[175710,171711],"length":1,"stats":{"Line":0}},{"line":169,"address":[175781],"length":1,"stats":{"Line":0}},{"line":173,"address":[171672,171761],"length":1,"stats":{"Line":2}},{"line":174,"address":[171921,171986],"length":1,"stats":{"Line":0}},{"line":175,"address":[172057],"length":1,"stats":{"Line":0}},{"line":178,"address":[172138],"length":1,"stats":{"Line":1}},{"line":181,"address":[172232],"length":1,"stats":{"Line":1}},{"line":182,"address":[172374,172706],"length":1,"stats":{"Line":2}},{"line":183,"address":[172449,172549],"length":1,"stats":{"Line":2}},{"line":187,"address":[172799,172875],"length":1,"stats":{"Line":0}},{"line":196,"address":[172946],"length":1,"stats":{"Line":0}},{"line":199,"address":[172806,173119],"length":1,"stats":{"Line":2}},{"line":200,"address":[173154],"length":1,"stats":{"Line":1}},{"line":205,"address":[173297],"length":1,"stats":{"Line":1}},{"line":208,"address":[173576],"length":1,"stats":{"Line":1}},{"line":209,"address":[173672,173727],"length":1,"stats":{"Line":0}},{"line":210,"address":[173754],"length":1,"stats":{"Line":0}},{"line":212,"address":[173762,174007],"length":1,"stats":{"Line":0}},{"line":213,"address":[174028],"length":1,"stats":{"Line":0}},{"line":214,"address":[174036,174123],"length":1,"stats":{"Line":0}},{"line":215,"address":[174318],"length":1,"stats":{"Line":0}},{"line":226,"address":[173983],"length":1,"stats":{"Line":0}},{"line":227,"address":[174055],"length":1,"stats":{"Line":0}},{"line":232,"address":[173698,174621],"length":1,"stats":{"Line":2}},{"line":233,"address":[174648],"length":1,"stats":{"Line":1}},{"line":234,"address":[174774,174730],"length":1,"stats":{"Line":0}},{"line":235,"address":[174829,174951,174793],"length":1,"stats":{"Line":0}},{"line":236,"address":[174972],"length":1,"stats":{"Line":0}},{"line":237,"address":[175326,175274],"length":1,"stats":{"Line":0}},{"line":248,"address":[174800,175504],"length":1,"stats":{"Line":0}},{"line":251,"address":[174741,175528],"length":1,"stats":{"Line":2}},{"line":254,"address":[174917],"length":1,"stats":{"Line":1}}],"covered":40,"coverable":82}]};
        var previousData = {"files":[{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","cell.rs"],"content":"use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n/// Cell value representation\r\n#[derive(Debug, Clone, PartialEq)]\r\npub enum CellValue {\r\n    Integer(i32),\r\n    Error,\r\n}\r\n\r\npub fn parse_cell_reference(\r\n    sheet: \u0026Spreadsheet,\r\n    cell_ref: \u0026str,\r\n) -\u003e Result\u003c(i16, i16), CommandStatus\u003e {\r\n    let cell_ref = cell_ref.as_bytes();\r\n    if cell_ref.is_empty() {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Find column/row split point in one pass\r\n    let mut split_idx = 0;\r\n    let mut col_length = 0;\r\n\r\n    while split_idx \u003c cell_ref.len() \u0026\u0026 cell_ref[split_idx] \u003e= b'A' \u0026\u0026 cell_ref[split_idx] \u003c= b'Z' {\r\n        col_length += 1;\r\n        if col_length \u003e 3 {\r\n            return Err(CommandStatus::CmdUnrecognized);\r\n        }\r\n        split_idx += 1;\r\n    }\r\n\r\n    // Verify we have columns and rows\r\n    if col_length == 0 || split_idx == cell_ref.len() {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Verify remaining chars are digits\r\n    for i in split_idx..cell_ref.len() {\r\n        if !cell_ref[i].is_ascii_digit() {\r\n            return Err(CommandStatus::CmdUnrecognized);\r\n        }\r\n    }\r\n\r\n    // Get column reference as a string slice (no allocation)\r\n    let col_name =\r\n        std::str::from_utf8(\u0026cell_ref[0..split_idx]).map_err(|_| CommandStatus::CmdUnrecognized)?;\r\n\r\n    // Parse row directly from bytes (avoid string allocation)\r\n    let mut row: i16 = 0;\r\n    for \u0026byte in \u0026cell_ref[split_idx..] {\r\n        row = row * 10 + (byte - b'0') as i16;\r\n    }\r\n\r\n    // Convert to 0-based\r\n    let row = row - 1;\r\n\r\n    // Convert column name to index\r\n    let col = sheet.column_name_to_index(col_name);\r\n    // Check row and column bounds\r\n    if row \u003c 0 || col \u003c 0 || row \u003e 998 || col \u003e 18277 {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n    Ok((row, col))\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_cell_reference_valid() {\r\n        let sheet = create_test_spreadsheet(10, 10);\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"A1\"), Ok((0, 0)));\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"B2\"), Ok((1, 1)));\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"AA10\"), Ok((9, 26)));\r\n        assert_eq!(parse_cell_reference(\u0026sheet, \"ZZZ999\"), Ok((998, 18277)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_cell_reference_invalid() {\r\n        let sheet = create_test_spreadsheet(10, 10);\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"1A\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A1B\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"AAAA1\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_cell_reference_bounds() {\r\n        let sheet = create_test_spreadsheet(10, 10);\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A1000\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"ZZZ1000\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_cell_reference(\u0026sheet, \"A0\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_cell_value_equality() {\r\n        assert_eq!(CellValue::Integer(42), CellValue::Integer(42));\r\n        assert_eq!(CellValue::Error, CellValue::Error);\r\n        assert_ne!(CellValue::Integer(42), CellValue::Error);\r\n    }\r\n}\r\n","traces":[{"line":10,"address":[177728],"length":1,"stats":{"Line":3}},{"line":14,"address":[177790],"length":1,"stats":{"Line":3}},{"line":15,"address":[177827],"length":1,"stats":{"Line":3}},{"line":16,"address":[177861],"length":1,"stats":{"Line":1}},{"line":20,"address":[177836],"length":1,"stats":{"Line":3}},{"line":21,"address":[177848],"length":1,"stats":{"Line":3}},{"line":23,"address":[177889,177859,179172,177923],"length":1,"stats":{"Line":13}},{"line":24,"address":[179092,178052,179073],"length":1,"stats":{"Line":4}},{"line":25,"address":[179080],"length":1,"stats":{"Line":3}},{"line":26,"address":[179131],"length":1,"stats":{"Line":1}},{"line":28,"address":[179108,179164,179177],"length":1,"stats":{"Line":6}},{"line":32,"address":[178113,177899],"length":1,"stats":{"Line":2}},{"line":33,"address":[178079],"length":1,"stats":{"Line":1}},{"line":37,"address":[178331,178128],"length":1,"stats":{"Line":5}},{"line":38,"address":[178996,178352],"length":1,"stats":{"Line":6}},{"line":39,"address":[179040],"length":1,"stats":{"Line":1}},{"line":44,"address":[178477,178209,178376],"length":1,"stats":{"Line":4}},{"line":48,"address":[178418],"length":1,"stats":{"Line":1}},{"line":49,"address":[178965,178428,178631,178556],"length":1,"stats":{"Line":10}},{"line":50,"address":[178652,178876,178970],"length":1,"stats":{"Line":4}},{"line":54,"address":[178606,178748,178706],"length":1,"stats":{"Line":5}},{"line":57,"address":[178714],"length":1,"stats":{"Line":3}},{"line":59,"address":[178806,178769,178740],"length":1,"stats":{"Line":12}},{"line":60,"address":[178775],"length":1,"stats":{"Line":1}},{"line":62,"address":[178833],"length":1,"stats":{"Line":6}}],"covered":25,"coverable":25},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","evaluator.rs"],"content":"use crate::cell::{CellValue, parse_cell_reference};\r\nuse crate::formula::parse_range;\r\nuse crate::formula::{eval_avg, eval_max, eval_min, eval_variance, sum_value};\r\nuse crate::graph::{add_children, remove_all_parents};\r\nuse crate::reevaluate_topo::{sleep_fn, toposort_reval_detect_cycle};\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet, MAX_DISPLAY};\r\nuse crate::formula::Range;\r\nuse crate::extensions::get_formula_string;\r\n\r\nfn resolve_cell_reference(sheet: \u0026Spreadsheet, s: \u0026str) -\u003e Result\u003c(i16, i16), CommandStatus\u003e {\r\n    if let Some(range) = sheet.named_ranges.get(s) {\r\n        if range.start_row == range.end_row \u0026\u0026 range.start_col == range.end_col {\r\n            Ok((range.start_row, range.start_col))\r\n        } else {\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        }\r\n    } else {\r\n        parse_cell_reference(sheet, s)\r\n    }\r\n}\r\n\r\npub fn handle_sleep(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    let cell_key = sheet.get_key(row, col);\r\n\r\n    // Handle cell reference case\r\n    if let Ok((target_row, target_col)) = parse_cell_reference(sheet, expr) {\r\n        // Get parent key before any borrowing\r\n        let pkey = sheet.get_key(target_row, target_col);\r\n\r\n        // Check for self-reference early (optimization)\r\n        if row == target_row \u0026\u0026 col == target_col {\r\n            return CommandStatus::CmdCircularRef;\r\n        }\r\n\r\n        // Remove parents and update cell in one block\r\n        remove_all_parents(sheet, row, col);\r\n\r\n        // Set up the new cell metadata\r\n        let meta = sheet.get_cell_meta(row, col);\r\n        meta.parent1 = pkey;\r\n        meta.parent2 = -1;\r\n        meta.formula = 102; // Custom formula code for sleep\r\n\r\n        // Add children and update sleep time\r\n        add_children(sheet, pkey, -1, 102, row, col);\r\n        // Add to sleep time if integer\r\n        // Get the value from parent cell\r\n        let parent_value = sheet.get_cell(target_row, target_col);\r\n        if let CellValue::Integer(val) = parent_value {\r\n            // Update cell value and sleep time\r\n            sleep_fn(sheet, row, col, *val, sleep_time);\r\n        } else {\r\n            *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n        }\r\n    }\r\n    // Handle numeric literal case\r\n    else if let Ok(val) = expr.parse::\u003ci32\u003e() {\r\n        // Remove all parents and update cell in one sequence\r\n        remove_all_parents(sheet, row, col);\r\n        // Update cell value and sleep_time\r\n        // Delete the cell meta entry\r\n        sheet.cell_meta.remove(\u0026cell_key);\r\n        sleep_fn(sheet, row, col, val, sleep_time);\r\n    } else {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn evaluate_arithmetic(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n) -\u003e CommandStatus {\r\n    let cell_key = sheet.get_key(row, col);\r\n\r\n    // Case 1: Integer literal\r\n    if let Ok(number) = expr.parse::\u003ci32\u003e() {\r\n        remove_all_parents(sheet, row, col);\r\n        // As no parents and formula remove the meta data from the set and map\r\n        // to avoid memory leaks\r\n        sheet.cell_meta.remove(\u0026cell_key);\r\n        *sheet.get_mut_cell(row, col) = CellValue::Integer(number);\r\n\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    // Case 2: Simple cell reference - check using bytes for better performance\r\n    let mut all_alnum = true;\r\n    for \u0026b in expr.as_bytes() {\r\n        if !(b.is_ascii_alphanumeric() || b == b'_') {\r\n            all_alnum = false;\r\n            break;\r\n        }\r\n    }\r\n\r\n    if all_alnum {\r\n        match resolve_cell_reference(sheet, expr) {\r\n            Ok((target_row, target_col)) =\u003e {\r\n                // Get reference cell key and value\r\n                let ref_cell_key = sheet.get_key(target_row, target_col);\r\n\r\n                // Remove old dependencies and set new ones\r\n                remove_all_parents(sheet, row, col);\r\n\r\n                // Update metadata\r\n                let meta = sheet.get_cell_meta(row, col);\r\n                meta.parent1 = ref_cell_key;\r\n                meta.parent2 = -1;\r\n                meta.formula = 82; // Code for simple cell reference\r\n\r\n                // Add dependency\r\n                add_children(sheet, ref_cell_key, -1, 82, row, col);\r\n\r\n                // Update cell value\r\n                *sheet.get_mut_cell(row, col) = match sheet.get_cell(target_row, target_col) {\r\n                    CellValue::Integer(val) =\u003e CellValue::Integer(*val),\r\n                    _ =\u003e CellValue::Error,\r\n                };\r\n\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Case 3: Binary arithmetic expression\r\n    // Find operator starting at index 1 (like C code, to handle leading minus sign)\r\n    let bytes = expr.as_bytes();\r\n    let mut op_idx = 0;\r\n    let mut op = 0u8;\r\n\r\n    // Start at index 1 to handle leading minus sign\r\n    for i in 1..bytes.len() {\r\n        match bytes[i] {\r\n            b'+' | b'-' | b'*' | b'/' =\u003e {\r\n                op = bytes[i];\r\n                op_idx = i;\r\n                break;\r\n            }\r\n            _ =\u003e {}\r\n        }\r\n    }\r\n\r\n    if op_idx == 0 {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Split into left and right parts\r\n    let left = \u0026expr[..op_idx];\r\n    let right = \u0026expr[op_idx + 1..];\r\n\r\n    if left.is_empty() || right.is_empty() {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Variables to track cell references and values\r\n    let mut left_val = 0;\r\n    let mut right_val = 0;\r\n    let mut left_is_cell = false;\r\n    let mut right_is_cell = false;\r\n    let mut error_found = false;\r\n    let mut left_cell_key = -1;\r\n    let mut right_cell_key = -1;\r\n\r\n    // Parse left operand\r\n    if let Ok(num) = left.parse::\u003ci32\u003e() {\r\n        left_val = num;\r\n    } else {\r\n        // Try as cell reference\r\n        match parse_cell_reference(sheet, left) {\r\n            Ok((left_row, left_col)) =\u003e {\r\n                left_is_cell = true;\r\n                left_cell_key = sheet.get_key(left_row, left_col);\r\n\r\n                // Get reference cell value\r\n                let left_cell = sheet.get_cell(left_row, left_col);\r\n                match left_cell {\r\n                    CellValue::Integer(val) =\u003e left_val = *val,\r\n                    _ =\u003e {\r\n                        error_found = true;\r\n                    }\r\n                }\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Parse right operand\r\n    if let Ok(num) = right.parse::\u003ci32\u003e() {\r\n        right_val = num;\r\n    } else {\r\n        // Try as cell reference\r\n        match parse_cell_reference(sheet, right) {\r\n            Ok((right_row, right_col)) =\u003e {\r\n                right_is_cell = true;\r\n                right_cell_key = sheet.get_key(right_row, right_col);\r\n\r\n                // Get reference cell value\r\n                let right_cell = sheet.get_cell(right_row, right_col);\r\n                match right_cell {\r\n                    CellValue::Integer(val) =\u003e right_val = *val,\r\n                    _ =\u003e {\r\n                        error_found = true;\r\n                    }\r\n                }\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Remove old dependencies\r\n    remove_all_parents(sheet, row, col);\r\n\r\n    // Determine formula type based on operator and operand types\r\n    let mut formula_type = match op {\r\n        b'+' =\u003e 10,\r\n        b'-' =\u003e 20,\r\n        b'*' =\u003e 40,\r\n        b'/' =\u003e 30,\r\n        _ =\u003e unreachable!(),\r\n    };\r\n\r\n    // Adjust formula type based on cell references (like C code)\r\n    if left_is_cell \u0026\u0026 right_is_cell {\r\n        formula_type += 0; // Both are cells, no adjustment needed\r\n    } else if left_is_cell {\r\n        formula_type += 2;\r\n    } else if right_is_cell {\r\n        formula_type += 3;\r\n    }\r\n\r\n    // Set metadata\r\n    let meta = sheet.get_cell_meta(row, col);\r\n    meta.formula = formula_type;\r\n    meta.parent1 = if left_is_cell {\r\n        left_cell_key\r\n    } else {\r\n        left_val\r\n    };\r\n    meta.parent2 = if right_is_cell {\r\n        right_cell_key\r\n    } else {\r\n        right_val\r\n    };\r\n\r\n    // Check for circular references\r\n\r\n    // Add dependencies\r\n    if left_is_cell \u0026\u0026 right_is_cell {\r\n        // Add dependencies for both cells\r\n        add_children(sheet, left_cell_key, right_cell_key, formula_type, row, col);\r\n    } else if left_is_cell {\r\n        // Ordering of Cells matters\r\n        add_children(sheet, left_cell_key, -1, formula_type, row, col);\r\n    } else if right_is_cell {\r\n        // Ordering of Cells matters\r\n        add_children(sheet, -1, right_cell_key, formula_type, row, col);\r\n    }\r\n\r\n    // Calculate result\r\n    let cell = sheet.get_mut_cell(row, col);\r\n\r\n    if error_found {\r\n        *cell = CellValue::Error;\r\n    } else {\r\n        match op {\r\n            b'+' =\u003e *cell = CellValue::Integer(left_val + right_val),\r\n            b'-' =\u003e *cell = CellValue::Integer(left_val - right_val),\r\n            b'*' =\u003e *cell = CellValue::Integer(left_val * right_val),\r\n            b'/' =\u003e {\r\n                if right_val == 0 {\r\n                    *cell = CellValue::Error;\r\n                } else {\r\n                    *cell = CellValue::Integer(left_val / right_val);\r\n                }\r\n            }\r\n            _ =\u003e unreachable!(),\r\n        }\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn evaluate_formula(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    // Fast fail for empty expression\r\n    if expr.is_empty() {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Optimize function checks by using bytes for prefix matching\r\n    let bytes = expr.as_bytes();\r\n\r\n    // Check for range-based functions with a single pass\r\n    let (is_formula, formula_type, prefix_len) = match bytes.get(0..3) {\r\n        Some(b\"AVG\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 6, 4),\r\n        Some(b\"MIN\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 7, 4),\r\n        Some(b\"MAX\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 8, 4),\r\n        Some(b\"SUM\") if bytes.get(3) == Some(\u0026b'(') =\u003e (true, 5, 4),\r\n        Some(b\"SLE\")\r\n            if bytes.len() \u003e 5\r\n                \u0026\u0026 bytes[3] == b'E'\r\n                \u0026\u0026 bytes[4] == b'P'\r\n                \u0026\u0026 bytes.get(5) == Some(\u0026b'(') =\u003e\r\n        {\r\n            // Handle sleep function separately\r\n            if !expr.ends_with(')') {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n            return handle_sleep(sheet, row, col, \u0026expr[6..expr.len() - 1], sleep_time);\r\n        }\r\n        Some(b\"STD\")\r\n            if bytes.len() \u003e 5\r\n                \u0026\u0026 bytes[3] == b'E'\r\n                \u0026\u0026 bytes[4] == b'V'\r\n                \u0026\u0026 bytes.get(5) == Some(\u0026b'(') =\u003e\r\n        {\r\n            (true, 9, 6)\r\n        }\r\n        _ =\u003e (false, -1, 0),\r\n    };\r\n\r\n    if is_formula {\r\n        // Validate formula format\r\n        if !expr.ends_with(')') {\r\n            return CommandStatus::CmdUnrecognized;\r\n        }\r\n\r\n        // Extract the range string without allocating extra memory\r\n        let range_str: \u0026str = \u0026expr[prefix_len..expr.len() - 1];\r\n\r\n        // Parse range and validate early to avoid unnecessary work\r\n        let range: Range = if let Some(named_range) = sheet.named_ranges.get(range_str) {\r\n            named_range.clone()\r\n        } else {\r\n            match parse_range(sheet, range_str) {\r\n                Ok(r) =\u003e r,\r\n                Err(status) =\u003e return status,\r\n            }\r\n        };\r\n\r\n        // let cell_key = sheet.get_key(row, col);\r\n        let parent1 = sheet.get_key(range.start_row, range.start_col);\r\n        let parent2 = sheet.get_key(range.end_row, range.end_col);\r\n        remove_all_parents(sheet, row, col);\r\n        // Update metadata\r\n        let meta = sheet.get_cell_meta(row, col);\r\n        meta.parent1 = parent1;\r\n        meta.parent2 = parent2;\r\n        meta.formula = formula_type;\r\n\r\n        // Add children and evaluate the appropriate function\r\n        add_children(sheet, parent1, parent2, formula_type, row, col);\r\n\r\n        match formula_type {\r\n            9 =\u003e eval_variance(sheet, row, col, parent1, parent2),\r\n            8 =\u003e eval_max(sheet, row, col, parent1, parent2),\r\n            7 =\u003e eval_min(sheet, row, col, parent1, parent2),\r\n            6 =\u003e eval_avg(sheet, row, col, parent1, parent2),\r\n            _ =\u003e sum_value(sheet, row, col, parent1, parent2), // SUM case\r\n        }\r\n    } else {\r\n        // Handle arithmetic expressions\r\n        evaluate_arithmetic(sheet, row, col, expr)\r\n    }\r\n}\r\n\r\npub fn set_cell_value(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    expr: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    if sheet.is_cell_locked(row, col) {\r\n        return CommandStatus::CmdLockedCell;\r\n    }\r\n    let cell_key = sheet.get_key(row, col);\r\n\r\n    // Save old state\r\n    let old_meta = sheet.cell_meta.get(\u0026cell_key).cloned();\r\n    let old_value = match sheet.get_cell(row, col) {\r\n        CellValue::Integer(val) =\u003e CellValue::Integer(*val),\r\n        _ =\u003e CellValue::Error,\r\n    };\r\n    let status: CommandStatus = evaluate_formula(sheet, row, col, expr, sleep_time);\r\n    if let CommandStatus::CmdOk = status {\r\n        // Reevaluate the cell dependents graphs i.e. all of its children\r\n        // Also at same time check for cycle in the graph as it will save time and memory\r\n        let has_cycle = toposort_reval_detect_cycle(sheet, row, col, sleep_time);\r\n        if has_cycle {\r\n            // If a cycle is detected, restore the old parents and formula\r\n            // Remove the new parents and formula\r\n            remove_all_parents(sheet, row, col);\r\n            // Restore the old value\r\n            *sheet.get_mut_cell(row, col) = old_value;\r\n            // Old meta\r\n            if let Some(old) = old_meta {\r\n                let (parent1, parent2, formula) = (old.parent1, old.parent2, old.formula);\r\n                sheet.cell_meta.insert(cell_key, old);\r\n                add_children(sheet, parent1, parent2, formula, row, col);\r\n            } else {\r\n                sheet.cell_meta.remove(\u0026cell_key);\r\n            }\r\n\r\n            return CommandStatus::CmdCircularRef;\r\n        } else {\r\n            // If no cycle, update the cell history with the old value\r\n            sheet.cell_history.entry(cell_key).or_insert_with(Vec::new).push(old_value);\r\n            sheet.set_last_edited(row, col);\r\n        }\r\n    }\r\n    status\r\n}\r\n\r\nfn set_cell_to_value(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    value: CellValue,\r\n    sleep_time: \u0026mut f64\r\n) -\u003e CommandStatus {\r\n    // Check if the cell is locked before setting the value\r\n        if sheet.is_cell_locked(row, col) {\r\n            return CommandStatus::CmdLockedCell;\r\n        }\r\n        // Check if the value is a valid integer\r\n        let cell_key = sheet.get_key(row, col);\r\n        // remove all parents and set the value                                             \r\n        remove_all_parents(sheet, row, col);\r\n        sheet.cell_meta.remove(\u0026cell_key);\r\n        *sheet.get_mut_cell(row, col) = value;\r\n        toposort_reval_detect_cycle(sheet, row, col, sleep_time);\r\n        sheet.set_last_edited(row, col);\r\n        CommandStatus::CmdOk\r\n}\r\n\r\npub fn handle_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    trimmed: \u0026str,\r\n    sleep_time: \u0026mut f64,\r\n) -\u003e CommandStatus {\r\n    // Fast path for single-character commands to avoid string comparisons\r\n    if trimmed.len() == 1 {\r\n        match trimmed.as_bytes()[0] {\r\n            b'w' | b'a' | b's' | b'd' =\u003e {\r\n                // We've already validated it's one byte, so this is safe\r\n                let direction = trimmed.chars().next().unwrap();\r\n                sheet.scroll_viewport(direction);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            b'q' =\u003e return CommandStatus::CmdOk, // Handle quit command if needed\r\n            _ =\u003e {}\r\n        }\r\n    }\r\n\r\n    // Use match for special commands for better branch prediction\r\n    match trimmed {\r\n        \"disable_output\" =\u003e {\r\n            sheet.output_enabled = false;\r\n            return CommandStatus::CmdOk;\r\n        }\r\n        \"enable_output\" =\u003e {\r\n            sheet.output_enabled = true;\r\n            return CommandStatus::CmdOk;\r\n        }\r\n        \"last_edit\" =\u003e {\r\n            sheet.scroll_to_last_edited();\r\n            return CommandStatus::CmdOk;\r\n        }\r\n        _ =\u003e {}\r\n    }\r\n\r\n    // Check for cell dependency visualization command\r\n    if trimmed.starts_with(\"visualize \") {\r\n        let cell_ref = \u0026trimmed[10..]; // Skip \"visualize \" prefix\r\n        match parse_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                return sheet.visualize_cell_relationships(row, col);\r\n            }\r\n            Err(status) =\u003e {\r\n                return status;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Check for scroll_to command with byte-based comparison\r\n    if trimmed.len() \u003e 10\r\n        \u0026\u0026 \u0026trimmed.as_bytes()[..9] == b\"scroll_to\"\r\n        \u0026\u0026 trimmed.as_bytes()[9] == b' '\r\n    {\r\n        let cell_ref = \u0026trimmed[10..];\r\n        return sheet.scroll_to_cell(cell_ref);\r\n    }\r\n\r\n    if trimmed.starts_with(\"display \") {\r\n        let num_str = trimmed.get(8..).unwrap_or(\"\").trim();\r\n        match num_str.parse::\u003ci16\u003e() {\r\n            Ok(num) if num \u003e 0 \u0026\u0026 num \u003c= MAX_DISPLAY =\u003e {\r\n                sheet.display_rows = num;\r\n                sheet.display_cols = num;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            _ =\u003e return CommandStatus::CmdUnrecognized,\r\n        }\r\n    }\r\n\r\n    if trimmed.starts_with(\"lock_cell \") {\r\n        let lock_target = trimmed.get(10..).unwrap_or(\"\").trim();\r\n        if lock_target.contains(':') {\r\n            match parse_range(sheet, lock_target) {\r\n                Ok(range) =\u003e {\r\n                    sheet.lock_range(range);\r\n                    return CommandStatus::CmdOk;\r\n                }\r\n                Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n            }\r\n        } else {\r\n            match resolve_cell_reference(sheet, lock_target) {\r\n                Ok((row, col)) =\u003e {\r\n                    let range = Range {\r\n                        start_row: row,\r\n                        start_col: col,\r\n                        end_row: row,\r\n                        end_col: col,\r\n                    };\r\n                    sheet.lock_range(range);\r\n                    return CommandStatus::CmdOk;\r\n                }\r\n                Err(status) =\u003e return status,\r\n            }\r\n        }\r\n    }\r\n\r\n    if trimmed.starts_with(\"name \") {\r\n        let parts: Vec\u003c\u0026str\u003e = trimmed[5..].split_whitespace().collect();\r\n        if parts.len() == 2 {\r\n            let target = parts[0];\r\n            let name = parts[1];\r\n            if let Ok(range) = parse_range(sheet, target) {\r\n                sheet.named_ranges.insert(name.to_string(), range);\r\n                return CommandStatus::CmdOk;\r\n            } else if let Ok((row, col)) = parse_cell_reference(sheet, target) {\r\n                let range = Range {\r\n                    start_row: row,\r\n                    start_col: col,\r\n                    end_row: row,\r\n                    end_col: col,\r\n                };\r\n                sheet.named_ranges.insert(name.to_string(), range);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    if trimmed.starts_with(\"history \") {\r\n        let cell_ref = trimmed[8..].trim();\r\n        return match resolve_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                let cell_key = sheet.get_key(row, col);\r\n                if let Some(history) = sheet.cell_history.get_mut(\u0026cell_key) {\r\n                    if let Some(prev_value) = history.pop() {\r\n                        set_cell_to_value(sheet, row, col, prev_value, sleep_time)\r\n                    } else {\r\n                        CommandStatus::CmdOk\r\n                    }\r\n                } else {\r\n                    CommandStatus::CmdOk\r\n                }\r\n            }\r\n            Err(status) =\u003e status,\r\n        };\r\n    }\r\n\r\n    if trimmed.starts_with(\"formula \") {\r\n        let cell_ref = trimmed[8..].trim();\r\n        match resolve_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                let formula_str = get_formula_string(sheet, row, col);\r\n                println!(\"{}\", formula_str);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            Err(status) =\u003e return status,\r\n        }\r\n    }\r\n\r\n    // Check for cell assignment using byte search for '='\r\n    let bytes = trimmed.as_bytes();\r\n    let mut eq_pos = None;\r\n\r\n    for (i, \u0026b) in bytes.iter().enumerate() {\r\n        if b == b'=' {\r\n            eq_pos = Some(i);\r\n            break;\r\n        }\r\n    }\r\n\r\n    if let Some(pos) = eq_pos {\r\n        // Use slice operations which are more efficient than split_at\r\n        let cell_ref = trimmed[..pos].trim();\r\n        let expr = trimmed[pos + 1..].trim();\r\n\r\n        // Parse the cell reference with direct result handling\r\n        return match parse_cell_reference(sheet, cell_ref) {\r\n            Ok((row, col)) =\u003e {\r\n                // All bounds checks in one condition\r\n                set_cell_value(sheet, row, col, expr, sleep_time)\r\n            }\r\n            Err(status) =\u003e status,\r\n        };\r\n    }\r\n    // No recognized command\r\n    CommandStatus::CmdUnrecognized\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_with_reference() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(5));\r\n        assert_eq!(sleep_time, 5.0);\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 102);\r\n        assert_eq!(meta.parent1, sheet.get_key(0, 0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_with_literal() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"3\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n        assert_eq!(sleep_time, 3.0);\r\n        assert!(!sheet.cell_meta.contains_key(\u0026sheet.get_key(1, 1)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_invalid() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"INVALID\", \u0026mut sleep_time),\r\n            CommandStatus::CmdUnrecognized\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_sleep_self_reference() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_sleep(\u0026mut sheet, 1, 1, \"B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_literal() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 0, 0, \"42\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(42));\r\n        assert!(!sheet.cell_meta.contains_key(\u0026sheet.get_key(0, 0)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_cell_ref() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(10);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 1, 1, \"A1\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(10));\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 82);\r\n        assert_eq!(meta.parent1, sheet.get_key(0, 0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_binary_add() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 1, 1, \"A1+3\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(8));\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 12);\r\n        assert_eq!(meta.parent1, sheet.get_key(0, 0));\r\n        assert_eq!(meta.parent2, 3);\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_arithmetic_binary_div_zero() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        assert_eq!(\r\n            evaluate_arithmetic(\u0026mut sheet, 1, 1, \"A1/0\"),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_formula_sum() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            evaluate_formula(\u0026mut sheet, 1, 1, \"SUM(A1:B1)\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n        let meta = sheet.cell_meta.get(\u0026sheet.get_key(1, 1)).unwrap();\r\n        assert_eq!(meta.formula, 5);\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_formula_invalid() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            evaluate_formula(\u0026mut sheet, 1, 1, \"SUM(A1)\", \u0026mut sleep_time),\r\n            CommandStatus::CmdUnrecognized\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_set_cell_value_with_cycle() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 0, 0, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_scroll() {\r\n        let mut sheet = create_test_spreadsheet(50, 50);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"s\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_row, 10);\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"d\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_col, 10);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_output_toggle() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"disable_output\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert!(!sheet.output_enabled);\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"enable_output\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert!(sheet.output_enabled);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_visualize() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"visualize A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"visualize Z9\", \u0026mut sleep_time),\r\n            CommandStatus::CmdInvalidCell\r\n        );\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_scroll_to() {\r\n        let mut sheet = create_test_spreadsheet(50, 50);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"scroll_to B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_row, 1);\r\n        assert_eq!(sheet.viewport_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_assignment() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"A1=42\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(42));\r\n    }\r\n\r\n    #[test]\r\n    fn test_set_cell_value_circular_ref() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 0, 0, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_last_edit() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        handle_command(\u0026mut sheet, \"B2=42\", \u0026mut sleep_time);\r\n        assert_eq!(sheet.last_edited, Some((1, 1)));\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"last_edit\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.viewport_row, 1);\r\n        assert_eq!(sheet.viewport_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_display() {\r\n        let mut sheet = create_test_spreadsheet(20, 20);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"display 5\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(sheet.display_rows, 5);\r\n        assert_eq!(sheet.display_cols, 5);\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_lock_cell() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"lock_cell B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert!(sheet.is_cell_locked(1, 1));\r\n    }\r\n\r\n    #[test]\r\n    fn test_handle_command_history() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"A2=2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"A2=3\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            handle_command(\u0026mut sheet, \"history A2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 0), CellValue::Integer(2));\r\n        assert_eq!(sheet.last_edited, Some((1, 0)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_evaluate_formula_max() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(3);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            evaluate_formula(\u0026mut sheet, 1, 1, \"MAX(A1:B1)\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(5));\r\n    }\r\n\r\n}\r\n","traces":[{"line":9,"address":[185360],"length":1,"stats":{"Line":1}},{"line":10,"address":[185394],"length":1,"stats":{"Line":1}},{"line":11,"address":[185452,185536],"length":1,"stats":{"Line":0}},{"line":12,"address":[185558],"length":1,"stats":{"Line":0}},{"line":14,"address":[185518],"length":1,"stats":{"Line":0}},{"line":17,"address":[185478],"length":1,"stats":{"Line":1}},{"line":21,"address":[187869,185616],"length":1,"stats":{"Line":0}},{"line":22,"address":[185680],"length":1,"stats":{"Line":0}},{"line":23,"address":[185707],"length":1,"stats":{"Line":0}},{"line":24,"address":[185722],"length":1,"stats":{"Line":0}},{"line":26,"address":[185794,185749,185848],"length":1,"stats":{"Line":0}},{"line":27,"address":[185824,185882,185968],"length":1,"stats":{"Line":0}},{"line":28,"address":[185914],"length":1,"stats":{"Line":0}},{"line":29,"address":[185923],"length":1,"stats":{"Line":0}},{"line":31,"address":[185933],"length":1,"stats":{"Line":0}},{"line":33,"address":[187757,186008,186905],"length":1,"stats":{"Line":0}},{"line":35,"address":[186920],"length":1,"stats":{"Line":0}},{"line":36,"address":[187012],"length":1,"stats":{"Line":0}},{"line":38,"address":[188354,187099,187121],"length":1,"stats":{"Line":0}},{"line":39,"address":[188226,187147],"length":1,"stats":{"Line":0}},{"line":40,"address":[188213,187109],"length":1,"stats":{"Line":0}},{"line":41,"address":[187199],"length":1,"stats":{"Line":0}},{"line":42,"address":[187238],"length":1,"stats":{"Line":0}},{"line":43,"address":[187273,188069],"length":1,"stats":{"Line":0}},{"line":44,"address":[188024,187178],"length":1,"stats":{"Line":0}},{"line":45,"address":[187450],"length":1,"stats":{"Line":0}},{"line":46,"address":[187489],"length":1,"stats":{"Line":0}},{"line":47,"address":[187508,187899],"length":1,"stats":{"Line":0}},{"line":49,"address":[187288],"length":1,"stats":{"Line":0}},{"line":50,"address":[187331],"length":1,"stats":{"Line":0}},{"line":51,"address":[187387],"length":1,"stats":{"Line":0}},{"line":52,"address":[187421],"length":1,"stats":{"Line":0}},{"line":53,"address":[187608],"length":1,"stats":{"Line":0}},{"line":56,"address":[186883],"length":1,"stats":{"Line":0}},{"line":58,"address":[187825],"length":1,"stats":{"Line":0}},{"line":59,"address":[188405,188546],"length":1,"stats":{"Line":0}},{"line":60,"address":[188428,188705],"length":1,"stats":{"Line":0}},{"line":61,"address":[188454,188849],"length":1,"stats":{"Line":0}},{"line":62,"address":[188480,188993],"length":1,"stats":{"Line":0}},{"line":63,"address":[188367,189121],"length":1,"stats":{"Line":0}},{"line":67,"address":[189447,186027],"length":1,"stats":{"Line":0}},{"line":68,"address":[189219],"length":1,"stats":{"Line":0}},{"line":69,"address":[189258],"length":1,"stats":{"Line":0}},{"line":70,"address":[189277],"length":1,"stats":{"Line":0}},{"line":72,"address":[189192],"length":1,"stats":{"Line":0}},{"line":74,"address":[189515],"length":1,"stats":{"Line":0}},{"line":75,"address":[189601,189771],"length":1,"stats":{"Line":0}},{"line":76,"address":[189930,189627],"length":1,"stats":{"Line":0}},{"line":77,"address":[189653,190074],"length":1,"stats":{"Line":0}},{"line":78,"address":[190218,189679],"length":1,"stats":{"Line":0}},{"line":79,"address":[190346,189705],"length":1,"stats":{"Line":0}},{"line":80,"address":[189563,190449],"length":1,"stats":{"Line":0}},{"line":84,"address":[186046,190775],"length":1,"stats":{"Line":0}},{"line":85,"address":[190547],"length":1,"stats":{"Line":0}},{"line":86,"address":[190586],"length":1,"stats":{"Line":0}},{"line":87,"address":[190673,190621],"length":1,"stats":{"Line":0}},{"line":89,"address":[190520],"length":1,"stats":{"Line":0}},{"line":91,"address":[190843],"length":1,"stats":{"Line":0}},{"line":92,"address":[190929,191070],"length":1,"stats":{"Line":0}},{"line":93,"address":[191229,190952],"length":1,"stats":{"Line":0}},{"line":94,"address":[191373,190978],"length":1,"stats":{"Line":0}},{"line":95,"address":[191004,191517],"length":1,"stats":{"Line":0}},{"line":96,"address":[190891,191645],"length":1,"stats":{"Line":0}},{"line":100,"address":[186070],"length":1,"stats":{"Line":0}},{"line":101,"address":[186113],"length":1,"stats":{"Line":0}},{"line":102,"address":[186169],"length":1,"stats":{"Line":0}},{"line":103,"address":[186203],"length":1,"stats":{"Line":0}},{"line":104,"address":[191824,191764],"length":1,"stats":{"Line":0}},{"line":107,"address":[186232],"length":1,"stats":{"Line":0}},{"line":108,"address":[186275],"length":1,"stats":{"Line":0}},{"line":109,"address":[186331],"length":1,"stats":{"Line":0}},{"line":110,"address":[186365],"length":1,"stats":{"Line":0}},{"line":111,"address":[192032,192092],"length":1,"stats":{"Line":0}},{"line":114,"address":[186394],"length":1,"stats":{"Line":0}},{"line":115,"address":[186437],"length":1,"stats":{"Line":0}},{"line":116,"address":[186493],"length":1,"stats":{"Line":0}},{"line":117,"address":[186527],"length":1,"stats":{"Line":0}},{"line":118,"address":[192300,192360],"length":1,"stats":{"Line":0}},{"line":121,"address":[186556],"length":1,"stats":{"Line":0}},{"line":122,"address":[186599],"length":1,"stats":{"Line":0}},{"line":123,"address":[186655],"length":1,"stats":{"Line":0}},{"line":124,"address":[186689],"length":1,"stats":{"Line":0}},{"line":125,"address":[192568,192628],"length":1,"stats":{"Line":0}},{"line":128,"address":[186718],"length":1,"stats":{"Line":0}},{"line":129,"address":[186761],"length":1,"stats":{"Line":0}},{"line":130,"address":[186817],"length":1,"stats":{"Line":0}},{"line":131,"address":[186851],"length":1,"stats":{"Line":0}},{"line":132,"address":[192836,192896],"length":1,"stats":{"Line":0}},{"line":135,"address":[185992,193154],"length":1,"stats":{"Line":0}},{"line":136,"address":[193053],"length":1,"stats":{"Line":0}},{"line":137,"address":[193092],"length":1,"stats":{"Line":0}},{"line":138,"address":[193119],"length":1,"stats":{"Line":0}},{"line":139,"address":[193167],"length":1,"stats":{"Line":0}},{"line":140,"address":[193179],"length":1,"stats":{"Line":0}},{"line":141,"address":[193218],"length":1,"stats":{"Line":0}},{"line":142,"address":[193255,193332],"length":1,"stats":{"Line":0}},{"line":144,"address":[193270],"length":1,"stats":{"Line":0}},{"line":150,"address":[193456],"length":1,"stats":{"Line":1}},{"line":157,"address":[193548],"length":1,"stats":{"Line":4}},{"line":160,"address":[193578],"length":1,"stats":{"Line":4}},{"line":162,"address":[193684],"length":1,"stats":{"Line":2}},{"line":165,"address":[193969,193718],"length":1,"stats":{"Line":3}},{"line":166,"address":[193978],"length":1,"stats":{"Line":1}},{"line":170,"address":[193804],"length":1,"stats":{"Line":1}},{"line":173,"address":[193830],"length":1,"stats":{"Line":1}},{"line":174,"address":[193872],"length":1,"stats":{"Line":1}},{"line":175,"address":[193874],"length":1,"stats":{"Line":1}},{"line":176,"address":[193881],"length":1,"stats":{"Line":1}},{"line":179,"address":[193887],"length":1,"stats":{"Line":1}},{"line":182,"address":[193925],"length":1,"stats":{"Line":1}},{"line":183,"address":[193949,194010],"length":1,"stats":{"Line":2}},{"line":185,"address":[194025],"length":1,"stats":{"Line":1}},{"line":187,"address":[194056],"length":1,"stats":{"Line":0}},{"line":191,"address":[193739,194120],"length":1,"stats":{"Line":3}},{"line":193,"address":[194135],"length":1,"stats":{"Line":1}},{"line":196,"address":[194151],"length":1,"stats":{"Line":1}},{"line":197,"address":[194194],"length":1,"stats":{"Line":1}},{"line":199,"address":[194207],"length":1,"stats":{"Line":1}},{"line":202,"address":[194088],"length":1,"stats":{"Line":1}},{"line":205,"address":[194224],"length":1,"stats":{"Line":1}},{"line":211,"address":[194324],"length":1,"stats":{"Line":1}},{"line":214,"address":[194358],"length":1,"stats":{"Line":4}},{"line":215,"address":[194454],"length":1,"stats":{"Line":1}},{"line":218,"address":[194473],"length":1,"stats":{"Line":1}},{"line":219,"address":[194529],"length":1,"stats":{"Line":1}},{"line":221,"address":[194577],"length":1,"stats":{"Line":1}},{"line":225,"address":[194603],"length":1,"stats":{"Line":3}},{"line":226,"address":[194726,194611,194660],"length":1,"stats":{"Line":9}},{"line":227,"address":[194743],"length":1,"stats":{"Line":3}},{"line":228,"address":[194770],"length":1,"stats":{"Line":2}},{"line":233,"address":[194710],"length":1,"stats":{"Line":1}},{"line":234,"address":[194909],"length":1,"stats":{"Line":1}},{"line":235,"address":[197858],"length":1,"stats":{"Line":1}},{"line":237,"address":[197900],"length":1,"stats":{"Line":1}},{"line":240,"address":[197948],"length":1,"stats":{"Line":1}},{"line":243,"address":[197983],"length":1,"stats":{"Line":1}},{"line":244,"address":[198034],"length":1,"stats":{"Line":1}},{"line":245,"address":[198036],"length":1,"stats":{"Line":1}},{"line":246,"address":[198043],"length":1,"stats":{"Line":1}},{"line":249,"address":[198049],"length":1,"stats":{"Line":1}},{"line":252,"address":[198220,198090],"length":1,"stats":{"Line":2}},{"line":253,"address":[198147],"length":1,"stats":{"Line":1}},{"line":254,"address":[198185],"length":1,"stats":{"Line":0}},{"line":257,"address":[198250],"length":1,"stats":{"Line":1}},{"line":259,"address":[198116],"length":1,"stats":{"Line":0}},{"line":265,"address":[194796],"length":1,"stats":{"Line":2}},{"line":266,"address":[194836],"length":1,"stats":{"Line":2}},{"line":267,"address":[194848],"length":1,"stats":{"Line":2}},{"line":270,"address":[194856,195061,194992],"length":1,"stats":{"Line":6}},{"line":271,"address":[195085],"length":1,"stats":{"Line":2}},{"line":273,"address":[195261,195201],"length":1,"stats":{"Line":2}},{"line":274,"address":[195232],"length":1,"stats":{"Line":2}},{"line":281,"address":[195033],"length":1,"stats":{"Line":2}},{"line":282,"address":[195277],"length":1,"stats":{"Line":0}},{"line":286,"address":[195306],"length":1,"stats":{"Line":2}},{"line":287,"address":[195358,195475],"length":1,"stats":{"Line":2}},{"line":289,"address":[195464,195504],"length":1,"stats":{"Line":4}},{"line":290,"address":[195515],"length":1,"stats":{"Line":0}},{"line":294,"address":[195544],"length":1,"stats":{"Line":2}},{"line":295,"address":[195555],"length":1,"stats":{"Line":2}},{"line":296,"address":[195566],"length":1,"stats":{"Line":2}},{"line":297,"address":[195574],"length":1,"stats":{"Line":2}},{"line":298,"address":[195582],"length":1,"stats":{"Line":2}},{"line":299,"address":[195590],"length":1,"stats":{"Line":2}},{"line":300,"address":[195601],"length":1,"stats":{"Line":2}},{"line":303,"address":[195612,195680],"length":1,"stats":{"Line":2}},{"line":304,"address":[195673],"length":1,"stats":{"Line":0}},{"line":307,"address":[195706],"length":1,"stats":{"Line":2}},{"line":308,"address":[195862],"length":1,"stats":{"Line":2}},{"line":309,"address":[195904],"length":1,"stats":{"Line":2}},{"line":310,"address":[195912],"length":1,"stats":{"Line":2}},{"line":313,"address":[195950],"length":1,"stats":{"Line":2}},{"line":314,"address":[195974],"length":1,"stats":{"Line":2}},{"line":315,"address":[196015],"length":1,"stats":{"Line":2}},{"line":316,"address":[196053],"length":1,"stats":{"Line":0}},{"line":317,"address":[196045],"length":1,"stats":{"Line":0}},{"line":321,"address":[195984],"length":1,"stats":{"Line":0}},{"line":326,"address":[195798,196079,196058],"length":1,"stats":{"Line":6}},{"line":327,"address":[196072],"length":1,"stats":{"Line":2}},{"line":330,"address":[196102],"length":1,"stats":{"Line":0}},{"line":331,"address":[196270],"length":1,"stats":{"Line":0}},{"line":332,"address":[196312],"length":1,"stats":{"Line":0}},{"line":333,"address":[196320],"length":1,"stats":{"Line":0}},{"line":336,"address":[196358],"length":1,"stats":{"Line":0}},{"line":337,"address":[196382],"length":1,"stats":{"Line":0}},{"line":338,"address":[196423],"length":1,"stats":{"Line":0}},{"line":339,"address":[196461],"length":1,"stats":{"Line":0}},{"line":340,"address":[196453],"length":1,"stats":{"Line":0}},{"line":344,"address":[196392],"length":1,"stats":{"Line":0}},{"line":349,"address":[196205],"length":1,"stats":{"Line":2}},{"line":352,"address":[196216],"length":1,"stats":{"Line":2}},{"line":353,"address":[196494],"length":1,"stats":{"Line":1}},{"line":354,"address":[196506],"length":1,"stats":{"Line":0}},{"line":355,"address":[196518],"length":1,"stats":{"Line":0}},{"line":356,"address":[196530],"length":1,"stats":{"Line":1}},{"line":361,"address":[196540,196828,196562],"length":1,"stats":{"Line":4}},{"line":362,"address":[196820,196833,196572],"length":1,"stats":{"Line":0}},{"line":363,"address":[196550,196794],"length":1,"stats":{"Line":4}},{"line":364,"address":[196617,196786,196799],"length":1,"stats":{"Line":4}},{"line":365,"address":[196763,196605],"length":1,"stats":{"Line":0}},{"line":366,"address":[196726,196765],"length":1,"stats":{"Line":0}},{"line":370,"address":[196674],"length":1,"stats":{"Line":2}},{"line":371,"address":[196698],"length":1,"stats":{"Line":2}},{"line":372,"address":[196710,196884,196863],"length":1,"stats":{"Line":4}},{"line":373,"address":[196865],"length":1,"stats":{"Line":2}},{"line":375,"address":[196849],"length":1,"stats":{"Line":0}},{"line":377,"address":[196938,196893,196917],"length":1,"stats":{"Line":6}},{"line":378,"address":[196919],"length":1,"stats":{"Line":0}},{"line":380,"address":[196903],"length":1,"stats":{"Line":2}},{"line":386,"address":[196948,196970],"length":1,"stats":{"Line":4}},{"line":388,"address":[197005],"length":1,"stats":{"Line":0}},{"line":389,"address":[196958],"length":1,"stats":{"Line":2}},{"line":391,"address":[197079],"length":1,"stats":{"Line":2}},{"line":392,"address":[197042],"length":1,"stats":{"Line":0}},{"line":394,"address":[197197],"length":1,"stats":{"Line":0}},{"line":398,"address":[197136],"length":1,"stats":{"Line":2}},{"line":400,"address":[197309,197160],"length":1,"stats":{"Line":2}},{"line":401,"address":[197279],"length":1,"stats":{"Line":0}},{"line":403,"address":[197232],"length":1,"stats":{"Line":2}},{"line":404,"address":[197464,197342],"length":1,"stats":{"Line":2}},{"line":405,"address":[197541,197371],"length":1,"stats":{"Line":0}},{"line":406,"address":[197403,197605],"length":1,"stats":{"Line":0}},{"line":408,"address":[197436,197829,197695],"length":1,"stats":{"Line":2}},{"line":409,"address":[197665],"length":1,"stats":{"Line":1}},{"line":411,"address":[197700,197834],"length":1,"stats":{"Line":0}},{"line":418,"address":[197519],"length":1,"stats":{"Line":1}},{"line":421,"address":[198272],"length":1,"stats":{"Line":1}},{"line":429,"address":[198395],"length":1,"stats":{"Line":1}},{"line":430,"address":[198518],"length":1,"stats":{"Line":0}},{"line":434,"address":[198420],"length":1,"stats":{"Line":1}},{"line":437,"address":[198457,199132,198910,198836,198577],"length":1,"stats":{"Line":6}},{"line":438,"address":[198531,198759],"length":1,"stats":{"Line":1}},{"line":439,"address":[198958],"length":1,"stats":{"Line":0}},{"line":440,"address":[199050],"length":1,"stats":{"Line":1}},{"line":441,"address":[199203],"length":1,"stats":{"Line":1}},{"line":443,"address":[199290],"length":1,"stats":{"Line":0}},{"line":444,"address":[199305],"length":1,"stats":{"Line":0}},{"line":445,"address":[199362],"length":1,"stats":{"Line":0}},{"line":446,"address":[199424],"length":1,"stats":{"Line":0}},{"line":449,"address":[199487],"length":1,"stats":{"Line":0}},{"line":450,"address":[199501],"length":1,"stats":{"Line":0}},{"line":452,"address":[199588,199527],"length":1,"stats":{"Line":0}},{"line":455,"address":[199681],"length":1,"stats":{"Line":0}},{"line":456,"address":[199696],"length":1,"stats":{"Line":0}},{"line":457,"address":[199753],"length":1,"stats":{"Line":0}},{"line":458,"address":[199815],"length":1,"stats":{"Line":0}},{"line":460,"address":[199862],"length":1,"stats":{"Line":0}},{"line":462,"address":[198542],"length":1,"stats":{"Line":3}},{"line":465,"address":[198897],"length":1,"stats":{"Line":2}},{"line":467,"address":[199976],"length":1,"stats":{"Line":1}},{"line":468,"address":[199990],"length":1,"stats":{"Line":0}},{"line":472,"address":[200019,200168],"length":1,"stats":{"Line":2}},{"line":475,"address":[200584,200184,200117],"length":1,"stats":{"Line":3}},{"line":476,"address":[200200],"length":1,"stats":{"Line":0}},{"line":478,"address":[200249],"length":1,"stats":{"Line":2}},{"line":479,"address":[200552],"length":1,"stats":{"Line":2}},{"line":480,"address":[200589],"length":1,"stats":{"Line":1}},{"line":485,"address":[200297],"length":1,"stats":{"Line":2}},{"line":486,"address":[200343],"length":1,"stats":{"Line":2}},{"line":487,"address":[200407],"length":1,"stats":{"Line":2}},{"line":489,"address":[200442],"length":1,"stats":{"Line":2}},{"line":490,"address":[200489],"length":1,"stats":{"Line":2}},{"line":491,"address":[200491],"length":1,"stats":{"Line":2}},{"line":492,"address":[200494],"length":1,"stats":{"Line":2}},{"line":495,"address":[200505],"length":1,"stats":{"Line":2}},{"line":497,"address":[200514],"length":1,"stats":{"Line":2}},{"line":498,"address":[200704],"length":1,"stats":{"Line":0}},{"line":499,"address":[200760],"length":1,"stats":{"Line":1}},{"line":500,"address":[200816],"length":1,"stats":{"Line":0}},{"line":501,"address":[200872],"length":1,"stats":{"Line":0}},{"line":502,"address":[200648],"length":1,"stats":{"Line":1}},{"line":506,"address":[199937],"length":1,"stats":{"Line":3}},{"line":510,"address":[200896],"length":1,"stats":{"Line":3}},{"line":517,"address":[200991],"length":1,"stats":{"Line":3}},{"line":518,"address":[201109],"length":1,"stats":{"Line":0}},{"line":520,"address":[201021],"length":1,"stats":{"Line":3}},{"line":523,"address":[201041],"length":1,"stats":{"Line":3}},{"line":524,"address":[201083],"length":1,"stats":{"Line":3}},{"line":525,"address":[201124],"length":1,"stats":{"Line":3}},{"line":526,"address":[201156],"length":1,"stats":{"Line":0}},{"line":528,"address":[201194],"length":1,"stats":{"Line":3}},{"line":529,"address":[201209],"length":1,"stats":{"Line":3}},{"line":532,"address":[201240],"length":1,"stats":{"Line":3}},{"line":533,"address":[201263],"length":1,"stats":{"Line":3}},{"line":536,"address":[201390],"length":1,"stats":{"Line":1}},{"line":538,"address":[201416],"length":1,"stats":{"Line":1}},{"line":540,"address":[201456],"length":1,"stats":{"Line":1}},{"line":541,"address":[201493],"length":1,"stats":{"Line":0}},{"line":542,"address":[201567],"length":1,"stats":{"Line":0}},{"line":543,"address":[201622],"length":1,"stats":{"Line":0}},{"line":545,"address":[201645],"length":1,"stats":{"Line":1}},{"line":548,"address":[201667],"length":1,"stats":{"Line":1}},{"line":551,"address":[201287],"length":1,"stats":{"Line":3}},{"line":552,"address":[201362],"length":1,"stats":{"Line":3}},{"line":555,"address":[201269],"length":1,"stats":{"Line":3}},{"line":558,"address":[201696],"length":1,"stats":{"Line":1}},{"line":566,"address":[201766],"length":1,"stats":{"Line":1}},{"line":567,"address":[201976],"length":1,"stats":{"Line":0}},{"line":570,"address":[201800],"length":1,"stats":{"Line":1}},{"line":572,"address":[201832],"length":1,"stats":{"Line":1}},{"line":573,"address":[201848],"length":1,"stats":{"Line":1}},{"line":574,"address":[201882],"length":1,"stats":{"Line":1}},{"line":575,"address":[201932],"length":1,"stats":{"Line":1}},{"line":576,"address":[201958],"length":1,"stats":{"Line":1}},{"line":577,"address":[201969],"length":1,"stats":{"Line":1}},{"line":580,"address":[202000,204990],"length":1,"stats":{"Line":5}},{"line":586,"address":[202109],"length":1,"stats":{"Line":5}},{"line":587,"address":[202136,202220],"length":1,"stats":{"Line":2}},{"line":590,"address":[202335],"length":1,"stats":{"Line":1}},{"line":591,"address":[202400],"length":1,"stats":{"Line":1}},{"line":592,"address":[202405],"length":1,"stats":{"Line":1}},{"line":594,"address":[202415],"length":1,"stats":{"Line":0}},{"line":601,"address":[202182],"length":1,"stats":{"Line":5}},{"line":602,"address":[202485],"length":1,"stats":{"Line":1}},{"line":603,"address":[202492],"length":1,"stats":{"Line":1}},{"line":605,"address":[202454],"length":1,"stats":{"Line":5}},{"line":606,"address":[202549],"length":1,"stats":{"Line":1}},{"line":607,"address":[202556],"length":1,"stats":{"Line":1}},{"line":609,"address":[202518],"length":1,"stats":{"Line":5}},{"line":610,"address":[202616],"length":1,"stats":{"Line":1}},{"line":611,"address":[202621],"length":1,"stats":{"Line":1}},{"line":617,"address":[202585],"length":1,"stats":{"Line":5}},{"line":618,"address":[202686],"length":1,"stats":{"Line":1}},{"line":619,"address":[202730],"length":1,"stats":{"Line":1}},{"line":620,"address":[206521],"length":1,"stats":{"Line":1}},{"line":621,"address":[206553],"length":1,"stats":{"Line":1}},{"line":623,"address":[206576],"length":1,"stats":{"Line":0}},{"line":624,"address":[206590],"length":1,"stats":{"Line":0}},{"line":630,"address":[202650],"length":1,"stats":{"Line":5}},{"line":631,"address":[202875],"length":1,"stats":{"Line":1}},{"line":632,"address":[202964],"length":1,"stats":{"Line":1}},{"line":634,"address":[203059],"length":1,"stats":{"Line":1}},{"line":635,"address":[203103],"length":1,"stats":{"Line":1}},{"line":638,"address":[202829],"length":1,"stats":{"Line":4}},{"line":639,"address":[203182],"length":1,"stats":{"Line":1}},{"line":640,"address":[203245],"length":1,"stats":{"Line":1}},{"line":641,"address":[206456,206402],"length":1,"stats":{"Line":2}},{"line":642,"address":[206486],"length":1,"stats":{"Line":1}},{"line":643,"address":[206493],"length":1,"stats":{"Line":1}},{"line":644,"address":[206500],"length":1,"stats":{"Line":1}},{"line":646,"address":[206438],"length":1,"stats":{"Line":0}},{"line":650,"address":[203136],"length":1,"stats":{"Line":4}},{"line":651,"address":[203357],"length":1,"stats":{"Line":1}},{"line":652,"address":[203436],"length":1,"stats":{"Line":1}},{"line":653,"address":[206143],"length":1,"stats":{"Line":0}},{"line":654,"address":[206331],"length":1,"stats":{"Line":0}},{"line":655,"address":[206347],"length":1,"stats":{"Line":0}},{"line":656,"address":[206376],"length":1,"stats":{"Line":0}},{"line":658,"address":[206389],"length":1,"stats":{"Line":0}},{"line":661,"address":[206040],"length":1,"stats":{"Line":1}},{"line":662,"address":[206191],"length":1,"stats":{"Line":1}},{"line":669,"address":[206255],"length":1,"stats":{"Line":1}},{"line":670,"address":[206284],"length":1,"stats":{"Line":1}},{"line":672,"address":[206297],"length":1,"stats":{"Line":0}},{"line":677,"address":[203314],"length":1,"stats":{"Line":3}},{"line":678,"address":[203518],"length":1,"stats":{"Line":0}},{"line":679,"address":[205388,203596],"length":1,"stats":{"Line":0}},{"line":680,"address":[205443,205394],"length":1,"stats":{"Line":0}},{"line":681,"address":[205476],"length":1,"stats":{"Line":0}},{"line":682,"address":[205572],"length":1,"stats":{"Line":0}},{"line":683,"address":[205631,205692],"length":1,"stats":{"Line":0}},{"line":684,"address":[205739],"length":1,"stats":{"Line":0}},{"line":685,"address":[205770,205675],"length":1,"stats":{"Line":0}},{"line":692,"address":[205925],"length":1,"stats":{"Line":0}},{"line":693,"address":[206003],"length":1,"stats":{"Line":0}},{"line":696,"address":[205425],"length":1,"stats":{"Line":0}},{"line":699,"address":[203475],"length":1,"stats":{"Line":3}},{"line":700,"address":[203676],"length":1,"stats":{"Line":1}},{"line":701,"address":[203731],"length":1,"stats":{"Line":1}},{"line":702,"address":[205020],"length":1,"stats":{"Line":1}},{"line":703,"address":[205062],"length":1,"stats":{"Line":1}},{"line":704,"address":[205088,205243,205173],"length":1,"stats":{"Line":2}},{"line":705,"address":[205335,205274,205189],"length":1,"stats":{"Line":2}},{"line":706,"address":[205304],"length":1,"stats":{"Line":1}},{"line":708,"address":[205327],"length":1,"stats":{"Line":0}},{"line":711,"address":[205235],"length":1,"stats":{"Line":0}},{"line":714,"address":[205147],"length":1,"stats":{"Line":0}},{"line":718,"address":[203630],"length":1,"stats":{"Line":3}},{"line":719,"address":[203980],"length":1,"stats":{"Line":0}},{"line":720,"address":[204035],"length":1,"stats":{"Line":0}},{"line":721,"address":[204759,204778],"length":1,"stats":{"Line":0}},{"line":722,"address":[204802,204751,204770],"length":1,"stats":{"Line":0}},{"line":723,"address":[204893,204820],"length":1,"stats":{"Line":0}},{"line":724,"address":[204964],"length":1,"stats":{"Line":0}},{"line":726,"address":[204827],"length":1,"stats":{"Line":0}},{"line":731,"address":[203830],"length":1,"stats":{"Line":3}},{"line":732,"address":[203857],"length":1,"stats":{"Line":3}},{"line":734,"address":[203869,204118,204192],"length":1,"stats":{"Line":8}},{"line":735,"address":[204233],"length":1,"stats":{"Line":3}},{"line":736,"address":[204245],"length":1,"stats":{"Line":3}},{"line":741,"address":[204176,204315],"length":1,"stats":{"Line":6}},{"line":743,"address":[204336],"length":1,"stats":{"Line":3}},{"line":744,"address":[204620,204459,204399],"length":1,"stats":{"Line":6}},{"line":747,"address":[204544],"length":1,"stats":{"Line":3}},{"line":748,"address":[204662],"length":1,"stats":{"Line":3}},{"line":750,"address":[204694],"length":1,"stats":{"Line":3}},{"line":752,"address":[204717],"length":1,"stats":{"Line":0}},{"line":756,"address":[204422],"length":1,"stats":{"Line":0}}],"covered":213,"coverable":398},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","formula.rs"],"content":"use crate::cell::{CellValue, parse_cell_reference};\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n#[derive(Debug, PartialEq, Clone)]\r\npub struct Range {\r\n    pub start_row: i16,\r\n    pub start_col: i16,\r\n    pub end_row: i16,\r\n    pub end_col: i16,\r\n}\r\n\r\n// Optimize the sum_value function for large ranges\r\npub fn sum_value(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let mut sum = 0;\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    // For smaller ranges, use the original approach\r\n    for i in start_row..=end_row {\r\n        for j in start_col..=end_col {\r\n            let ref_cell_value = sheet.get_cell(i, j);\r\n            if let CellValue::Integer(value) = ref_cell_value {\r\n                sum += value;\r\n            } else {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Now set the result\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(sum);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Add variance evaluation function\r\npub fn eval_variance(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    let count = ((end_row - start_row + 1) as i32) * ((end_col - start_col + 1) as i32);\r\n    sum_value(sheet, row, col, parent1, parent2);\r\n    // Check if sum_value was successful\r\n    let cell_value = sheet.get_mut_cell(row, col);\r\n    let mean_value;\r\n    if let CellValue::Integer(value) = cell_value {\r\n        let val = *value / count;\r\n        *cell_value = CellValue::Integer(val);\r\n        mean_value = val as f64;\r\n    } else {\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    let mut variance = 0.0;\r\n\r\n    for i in start_row..=end_row {\r\n        for j in start_col..=end_col {\r\n            if let CellValue::Integer(value) = *sheet.get_cell(i, j) {\r\n                variance += ((value as f64) - (mean_value)).powi(2);\r\n            }\r\n        }\r\n    }\r\n\r\n    variance /= count as f64;\r\n    let std_dev = (variance.sqrt() + 0.5) as i32;\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(std_dev);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn eval_min(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let mut min_value = i32::MAX;\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    // First collect all values (immutable borrows)\r\n    for r in start_row..=end_row {\r\n        for c in start_col..=end_col {\r\n            if let CellValue::Integer(value) = sheet.get_cell(r, c) {\r\n                min_value = std::cmp::min(min_value, *value);\r\n            } else {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Now get the mutable cell and set its value (mutable borrow)\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(min_value);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Fix eval_max implementation\r\npub fn eval_max(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let mut max_value = i32::MIN;\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    // First collect all values (immutable borrows)\r\n    for r in start_row..=end_row {\r\n        for c in start_col..=end_col {\r\n            if let CellValue::Integer(value) = sheet.get_cell(r, c) {\r\n                max_value = std::cmp::max(max_value, *value);\r\n            } else {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Now get the mutable cell and set its value (mutable borrow)\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(max_value);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\npub fn eval_avg(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    parent1: i32,\r\n    parent2: i32,\r\n) -\u003e CommandStatus {\r\n    let (start_row, start_col) = sheet.get_row_col(parent1);\r\n    let (end_row, end_col) = sheet.get_row_col(parent2);\r\n    let count = ((end_row - start_row + 1) as i32) * ((end_col - start_col + 1) as i32);\r\n    match sum_value(sheet, row, col, parent1, parent2) {\r\n        CommandStatus::CmdOk =\u003e {\r\n            let cell_value = sheet.get_mut_cell(row, col);\r\n            if let CellValue::Integer(value) = cell_value {\r\n                *cell_value = CellValue::Integer(*value / count);\r\n            }\r\n        }\r\n        _ =\u003e return CommandStatus::CmdOk,\r\n    }\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Keep the Range struct and parse_range function\r\npub fn parse_range(spreadsheet: \u0026Spreadsheet, range_str: \u0026str) -\u003e Result\u003cRange, CommandStatus\u003e {\r\n    // Check for minimum valid range pattern length (like \"A1:A1\")\r\n    if range_str.len() \u003c 3 {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Find the colon index using bytes to avoid UTF-8 decoding\r\n    let bytes = range_str.as_bytes();\r\n    let mut colon_index = 0;\r\n\r\n    for (i, \u0026b) in bytes.iter().enumerate() {\r\n        if b == b':' {\r\n            colon_index = i;\r\n            break;\r\n        }\r\n    }\r\n\r\n    // Validate colon position (must exist and have chars on both sides)\r\n    if colon_index == 0 || colon_index + 1 \u003e= range_str.len() {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Avoid creating new strings by using slices\r\n    let start_cell = \u0026range_str[..colon_index];\r\n    let end_cell = \u0026range_str[colon_index + 1..];\r\n\r\n    // Parse cell references and validate them in one step\r\n    let (start_row, start_col) = parse_cell_reference(spreadsheet, start_cell)?;\r\n    let (end_row, end_col) = parse_cell_reference(spreadsheet, end_cell)?;\r\n\r\n    // Ensure coordinates are valid and range is properly ordered\r\n    if start_row \u003c 0\r\n        || start_col \u003c 0\r\n        || end_row \u003c 0\r\n        || end_col \u003c 0\r\n        || start_row \u003e end_row\r\n        || start_col \u003e end_col\r\n    {\r\n        return Err(CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    // Construct the Range directly\r\n    Ok(Range {\r\n        start_row,\r\n        start_col,\r\n        end_row,\r\n        end_col,\r\n    })\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_sum_value() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            sum_value(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_sum_value_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Error;\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            sum_value(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_variance() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(2);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(4);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_variance(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(1));\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_variance_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Error;\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(4);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_variance(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_min() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(3);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_min(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(1));\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_max() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(3);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_max(\u0026mut sheet, 1, 2, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 2), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_min_max_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Error;\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_min(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n        assert_eq!(\r\n            eval_max(\u0026mut sheet, 1, 2, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 2), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_eval_avg() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(2);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(4);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        assert_eq!(\r\n            eval_avg(\u0026mut sheet, 1, 1, parent1, parent2),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_range_valid() {\r\n        let sheet = create_test_spreadsheet(5, 5);\r\n        let range = parse_range(\u0026sheet, \"A1:B2\").unwrap();\r\n        assert_eq!(range.start_row, 0);\r\n        assert_eq!(range.start_col, 0);\r\n        assert_eq!(range.end_row, 1);\r\n        assert_eq!(range.end_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_parse_range_invalid() {\r\n        let sheet = create_test_spreadsheet(5, 5);\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \"A\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \"A1:\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \":A1\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n        assert_eq!(\r\n            parse_range(\u0026sheet, \"B2:A1\"),\r\n            Err(CommandStatus::CmdUnrecognized)\r\n        );\r\n    }\r\n}\r\n","traces":[{"line":13,"address":[312608],"length":1,"stats":{"Line":1}},{"line":20,"address":[312684],"length":1,"stats":{"Line":1}},{"line":21,"address":[312692],"length":1,"stats":{"Line":1}},{"line":22,"address":[312735],"length":1,"stats":{"Line":1}},{"line":24,"address":[313046,312769],"length":1,"stats":{"Line":2}},{"line":25,"address":[313249,313064],"length":1,"stats":{"Line":2}},{"line":26,"address":[313307],"length":1,"stats":{"Line":1}},{"line":27,"address":[313331],"length":1,"stats":{"Line":1}},{"line":28,"address":[313356],"length":1,"stats":{"Line":1}},{"line":30,"address":[313390],"length":1,"stats":{"Line":1}},{"line":31,"address":[313422],"length":1,"stats":{"Line":1}},{"line":37,"address":[312986],"length":1,"stats":{"Line":1}},{"line":38,"address":[313026],"length":1,"stats":{"Line":1}},{"line":42,"address":[313440],"length":1,"stats":{"Line":2}},{"line":49,"address":[313519],"length":1,"stats":{"Line":1}},{"line":50,"address":[313559],"length":1,"stats":{"Line":1}},{"line":51,"address":[313878,313595],"length":1,"stats":{"Line":1}},{"line":52,"address":[313818],"length":1,"stats":{"Line":1}},{"line":54,"address":[313844],"length":1,"stats":{"Line":1}},{"line":56,"address":[313903,313868],"length":1,"stats":{"Line":2}},{"line":57,"address":[313918,313950,314262],"length":1,"stats":{"Line":2}},{"line":58,"address":[314028],"length":1,"stats":{"Line":1}},{"line":59,"address":[314055],"length":1,"stats":{"Line":1}},{"line":61,"address":[313932],"length":1,"stats":{"Line":1}},{"line":64,"address":[314074],"length":1,"stats":{"Line":1}},{"line":66,"address":[314278,314499,314083],"length":1,"stats":{"Line":3}},{"line":67,"address":[314735,314520],"length":1,"stats":{"Line":2}},{"line":68,"address":[314883,314808],"length":1,"stats":{"Line":2}},{"line":69,"address":[314853],"length":1,"stats":{"Line":1}},{"line":74,"address":[314329],"length":1,"stats":{"Line":1}},{"line":75,"address":[314349],"length":1,"stats":{"Line":1}},{"line":76,"address":[314431],"length":1,"stats":{"Line":1}},{"line":77,"address":[314479],"length":1,"stats":{"Line":1}},{"line":80,"address":[314896],"length":1,"stats":{"Line":2}},{"line":87,"address":[314966],"length":1,"stats":{"Line":1}},{"line":88,"address":[314974],"length":1,"stats":{"Line":2}},{"line":89,"address":[315017],"length":1,"stats":{"Line":2}},{"line":91,"address":[315328,315051],"length":1,"stats":{"Line":4}},{"line":92,"address":[315531,315647,315346],"length":1,"stats":{"Line":6}},{"line":93,"address":[315589],"length":1,"stats":{"Line":2}},{"line":94,"address":[315631],"length":1,"stats":{"Line":2}},{"line":96,"address":[315664],"length":1,"stats":{"Line":1}},{"line":97,"address":[315696],"length":1,"stats":{"Line":1}},{"line":103,"address":[315268],"length":1,"stats":{"Line":1}},{"line":104,"address":[315308],"length":1,"stats":{"Line":1}},{"line":108,"address":[315712],"length":1,"stats":{"Line":1}},{"line":115,"address":[315782],"length":1,"stats":{"Line":1}},{"line":116,"address":[315790],"length":1,"stats":{"Line":1}},{"line":117,"address":[315833],"length":1,"stats":{"Line":1}},{"line":119,"address":[315867,316144],"length":1,"stats":{"Line":2}},{"line":120,"address":[316347,316463,316162],"length":1,"stats":{"Line":3}},{"line":121,"address":[316405],"length":1,"stats":{"Line":1}},{"line":122,"address":[316447],"length":1,"stats":{"Line":1}},{"line":124,"address":[316480],"length":1,"stats":{"Line":1}},{"line":125,"address":[316512],"length":1,"stats":{"Line":1}},{"line":131,"address":[316084],"length":1,"stats":{"Line":1}},{"line":132,"address":[316124],"length":1,"stats":{"Line":1}},{"line":135,"address":[316528],"length":1,"stats":{"Line":1}},{"line":142,"address":[316589],"length":1,"stats":{"Line":1}},{"line":143,"address":[316623],"length":1,"stats":{"Line":1}},{"line":144,"address":[316896,316648],"length":1,"stats":{"Line":1}},{"line":145,"address":[316868],"length":1,"stats":{"Line":1}},{"line":147,"address":[316927],"length":1,"stats":{"Line":1}},{"line":148,"address":[316977,317100,316948],"length":1,"stats":{"Line":3}},{"line":149,"address":[317018,317102,316989],"length":1,"stats":{"Line":2}},{"line":152,"address":[316958],"length":1,"stats":{"Line":0}},{"line":154,"address":[317003],"length":1,"stats":{"Line":1}},{"line":158,"address":[317136],"length":1,"stats":{"Line":1}},{"line":160,"address":[317208],"length":1,"stats":{"Line":2}},{"line":161,"address":[317360],"length":1,"stats":{"Line":1}},{"line":165,"address":[317233],"length":1,"stats":{"Line":2}},{"line":166,"address":[317260],"length":1,"stats":{"Line":2}},{"line":168,"address":[317269,317380,317448],"length":1,"stats":{"Line":6}},{"line":169,"address":[317486],"length":1,"stats":{"Line":2}},{"line":170,"address":[317495],"length":1,"stats":{"Line":2}},{"line":176,"address":[317533,317438],"length":1,"stats":{"Line":4}},{"line":177,"address":[317507],"length":1,"stats":{"Line":1}},{"line":181,"address":[317608],"length":1,"stats":{"Line":2}},{"line":182,"address":[317942,317651],"length":1,"stats":{"Line":2}},{"line":185,"address":[317973,318221,317754],"length":1,"stats":{"Line":4}},{"line":186,"address":[318031,318260,318330],"length":1,"stats":{"Line":4}},{"line":189,"address":[318317],"length":1,"stats":{"Line":2}},{"line":190,"address":[318369],"length":1,"stats":{"Line":2}},{"line":191,"address":[318407],"length":1,"stats":{"Line":2}},{"line":192,"address":[318418],"length":1,"stats":{"Line":2}},{"line":193,"address":[318433],"length":1,"stats":{"Line":2}},{"line":194,"address":[318448],"length":1,"stats":{"Line":2}},{"line":196,"address":[318380],"length":1,"stats":{"Line":1}},{"line":200,"address":[318477],"length":1,"stats":{"Line":2}}],"covered":88,"coverable":89},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","graph.rs"],"content":"use crate::spreadsheet::Spreadsheet;\r\n\r\npub fn add_children(\r\n    sheet: \u0026mut Spreadsheet,\r\n    cell1: i32,\r\n    cell2: i32,\r\n    formula: i16,\r\n    row: i16,\r\n    col: i16,\r\n) {\r\n    if formula == -1 {\r\n        return;\r\n    }\r\n    let rem = formula % 10;\r\n    let child_key = sheet.get_key(row, col);\r\n    if rem == 0 {\r\n        sheet.add_child(\u0026cell1, \u0026child_key);\r\n        sheet.add_child(\u0026cell2, \u0026child_key);\r\n    } else if rem == 2 {\r\n        sheet.add_child(\u0026cell1, \u0026child_key);\r\n    } else if rem == 3 {\r\n        sheet.add_child(\u0026cell2, \u0026child_key);\r\n    } else {\r\n        // For range operations, use the optimized range_children structure\r\n        sheet.add_range_child(cell1, cell2, child_key);\r\n    }\r\n}\r\n\r\npub fn remove_all_parents(sheet: \u0026mut Spreadsheet, row: i16, col: i16) {\r\n    // This removes the child row, col from its parent cells\r\n    let child_key = sheet.get_key(row, col);\r\n\r\n    let meta = match sheet.cell_meta.get(\u0026child_key) {\r\n        Some(meta) =\u003e meta,\r\n        None =\u003e return, // No metadata, no parents to remove\r\n    };\r\n\r\n    if meta.formula == -1 {\r\n        return;\r\n    }\r\n\r\n    let rem: i16 = (meta.formula % 10) as i16;\r\n\r\n    if rem \u003e= 5 \u0026\u0026 rem \u003c= 9 {\r\n        // Use the optimized range_children removal for range operations\r\n        sheet.remove_range_child(child_key);\r\n    } else if rem == 0 {\r\n        let parent1 = meta.parent1;\r\n        let parent2 = meta.parent2;\r\n        sheet.remove_child(parent1, child_key);\r\n        sheet.remove_child(parent2, child_key);\r\n    } else if rem == 2 {\r\n        sheet.remove_child(meta.parent1, child_key);\r\n    } else if rem == 3 {\r\n        sheet.remove_child(meta.parent2, child_key);\r\n    }\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::spreadsheet::Spreadsheet;\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_children_both_parents() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(0, 1);\r\n        let child = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, parent2, 0, 1, 1); // Formula type 0\r\n        assert!(sheet.get_cell_children(parent1).unwrap().contains(\u0026child));\r\n        assert!(sheet.get_cell_children(parent2).unwrap().contains(\u0026child));\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_children_single_parent() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let child = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, -1, 2, 1, 1); // Formula type 2\r\n        assert!(sheet.get_cell_children(parent1).unwrap().contains(\u0026child));\r\n        assert!(sheet.get_cell_children(-1).is_none());\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_children_range() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, parent2, 5, 2, 2); // Formula type 5 (SUM)\r\n    }\r\n\r\n    #[test]\r\n    fn test_remove_all_parents_no_meta() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        remove_all_parents(\u0026mut sheet, 1, 1);\r\n        assert!(!sheet.cell_meta.contains_key(\u0026sheet.get_key(1, 1)));\r\n    }\r\n\r\n    #[test]\r\n    fn test_remove_all_parents_single_parent() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let child = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, -1, 2, 1, 1);\r\n        let meta = sheet.get_cell_meta(1, 1);\r\n        meta.parent1 = parent1;\r\n        meta.formula = 2;\r\n        remove_all_parents(\u0026mut sheet, 1, 1);\r\n        let children = sheet.get_cell_children(parent1);\r\n        assert!(children.is_none() || !children.unwrap().contains(\u0026child));\r\n    }\r\n\r\n    #[test]\r\n    fn test_remove_all_parents_range() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let parent1 = sheet.get_key(0, 0);\r\n        let parent2 = sheet.get_key(1, 1);\r\n        add_children(\u0026mut sheet, parent1, parent2, 5, 2, 2); // adds range child\r\n        let meta = sheet.get_cell_meta(2, 2);\r\n        meta.parent1 = parent1;\r\n        meta.parent2 = parent2;\r\n        meta.formula = 5;\r\n        remove_all_parents(\u0026mut sheet, 2, 2);\r\n    }\r\n}\r\n","traces":[{"line":3,"address":[386544],"length":1,"stats":{"Line":1}},{"line":11,"address":[386625],"length":1,"stats":{"Line":1}},{"line":14,"address":[386641,386721],"length":1,"stats":{"Line":1}},{"line":15,"address":[386693],"length":1,"stats":{"Line":1}},{"line":16,"address":[386713],"length":1,"stats":{"Line":2}},{"line":17,"address":[386742],"length":1,"stats":{"Line":1}},{"line":18,"address":[386762],"length":1,"stats":{"Line":1}},{"line":19,"address":[386787],"length":1,"stats":{"Line":2}},{"line":20,"address":[386798],"length":1,"stats":{"Line":2}},{"line":21,"address":[386823],"length":1,"stats":{"Line":2}},{"line":22,"address":[386834],"length":1,"stats":{"Line":0}},{"line":25,"address":[386859],"length":1,"stats":{"Line":2}},{"line":29,"address":[386896],"length":1,"stats":{"Line":1}},{"line":31,"address":[386926],"length":1,"stats":{"Line":1}},{"line":33,"address":[386946],"length":1,"stats":{"Line":1}},{"line":34,"address":[386996],"length":1,"stats":{"Line":1}},{"line":38,"address":[387011],"length":1,"stats":{"Line":1}},{"line":42,"address":[387077,387023],"length":1,"stats":{"Line":1}},{"line":44,"address":[387111,387069],"length":1,"stats":{"Line":2}},{"line":46,"address":[387122],"length":1,"stats":{"Line":1}},{"line":47,"address":[387098],"length":1,"stats":{"Line":1}},{"line":48,"address":[387146],"length":1,"stats":{"Line":0}},{"line":49,"address":[387152],"length":1,"stats":{"Line":0}},{"line":50,"address":[387163],"length":1,"stats":{"Line":0}},{"line":51,"address":[387181],"length":1,"stats":{"Line":0}},{"line":52,"address":[387200],"length":1,"stats":{"Line":1}},{"line":53,"address":[387216],"length":1,"stats":{"Line":1}},{"line":54,"address":[387237],"length":1,"stats":{"Line":0}},{"line":55,"address":[387257],"length":1,"stats":{"Line":0}}],"covered":22,"coverable":29},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","main.rs"],"content":"mod cell;\r\nmod evaluator;\r\nmod formula;\r\nmod graph;\r\nmod reevaluate_topo;\r\nmod spreadsheet;\r\nmod vim_mode;\r\nmod visualize_cells;\r\nmod extensions;\r\nuse std::env;\r\nuse std::io::{self, Write};\r\nuse std::process;\r\nuse std::thread::sleep;\r\nuse std::time::{Duration, Instant};\r\nuse evaluator::handle_command;\r\nuse spreadsheet::CommandStatus;\r\nuse spreadsheet::Spreadsheet;\r\nconst DEFAULT_FILENAME: \u0026str = \"untitled.sheet\";\r\n\r\nfn main() {\r\n    let args: Vec\u003cString\u003e = env::args().collect();\r\n    let mut vim_mode_enabled = false;\r\n    let mut rows_arg_index = 1;\r\n    let mut cols_arg_index = 2;\r\n\r\n    if args.len() \u003e 1 \u0026\u0026 args[1] == \"--vim\" {\r\n        vim_mode_enabled = true;\r\n        rows_arg_index = 2;\r\n        cols_arg_index = 3;\r\n    }\r\n\r\n    // else if args.len() != 3 {\r\n    //     eprintln!(\"Usage: {} \u003crows\u003e \u003ccolumns\u003e\", args[0]);\r\n    //     process::exit(1);\r\n    // }\r\n\r\n    let rows: i16 = args[rows_arg_index].parse().unwrap_or_else(|_| {\r\n        eprintln!(\"Invalid number for rows\");\r\n        process::exit(1);\r\n    });\r\n\r\n    let cols: i16 = args[cols_arg_index].parse().unwrap_or_else(|_| {\r\n        eprintln!(\"Invalid number for columns\");\r\n        process::exit(1);\r\n    });\r\n\r\n    let mut sleep_time = 0.0; // Initialize sleep time\r\n    let start = Instant::now();\r\n\r\n    let mut sheet = match Spreadsheet::create(rows, cols) {\r\n        Some(s) =\u003e s,\r\n        None =\u003e {\r\n            eprintln!(\r\n                \"Failed to create spreadsheet with dimensions {}x{}\",\r\n                rows, cols\r\n            );\r\n            eprintln!(\"Please try smaller dimensions.\");\r\n            process::exit(1);\r\n        }\r\n    };\r\n    if vim_mode_enabled {\r\n        let filename = Some(DEFAULT_FILENAME.to_string());\r\n        vim_mode::run_editor(\u0026mut sheet, filename);\r\n    } else {\r\n        let mut command_time = start.elapsed().as_secs_f64();\r\n        let mut last_time = command_time; // Update last_time with the command time\r\n\r\n        let mut last_status = \"ok\"; // Placeholder for last status\r\n        let mut input = String::with_capacity(128);\r\n\r\n        // Main loop for command input\r\n        loop {\r\n            sheet.print_spreadsheet();\r\n            print!(\"[{:.1}] ({}) \u003e \", last_time, last_status);\r\n            io::stdout().flush().unwrap(); // Ensure the prompt is shown\r\n\r\n            input.clear();\r\n            if io::stdin().read_line(\u0026mut input).unwrap() == 0 {\r\n                break; // End of input\r\n            }\r\n\r\n            let trimmed = input.trim(); // Remove any newline characters\r\n            if trimmed == \"q\" {\r\n                break;\r\n            }\r\n\r\n            // Process the command and measure execution time\r\n            let start = Instant::now();\r\n            // Pass by reference instead of cloning\r\n            let status = handle_command(\u0026mut sheet, trimmed, \u0026mut sleep_time);\r\n            command_time = start.elapsed().as_secs_f64();\r\n\r\n            if sleep_time \u003c= command_time {\r\n                sleep_time = 0.0;\r\n            } else {\r\n                sleep_time -= command_time;\r\n            }\r\n            last_time = command_time + sleep_time;\r\n            if sleep_time \u003e 0.0 {\r\n                sleep(Duration::from_secs_f64(sleep_time));\r\n            }\r\n            sleep_time = 0.0;\r\n\r\n            // Update last_status based on the current command status\r\n            last_status = match status {\r\n                CommandStatus::CmdOk =\u003e \"ok\",\r\n                CommandStatus::CmdUnrecognized =\u003e \"unrecognized_cmd\",\r\n                CommandStatus::CmdCircularRef =\u003e \"circular_ref\",\r\n                CommandStatus::CmdInvalidCell =\u003e \"invalid_cell\",\r\n                CommandStatus::CmdLockedCell =\u003e \"locked_cell\",\r\n            };\r\n        }\r\n    }\r\n}\r\n","traces":[{"line":19,"address":[264784,267669,267580],"length":1,"stats":{"Line":0}},{"line":20,"address":[264791],"length":1,"stats":{"Line":0}},{"line":21,"address":[264853],"length":1,"stats":{"Line":0}},{"line":22,"address":[264861],"length":1,"stats":{"Line":0}},{"line":23,"address":[264873],"length":1,"stats":{"Line":0}},{"line":25,"address":[264885,264992,265101,264948],"length":1,"stats":{"Line":0}},{"line":26,"address":[265069],"length":1,"stats":{"Line":0}},{"line":27,"address":[265077],"length":1,"stats":{"Line":0}},{"line":28,"address":[265089],"length":1,"stats":{"Line":0}},{"line":36,"address":[232976],"length":1,"stats":{"Line":0}},{"line":37,"address":[232987],"length":1,"stats":{"Line":0}},{"line":38,"address":[233027],"length":1,"stats":{"Line":0}},{"line":41,"address":[233056],"length":1,"stats":{"Line":0}},{"line":42,"address":[233067],"length":1,"stats":{"Line":0}},{"line":43,"address":[233107],"length":1,"stats":{"Line":0}},{"line":46,"address":[265440],"length":1,"stats":{"Line":0}},{"line":47,"address":[265452],"length":1,"stats":{"Line":0}},{"line":49,"address":[265508],"length":1,"stats":{"Line":0}},{"line":50,"address":[265597],"length":1,"stats":{"Line":0}},{"line":52,"address":[265590,265684],"length":1,"stats":{"Line":0}},{"line":56,"address":[265776],"length":1,"stats":{"Line":0}},{"line":57,"address":[265821],"length":1,"stats":{"Line":0}},{"line":60,"address":[265649],"length":1,"stats":{"Line":0}},{"line":61,"address":[267589,265873],"length":1,"stats":{"Line":0}},{"line":62,"address":[267639],"length":1,"stats":{"Line":0}},{"line":64,"address":[265839,265958],"length":1,"stats":{"Line":0}},{"line":65,"address":[266015],"length":1,"stats":{"Line":0}},{"line":67,"address":[266033],"length":1,"stats":{"Line":0}},{"line":68,"address":[266073],"length":1,"stats":{"Line":0}},{"line":71,"address":[267560],"length":1,"stats":{"Line":0}},{"line":72,"address":[266090],"length":1,"stats":{"Line":0}},{"line":73,"address":[266153],"length":1,"stats":{"Line":0}},{"line":74,"address":[266617],"length":1,"stats":{"Line":0}},{"line":76,"address":[266709],"length":1,"stats":{"Line":0}},{"line":77,"address":[266716],"length":1,"stats":{"Line":0}},{"line":81,"address":[266872],"length":1,"stats":{"Line":0}},{"line":82,"address":[266948],"length":1,"stats":{"Line":0}},{"line":87,"address":[266988],"length":1,"stats":{"Line":0}},{"line":89,"address":[267032],"length":1,"stats":{"Line":0}},{"line":90,"address":[267086],"length":1,"stats":{"Line":0}},{"line":92,"address":[267174,267229],"length":1,"stats":{"Line":0}},{"line":93,"address":[267231],"length":1,"stats":{"Line":0}},{"line":95,"address":[267198],"length":1,"stats":{"Line":0}},{"line":97,"address":[267244],"length":1,"stats":{"Line":0}},{"line":98,"address":[267271],"length":1,"stats":{"Line":0}},{"line":99,"address":[267336],"length":1,"stats":{"Line":0}},{"line":101,"address":[267290],"length":1,"stats":{"Line":0}},{"line":104,"address":[267528,267302],"length":1,"stats":{"Line":0}},{"line":105,"address":[267385],"length":1,"stats":{"Line":0}},{"line":106,"address":[267414],"length":1,"stats":{"Line":0}},{"line":107,"address":[267443],"length":1,"stats":{"Line":0}},{"line":108,"address":[267472],"length":1,"stats":{"Line":0}},{"line":109,"address":[267501],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":53},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","reevaluate_topo.rs"],"content":"use crate::cell::CellValue;\r\nuse crate::formula::{eval_avg, eval_max, eval_min, eval_variance, sum_value};\r\nuse crate::spreadsheet::Spreadsheet;\r\nuse std::collections::HashSet;\r\n\r\npub fn sleep_fn(sheet: \u0026mut Spreadsheet, row: i16, col: i16, value: i32, sleep_val: \u0026mut f64) {\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(value);\r\n    if value \u003c 0 {\r\n        return;\r\n    }\r\n    *sleep_val += value as f64;\r\n}\r\n\r\npub fn reevaluate_formula(sheet: \u0026mut Spreadsheet, row: i16, col: i16, sleep_val: \u0026mut f64) {\r\n    let cell_meta = sheet.get_cell_meta(row, col);\r\n    let rem = cell_meta.formula % 10;\r\n    let msb = cell_meta.formula / 10;\r\n    let parent1 = cell_meta.parent1;\r\n    let parent2 = cell_meta.parent2;\r\n\r\n    match rem {\r\n        0 =\u003e {\r\n            let par1 = sheet.get_key_cell(parent1);\r\n            let par2 = sheet.get_key_cell(parent2);\r\n            if CellValue::Error == *par1 || CellValue::Error == *par2 {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return;\r\n            }\r\n            if let CellValue::Integer(p1_value) = par1 {\r\n                if let CellValue::Integer(p2_value) = par2 {\r\n                    match msb {\r\n                        1 =\u003e {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value + p2_value);\r\n                        }\r\n                        2 =\u003e {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value - p2_value);\r\n                        }\r\n                        4 =\u003e {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value * p2_value);\r\n                        }\r\n                        _ =\u003e {\r\n                            if *p2_value == 0 {\r\n                                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                            } else {\r\n                                *sheet.get_mut_cell(row, col) =\r\n                                    CellValue::Integer(p1_value / p2_value);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        2 =\u003e {\r\n            let par1 = sheet.get_key_cell(parent1);\r\n            if CellValue::Error == *par1 {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return;\r\n            }\r\n            if let CellValue::Integer(p1_value) = par1 {\r\n                match msb {\r\n                    1 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value + parent2);\r\n                    }\r\n                    2 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value - parent2);\r\n                    }\r\n                    4 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value * parent2);\r\n                    }\r\n                    3 =\u003e {\r\n                        if parent2 == 0 {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                        } else {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(p1_value / parent2);\r\n                        }\r\n                    }\r\n                    8 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(*p1_value);\r\n                    }\r\n                    _ =\u003e {\r\n                        sleep_fn(sheet, row, col, *p1_value, sleep_val);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        3 =\u003e {\r\n            let par2 = sheet.get_key_cell(parent2);\r\n            if CellValue::Error == *par2 {\r\n                *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                return;\r\n            }\r\n            if let CellValue::Integer(p2_value) = par2 {\r\n                match msb {\r\n                    1 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 + p2_value);\r\n                    }\r\n                    2 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 - p2_value);\r\n                    }\r\n                    4 =\u003e {\r\n                        *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 * p2_value);\r\n                    }\r\n                    _ =\u003e {\r\n                        if *p2_value == 0 {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Error;\r\n                        } else {\r\n                            *sheet.get_mut_cell(row, col) = CellValue::Integer(parent1 / p2_value);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        5 =\u003e {\r\n            sum_value(sheet, row, col, parent1, parent2);\r\n        }\r\n        6 =\u003e {\r\n            eval_avg(sheet, row, col, parent1, parent2);\r\n        }\r\n        7 =\u003e {\r\n            eval_min(sheet, row, col, parent1, parent2);\r\n        }\r\n        8 =\u003e {\r\n            eval_max(sheet, row, col, parent1, parent2);\r\n        }\r\n        _ =\u003e {\r\n            eval_variance(sheet, row, col, parent1, parent2);\r\n        }\r\n    }\r\n}\r\n\r\n// rustdoc this function\r\n/// Performs a topological sort on the spreadsheet to reevaluate cells in the correct order.\r\n/// This function also detects cycles in the dependency graph. If a cycle is detected, it returns true.\r\n\r\npub fn toposort_reval_detect_cycle(\r\n    sheet: \u0026mut Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n    sleep_val: \u0026mut f64,\r\n) -\u003e bool {\r\n    let cell_key = sheet.get_key(row, col);\r\n    // These collections will be used for the topological sort and cycle detection\r\n    let mut fully_visited: HashSet\u003ci32\u003e = HashSet::new();\r\n    let mut result: Vec\u003ci32\u003e = Vec::new();\r\n    let mut dfs_stack: Vec\u003c(i32, bool)\u003e = Vec::new();\r\n    let mut in_current_path: HashSet\u003ci32\u003e = HashSet::new();\r\n\r\n    // Helper to push all dependents (both direct and range-based) for a given cell key\r\n    fn push_dependents(\r\n        cell_key: i32,\r\n        sheet: \u0026Spreadsheet,\r\n        stack: \u0026mut Vec\u003c(i32, bool)\u003e,\r\n        fully_visited: \u0026HashSet\u003ci32\u003e,\r\n    ) {\r\n        // Direct children from standard dependencies\r\n        if let Some(children) = sheet.get_cell_children(cell_key) {\r\n            for child in children {\r\n                if !fully_visited.contains(child) {\r\n                    stack.push((*child, false));\r\n                }\r\n            }\r\n        }\r\n\r\n        for range_child in \u0026sheet.range_children {\r\n            if !fully_visited.contains(\u0026range_child.child_key)\r\n                \u0026\u0026 sheet.is_cell_in_range(cell_key, range_child.start_key, range_child.end_key)\r\n            {\r\n                stack.push((range_child.child_key, false));\r\n            }\r\n        }\r\n    }\r\n\r\n    // Start from all direct children and range-based children of the updated cell\r\n    push_dependents(cell_key, sheet, \u0026mut dfs_stack, \u0026fully_visited);\r\n\r\n    while let Some((current, expanded)) = dfs_stack.pop() {\r\n        if expanded {\r\n            // If we're processing a fully expanded node:\r\n            in_current_path.remove(\u0026current);\r\n            if !result.contains(\u0026current) {\r\n                result.push(current);\r\n            }\r\n            fully_visited.insert(current);\r\n        } else {\r\n            // If we haven't expanded this node yet:\r\n            if in_current_path.contains(\u0026current) {\r\n                // Cycle detected\r\n                // Debugging output\r\n                // println!(\"Cycle detected at cell: {}\", current);\r\n                // Uncomment the following line to see the cycle path\r\n                // println!(\"Cycle path: {:?}\", in_current_path);\r\n                return true;\r\n            }\r\n\r\n            // Add back the current node as expanded\r\n            dfs_stack.push((current, true));\r\n            in_current_path.insert(current);\r\n\r\n            // Process all its dependents (both direct and range-based)\r\n            push_dependents(current, sheet, \u0026mut dfs_stack, \u0026fully_visited);\r\n        }\r\n    }\r\n\r\n    // Reverse the result to get the correct topological order\r\n    result.reverse();\r\n\r\n    // Now reevaluate all cells in the topological order\r\n    for key in result {\r\n        if key \u003e= 0 {\r\n            let (row, col) = sheet.get_row_col(key);\r\n            reevaluate_formula(sheet, row, col, sleep_val);\r\n        }\r\n    }\r\n\r\n    false // No cycle detected\r\n}\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n    use crate::evaluator::set_cell_value;\r\n    use crate::spreadsheet::{CommandStatus, Spreadsheet};\r\n\r\n    fn create_test_spreadsheet(rows: i16, cols: i16) -\u003e Spreadsheet {\r\n        Spreadsheet::create(rows, cols).unwrap()\r\n    }\r\n\r\n    #[test]\r\n    fn test_sleep_fn_positive() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        sleep_fn(\u0026mut sheet, 0, 0, 5, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(5));\r\n        assert_eq!(sleep_time, 5.0);\r\n    }\r\n\r\n    #[test]\r\n    fn test_sleep_fn_negative() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        let mut sleep_time = 0.0;\r\n        sleep_fn(\u0026mut sheet, 0, 0, -5, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(-5));\r\n        assert_eq!(sleep_time, 0.0);\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_arithmetic() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(3);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        {\r\n            let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n            meta.formula = 10; // Addition\r\n        }\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(5));\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_arithmetic_div_zero() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(0);\r\n        let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n        meta.formula = 30; // Division\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_error() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Error;\r\n        let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n        meta.formula = 10; // Addition\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_sum() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(2);\r\n        let key1 = sheet.get_key(0, 0);\r\n            let key2 = sheet.get_key(0, 1);\r\n            let meta = sheet.get_cell_meta(1, 1);\r\n            meta.parent1 = key1;\r\n            meta.parent2 = key2;\r\n        meta.formula = 5; // SUM\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(3));\r\n    }\r\n\r\n    #[test]\r\n    fn test_cycle_prevention() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        let mut sleep_time = 0.0;\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 1, 1, \"A1\", \u0026mut sleep_time),\r\n            CommandStatus::CmdOk\r\n        );\r\n        assert_eq!(\r\n            set_cell_value(\u0026mut sheet, 0, 0, \"B2\", \u0026mut sleep_time),\r\n            CommandStatus::CmdCircularRef\r\n        );\r\n        assert!(!toposort_reval_detect_cycle(\r\n            \u0026mut sheet,\r\n            0,\r\n            0,\r\n            \u0026mut sleep_time\r\n        ));\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(1)); // A1 unchanged\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(1)); // B2 still references A1\r\n    }\r\n\r\n    #[test]\r\n    fn test_toposort_reval_no_cycle() {\r\n        let mut sheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(1);\r\n        let mut sleep_time = 0.0;\r\n        set_cell_value(\u0026mut sheet, 1, 1, \"A1\", \u0026mut sleep_time);\r\n        assert!(!toposort_reval_detect_cycle(\r\n            \u0026mut sheet,\r\n            1,\r\n            1,\r\n            \u0026mut sleep_time\r\n        ));\r\n    }\r\n\r\n    #[test]\r\n    fn test_reevaluate_formula_div_by_zero() {\r\n        let mut sheet: Spreadsheet = create_test_spreadsheet(5, 5);\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(5);\r\n        *sheet.get_mut_cell(0, 1) = CellValue::Integer(0);\r\n        let parent1_key = sheet.get_key(0, 0);\r\n        let parent2_key = sheet.get_key(0, 1);\r\n        let meta = sheet.get_cell_meta(1, 1);\r\n        meta.parent1 = parent1_key;\r\n        meta.parent2 = parent2_key;\r\n        meta.formula = 30; // Division\r\n        let mut sleep_time = 0.0;\r\n        reevaluate_formula(\u0026mut sheet, 1, 1, \u0026mut sleep_time);\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Error);\r\n    }\r\n    \r\n}\r\n","traces":[{"line":6,"address":[206880],"length":1,"stats":{"Line":1}},{"line":7,"address":[206926],"length":1,"stats":{"Line":1}},{"line":8,"address":[206966],"length":1,"stats":{"Line":1}},{"line":11,"address":[206980],"length":1,"stats":{"Line":1}},{"line":14,"address":[207008],"length":1,"stats":{"Line":5}},{"line":15,"address":[207077],"length":1,"stats":{"Line":5}},{"line":16,"address":[207195,207104],"length":1,"stats":{"Line":5}},{"line":17,"address":[207229,207323,207167],"length":1,"stats":{"Line":10}},{"line":18,"address":[207261],"length":1,"stats":{"Line":5}},{"line":19,"address":[207274],"length":1,"stats":{"Line":5}},{"line":21,"address":[207288],"length":1,"stats":{"Line":5}},{"line":23,"address":[207388],"length":1,"stats":{"Line":4}},{"line":24,"address":[207415],"length":1,"stats":{"Line":4}},{"line":25,"address":[207438,207738],"length":1,"stats":{"Line":7}},{"line":26,"address":[207771],"length":1,"stats":{"Line":1}},{"line":29,"address":[207819],"length":1,"stats":{"Line":3}},{"line":30,"address":[207880,207854],"length":1,"stats":{"Line":6}},{"line":31,"address":[207897],"length":1,"stats":{"Line":3}},{"line":32,"address":[208045],"length":1,"stats":{"Line":1}},{"line":33,"address":[207968],"length":1,"stats":{"Line":1}},{"line":35,"address":[208137],"length":1,"stats":{"Line":0}},{"line":36,"address":[208060],"length":1,"stats":{"Line":0}},{"line":38,"address":[208229],"length":1,"stats":{"Line":0}},{"line":39,"address":[208152],"length":1,"stats":{"Line":0}},{"line":42,"address":[208382,208290,207944],"length":1,"stats":{"Line":4}},{"line":43,"address":[208249],"length":1,"stats":{"Line":2}},{"line":45,"address":[208352],"length":1,"stats":{"Line":0}},{"line":46,"address":[208305],"length":1,"stats":{"Line":0}},{"line":54,"address":[207472],"length":1,"stats":{"Line":1}},{"line":55,"address":[207493],"length":1,"stats":{"Line":1}},{"line":56,"address":[208420],"length":1,"stats":{"Line":0}},{"line":59,"address":[208476,208392],"length":1,"stats":{"Line":2}},{"line":60,"address":[208493],"length":1,"stats":{"Line":1}},{"line":61,"address":[208662],"length":1,"stats":{"Line":0}},{"line":62,"address":[208585],"length":1,"stats":{"Line":0}},{"line":64,"address":[208753],"length":1,"stats":{"Line":0}},{"line":65,"address":[208676],"length":1,"stats":{"Line":0}},{"line":67,"address":[208844],"length":1,"stats":{"Line":0}},{"line":68,"address":[208767],"length":1,"stats":{"Line":0}},{"line":71,"address":[208994,208853,209085],"length":1,"stats":{"Line":0}},{"line":72,"address":[208953],"length":1,"stats":{"Line":0}},{"line":74,"address":[209008],"length":1,"stats":{"Line":0}},{"line":77,"address":[208933],"length":1,"stats":{"Line":1}},{"line":78,"address":[208883],"length":1,"stats":{"Line":1}},{"line":81,"address":[208558],"length":1,"stats":{"Line":0}},{"line":87,"address":[207527],"length":1,"stats":{"Line":0}},{"line":88,"address":[207548],"length":1,"stats":{"Line":0}},{"line":89,"address":[209123],"length":1,"stats":{"Line":0}},{"line":92,"address":[209095,209179],"length":1,"stats":{"Line":0}},{"line":93,"address":[209195],"length":1,"stats":{"Line":0}},{"line":94,"address":[209336],"length":1,"stats":{"Line":0}},{"line":95,"address":[209259],"length":1,"stats":{"Line":0}},{"line":97,"address":[209426],"length":1,"stats":{"Line":0}},{"line":98,"address":[209349],"length":1,"stats":{"Line":0}},{"line":100,"address":[209516],"length":1,"stats":{"Line":0}},{"line":101,"address":[209439],"length":1,"stats":{"Line":0}},{"line":104,"address":[209577,209667,209237],"length":1,"stats":{"Line":0}},{"line":105,"address":[209536],"length":1,"stats":{"Line":0}},{"line":107,"address":[209590],"length":1,"stats":{"Line":0}},{"line":114,"address":[207597],"length":1,"stats":{"Line":1}},{"line":117,"address":[207637],"length":1,"stats":{"Line":0}},{"line":120,"address":[207677],"length":1,"stats":{"Line":0}},{"line":123,"address":[207717],"length":1,"stats":{"Line":0}},{"line":126,"address":[207363],"length":1,"stats":{"Line":0}},{"line":135,"address":[210933,209680,210960],"length":1,"stats":{"Line":3}},{"line":141,"address":[209739],"length":1,"stats":{"Line":3}},{"line":143,"address":[209776],"length":1,"stats":{"Line":3}},{"line":144,"address":[209789],"length":1,"stats":{"Line":3}},{"line":145,"address":[209833],"length":1,"stats":{"Line":3}},{"line":146,"address":[209902],"length":1,"stats":{"Line":3}},{"line":149,"address":[210976],"length":1,"stats":{"Line":3}},{"line":156,"address":[211045],"length":1,"stats":{"Line":3}},{"line":157,"address":[211094,211158],"length":1,"stats":{"Line":2}},{"line":158,"address":[211231],"length":1,"stats":{"Line":1}},{"line":159,"address":[211250],"length":1,"stats":{"Line":1}},{"line":164,"address":[211131,211331,211268],"length":1,"stats":{"Line":6}},{"line":165,"address":[211351],"length":1,"stats":{"Line":0}},{"line":166,"address":[211377],"length":1,"stats":{"Line":0}},{"line":168,"address":[211402],"length":1,"stats":{"Line":0}},{"line":174,"address":[209968,210012],"length":1,"stats":{"Line":7}},{"line":176,"address":[210022],"length":1,"stats":{"Line":4}},{"line":177,"address":[210117],"length":1,"stats":{"Line":1}},{"line":179,"address":[210194],"length":1,"stats":{"Line":1}},{"line":180,"address":[210397],"length":1,"stats":{"Line":1}},{"line":181,"address":[210501,210453],"length":1,"stats":{"Line":2}},{"line":183,"address":[210482,210503],"length":1,"stats":{"Line":2}},{"line":186,"address":[210167,210208],"length":1,"stats":{"Line":2}},{"line":192,"address":[210248],"length":1,"stats":{"Line":1}},{"line":196,"address":[210214],"length":1,"stats":{"Line":1}},{"line":197,"address":[210268],"length":1,"stats":{"Line":1}},{"line":200,"address":[210295],"length":1,"stats":{"Line":1}},{"line":205,"address":[210131,210518],"length":1,"stats":{"Line":6}},{"line":208,"address":[210725,210525,210767],"length":1,"stats":{"Line":7}},{"line":209,"address":[210785],"length":1,"stats":{"Line":1}},{"line":210,"address":[210862],"length":1,"stats":{"Line":1}},{"line":211,"address":[210915],"length":1,"stats":{"Line":1}},{"line":215,"address":[210795],"length":1,"stats":{"Line":3}}],"covered":59,"coverable":97},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","spreadsheet.rs"],"content":"use crate::cell::{CellValue, parse_cell_reference};\r\nuse crate::visualize_cells;\r\nuse std::cmp::min;\r\nuse std::collections::HashMap;\r\nuse std::collections::HashSet;\r\nuse crate::formula::Range;\r\n\r\n// Constants\r\nconst MAX_ROWS: i16 = 999; // Maximum number of rows in the spreadsheet   \r\nconst MAX_COLS: i16 = 18278; // Maximum number of columns in the spreadsheet\r\npub const MAX_DISPLAY: i16 = 15;\r\n\r\n// Structure to represent a range-based child relationship\r\n#[derive(Debug, Clone, PartialEq, Eq, Hash)]\r\npub struct RangeChild {\r\n    pub start_key: i32, // Range start cell key\r\n    pub end_key: i32,   // Range end cell key\r\n    pub child_key: i32, // Child cell key\r\n}\r\n\r\n#[derive(Debug, PartialEq)]\r\npub enum CommandStatus {\r\n    CmdOk,\r\n    CmdUnrecognized,\r\n    CmdCircularRef,\r\n    CmdInvalidCell,\r\n    CmdLockedCell,\r\n}\r\n\r\n// Modified CellMeta to remove children (they're now stored separately)\r\n#[derive(Debug, Clone)]\r\npub struct CellMeta {\r\n    pub formula: i16,\r\n    pub parent1: i32,\r\n    pub parent2: i32,\r\n}\r\n\r\nimpl CellMeta {\r\n    pub fn new() -\u003e Self {\r\n        CellMeta {\r\n            formula: -1,\r\n            parent1: -1,\r\n            parent2: -1,\r\n        }\r\n    }\r\n}\r\n\r\n// Spreadsheet structure with HashMap of boxed HashSets for children\r\npub struct Spreadsheet {\r\n    pub grid: Vec\u003cCellValue\u003e, // Vector of CellValues (contiguous in memory)\r\n    pub children: HashMap\u003ci32, Box\u003cHashSet\u003ci32\u003e\u003e\u003e, // Map from cell key to boxed HashSet of children\r\n    pub range_children: Vec\u003cRangeChild\u003e, // Vector of range-based child relationships\r\n    pub cell_meta: HashMap\u003ci32, CellMeta\u003e, // Map from cell key to metadata\r\n    pub rows: i16,\r\n    pub cols: i16,\r\n    pub viewport_row: i16,\r\n    pub viewport_col: i16,\r\n    pub output_enabled: bool,\r\n    pub display_rows: i16,\r\n    pub display_cols: i16,\r\n    pub locked_ranges: Vec\u003cRange\u003e,\r\n    pub named_ranges: HashMap\u003cString, Range\u003e,\r\n    pub cell_history: HashMap\u003ci32, Vec\u003cCellValue\u003e\u003e,\r\n    pub last_edited: Option\u003c(i16, i16)\u003e,\r\n}\r\n\r\nimpl Spreadsheet {\r\n    // Create a new spreadsheet with specified dimensions\r\n    pub fn create(rows: i16, cols: i16) -\u003e Option\u003cSpreadsheet\u003e {\r\n        if rows \u003c 1 || rows \u003e MAX_ROWS || cols \u003c 1 || cols \u003e MAX_COLS {\r\n            eprintln!(\"Invalid spreadsheet dimensions\");\r\n            return None;\r\n        }\r\n\r\n        // Create empty cells - initialize with Integer(0)\r\n        let total = rows as usize * cols as usize;\r\n        let grid = vec![CellValue::Integer(0); total];\r\n\r\n        Some(Spreadsheet {\r\n            grid,\r\n            children: HashMap::new(),\r\n            range_children: Vec::with_capacity(32), // Preallocate with initial size\r\n            cell_meta: HashMap::new(),\r\n            rows,\r\n            cols,\r\n            viewport_row: 0,\r\n            viewport_col: 0,\r\n            output_enabled: true,\r\n            display_rows: 10,\r\n            display_cols: 10,\r\n            locked_ranges: Vec::new(),\r\n            named_ranges: HashMap::new(),\r\n            cell_history: HashMap::new(),\r\n            last_edited: None,\r\n        })\r\n    }\r\n\r\n    // Helper to get cell key from coordinates\r\n    pub fn get_key(\u0026self, row: i16, col: i16) -\u003e i32 {\r\n        (row as i32 * self.cols as i32 + col as i32) as i32\r\n    }\r\n\r\n    // Helper to get coordinates from cell key\r\n    pub fn get_row_col(\u0026self, key: i32) -\u003e (i16, i16) {\r\n        let row = (key / (self.cols as i32)) as i16;\r\n        let col = (key % (self.cols as i32)) as i16;\r\n        (row, col)\r\n    }\r\n\r\n    // Helper to get index from row and column\r\n    pub fn get_index(\u0026self, row: i16, col: i16) -\u003e usize {\r\n        (row as usize) * (self.cols as usize) + (col as usize)\r\n    }\r\n\r\n    // Get cell metadata, creating it if it doesn't exist\r\n    pub fn get_cell_meta(\u0026mut self, row: i16, col: i16) -\u003e \u0026mut CellMeta {\r\n        let key = self.get_key(row, col);\r\n        self.cell_meta.entry(key).or_insert_with(CellMeta::new)\r\n    }\r\n\r\n    pub fn get_cell_meta_ref(\u0026self, row: i16, col: i16) -\u003e \u0026CellMeta {\r\n        let key = self.get_key(row, col);\r\n        self.cell_meta.get(\u0026key).unwrap_or(\u0026CellMeta {\r\n            formula: -1,\r\n            parent1: -1,\r\n            parent2: -1,\r\n        })\r\n    }\r\n\r\n    pub fn get_column_name(\u0026self, mut col: i16) -\u003e String {\r\n        // Pre-calculate the length needed for the string\r\n        let mut temp_col = col + 1; // Convert from 0-based to 1-based\r\n        let mut len = 0;\r\n        while temp_col \u003e 0 {\r\n            len += 1;\r\n            temp_col = (temp_col - 1) / 26;\r\n        }\r\n\r\n        // Add column letters directly in reverse order\r\n        col += 1; // Convert from 0-based to 1-based\r\n\r\n        // Handle special case for col = 0\r\n        if col == 0 {\r\n            return \"A\".to_string();\r\n        }\r\n\r\n        // Create a buffer of bytes to avoid repeated string operations\r\n        let mut buffer = vec![0; len];\r\n        let mut i = len;\r\n\r\n        while col \u003e 0 {\r\n            i -= 1;\r\n            buffer[i] = b'A' + ((col - 1) % 26) as u8;\r\n            col = (col - 1) / 26;\r\n        }\r\n\r\n        // Convert the byte buffer to a string in one operation\r\n        unsafe {\r\n            // This is safe because we know our bytes are valid ASCII from b'A' to b'Z'\r\n            String::from_utf8_unchecked(buffer)\r\n        }\r\n    }\r\n\r\n    pub fn column_name_to_index(\u0026self, name: \u0026str) -\u003e i16 {\r\n        let bytes = name.as_bytes();\r\n        let mut index: i16 = 0;\r\n        for \u0026b in bytes {\r\n            index = index * 26 + ((b - b'A') as i16 + 1);\r\n        }\r\n        index - 1 // Convert from 1-based to 0-based\r\n    }\r\n\r\n    pub fn get_cell(\u0026self, row: i16, col: i16) -\u003e \u0026CellValue {\r\n        let index = self.get_index(row, col);\r\n        \u0026self.grid[index]\r\n    }\r\n\r\n    pub fn get_key_cell(\u0026self, cell_key: i32) -\u003e \u0026CellValue {\r\n        \u0026self.grid[cell_key as usize]\r\n    }\r\n\r\n    pub fn get_mut_cell(\u0026mut self, row: i16, col: i16) -\u003e \u0026mut CellValue {\r\n        let index = self.get_index(row, col);\r\n        \u0026mut self.grid[index]\r\n    }\r\n\r\n    // Add a range-based child relationship\r\n    pub fn add_range_child(\u0026mut self, start_key: i32, end_key: i32, child_key: i32) {\r\n        self.range_children.push(RangeChild {\r\n            start_key,\r\n            end_key,\r\n            child_key,\r\n        });\r\n    }\r\n\r\n    // Remove range-based child relationships for a given child\r\n    pub fn remove_range_child(\u0026mut self, child_key: i32) {\r\n        self.range_children.retain(|rc| rc.child_key != child_key);\r\n    }\r\n\r\n    // Check if a cell is within a range\r\n    pub fn is_cell_in_range(\u0026self, cell_key: i32, start_key: i32, end_key: i32) -\u003e bool {\r\n        let (cell_row, cell_col) = self.get_row_col(cell_key);\r\n        let (start_row, start_col) = self.get_row_col(start_key);\r\n        let (end_row, end_col) = self.get_row_col(end_key);\r\n\r\n        cell_row \u003e= start_row \u0026\u0026 cell_row \u003c= end_row \u0026\u0026 cell_col \u003e= start_col \u0026\u0026 cell_col \u003c= end_col\r\n    }\r\n\r\n    // Add a child to a cell's dependents (modified for HashMap of boxed HashSets)\r\n    pub fn add_child(\u0026mut self, parent_key: \u0026i32, child_key: \u0026i32) {\r\n        self.children\r\n            .entry(*parent_key)\r\n            .or_insert_with(|| Box::new(HashSet::with_capacity(5)))\r\n            .insert(*child_key);\r\n    }\r\n\r\n    // Remove a child from a cell's dependents (modified for HashMap of boxed HashSets)\r\n    pub fn remove_child(\u0026mut self, parent_key: i32, child_key: i32) {\r\n        if let Some(children) = self.children.get_mut(\u0026parent_key) {\r\n            children.remove(\u0026child_key);\r\n\r\n            // If the hashset is now empty, remove it from the HashMap to save memory\r\n            if children.is_empty() {\r\n                self.children.remove(\u0026parent_key);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Get children for a cell (immutable) (modified for HashMap of boxed HashSets)\r\n    pub fn get_cell_children(\u0026self, key: i32) -\u003e Option\u003c\u0026HashSet\u003ci32\u003e\u003e {\r\n        self.children.get(\u0026key).map(|boxed_set| boxed_set.as_ref())\r\n    }\r\n\r\n    pub fn print_spreadsheet(\u0026self) {\r\n        if !self.output_enabled {\r\n            return;\r\n        }\r\n\r\n        let start_row = self.viewport_row;\r\n        let start_col = self.viewport_col;\r\n        let display_row = min(self.rows - start_row, 10); // Display only a portion of the spreadsheet\r\n        let display_col = min(self.cols - start_col, 10);\r\n\r\n        // Print column headers\r\n        print!(\"     \");\r\n        for i in 0..display_col {\r\n            print!(\"{:\u003c8} \", self.get_column_name(start_col + i));\r\n        }\r\n        println!();\r\n\r\n        // Print rows with data\r\n        for i in 0..display_row {\r\n            print!(\"{:\u003c4} \", start_row + i + 1); // Show 1-based row numbers\r\n            for j in 0..display_col {\r\n                let cell_value = self.get_cell(start_row + i, start_col + j);\r\n                match cell_value {\r\n                    CellValue::Integer(value) =\u003e print!(\"{:\u003c8} \", value),\r\n                    CellValue::Error =\u003e print!(\"{:\u003c8} \", \"ERR\"),\r\n                }\r\n            }\r\n            println!();\r\n        }\r\n    }\r\n\r\n    pub fn scroll_to_cell(\u0026mut self, cell: \u0026str) -\u003e CommandStatus {\r\n        match parse_cell_reference(self, cell) {\r\n            Ok((row, col)) =\u003e {\r\n                if row \u003e= 0 \u0026\u0026 row \u003c self.rows \u0026\u0026 col \u003e= 0 \u0026\u0026 col \u003c self.cols {\r\n                    self.viewport_row = row;\r\n                    self.viewport_col = col;\r\n                    return CommandStatus::CmdOk;\r\n                } else {\r\n                    return CommandStatus::CmdInvalidCell;\r\n                }\r\n            }\r\n            Err(_) =\u003e {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n    }\r\n\r\n    pub fn scroll_viewport(\u0026mut self, direction: char) {\r\n        const VIEWPORT_SIZE: i16 = 10;\r\n        match direction {\r\n            'w' =\u003e {\r\n                self.viewport_row = if self.viewport_row \u003e 10 {\r\n                    self.viewport_row - 10\r\n                } else {\r\n                    0\r\n                };\r\n            }\r\n            's' =\u003e {\r\n                if self.viewport_row + VIEWPORT_SIZE \u003c self.rows - 9 {\r\n                    self.viewport_row += 10;\r\n                } else {\r\n                    self.viewport_row = self.rows - VIEWPORT_SIZE;\r\n                }\r\n            }\r\n            'a' =\u003e {\r\n                self.viewport_col = if self.viewport_col \u003e 10 {\r\n                    self.viewport_col - 10\r\n                } else {\r\n                    0\r\n                };\r\n            }\r\n\r\n            'd' =\u003e {\r\n                if self.viewport_col + VIEWPORT_SIZE \u003c self.cols - 9 {\r\n                    self.viewport_col += 10;\r\n                } else {\r\n                    self.viewport_col = self.cols - VIEWPORT_SIZE;\r\n                }\r\n            }\r\n            _ =\u003e {} // Invalid direction, do nothing\r\n        }\r\n    }\r\n\r\n    pub fn visualize_cell_relationships(\u0026self, row: i16, col: i16) -\u003e CommandStatus {\r\n        // Check if the cell is valid\r\n        visualize_cells::visualize_cell_relationships(self, row, col)\r\n    }\r\n\r\n    pub fn lock_range(\u0026mut self, range: Range) {\r\n        self.locked_ranges.push(range);\r\n    }\r\n\r\n    pub fn is_cell_locked(\u0026self, row: i16, col: i16) -\u003e bool {\r\n        for range in \u0026self.locked_ranges {\r\n            if row \u003e= range.start_row \u0026\u0026 row \u003c= range.end_row \u0026\u0026 col \u003e= range.start_col \u0026\u0026 col \u003c= range.end_col {\r\n                return true;\r\n            }\r\n        }\r\n        false\r\n    }\r\n\r\n    pub fn set_last_edited(\u0026mut self, row: i16, col: i16) {\r\n        self.last_edited = Some((row, col));\r\n    }\r\n\r\n    pub fn scroll_to_last_edited(\u0026mut self) {\r\n        if let Some((row, col)) = self.last_edited {\r\n            self.viewport_row = row;\r\n            self.viewport_col = col;\r\n        }\r\n    }\r\n\r\n    pub fn get_cell_name(\u0026self, row: i16, col: i16) -\u003e String {\r\n        for (name, range) in \u0026self.named_ranges {\r\n            if range.start_row == row \u0026\u0026 range.start_col == col \u0026\u0026\r\n               range.end_row == row \u0026\u0026 range.end_col == col {\r\n                return name.clone();\r\n            }\r\n        }\r\n        let col_name = self.get_column_name(col);\r\n        format!(\"{}{}\", col_name, row + 1)\r\n    }\r\n}\r\n\r\n#[cfg(test)]\r\nmod tests {\r\n    use super::*;\r\n    use crate::cell::CellValue;\r\n\r\n    #[test]\r\n    fn test_create_valid_dimensions() {\r\n        let sheet = Spreadsheet::create(5, 5).unwrap();\r\n        assert_eq!(sheet.rows, 5);\r\n        assert_eq!(sheet.cols, 5);\r\n        assert_eq!(sheet.grid.len(), 25);\r\n        assert_eq!(sheet.viewport_row, 0);\r\n        assert_eq!(sheet.viewport_col, 0);\r\n    }\r\n\r\n    #[test]\r\n    fn test_create_invalid_dimensions() {\r\n        assert!(Spreadsheet::create(0, 5).is_none());\r\n        assert!(Spreadsheet::create(5, 0).is_none());\r\n        assert!(Spreadsheet::create(MAX_ROWS + 1, 5).is_none());\r\n        assert!(Spreadsheet::create(5, MAX_COLS + 1).is_none());\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_column_name() {\r\n        let sheet = Spreadsheet::create(1, 1).unwrap();\r\n        assert_eq!(sheet.get_column_name(0), \"A\");\r\n        assert_eq!(sheet.get_column_name(25), \"Z\");\r\n        assert_eq!(sheet.get_column_name(26), \"AA\");\r\n        assert_eq!(sheet.get_column_name(51), \"AZ\");\r\n    }\r\n\r\n    #[test]\r\n    fn test_column_name_to_index() {\r\n        let sheet = Spreadsheet::create(1, 1).unwrap();\r\n        assert_eq!(sheet.column_name_to_index(\"A\"), 0);\r\n        assert_eq!(sheet.column_name_to_index(\"Z\"), 25);\r\n        assert_eq!(sheet.column_name_to_index(\"AA\"), 26);\r\n        assert_eq!(sheet.column_name_to_index(\"AZ\"), 51);\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_cell_and_get_mut_cell() {\r\n        let mut sheet = Spreadsheet::create(2, 2).unwrap();\r\n        let cell_value = sheet.get_mut_cell(0, 0);\r\n        *cell_value = CellValue::Integer(42);\r\n        assert_eq!(*sheet.get_cell(0, 0), CellValue::Integer(42));\r\n        assert_eq!(*sheet.get_cell(1, 1), CellValue::Integer(0));\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_key_and_row_col() {\r\n        let sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let key = sheet.get_key(2, 3);\r\n        let (row, col) = sheet.get_row_col(key);\r\n        assert_eq!(row, 2);\r\n        assert_eq!(col, 3);\r\n    }\r\n\r\n    #[test]\r\n    fn test_get_cell_meta() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let meta = sheet.get_cell_meta(1, 1);\r\n        assert_eq!(meta.formula, -1);\r\n        assert_eq!(meta.parent1, -1);\r\n        assert_eq!(meta.parent2, -1);\r\n        meta.formula = 10;\r\n        assert_eq!(sheet.get_cell_meta(1, 1).formula, 10);\r\n    }\r\n\r\n    #[test]\r\n    fn test_add_remove_child() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let parent = sheet.get_key(0, 0);\r\n        let child = sheet.get_key(1, 1);\r\n        sheet.add_child(\u0026parent, \u0026child);\r\n        assert!(sheet.get_cell_children(parent).unwrap().contains(\u0026child));\r\n        sheet.remove_child(parent, child);\r\n        assert!(sheet.get_cell_children(parent).is_none());\r\n    }\r\n\r\n    #[test]\r\n    fn test_is_cell_in_range() {\r\n        let sheet = Spreadsheet::create(5, 5).unwrap();\r\n        let cell_key = sheet.get_key(1, 1);\r\n        let start_key = sheet.get_key(0, 0);\r\n        let end_key = sheet.get_key(2, 2);\r\n        assert!(sheet.is_cell_in_range(cell_key, start_key, end_key));\r\n        assert!(!sheet.is_cell_in_range(cell_key, end_key, start_key));\r\n    }\r\n\r\n    #[test]\r\n    fn test_scroll_to_cell_valid() {\r\n        let mut sheet = Spreadsheet::create(20, 20).unwrap();\r\n        let status = sheet.scroll_to_cell(\"B2\");\r\n        assert_eq!(status, CommandStatus::CmdOk);\r\n        assert_eq!(sheet.viewport_row, 1);\r\n        assert_eq!(sheet.viewport_col, 1);\r\n    }\r\n\r\n    #[test]\r\n    fn test_scroll_to_cell_invalid() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        assert_eq!(sheet.scroll_to_cell(\"F6\"), CommandStatus::CmdInvalidCell);\r\n        assert_eq!(sheet.scroll_to_cell(\"1A\"), CommandStatus::CmdUnrecognized);\r\n    }\r\n\r\n    #[test]\r\n    fn test_scroll_viewport() {\r\n        let mut sheet = Spreadsheet::create(50, 50).unwrap();\r\n        sheet.scroll_viewport('s');\r\n        assert_eq!(sheet.viewport_row, 10);\r\n        sheet.scroll_viewport('d');\r\n        assert_eq!(sheet.viewport_col, 10);\r\n        sheet.scroll_viewport('w');\r\n        assert_eq!(sheet.viewport_row, 0);\r\n        sheet.scroll_viewport('a');\r\n        assert_eq!(sheet.viewport_col, 0);\r\n        sheet.viewport_row = 45;\r\n        sheet.scroll_viewport('s');\r\n        assert_eq!(sheet.viewport_row, 40);\r\n    }\r\n\r\n    #[test]\r\n    fn test_print_spreadsheet_disabled() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        sheet.output_enabled = false;\r\n        sheet.print_spreadsheet(); // Should not panic\r\n    }\r\n\r\n    #[test]\r\n    fn test_print_spreadsheet_with_values() {\r\n        let mut sheet = Spreadsheet::create(5, 5).unwrap();\r\n        *sheet.get_mut_cell(0, 0) = CellValue::Integer(42);\r\n        *sheet.get_mut_cell(1, 1) = CellValue::Error;\r\n        sheet.output_enabled = true;\r\n        sheet.print_spreadsheet(); // Should not panic\r\n    }\r\n}\r\n","traces":[{"line":39,"address":[303152],"length":1,"stats":{"Line":1}},{"line":69,"address":[303184,304177],"length":1,"stats":{"Line":7}},{"line":70,"address":[303307,303233],"length":1,"stats":{"Line":15}},{"line":71,"address":[303250],"length":1,"stats":{"Line":1}},{"line":72,"address":[303284],"length":1,"stats":{"Line":1}},{"line":76,"address":[303450,303334],"length":1,"stats":{"Line":7}},{"line":77,"address":[303366],"length":1,"stats":{"Line":8}},{"line":79,"address":[303788],"length":1,"stats":{"Line":7}},{"line":80,"address":[303407],"length":1,"stats":{"Line":7}},{"line":81,"address":[303443],"length":1,"stats":{"Line":8}},{"line":82,"address":[303506],"length":1,"stats":{"Line":7}},{"line":83,"address":[303578],"length":1,"stats":{"Line":8}},{"line":91,"address":[303630],"length":1,"stats":{"Line":7}},{"line":92,"address":[303682],"length":1,"stats":{"Line":8}},{"line":93,"address":[303734],"length":1,"stats":{"Line":7}},{"line":94,"address":[303778],"length":1,"stats":{"Line":8}},{"line":99,"address":[304208],"length":1,"stats":{"Line":1}},{"line":100,"address":[304238,304308],"length":1,"stats":{"Line":4}},{"line":104,"address":[304336],"length":1,"stats":{"Line":2}},{"line":105,"address":[304467,304358],"length":1,"stats":{"Line":1}},{"line":106,"address":[304449,304491,304556],"length":1,"stats":{"Line":3}},{"line":111,"address":[304576],"length":1,"stats":{"Line":3}},{"line":112,"address":[304684,304606],"length":1,"stats":{"Line":2}},{"line":116,"address":[304704],"length":1,"stats":{"Line":1}},{"line":117,"address":[304734],"length":1,"stats":{"Line":1}},{"line":118,"address":[304756],"length":1,"stats":{"Line":1}},{"line":121,"address":[304800],"length":1,"stats":{"Line":0}},{"line":122,"address":[304830],"length":1,"stats":{"Line":0}},{"line":123,"address":[304850],"length":1,"stats":{"Line":0}},{"line":130,"address":[305637,305612,304896],"length":1,"stats":{"Line":1}},{"line":132,"address":[304929,304978],"length":1,"stats":{"Line":1}},{"line":133,"address":[304967],"length":1,"stats":{"Line":1}},{"line":134,"address":[304976,305749,304994],"length":1,"stats":{"Line":3}},{"line":135,"address":[305678,305651,305024],"length":1,"stats":{"Line":2}},{"line":136,"address":[305754,305656,305699],"length":1,"stats":{"Line":2}},{"line":140,"address":[305072,305057,305002],"length":1,"stats":{"Line":2}},{"line":143,"address":[305062],"length":1,"stats":{"Line":1}},{"line":144,"address":[305093],"length":1,"stats":{"Line":0}},{"line":148,"address":[305112],"length":1,"stats":{"Line":1}},{"line":149,"address":[305144],"length":1,"stats":{"Line":1}},{"line":151,"address":[305169,305154,305586],"length":1,"stats":{"Line":3}},{"line":152,"address":[305311,305338,305227],"length":1,"stats":{"Line":2}},{"line":153,"address":[305358,305316],"length":1,"stats":{"Line":2}},{"line":154,"address":[305506,305591],"length":1,"stats":{"Line":1}},{"line":160,"address":[305182],"length":1,"stats":{"Line":1}},{"line":164,"address":[305776],"length":1,"stats":{"Line":3}},{"line":165,"address":[305821],"length":1,"stats":{"Line":3}},{"line":166,"address":[305842],"length":1,"stats":{"Line":6}},{"line":167,"address":[305849,305927,306120],"length":1,"stats":{"Line":12}},{"line":168,"address":[306125,305996,305942],"length":1,"stats":{"Line":9}},{"line":170,"address":[305976,305905],"length":1,"stats":{"Line":6}},{"line":173,"address":[306144],"length":1,"stats":{"Line":1}},{"line":174,"address":[306174],"length":1,"stats":{"Line":1}},{"line":175,"address":[306198],"length":1,"stats":{"Line":1}},{"line":178,"address":[306224],"length":1,"stats":{"Line":4}},{"line":179,"address":[306237],"length":1,"stats":{"Line":4}},{"line":182,"address":[306272],"length":1,"stats":{"Line":3}},{"line":183,"address":[306302],"length":1,"stats":{"Line":2}},{"line":184,"address":[306326],"length":1,"stats":{"Line":3}},{"line":188,"address":[306352],"length":1,"stats":{"Line":2}},{"line":189,"address":[306373],"length":1,"stats":{"Line":2}},{"line":197,"address":[306416],"length":1,"stats":{"Line":1}},{"line":198,"address":[306429],"length":1,"stats":{"Line":3}},{"line":202,"address":[306448],"length":1,"stats":{"Line":1}},{"line":203,"address":[306482],"length":1,"stats":{"Line":1}},{"line":204,"address":[306516],"length":1,"stats":{"Line":1}},{"line":205,"address":[306550],"length":1,"stats":{"Line":1}},{"line":207,"address":[306588],"length":1,"stats":{"Line":1}},{"line":211,"address":[306672],"length":1,"stats":{"Line":2}},{"line":212,"address":[306775,306708,306702,306765],"length":1,"stats":{"Line":5}},{"line":213,"address":[306706],"length":1,"stats":{"Line":1}},{"line":214,"address":[445424,445428],"length":1,"stats":{"Line":2}},{"line":215,"address":[306763],"length":1,"stats":{"Line":1}},{"line":219,"address":[306800],"length":1,"stats":{"Line":1}},{"line":220,"address":[306822],"length":1,"stats":{"Line":1}},{"line":221,"address":[306882,306956,306917],"length":1,"stats":{"Line":2}},{"line":224,"address":[306976,306932],"length":1,"stats":{"Line":2}},{"line":225,"address":[307008],"length":1,"stats":{"Line":1}},{"line":231,"address":[307056],"length":1,"stats":{"Line":4}},{"line":232,"address":[307069],"length":1,"stats":{"Line":6}},{"line":235,"address":[309240,307104],"length":1,"stats":{"Line":2}},{"line":236,"address":[307124],"length":1,"stats":{"Line":2}},{"line":240,"address":[307146],"length":1,"stats":{"Line":1}},{"line":241,"address":[307166],"length":1,"stats":{"Line":1}},{"line":242,"address":[307186,307276],"length":1,"stats":{"Line":1}},{"line":243,"address":[307297,307385,307252],"length":1,"stats":{"Line":2}},{"line":246,"address":[307323],"length":1,"stats":{"Line":1}},{"line":247,"address":[307357,307401,307517],"length":1,"stats":{"Line":3}},{"line":248,"address":[307533,308859],"length":1,"stats":{"Line":2}},{"line":250,"address":[307444],"length":1,"stats":{"Line":1}},{"line":253,"address":[307484,307557],"length":1,"stats":{"Line":2}},{"line":254,"address":[307630,308011],"length":1,"stats":{"Line":1}},{"line":255,"address":[307983,308027,308120],"length":1,"stats":{"Line":3}},{"line":256,"address":[308141,308251],"length":1,"stats":{"Line":1}},{"line":257,"address":[308238],"length":1,"stats":{"Line":1}},{"line":258,"address":[308272],"length":1,"stats":{"Line":1}},{"line":259,"address":[308567],"length":1,"stats":{"Line":1}},{"line":262,"address":[308070],"length":1,"stats":{"Line":1}},{"line":266,"address":[309264],"length":1,"stats":{"Line":1}},{"line":267,"address":[309288],"length":1,"stats":{"Line":1}},{"line":268,"address":[309341],"length":1,"stats":{"Line":1}},{"line":269,"address":[309403,309371],"length":1,"stats":{"Line":2}},{"line":270,"address":[309457],"length":1,"stats":{"Line":1}},{"line":271,"address":[309464],"length":1,"stats":{"Line":1}},{"line":272,"address":[309471],"length":1,"stats":{"Line":1}},{"line":274,"address":[309386],"length":1,"stats":{"Line":1}},{"line":278,"address":[309379],"length":1,"stats":{"Line":1}},{"line":283,"address":[309488],"length":1,"stats":{"Line":1}},{"line":285,"address":[309508],"length":1,"stats":{"Line":1}},{"line":286,"address":[309720],"length":1,"stats":{"Line":1}},{"line":287,"address":[309554,309671,309735,309708],"length":1,"stats":{"Line":3}},{"line":288,"address":[309730,309737,309678],"length":1,"stats":{"Line":0}},{"line":290,"address":[309664],"length":1,"stats":{"Line":1}},{"line":294,"address":[309571,309909,309947,309758],"length":1,"stats":{"Line":4}},{"line":295,"address":[309952,309940,309867],"length":1,"stats":{"Line":2}},{"line":297,"address":[309914,309837,309902],"length":1,"stats":{"Line":2}},{"line":300,"address":[310024],"length":1,"stats":{"Line":1}},{"line":301,"address":[309975,310012,310039,309608],"length":1,"stats":{"Line":3}},{"line":302,"address":[309982,310041,310034],"length":1,"stats":{"Line":0}},{"line":304,"address":[309968],"length":1,"stats":{"Line":1}},{"line":309,"address":[310213,309632,310062,310251],"length":1,"stats":{"Line":3}},{"line":310,"address":[310171,310244,310256],"length":1,"stats":{"Line":2}},{"line":312,"address":[310206,310141,310218],"length":1,"stats":{"Line":0}},{"line":319,"address":[310272],"length":1,"stats":{"Line":1}},{"line":321,"address":[310297],"length":1,"stats":{"Line":1}},{"line":324,"address":[310320],"length":1,"stats":{"Line":1}},{"line":325,"address":[310344],"length":1,"stats":{"Line":1}},{"line":328,"address":[310384],"length":1,"stats":{"Line":3}},{"line":329,"address":[310491,310419],"length":1,"stats":{"Line":5}},{"line":330,"address":[310506,310534],"length":1,"stats":{"Line":2}},{"line":331,"address":[310576],"length":1,"stats":{"Line":1}},{"line":334,"address":[310479],"length":1,"stats":{"Line":3}},{"line":337,"address":[310592],"length":1,"stats":{"Line":3}},{"line":338,"address":[310613],"length":1,"stats":{"Line":3}},{"line":341,"address":[310656],"length":1,"stats":{"Line":1}},{"line":342,"address":[310666],"length":1,"stats":{"Line":1}},{"line":343,"address":[310708],"length":1,"stats":{"Line":1}},{"line":344,"address":[310715],"length":1,"stats":{"Line":1}},{"line":348,"address":[311257,310736],"length":1,"stats":{"Line":0}},{"line":349,"address":[310946,310798],"length":1,"stats":{"Line":0}},{"line":350,"address":[311289,310988],"length":1,"stats":{"Line":0}},{"line":351,"address":[311309],"length":1,"stats":{"Line":0}},{"line":352,"address":[311349],"length":1,"stats":{"Line":0}},{"line":355,"address":[310900],"length":1,"stats":{"Line":0}},{"line":356,"address":[310934,311047],"length":1,"stats":{"Line":0}}],"covered":131,"coverable":145},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","vim_mode","commands.rs"],"content":"// vim_mode/commands.rs\r\nuse super::editor::{EditorMode, EditorState};\r\nuse crate::{evaluator, spreadsheet};\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\nuse std::cell;\r\nuse std::fs::{File, OpenOptions};\r\nuse std::io::{BufRead, BufReader, Write, BufWriter};\r\nuse std::path::Path;\r\nuse crate::cell::{parse_cell_reference, CellValue};\r\nuse crate::graph;\r\n\r\n\r\n// Handle vim-specific commands\r\npub fn handle_vim_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    input: \u0026str,\r\n    state: \u0026mut EditorState,\r\n) -\u003e CommandStatus {\r\n    if !input.trim().is_empty() {\r\n        state.add_to_history(input);\r\n    }\r\n    // Handle mode-specific input\r\n    match state.mode {\r\n        EditorMode::Normal =\u003e handle_normal_mode_command(sheet, input, state),\r\n        EditorMode::Insert =\u003e handle_insert_mode_command(sheet, input, state),\r\n       \r\n    \r\n\r\n    }\r\n}\r\n\r\n// Process commands in normal mode\r\nfn handle_normal_mode_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    input: \u0026str,\r\n    state: \u0026mut EditorState,\r\n) -\u003e CommandStatus {\r\n    // Single character commands\r\n    //store the input add_history \r\n    \r\n\r\n    if input.len() == 1 {\r\n        match input.chars().next().unwrap() {\r\n\r\n\r\n            // Movement commands\r\n            'h' | 'j' | 'k' | 'l' =\u003e {\r\n                state.move_cursor(input.chars().next().unwrap(), sheet);\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            // Mode switching\r\n            'i' =\u003e {\r\n                state.mode = EditorMode::Insert;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            // Editing commands\r\n            'd' =\u003e return cut_cell(sheet, state),\r\n            'y' =\u003e return yank_cell(sheet, state),\r\n            'p' =\u003e return paste_cell(sheet, state),\r\n            'q' =\u003e {\r\n                state.should_quit = true;\r\n                return CommandStatus::CmdOk;\r\n            }\r\n            _ =\u003e {}\r\n        }\r\n    }\r\n\r\n    // File commands\r\n    if input.starts_with(':') {\r\n\r\n        let cmd = \u0026input[1..];\r\n\r\n        // :w - write file\r\n        if cmd.starts_with('w') \u0026\u0026 !cmd.starts_with(\"wq\") {\r\n            // Extract filename if provided\r\n            let filename = if cmd.len() \u003e 1 \u0026\u0026 cmd.chars().nth(1) == Some(' ') {\r\n                Some(cmd[2..].trim().to_string())\r\n            } else if cmd == \"w\" {\r\n                state.save_file.clone()\r\n            } else {\r\n                None\r\n            };\r\n\r\n            if let Some(file) = filename {\r\n                state.save_file = Some(file.clone());\r\n                return save_spreadsheet(sheet, \u0026file);\r\n            } else {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n\r\n        // :q - quit\r\n        if cmd == \"q\" {\r\n            state.should_quit = true;\r\n            return CommandStatus::CmdOk;\r\n        }\r\n\r\n        // :wq - write and quit\r\n        if cmd.starts_with(\"wq\") {\r\n            // Extract filename if provided (e.g., \":wq filename.csv\")\r\n            let filename = if cmd.len() \u003e 2 \u0026\u0026 cmd.chars().nth(2) == Some(' ') {\r\n                Some(cmd[3..].trim().to_string())\r\n            } else {\r\n                state.save_file.clone()\r\n            };\r\n\r\n            if let Some(file) = filename {\r\n                state.save_file = Some(file.clone());\r\n                let status = save_spreadsheet(sheet, \u0026file);\r\n                if status == CommandStatus::CmdOk {\r\n                    state.should_quit = true;\r\n                }\r\n                return status;\r\n            } else {\r\n                // No file specified\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n\r\n        // :!rm % - delete the current file\r\n        if cmd.trim() == \"!rm %\" {\r\n            if let Some(file) = \u0026state.save_file {\r\n                match std::fs::remove_file(file) {\r\n                    Ok(_) =\u003e {\r\n                        state.save_file = None;\r\n                        return CommandStatus::CmdOk;\r\n                    }\r\n                    Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n                }\r\n            } else {\r\n                return CommandStatus::CmdUnrecognized;\r\n            }\r\n        }\r\n    }\r\n\r\n    // If not handled as a vim command, pass it to the standard command handler\r\n    let mut sleep_time = 0.0;\r\n    evaluator::handle_command(sheet, input, \u0026mut sleep_time);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Save spreadsheet to a file\r\npub fn save_spreadsheet(sheet: \u0026Spreadsheet, filename: \u0026str) -\u003e CommandStatus {\r\n    let path = Path::new(filename);\r\n    \r\n    // Open file for writing\r\n    let file = match OpenOptions::new()\r\n        .write(true)\r\n        .create(true)\r\n        .truncate(true)\r\n        .open(path)\r\n    {\r\n        Ok(file) =\u003e file,\r\n        Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n    };\r\n\r\n    // Create a buffered writer\r\n    let mut writer = BufWriter::new(file);\r\n\r\n    // Write header with dimensions\r\n    if let Err(_) = writeln!(writer, \"DIMS,{},{}\", sheet.rows, sheet.cols) {\r\n        return CommandStatus::CmdUnrecognized;\r\n    }\r\n\r\n    // Write cell data with formulas\r\n    for row in 0..sheet.rows {\r\n        for col in 0..sheet.cols {\r\n            let key = sheet.get_key(row, col);\r\n            let cell_value = sheet.get_cell(row, col);\r\n            \r\n            // Only write cells with non-zero values or formulas\r\n            let is_nonzero = match cell_value {\r\n                CellValue::Integer(0) =\u003e false,\r\n                _ =\u003e true,\r\n            };\r\n            \r\n            // Check if cell has formula metadata\r\n            let has_metadata = sheet.cell_meta.contains_key(\u0026key);\r\n            \r\n            if is_nonzero || has_metadata {\r\n                let cell_ref = format!(\"{}{}\", sheet.get_column_name(col), row + 1);\r\n                \r\n                // Write the cell value\r\n                match cell_value {\r\n                    CellValue::Integer(val) =\u003e {\r\n                        write!(writer, \"CELL,{},{}\", cell_ref, val).unwrap();\r\n                    },\r\n                    CellValue::Error =\u003e {\r\n                        write!(writer, \"CELL,{},ERR\", cell_ref).unwrap();\r\n                    },\r\n                }\r\n                \r\n                // If the cell has formula metadata, write it too\r\n                if let Some(meta) = sheet.cell_meta.get(\u0026key) {\r\n                    if meta.formula != -1 {\r\n                        // Get the parent cells as references\r\n                        let parent1_ref = if meta.parent1 != -1 {\r\n                            let (p1_row, p1_col) = sheet.get_row_col(meta.parent1);\r\n                            format!(\"{}{}\", sheet.get_column_name(p1_col), p1_row + 1)\r\n                        } else {\r\n                            String::from(\"\")\r\n                        };\r\n                        \r\n                        let parent2_ref = if meta.parent2 != -1 {\r\n                            let (p2_row, p2_col) = sheet.get_row_col(meta.parent2);\r\n                            format!(\"{}{}\", sheet.get_column_name(p2_col), p2_row + 1)\r\n                        } else {\r\n                            String::from(\"\")\r\n                        };\r\n                        \r\n                        write!(writer, \",FORMULA,{},{},{}\", \r\n                            meta.formula, parent1_ref, parent2_ref).unwrap();\r\n                    }\r\n                }\r\n                \r\n                // End the line\r\n                writeln!(writer, \"\").unwrap();\r\n            }\r\n        }\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Load a spreadsheet from a file\r\npub fn load_spreadsheet(sheet: \u0026mut Spreadsheet, filename: \u0026str) -\u003e CommandStatus {\r\n    let path = Path::new(filename);\r\n\r\n    // Open file for reading\r\n    let file = match File::open(path) {\r\n        Ok(file) =\u003e file,\r\n        Err(_) =\u003e return CommandStatus::CmdUnrecognized,\r\n    };\r\n\r\n    // Create a buffered reader\r\n    let reader = BufReader::new(file);\r\n    \r\n    // Clear the existing spreadsheet\r\n    for row in 0..sheet.rows {\r\n        for col in 0..sheet.cols {\r\n            let key = sheet.get_key(row, col);\r\n            // Clear cell value\r\n            let index = sheet.get_index(row, col);\r\n            sheet.grid[index] = CellValue::Integer(0);\r\n            \r\n            // Clear metadata and dependencies\r\n            if sheet.cell_meta.contains_key(\u0026key) {\r\n                // Remove all parent-child relationships\r\n                graph::remove_all_parents(sheet, row, col);\r\n                sheet.cell_meta.remove(\u0026key);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Read and parse the file\r\n    for line_result in reader.lines() {\r\n        let line = match line_result {\r\n            Ok(line) =\u003e line,\r\n            Err(_) =\u003e continue,\r\n        };\r\n        \r\n        let parts: Vec\u003c\u0026str\u003e = line.split(',').collect();\r\n        if parts.is_empty() {\r\n            continue;\r\n        }\r\n        \r\n        // Process line based on type\r\n        match parts[0] {\r\n            \"DIMS\" =\u003e {\r\n                // Dimensions line: DIMS,rows,cols\r\n                if parts.len() \u003e= 3 {\r\n                    // We don't resize the sheet here, just validate dimensions\r\n                    let file_rows: i16 = parts[1].parse().unwrap_or(0);\r\n                    let file_cols: i16 = parts[2].parse().unwrap_or(0);\r\n                    \r\n                    if file_rows \u003e sheet.rows || file_cols \u003e sheet.cols {\r\n                        eprintln!(\"Warning: File contains a larger spreadsheet than current dimensions\");\r\n                    }\r\n                }\r\n            },\r\n            \"CELL\" =\u003e {\r\n                // Cell data line: CELL,ref,value[,FORMULA,formula_code,parent1,parent2]\r\n                if parts.len() \u003e= 3 {\r\n                    let cell_ref = parts[1];\r\n                    let value_str = parts[2];\r\n                    \r\n                    // Parse cell reference\r\n                    if let Ok((row, col)) = parse_cell_reference(sheet, cell_ref) {\r\n                        // Set cell value\r\n                        let cell_value = if value_str == \"ERR\" {\r\n                            CellValue::Error\r\n                        } else {\r\n                            match value_str.parse::\u003ci32\u003e() {\r\n                                Ok(val) =\u003e CellValue::Integer(val),\r\n                                Err(_) =\u003e continue,\r\n                            }\r\n                        };\r\n                        \r\n                        let index = sheet.get_index(row, col);\r\n                        sheet.grid[index] = cell_value;\r\n                        \r\n                        // If there's formula data, process it\r\n                        if parts.len() \u003e= 6 \u0026\u0026 parts[3] == \"FORMULA\" {\r\n                            let formula: i16 = parts[4].parse().unwrap_or(-1);\r\n                            let parent1_ref = parts[5];\r\n                            let parent2_ref = if parts.len() \u003e 6 { parts[6] } else { \"\" };\r\n                            \r\n                            if formula != -1 {\r\n                                // Get parent cell keys\r\n                                let parent1_key = if !parent1_ref.is_empty() {\r\n                                    if let Ok((p1_row, p1_col)) = parse_cell_reference(sheet, parent1_ref) {\r\n                                        sheet.get_key(p1_row, p1_col)\r\n                                    } else {\r\n                                        -1\r\n                                    }\r\n                                } else {\r\n                                    -1\r\n                                };\r\n                                \r\n                                let parent2_key = if !parent2_ref.is_empty() {\r\n                                    if let Ok((p2_row, p2_col)) = parse_cell_reference(sheet, parent2_ref) {\r\n                                        sheet.get_key(p2_row, p2_col)\r\n                                    } else {\r\n                                        -1\r\n                                    }\r\n                                } else {\r\n                                    -1\r\n                                };\r\n                                \r\n                                // Set cell metadata\r\n                                let key = sheet.get_key(row, col);\r\n                                let meta = sheet.cell_meta.entry(key).or_insert_with(|| crate::spreadsheet::CellMeta::new());\r\n                                meta.formula = formula;\r\n                                meta.parent1 = parent1_key;\r\n                                meta.parent2 = parent2_key;\r\n                                \r\n                                // Add dependencies\r\n                                graph::add_children(sheet, parent1_key, parent2_key, formula, row, col);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            _ =\u003e continue,\r\n        }\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n\r\n// Process commands in insert mode\r\nfn handle_insert_mode_command(\r\n    sheet: \u0026mut Spreadsheet,\r\n    input: \u0026str,\r\n    state: \u0026mut EditorState,\r\n) -\u003e CommandStatus {\r\n    // Check for Escape key to exit insert mode\r\n    if input == \"Esc\" || input == \"\\x1b\" {\r\n        state.mode = EditorMode::Normal;\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    // Directly set the value of the cell at the cursor\r\n    let status = state.set_cursor_cell_value(sheet, input);\r\n\r\n    // If successful, move cursor down (like vim behavior)\r\n    if status == CommandStatus::CmdOk {\r\n        state.move_cursor('j', sheet);\r\n    }\r\n\r\n    status\r\n}\r\n\r\n// Cut the current cell (copy + clear)\r\nfn cut_cell(sheet: \u0026mut Spreadsheet, state: \u0026mut EditorState) -\u003e CommandStatus {\r\n    // First copy the cell\r\n    let status = yank_cell(sheet, state);\r\n    if status != CommandStatus::CmdOk {\r\n        return status;\r\n    }\r\n    let row = state.cursor_row;\r\n    let col = state.cursor_col;\r\n\r\n\r\n\r\n    *sheet.get_mut_cell(row, col) = CellValue::Integer(0);\r\n    \r\n    // Reset formula metadata\r\n    let cell_key = sheet.get_key(row, col);\r\n    if let Some(meta) = sheet.cell_meta.get_mut(\u0026cell_key) {\r\n        meta.formula = -1;  // No formula\r\n        meta.parent1 = -1;  // No parents\r\n        meta.parent2 = -1;\r\n    }\r\n    \r\n    // Also remove this cell from any dependency tracking\r\n    graph::remove_all_parents(sheet,row, col);\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n// Copy (yank) the current cell\r\nfn yank_cell(sheet: \u0026mut Spreadsheet, state: \u0026mut EditorState) -\u003e CommandStatus {\r\n    // Get the cell reference string and value\r\n    let cell_value = sheet.get_cell(state.cursor_row, state.cursor_col).clone();\r\n\r\n    // Get the formula for the cell (if any)\r\n    let cell_key = sheet.get_key(state.cursor_row, state.cursor_col);\r\n    let formula = if let Some(meta) = sheet.cell_meta.get(\u0026cell_key) {\r\n        if meta.formula != -1 {\r\n            // Get the parent cells as references\r\n       //get the parents , and the formula code converted to the actual operation\r\n            let parent1_ref = if meta.parent1 != -1 {\r\n                let (p1_row, p1_col) = sheet.get_row_col(meta.parent1);\r\n                format!(\"{}{}\", sheet.get_column_name(p1_col), p1_row + 1)\r\n            } else {\r\n                String::from(\"\")\r\n            };\r\n            \r\n            let parent2_ref = if meta.parent2 != -1 {\r\n                let (p2_row, p2_col) = sheet.get_row_col(meta.parent2);\r\n                format!(\"{}{}\", sheet.get_column_name(p2_col), p2_row + 1)\r\n            } else {\r\n                String::from(\"\")\r\n            };\r\n            // Convert formula code to string\r\n            if meta.formula==10{\r\n                format!(\"{}+{}\", parent1_ref, parent2_ref)\r\n            } else if meta.formula==20{\r\n                format!(\"{}-{}\", parent1_ref, parent2_ref)\r\n            } else if meta.formula==40{\r\n                format!(\"{}*{}\", parent1_ref, parent2_ref)\r\n            } else if meta.formula==30{\r\n                format!(\"{}/{}\", parent1_ref, parent2_ref)\r\n            } else {\r\n                format!(\"{}\", meta.formula)\r\n            }\r\n            \r\n             \r\n        } else {\r\n            String::new()\r\n    }\r\n    } else {\r\n        String::new()\r\n    };\r\n\r\n\r\n    // Store in clipboard\r\n    state.clipboard = Some((state.cursor_row, state.cursor_col, cell_value, formula));\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n\r\n\r\n// Paste to the current cell\r\nfn paste_cell(sheet: \u0026mut Spreadsheet, state: \u0026mut EditorState) -\u003e CommandStatus {\r\n    if let Some((_row, _col, _value, formula)) = \u0026state.clipboard {\r\n        // Get the target cell reference\r\n        let cell_ref = state.cursor_to_cell_ref(sheet);\r\n\r\n        // If there's a formula, paste that\r\n        if !formula.is_empty() {\r\n            let command = format!(\"{}={}\", cell_ref, formula);\r\n            return evaluator::handle_command(sheet, \u0026command, \u0026mut 0.0);\r\n        } else {\r\n            // Otherwise paste the literal value\r\n            match _value {\r\n                crate::cell::CellValue::Integer(value) =\u003e {\r\n                    let command = format!(\"{}={}\", cell_ref, value);\r\n                    return evaluator::handle_command(sheet, \u0026command, \u0026mut 0.0);\r\n                }\r\n                crate::cell::CellValue::Error =\u003e {\r\n                    // Can't paste an error\r\n                    return CommandStatus::CmdUnrecognized;\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        // Nothing in clipboard\r\n        CommandStatus::CmdUnrecognized\r\n    }\r\n}\r\n","traces":[{"line":14,"address":[451744],"length":1,"stats":{"Line":0}},{"line":19,"address":[451812],"length":1,"stats":{"Line":0}},{"line":20,"address":[451847],"length":1,"stats":{"Line":0}},{"line":23,"address":[451857],"length":1,"stats":{"Line":0}},{"line":24,"address":[451894],"length":1,"stats":{"Line":0}},{"line":25,"address":[451925],"length":1,"stats":{"Line":0}},{"line":33,"address":[451952,453523],"length":1,"stats":{"Line":0}},{"line":42,"address":[452037],"length":1,"stats":{"Line":0}},{"line":43,"address":[452074],"length":1,"stats":{"Line":0}},{"line":48,"address":[452201],"length":1,"stats":{"Line":0}},{"line":49,"address":[452266],"length":1,"stats":{"Line":0}},{"line":53,"address":[452278],"length":1,"stats":{"Line":0}},{"line":54,"address":[452302],"length":1,"stats":{"Line":0}},{"line":57,"address":[452319],"length":1,"stats":{"Line":0}},{"line":58,"address":[452340],"length":1,"stats":{"Line":0}},{"line":59,"address":[452361],"length":1,"stats":{"Line":0}},{"line":61,"address":[452377],"length":1,"stats":{"Line":0}},{"line":62,"address":[452384],"length":1,"stats":{"Line":0}},{"line":69,"address":[452168],"length":1,"stats":{"Line":0}},{"line":71,"address":[452459],"length":1,"stats":{"Line":0}},{"line":74,"address":[452524,452619],"length":1,"stats":{"Line":0}},{"line":76,"address":[452688,452780,453051],"length":1,"stats":{"Line":0}},{"line":77,"address":[452903],"length":1,"stats":{"Line":0}},{"line":78,"address":[452747,453079],"length":1,"stats":{"Line":0}},{"line":79,"address":[453086],"length":1,"stats":{"Line":0}},{"line":81,"address":[453053],"length":1,"stats":{"Line":0}},{"line":84,"address":[453111],"length":1,"stats":{"Line":0}},{"line":85,"address":[453188,453270],"length":1,"stats":{"Line":0}},{"line":86,"address":[453422],"length":1,"stats":{"Line":0}},{"line":88,"address":[453215],"length":1,"stats":{"Line":0}},{"line":93,"address":[452586],"length":1,"stats":{"Line":0}},{"line":94,"address":[453659],"length":1,"stats":{"Line":0}},{"line":95,"address":[453666],"length":1,"stats":{"Line":0}},{"line":99,"address":[453583],"length":1,"stats":{"Line":0}},{"line":101,"address":[454168,453774],"length":1,"stats":{"Line":0}},{"line":102,"address":[454291],"length":1,"stats":{"Line":0}},{"line":104,"address":[454138],"length":1,"stats":{"Line":0}},{"line":107,"address":[454439],"length":1,"stats":{"Line":0}},{"line":108,"address":[454598,454516],"length":1,"stats":{"Line":0}},{"line":109,"address":[454750],"length":1,"stats":{"Line":0}},{"line":110,"address":[454878,454804],"length":1,"stats":{"Line":0}},{"line":111,"address":[454871],"length":1,"stats":{"Line":0}},{"line":113,"address":[454840],"length":1,"stats":{"Line":0}},{"line":116,"address":[454543],"length":1,"stats":{"Line":0}},{"line":121,"address":[453676],"length":1,"stats":{"Line":0}},{"line":122,"address":[453847],"length":1,"stats":{"Line":0}},{"line":123,"address":[453903],"length":1,"stats":{"Line":0}},{"line":125,"address":[454074,454003,453972],"length":1,"stats":{"Line":0}},{"line":126,"address":[454110],"length":1,"stats":{"Line":0}},{"line":128,"address":[453991],"length":1,"stats":{"Line":0}},{"line":131,"address":[453947],"length":1,"stats":{"Line":0}},{"line":137,"address":[452416],"length":1,"stats":{"Line":0}},{"line":138,"address":[452429],"length":1,"stats":{"Line":0}},{"line":139,"address":[452442],"length":1,"stats":{"Line":0}},{"line":143,"address":[454960,458401,458329],"length":1,"stats":{"Line":0}},{"line":144,"address":[455031],"length":1,"stats":{"Line":0}},{"line":147,"address":[455076],"length":1,"stats":{"Line":0}},{"line":153,"address":[455178],"length":1,"stats":{"Line":0}},{"line":154,"address":[455222],"length":1,"stats":{"Line":0}},{"line":158,"address":[455252],"length":1,"stats":{"Line":0}},{"line":161,"address":[455413,455346],"length":1,"stats":{"Line":0}},{"line":162,"address":[455571],"length":1,"stats":{"Line":0}},{"line":166,"address":[455793,455645],"length":1,"stats":{"Line":0}},{"line":167,"address":[455872,455814],"length":1,"stats":{"Line":0}},{"line":168,"address":[455991],"length":1,"stats":{"Line":0}},{"line":169,"address":[456037],"length":1,"stats":{"Line":0}},{"line":172,"address":[456068],"length":1,"stats":{"Line":0}},{"line":174,"address":[456099],"length":1,"stats":{"Line":0}},{"line":178,"address":[456115],"length":1,"stats":{"Line":0}},{"line":180,"address":[456151],"length":1,"stats":{"Line":0}},{"line":181,"address":[456187],"length":1,"stats":{"Line":0}},{"line":184,"address":[456554],"length":1,"stats":{"Line":0}},{"line":185,"address":[456567],"length":1,"stats":{"Line":0}},{"line":186,"address":[456595,456684],"length":1,"stats":{"Line":0}},{"line":189,"address":[456842,456618],"length":1,"stats":{"Line":0}},{"line":194,"address":[456818,456951],"length":1,"stats":{"Line":0}},{"line":195,"address":[457009],"length":1,"stats":{"Line":0}},{"line":197,"address":[457050],"length":1,"stats":{"Line":0}},{"line":198,"address":[457151,457092],"length":1,"stats":{"Line":0}},{"line":199,"address":[457175],"length":1,"stats":{"Line":0}},{"line":201,"address":[457111,457072],"length":1,"stats":{"Line":0}},{"line":204,"address":[457118],"length":1,"stats":{"Line":0}},{"line":205,"address":[457687,457580],"length":1,"stats":{"Line":0}},{"line":206,"address":[457711],"length":1,"stats":{"Line":0}},{"line":208,"address":[457560,457640],"length":1,"stats":{"Line":0}},{"line":211,"address":[457647,458135],"length":1,"stats":{"Line":0}},{"line":217,"address":[457016,458354],"length":1,"stats":{"Line":0}},{"line":222,"address":[455762],"length":1,"stats":{"Line":0}},{"line":226,"address":[458448,462285,462757],"length":1,"stats":{"Line":0}},{"line":227,"address":[458525],"length":1,"stats":{"Line":0}},{"line":230,"address":[458565],"length":1,"stats":{"Line":0}},{"line":231,"address":[458591],"length":1,"stats":{"Line":0}},{"line":232,"address":[458635],"length":1,"stats":{"Line":0}},{"line":236,"address":[458759,458665],"length":1,"stats":{"Line":0}},{"line":239,"address":[459024,458767,458853],"length":1,"stats":{"Line":0}},{"line":240,"address":[462346,459048],"length":1,"stats":{"Line":0}},{"line":241,"address":[462468],"length":1,"stats":{"Line":0}},{"line":243,"address":[462517],"length":1,"stats":{"Line":0}},{"line":244,"address":[462556],"length":1,"stats":{"Line":0}},{"line":247,"address":[462629],"length":1,"stats":{"Line":0}},{"line":249,"address":[462686],"length":1,"stats":{"Line":0}},{"line":250,"address":[462707],"length":1,"stats":{"Line":0}},{"line":256,"address":[459098,459244,459194,458946],"length":1,"stats":{"Line":0}},{"line":257,"address":[459292],"length":1,"stats":{"Line":0}},{"line":258,"address":[459371],"length":1,"stats":{"Line":0}},{"line":262,"address":[459583,459447],"length":1,"stats":{"Line":0}},{"line":263,"address":[459682,459621],"length":1,"stats":{"Line":0}},{"line":268,"address":[459688],"length":1,"stats":{"Line":0}},{"line":269,"address":[459748],"length":1,"stats":{"Line":0}},{"line":271,"address":[461768,459843],"length":1,"stats":{"Line":0}},{"line":273,"address":[461778],"length":1,"stats":{"Line":0}},{"line":274,"address":[461906],"length":1,"stats":{"Line":0}},{"line":276,"address":[462047],"length":1,"stats":{"Line":0}},{"line":277,"address":[462082],"length":1,"stats":{"Line":0}},{"line":281,"address":[459868,459802],"length":1,"stats":{"Line":0}},{"line":283,"address":[459885],"length":1,"stats":{"Line":0}},{"line":284,"address":[459932],"length":1,"stats":{"Line":0}},{"line":285,"address":[460014],"length":1,"stats":{"Line":0}},{"line":288,"address":[460104],"length":1,"stats":{"Line":0}},{"line":290,"address":[460248,460332],"length":1,"stats":{"Line":0}},{"line":291,"address":[460321],"length":1,"stats":{"Line":0}},{"line":293,"address":[460342,460290],"length":1,"stats":{"Line":0}},{"line":294,"address":[460388],"length":1,"stats":{"Line":0}},{"line":299,"address":[460444],"length":1,"stats":{"Line":0}},{"line":300,"address":[460489],"length":1,"stats":{"Line":0}},{"line":303,"address":[460574],"length":1,"stats":{"Line":0}},{"line":304,"address":[460687],"length":1,"stats":{"Line":0}},{"line":305,"address":[460836],"length":1,"stats":{"Line":0}},{"line":306,"address":[461039,460926],"length":1,"stats":{"Line":0}},{"line":308,"address":[461022],"length":1,"stats":{"Line":0}},{"line":310,"address":[461080,461148],"length":1,"stats":{"Line":0}},{"line":311,"address":[461158,461125,461243,461295,461262],"length":1,"stats":{"Line":0}},{"line":312,"address":[461301,461273,461235,461254],"length":1,"stats":{"Line":0}},{"line":314,"address":[461284],"length":1,"stats":{"Line":0}},{"line":317,"address":[461137],"length":1,"stats":{"Line":0}},{"line":320,"address":[461308,461392],"length":1,"stats":{"Line":0}},{"line":321,"address":[461506,461487,461353,461539,461402],"length":1,"stats":{"Line":0}},{"line":322,"address":[461498,461545,461479,461517],"length":1,"stats":{"Line":0}},{"line":324,"address":[461528],"length":1,"stats":{"Line":0}},{"line":327,"address":[461381],"length":1,"stats":{"Line":0}},{"line":331,"address":[461576],"length":1,"stats":{"Line":0}},{"line":332,"address":[237664,237676],"length":1,"stats":{"Line":0}},{"line":333,"address":[461698],"length":1,"stats":{"Line":0}},{"line":334,"address":[461703],"length":1,"stats":{"Line":0}},{"line":335,"address":[461712],"length":1,"stats":{"Line":0}},{"line":338,"address":[461722],"length":1,"stats":{"Line":0}},{"line":348,"address":[459332],"length":1,"stats":{"Line":0}},{"line":353,"address":[462816],"length":1,"stats":{"Line":0}},{"line":359,"address":[462849],"length":1,"stats":{"Line":0}},{"line":360,"address":[462898],"length":1,"stats":{"Line":0}},{"line":361,"address":[462916],"length":1,"stats":{"Line":0}},{"line":365,"address":[462932],"length":1,"stats":{"Line":0}},{"line":368,"address":[462951],"length":1,"stats":{"Line":0}},{"line":369,"address":[462991],"length":1,"stats":{"Line":0}},{"line":372,"address":[462972],"length":1,"stats":{"Line":0}},{"line":376,"address":[463024],"length":1,"stats":{"Line":0}},{"line":378,"address":[463048],"length":1,"stats":{"Line":0}},{"line":379,"address":[463057],"length":1,"stats":{"Line":0}},{"line":380,"address":[463253],"length":1,"stats":{"Line":0}},{"line":382,"address":[463092],"length":1,"stats":{"Line":0}},{"line":383,"address":[463109],"length":1,"stats":{"Line":0}},{"line":387,"address":[463126],"length":1,"stats":{"Line":0}},{"line":390,"address":[463186],"length":1,"stats":{"Line":0}},{"line":391,"address":[463263,463206],"length":1,"stats":{"Line":0}},{"line":392,"address":[463273],"length":1,"stats":{"Line":0}},{"line":393,"address":[463279],"length":1,"stats":{"Line":0}},{"line":394,"address":[463285],"length":1,"stats":{"Line":0}},{"line":398,"address":[463307],"length":1,"stats":{"Line":0}},{"line":399,"address":[463318],"length":1,"stats":{"Line":0}},{"line":403,"address":[463344,465650],"length":1,"stats":{"Line":0}},{"line":405,"address":[463380],"length":1,"stats":{"Line":0}},{"line":408,"address":[463444],"length":1,"stats":{"Line":0}},{"line":409,"address":[463475],"length":1,"stats":{"Line":0}},{"line":410,"address":[463538],"length":1,"stats":{"Line":0}},{"line":413,"address":[463576],"length":1,"stats":{"Line":0}},{"line":414,"address":[463791],"length":1,"stats":{"Line":0}},{"line":415,"address":[463833,463902],"length":1,"stats":{"Line":0}},{"line":417,"address":[463760],"length":1,"stats":{"Line":0}},{"line":420,"address":[463879],"length":1,"stats":{"Line":0}},{"line":421,"address":[464358,464263],"length":1,"stats":{"Line":0}},{"line":422,"address":[464382],"length":1,"stats":{"Line":0}},{"line":424,"address":[464320,464246],"length":1,"stats":{"Line":0}},{"line":427,"address":[464327],"length":1,"stats":{"Line":0}},{"line":428,"address":[464847,464763],"length":1,"stats":{"Line":0}},{"line":429,"address":[464775],"length":1,"stats":{"Line":0}},{"line":430,"address":[465000,465044],"length":1,"stats":{"Line":0}},{"line":431,"address":[465012],"length":1,"stats":{"Line":0}},{"line":432,"address":[465182,465226],"length":1,"stats":{"Line":0}},{"line":433,"address":[465194],"length":1,"stats":{"Line":0}},{"line":434,"address":[465364,465414],"length":1,"stats":{"Line":0}},{"line":436,"address":[465376,465539],"length":1,"stats":{"Line":0}},{"line":441,"address":[463559],"length":1,"stats":{"Line":0}},{"line":444,"address":[463547],"length":1,"stats":{"Line":0}},{"line":449,"address":[465677,463603],"length":1,"stats":{"Line":0}},{"line":451,"address":[465750],"length":1,"stats":{"Line":0}},{"line":456,"address":[466324,465776,466665],"length":1,"stats":{"Line":0}},{"line":457,"address":[465809,465945],"length":1,"stats":{"Line":0}},{"line":459,"address":[465919],"length":1,"stats":{"Line":0}},{"line":462,"address":[465924,465991],"length":1,"stats":{"Line":0}},{"line":463,"address":[466010,466052],"length":1,"stats":{"Line":0}},{"line":464,"address":[466255,466183],"length":1,"stats":{"Line":0}},{"line":467,"address":[466022],"length":1,"stats":{"Line":0}},{"line":468,"address":[466338],"length":1,"stats":{"Line":0}},{"line":469,"address":[466363,466393],"length":1,"stats":{"Line":0}},{"line":470,"address":[466524,466596],"length":1,"stats":{"Line":0}},{"line":474,"address":[466370],"length":1,"stats":{"Line":0}},{"line":480,"address":[465940],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":207},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","vim_mode","editor.rs"],"content":"// vim_mode/editor.rs\r\nuse crate::cell::CellValue;\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\nuse std::io::{self, Write};\r\n\r\n// Define editor modes\r\n#[derive(Debug, Clone, Copy, PartialEq)]\r\npub enum EditorMode {\r\n    Normal,\r\n    Insert,\r\n    \r\n}\r\n\r\n// Editor state structure\r\npub struct EditorState {\r\n    pub mode: EditorMode,\r\n    pub cursor_row: i16,\r\n    pub cursor_col: i16,\r\n    pub clipboard: Option\u003c(i16, i16, CellValue, String)\u003e, // (row, col, value, formula)\r\n    pub should_quit: bool,\r\n    pub save_file: Option\u003cString\u003e,\r\n    // Command history\r\n    pub command_history: Vec\u003cString\u003e,\r\n    pub history_position: usize,\r\n    pub current_input: String,\r\n    pub command_buffer: String,\r\n}\r\n\r\nimpl EditorState {\r\n    pub fn new() -\u003e Self {\r\n        EditorState {\r\n            mode: EditorMode::Normal,\r\n            cursor_row: 0,\r\n            cursor_col: 0,\r\n            clipboard: None,\r\n            should_quit: false,\r\n            save_file: None,\r\n            command_history: Vec::new(),\r\n            history_position: 0,\r\n            current_input: String::new(),\r\n            command_buffer: String::new(),\r\n        }\r\n    }\r\n\r\n    pub fn mode_display(\u0026self) -\u003e \u0026str {\r\n        match self.mode {\r\n            EditorMode::Normal =\u003e \"NORMAL\",\r\n            EditorMode::Insert =\u003e \"INSERT\",\r\n            \r\n        }\r\n    }\r\n\r\n  \r\n\r\n    // Move cursor in the specified direction\r\n    pub fn move_cursor(\u0026mut self, direction: char, sheet: \u0026mut Spreadsheet) {\r\n        match direction {\r\n            'h' =\u003e {\r\n                if self.cursor_col \u003e 0 {\r\n                    self.cursor_col -= 1\r\n                }\r\n            }\r\n            'j' =\u003e {\r\n                if self.cursor_row \u003c sheet.rows - 1 {\r\n                    self.cursor_row += 1\r\n                }\r\n            }\r\n            'k' =\u003e {\r\n                if self.cursor_row \u003e 0 {\r\n                    self.cursor_row -= 1\r\n                }\r\n            } // Fixed 'k' from 'u'\r\n            'l' =\u003e {\r\n                if self.cursor_col \u003c sheet.cols - 1 {\r\n                    self.cursor_col += 1\r\n                }\r\n            }\r\n            _ =\u003e {}\r\n        }\r\n\r\n        // Ensure viewport contains cursor\r\n        self.adjust_viewport(sheet);\r\n    }\r\n    pub fn add_to_history(\u0026mut self, command: \u0026str) {\r\n        // Don't add empty commands or duplicates of the most recent command\r\n        if command.trim().is_empty()\r\n            || (self\r\n                .command_history\r\n                .last()\r\n                .map_or(false, |last| last == command))\r\n        {\r\n            return;\r\n        }\r\n\r\n        self.command_history.push(command.to_string());\r\n        self.history_position = self.command_history.len();\r\n    }\r\n\r\n    // Navigate through command history\r\n    pub fn navigate_history(\u0026mut self, direction: \u0026str) -\u003e String {\r\n        // If navigating history for the first time, save current input\r\n        if self.history_position == self.command_history.len() \u0026\u0026 direction == \"up\" {\r\n            self.current_input = self.command_buffer.clone();\r\n        }\r\n\r\n        match direction {\r\n            \"up\" =\u003e {\r\n                if self.history_position \u003e 0 {\r\n                    self.history_position -= 1;\r\n                    self.command_history\r\n                        .get(self.history_position)\r\n                        .unwrap_or(\u0026String::new())\r\n                        .clone()\r\n                } else {\r\n                    self.command_history\r\n                        .get(0)\r\n                        .unwrap_or(\u0026String::new())\r\n                        .clone()\r\n                }\r\n            }\r\n            \"down\" =\u003e {\r\n                if self.history_position \u003c self.command_history.len() - 1 {\r\n                    self.history_position += 1;\r\n                    self.command_history\r\n                        .get(self.history_position)\r\n                        .unwrap_or(\u0026String::new())\r\n                        .clone()\r\n                } else {\r\n                    self.history_position = self.command_history.len();\r\n                    self.current_input.clone()\r\n                }\r\n            }\r\n            _ =\u003e String::new(),\r\n        }\r\n    }\r\n\r\n\r\n\r\n    // Adjust spreadsheet viewport to contain cursor\r\n    pub fn adjust_viewport(\u0026self, sheet: \u0026mut Spreadsheet) {\r\n        const VIEWPORT_SIZE: i16 = 10;\r\n\r\n        // Adjust viewport row if cursor is outside\r\n        if self.cursor_row \u003c sheet.viewport_row {\r\n            sheet.viewport_row = self.cursor_row;\r\n        } else if self.cursor_row \u003e= sheet.viewport_row + VIEWPORT_SIZE {\r\n            sheet.viewport_row = self.cursor_row - VIEWPORT_SIZE + 1;\r\n            if sheet.viewport_row \u003c 0 {\r\n                sheet.viewport_row = 0;\r\n            }\r\n        }\r\n\r\n        // Adjust viewport column if cursor is outside\r\n        if self.cursor_col \u003c sheet.viewport_col {\r\n            sheet.viewport_col = self.cursor_col;\r\n        } else if self.cursor_col \u003e= sheet.viewport_col + VIEWPORT_SIZE {\r\n            sheet.viewport_col = self.cursor_col - VIEWPORT_SIZE + 1;\r\n            if sheet.viewport_col \u003c 0 {\r\n                sheet.viewport_col = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Custom rendering function for vim mode\r\n    pub fn render_spreadsheet(\u0026self, sheet: \u0026Spreadsheet) {\r\n        // Clear screen\r\n        print!(\"\\x1B[2J\\x1B[1;1H\");\r\n\r\n        // Calculate visible area\r\n        let start_row = sheet.viewport_row;\r\n        let start_col = sheet.viewport_col;\r\n        let end_row = std::cmp::min(start_row + 10, sheet.rows);\r\n        let end_col = std::cmp::min(start_col + 10, sheet.cols);\r\n\r\n        // Print column headers only once\r\n        print!(\"     \");\r\n        for col in start_col..end_col {\r\n            print!(\"{:\u003c8} \", sheet.get_column_name(col));\r\n        }\r\n        println!();\r\n\r\n        // Print rows with data\r\n        for row in start_row..end_row {\r\n            print!(\"{:\u003c4} \", row + 1); // Show 1-based row numbers\r\n\r\n            for col in start_col..end_col {\r\n                let cell_value = sheet.get_cell(row, col);\r\n\r\n                // Highlight the cell under the cursor\r\n                if row == self.cursor_row \u0026\u0026 col == self.cursor_col {\r\n                    print!(\"\\x1B[7m\"); // Invert colors\r\n                    match cell_value {\r\n                        CellValue::Integer(value) =\u003e print!(\"{:\u003c8}\", value),\r\n                        CellValue::Error =\u003e print!(\"{:\u003c8}\", \"ERR\"),\r\n                    }\r\n                    print!(\"\\x1B[0m \"); // Reset colors\r\n                } else {\r\n                    match cell_value {\r\n                        CellValue::Integer(value) =\u003e print!(\"{:\u003c8} \", value),\r\n                        CellValue::Error =\u003e print!(\"{:\u003c8} \", \"ERR\"),\r\n                    }\r\n                }\r\n            }\r\n            println!();\r\n        }\r\n\r\n        // Display status bar\r\n        let col_letter = sheet.get_column_name(self.cursor_col);\r\n        let cell_ref = format!(\"{}{}\", col_letter, self.cursor_row + 1);\r\n\r\n        // Get formula for current cell (if exists)\r\n        let cell_key = sheet.get_key(self.cursor_row, self.cursor_col);\r\n        let formula_str = if let Some(meta) = sheet.cell_meta.get(\u0026cell_key) {\r\n            \r\n                if meta.formula != 0 {\r\n                    // Get the parent cells as references\r\n               //get the parents , and the formula code converted to the actual operation\r\n                    let parent1_ref = if meta.parent1 != -1 {\r\n                        let (p1_row, p1_col) = sheet.get_row_col(meta.parent1);\r\n                        format!(\"{}{}\", sheet.get_column_name(p1_col), p1_row + 1)\r\n                    } else {\r\n                        String::from(\"\")\r\n                    };\r\n                    \r\n                    let parent2_ref = if meta.parent2 != -1 {\r\n                        let (p2_row, p2_col) = sheet.get_row_col(meta.parent2);\r\n                        format!(\"{}{}\", sheet.get_column_name(p2_col), p2_row + 1)\r\n                    } else {\r\n                        String::from(\"\")\r\n                    };\r\n                    // Convert formula code to string\r\n                    if meta.formula==10{\r\n                        format!(\"{}+{}\", parent1_ref, parent2_ref)\r\n                    } else if meta.formula==20{\r\n                        format!(\"{}-{}\", parent1_ref, parent2_ref)\r\n                    } else if meta.formula==40{\r\n                        format!(\"{}*{}\", parent1_ref, parent2_ref)\r\n                    } else if meta.formula==30{\r\n                        format!(\"{}/{}\", parent1_ref, parent2_ref)\r\n                    } else {\r\n                        let (row, col) = sheet.get_row_col(cell_key);\r\n                        format!(\"{:?}\", sheet.get_cell(row,col))\r\n                    }\r\n                    \r\n        \r\n                \r\n            } else {\r\n                \"\".to_string()\r\n            }\r\n        } else {\r\n            \"\".to_string()\r\n        };\r\n\r\n        println!(\"\\nCursor at: {} - {}\", cell_ref, formula_str);\r\n\r\n        // Display mode\r\n        println!(\r\n            \"Mode: {} | Use hjkl to navigate, i to insert, Esc to exit insert mode\",\r\n            self.mode_display()\r\n        );\r\n\r\n        // If clipboard has content, show it\r\n        if let Some((_, _, value, formula)) = \u0026self.clipboard {\r\n            println!(\"Clipboard: {:?}\", value);\r\n            if !formula.is_empty() {\r\n                println!(\"Formula: {:?}\", formula);\r\n            }\r\n        }\r\n\r\n        io::stdout().flush().unwrap();\r\n    }\r\n\r\n    // Set the value of the cell at the cursor\r\n    pub fn set_cursor_cell_value(\u0026self, sheet: \u0026mut Spreadsheet, value: \u0026str) -\u003e CommandStatus {\r\n        let cell_ref = self.cursor_to_cell_ref(sheet);\r\n        let command = format!(\"{}={}\", cell_ref, value);\r\n        let mut sleep_time = 0.0;\r\n        crate::evaluator::handle_command(sheet, \u0026command, \u0026mut sleep_time)\r\n    }\r\n\r\n    // Convert cursor position to cell reference string (e.g., \"A1\")\r\n    pub fn cursor_to_cell_ref(\u0026self, sheet: \u0026Spreadsheet) -\u003e String {\r\n        let col_letter = sheet.get_column_name(self.cursor_col);\r\n        format!(\"{}{}\", col_letter, self.cursor_row + 1)\r\n    }\r\n}\r\n","traces":[{"line":30,"address":[238179,237760,238158],"length":1,"stats":{"Line":0}},{"line":38,"address":[237807],"length":1,"stats":{"Line":0}},{"line":40,"address":[237856],"length":1,"stats":{"Line":0}},{"line":41,"address":[237905],"length":1,"stats":{"Line":0}},{"line":45,"address":[238192],"length":1,"stats":{"Line":0}},{"line":46,"address":[238197],"length":1,"stats":{"Line":0}},{"line":47,"address":[238214],"length":1,"stats":{"Line":0}},{"line":48,"address":[238237],"length":1,"stats":{"Line":0}},{"line":56,"address":[238272],"length":1,"stats":{"Line":0}},{"line":57,"address":[238302],"length":1,"stats":{"Line":0}},{"line":59,"address":[238550,238363],"length":1,"stats":{"Line":0}},{"line":60,"address":[238555,238511],"length":1,"stats":{"Line":0}},{"line":64,"address":[238389,238651,238581],"length":1,"stats":{"Line":0}},{"line":65,"address":[238612,238656],"length":1,"stats":{"Line":0}},{"line":69,"address":[238716,238437],"length":1,"stats":{"Line":0}},{"line":70,"address":[238677,238721],"length":1,"stats":{"Line":0}},{"line":74,"address":[238747,238817,238463],"length":1,"stats":{"Line":0}},{"line":75,"address":[238822,238778],"length":1,"stats":{"Line":0}},{"line":82,"address":[238348],"length":1,"stats":{"Line":0}},{"line":84,"address":[238848],"length":1,"stats":{"Line":0}},{"line":86,"address":[238871],"length":1,"stats":{"Line":0}},{"line":87,"address":[238905],"length":1,"stats":{"Line":0}},{"line":90,"address":[484526,484512],"length":1,"stats":{"Line":0}},{"line":95,"address":[238947],"length":1,"stats":{"Line":0}},{"line":96,"address":[238992],"length":1,"stats":{"Line":0}},{"line":100,"address":[239758,239024],"length":1,"stats":{"Line":0}},{"line":102,"address":[239163,239081,239340],"length":1,"stats":{"Line":0}},{"line":103,"address":[239194],"length":1,"stats":{"Line":0}},{"line":107,"address":[239117],"length":1,"stats":{"Line":0}},{"line":108,"address":[239389],"length":1,"stats":{"Line":0}},{"line":109,"address":[240055,239855,239975],"length":1,"stats":{"Line":0}},{"line":110,"address":[240043,239982,240005,240121],"length":1,"stats":{"Line":0}},{"line":111,"address":[239998],"length":1,"stats":{"Line":0}},{"line":112,"address":[240028],"length":1,"stats":{"Line":0}},{"line":115,"address":[239785,239838,239936],"length":1,"stats":{"Line":0}},{"line":117,"address":[239823],"length":1,"stats":{"Line":0}},{"line":121,"address":[239345],"length":1,"stats":{"Line":0}},{"line":122,"address":[239488,239425],"length":1,"stats":{"Line":0}},{"line":123,"address":[239666,239555],"length":1,"stats":{"Line":0}},{"line":124,"address":[239593,239654,239729,239616],"length":1,"stats":{"Line":0}},{"line":125,"address":[239609],"length":1,"stats":{"Line":0}},{"line":126,"address":[239639],"length":1,"stats":{"Line":0}},{"line":129,"address":[239516],"length":1,"stats":{"Line":0}},{"line":130,"address":[239538],"length":1,"stats":{"Line":0}},{"line":133,"address":[239413],"length":1,"stats":{"Line":0}},{"line":140,"address":[240160],"length":1,"stats":{"Line":0}},{"line":144,"address":[240184,240271],"length":1,"stats":{"Line":0}},{"line":145,"address":[240257],"length":1,"stats":{"Line":0}},{"line":146,"address":[240210,240283],"length":1,"stats":{"Line":0}},{"line":147,"address":[240346,240439],"length":1,"stats":{"Line":0}},{"line":148,"address":[240469,240424],"length":1,"stats":{"Line":0}},{"line":149,"address":[240460],"length":1,"stats":{"Line":0}},{"line":154,"address":[240545,240316],"length":1,"stats":{"Line":0}},{"line":155,"address":[240531],"length":1,"stats":{"Line":0}},{"line":156,"address":[240484,240557],"length":1,"stats":{"Line":0}},{"line":157,"address":[240590,240680],"length":1,"stats":{"Line":0}},{"line":158,"address":[240710,240668],"length":1,"stats":{"Line":0}},{"line":159,"address":[240701],"length":1,"stats":{"Line":0}},{"line":165,"address":[244057,240720,244788],"length":1,"stats":{"Line":0}},{"line":167,"address":[240759],"length":1,"stats":{"Line":0}},{"line":170,"address":[240802],"length":1,"stats":{"Line":0}},{"line":171,"address":[240825],"length":1,"stats":{"Line":0}},{"line":172,"address":[240848,240950],"length":1,"stats":{"Line":0}},{"line":173,"address":[240925,241093,240982],"length":1,"stats":{"Line":0}},{"line":176,"address":[241013],"length":1,"stats":{"Line":0}},{"line":177,"address":[241064,241248,241109],"length":1,"stats":{"Line":0}},{"line":178,"address":[246628,241240,241275],"length":1,"stats":{"Line":0}},{"line":180,"address":[241152],"length":1,"stats":{"Line":0}},{"line":183,"address":[241306,241203,241416],"length":1,"stats":{"Line":0}},{"line":184,"address":[244809,241440,245140],"length":1,"stats":{"Line":0}},{"line":186,"address":[245111,245255,245156],"length":1,"stats":{"Line":0}},{"line":187,"address":[245276],"length":1,"stats":{"Line":0}},{"line":190,"address":[245359,245319],"length":1,"stats":{"Line":0}},{"line":191,"address":[245368],"length":1,"stats":{"Line":0}},{"line":192,"address":[245408],"length":1,"stats":{"Line":0}},{"line":193,"address":[246012],"length":1,"stats":{"Line":0}},{"line":194,"address":[246305],"length":1,"stats":{"Line":0}},{"line":196,"address":[246580],"length":1,"stats":{"Line":0}},{"line":198,"address":[245333],"length":1,"stats":{"Line":0}},{"line":199,"address":[245430],"length":1,"stats":{"Line":0}},{"line":200,"address":[245725],"length":1,"stats":{"Line":0}},{"line":204,"address":[245199],"length":1,"stats":{"Line":0}},{"line":208,"address":[241365],"length":1,"stats":{"Line":0}},{"line":209,"address":[241409,241515],"length":1,"stats":{"Line":0}},{"line":212,"address":[241731,241813],"length":1,"stats":{"Line":0}},{"line":213,"address":[241820],"length":1,"stats":{"Line":0}},{"line":215,"address":[241913],"length":1,"stats":{"Line":0}},{"line":218,"address":[241978],"length":1,"stats":{"Line":0}},{"line":219,"address":[242050,242109],"length":1,"stats":{"Line":0}},{"line":220,"address":[242133],"length":1,"stats":{"Line":0}},{"line":222,"address":[242069,242030],"length":1,"stats":{"Line":0}},{"line":225,"address":[242076],"length":1,"stats":{"Line":0}},{"line":226,"address":[242538,242639],"length":1,"stats":{"Line":0}},{"line":227,"address":[242663],"length":1,"stats":{"Line":0}},{"line":229,"address":[242518,242598],"length":1,"stats":{"Line":0}},{"line":232,"address":[242605],"length":1,"stats":{"Line":0}},{"line":233,"address":[243047,243131],"length":1,"stats":{"Line":0}},{"line":234,"address":[243059],"length":1,"stats":{"Line":0}},{"line":235,"address":[243334,243290],"length":1,"stats":{"Line":0}},{"line":236,"address":[243302],"length":1,"stats":{"Line":0}},{"line":237,"address":[243478,243522],"length":1,"stats":{"Line":0}},{"line":238,"address":[243490],"length":1,"stats":{"Line":0}},{"line":239,"address":[243666,243724],"length":1,"stats":{"Line":0}},{"line":241,"address":[243870,243681],"length":1,"stats":{"Line":0}},{"line":242,"address":[243886],"length":1,"stats":{"Line":0}},{"line":248,"address":[241966,241985],"length":1,"stats":{"Line":0}},{"line":251,"address":[244066,241939],"length":1,"stats":{"Line":0}},{"line":254,"address":[244127,242003],"length":1,"stats":{"Line":0}},{"line":257,"address":[244286],"length":1,"stats":{"Line":0}},{"line":263,"address":[244372],"length":1,"stats":{"Line":0}},{"line":264,"address":[244482,244456],"length":1,"stats":{"Line":0}},{"line":265,"address":[244553],"length":1,"stats":{"Line":0}},{"line":266,"address":[244598],"length":1,"stats":{"Line":0}},{"line":270,"address":[244463,244686],"length":1,"stats":{"Line":0}},{"line":274,"address":[246944,247329],"length":1,"stats":{"Line":0}},{"line":275,"address":[247001],"length":1,"stats":{"Line":0}},{"line":276,"address":[247076,247019],"length":1,"stats":{"Line":0}},{"line":277,"address":[247190],"length":1,"stats":{"Line":0}},{"line":278,"address":[247284,247207],"length":1,"stats":{"Line":0}},{"line":282,"address":[247360,247697],"length":1,"stats":{"Line":0}},{"line":283,"address":[247411],"length":1,"stats":{"Line":0}},{"line":284,"address":[247495,247446],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":122},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","vim_mode","mod.rs"],"content":"mod commands;\r\nmod editor;\r\n\r\nuse crate::spreadsheet::Spreadsheet;\r\nuse std::io::{self, Write};\r\n\r\npub fn run_editor(sheet: \u0026mut Spreadsheet, filename: Option\u003cString\u003e) {\r\n    // Initialize vim mode editor state\r\n    let mut editor_state = editor::EditorState::new();\r\n\r\n    // If a filename was provided, load it and set it as saved file\r\n    if let Some(file) = filename {\r\n        editor_state.save_file = Some(file.clone());\r\n        let _ = commands::load_spreadsheet(sheet, \u0026file);\r\n    }\r\n\r\n    // Main editor loop\r\n    loop {\r\n        // Render the spreadsheet with cursor\r\n        editor_state.render_spreadsheet(sheet);\r\n\r\n        // Show command prompt\r\n        print!(\"{} \u003e \", editor_state.mode_display());\r\n        io::stdout().flush().unwrap();\r\n\r\n        // Get user input\r\n        let mut input = String::with_capacity(128);\r\n        if io::stdin().read_line(\u0026mut input).unwrap() == 0 {\r\n            break; // End of input\r\n        }\r\n\r\n        let trimmed = input.trim();\r\n        \r\n        // Handle command history navigation keys\r\n        if trimmed == \"\\x10\" {  // Ctrl+P for previous command\r\n            if !editor_state.command_history.is_empty() {\r\n                let prev_cmd = editor_state.navigate_history(\"up\");\r\n                // Print the previous command on a new line for the user to see/copy\r\n                println!(\"\\n[history] {}\", prev_cmd);\r\n            }\r\n            continue;\r\n        } else if trimmed == \"\\x0e\" {  // Ctrl+N for next command\r\n            let next_cmd = editor_state.navigate_history(\"down\");\r\n            // Print the next command on a new line for the user to see/copy\r\n            println!(\"\\n[history] {}\", next_cmd);\r\n            continue;\r\n        } else {\r\n            // For regular commands, use the input as is\r\n            editor_state.command_buffer = trimmed.to_string();\r\n        }\r\n\r\n        // Handle special command to exit vim mode\r\n        if trimmed == \":q!\" {\r\n            break;\r\n        }\r\n\r\n        // Process the command - note that history is now handled inside handle_vim_command\r\n        let _ = commands::handle_vim_command(sheet, trimmed, \u0026mut editor_state);\r\n\r\n        // Handle special case for Esc key in terminal\r\n        if trimmed == \"\\x1b\" \u0026\u0026 editor_state.mode == editor::EditorMode::Insert {\r\n            editor_state.mode = editor::EditorMode::Normal;\r\n        }\r\n\r\n        // Check for quit command\r\n        if editor_state.should_quit {\r\n            break;\r\n        }\r\n    }\r\n}","traces":[{"line":7,"address":[222384,224387,222944],"length":1,"stats":{"Line":0}},{"line":9,"address":[222412],"length":1,"stats":{"Line":0}},{"line":12,"address":[222520],"length":1,"stats":{"Line":0}},{"line":13,"address":[222681,222591],"length":1,"stats":{"Line":0}},{"line":14,"address":[222847],"length":1,"stats":{"Line":0}},{"line":20,"address":[222631],"length":1,"stats":{"Line":0}},{"line":23,"address":[222961],"length":1,"stats":{"Line":0}},{"line":24,"address":[223098],"length":1,"stats":{"Line":0}},{"line":27,"address":[223183],"length":1,"stats":{"Line":0}},{"line":28,"address":[223251,223190],"length":1,"stats":{"Line":0}},{"line":32,"address":[223362],"length":1,"stats":{"Line":0}},{"line":35,"address":[223432],"length":1,"stats":{"Line":0}},{"line":36,"address":[224184,223502],"length":1,"stats":{"Line":0}},{"line":37,"address":[224190],"length":1,"stats":{"Line":0}},{"line":39,"address":[224288,224241],"length":1,"stats":{"Line":0}},{"line":42,"address":[223468,223520],"length":1,"stats":{"Line":0}},{"line":43,"address":[223557],"length":1,"stats":{"Line":0}},{"line":45,"address":[224029,224076],"length":1,"stats":{"Line":0}},{"line":49,"address":[223595,223526],"length":1,"stats":{"Line":0}},{"line":53,"address":[223719],"length":1,"stats":{"Line":0}},{"line":58,"address":[223764],"length":1,"stats":{"Line":0}},{"line":61,"address":[223847,223795,223907],"length":1,"stats":{"Line":0}},{"line":62,"address":[223883],"length":1,"stats":{"Line":0}},{"line":66,"address":[223831],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":24},{"path":["/","mnt","d","Repos","Ferro_spreadsheet","src","visualize_cells.rs"],"content":"use crate::cell::CellValue;\r\nuse crate::spreadsheet::{CommandStatus, Spreadsheet};\r\nuse petgraph::{\r\n    dot::{Config, Dot},\r\n    graph::{DiGraph, NodeIndex},\r\n};\r\nuse std::collections::{HashMap, HashSet};\r\nuse std::{fs::File, io::Write, process::Command};\r\n\r\npub fn visualize_cell_relationships(\r\n    spreadsheet: \u0026Spreadsheet,\r\n    row: i16,\r\n    col: i16,\r\n) -\u003e CommandStatus {\r\n    // ...move the entire body of the function from spreadsheet.rs here, replacing `spreadsheet` with `spreadsheet`...\r\n    if row \u003c 0 || row \u003e= spreadsheet.rows || col \u003c 0 || col \u003e= spreadsheet.cols {\r\n        return CommandStatus::CmdInvalidCell;\r\n    }\r\n\r\n    // Get the cell key\r\n    let cell_key = spreadsheet.get_key(row, col);\r\n\r\n    // Create a directed graph for visualization\r\n    let mut graph = DiGraph::\u003cString, \u0026str\u003e::new();\r\n    let mut node_indices = HashMap::new();\r\n\r\n    // Function to get formatted cell name\r\n    let get_cell_label = |key: i32| -\u003e String {\r\n        let (r, c) = spreadsheet.get_row_col(key);\r\n        let col_name = spreadsheet.get_column_name(c);\r\n        format!(\r\n            \"{}{} ({})\",\r\n            col_name,\r\n            r + 1,\r\n            match spreadsheet.grid[key as usize] {\r\n                CellValue::Integer(val) =\u003e val.to_string(),\r\n                CellValue::Error =\u003e \"ERROR\".to_string(),\r\n            }\r\n        )\r\n    };\r\n\r\n    // Add the target cell to the graph\r\n    let target_label = get_cell_label(cell_key);\r\n    let target_node = graph.add_node(target_label.clone());\r\n    node_indices.insert(cell_key, target_node);\r\n\r\n    // Helper function to process relationships\r\n    fn process_relationships(\r\n        spreadsheet: \u0026Spreadsheet,\r\n        start_key: i32,\r\n        is_parent_direction: bool,\r\n        processed: \u0026mut HashSet\u003ci32\u003e,\r\n        depth_limit: usize,\r\n        graph: \u0026mut DiGraph\u003cString, \u0026str\u003e,\r\n        node_indices: \u0026mut HashMap\u003ci32, NodeIndex\u003e,\r\n        get_cell_label: \u0026dyn Fn(i32) -\u003e String,\r\n    ) {\r\n        if !processed.insert(start_key) {\r\n            return; // Already processed this cell\r\n        }\r\n\r\n        // Add appropriate relationships based on direction\r\n        if is_parent_direction {\r\n            // Add parents - traverse up the dependency tree\r\n            if let Some(meta) = spreadsheet.cell_meta.get(\u0026start_key) {\r\n                for parent_key in [meta.parent1, meta.parent2].iter().filter(|\u0026\u0026k| k \u003e= 0) {\r\n                    // Create parent node if it doesn't exist\r\n                    let parent_idx = if let Some(\u0026idx) = node_indices.get(parent_key) {\r\n                        idx\r\n                    } else {\r\n                        let parent_label = get_cell_label(*parent_key);\r\n                        let idx = graph.add_node(parent_label);\r\n                        node_indices.insert(*parent_key, idx);\r\n                        idx\r\n                    };\r\n\r\n                    // Add edge from parent to child\r\n                    let child_idx = node_indices[\u0026start_key];\r\n                    graph.add_edge(parent_idx, child_idx, \"depends on\");\r\n\r\n                    // Recurse for this parent (up to the depth limit)\r\n                    if processed.len() \u003c depth_limit {\r\n                        process_relationships(\r\n                            spreadsheet,\r\n                            *parent_key,\r\n                            true,\r\n                            processed,\r\n                            depth_limit,\r\n                            graph,\r\n                            node_indices,\r\n                            get_cell_label,\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            // Add children - traverse down the dependency tree\r\n            if let Some(children) = spreadsheet.get_cell_children(start_key) {\r\n                for \u0026child_key in children {\r\n                    // Create child node if it doesn't exist\r\n                    let child_idx = if let Some(\u0026idx) = node_indices.get(\u0026child_key) {\r\n                        idx\r\n                    } else {\r\n                        let child_label = get_cell_label(child_key);\r\n                        let idx = graph.add_node(child_label);\r\n                        node_indices.insert(child_key, idx);\r\n                        idx\r\n                    };\r\n\r\n                    // Add edge from parent to child\r\n                    let parent_idx = node_indices[\u0026start_key];\r\n                    graph.add_edge(parent_idx, child_idx, \"used by\");\r\n\r\n                    // Recurse for this child (up to the depth limit)\r\n                    if processed.len() \u003c depth_limit {\r\n                        process_relationships(\r\n                            spreadsheet,\r\n                            child_key,\r\n                            false,\r\n                            processed,\r\n                            depth_limit,\r\n                            graph,\r\n                            node_indices,\r\n                            get_cell_label,\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Process parents (upward traversal)\r\n    let mut processed = HashSet::new();\r\n    // Mark target cell as processed\r\n    process_relationships(\r\n        spreadsheet,\r\n        cell_key,\r\n        true,\r\n        \u0026mut processed,\r\n        20,\r\n        \u0026mut graph,\r\n        \u0026mut node_indices,\r\n        \u0026get_cell_label,\r\n    );\r\n\r\n    // Process children (downward traversal)\r\n    let mut processed = HashSet::new();\r\n    // Mark target cell as processed\r\n    process_relationships(\r\n        spreadsheet,\r\n        cell_key,\r\n        false,\r\n        \u0026mut processed,\r\n        20,\r\n        \u0026mut graph,\r\n        \u0026mut node_indices,\r\n        \u0026get_cell_label,\r\n    );\r\n\r\n    // Generate DOT format\r\n    let dot = Dot::with_config(\u0026graph, \u0026[Config::EdgeNoLabel]);\r\n\r\n    // Save to temp file\r\n    let temp_file = format!(\"cell_{}_{}_relationships.dot\", row, col);\r\n    let mut file = match File::create(\u0026temp_file) {\r\n        Ok(file) =\u003e file,\r\n        Err(e) =\u003e {\r\n            eprintln!(\"Failed to create dot file: {}\", e);\r\n            return CommandStatus::CmdOk;\r\n        }\r\n    };\r\n\r\n    if let Err(e) = writeln!(file, \"{:?}\", dot) {\r\n        eprintln!(\"Failed to write to dot file: {}\", e);\r\n        return CommandStatus::CmdOk;\r\n    }\r\n\r\n    println!(\"Cell relationships saved to {}\", temp_file);\r\n\r\n    // Attempt to render with Graphviz if available\r\n    let output_file = format!(\"cell_{}_{}_relationships.png\", row, col);\r\n    match Command::new(\"dot\")\r\n        .args([\"-Tpng\", \u0026temp_file, \"-o\", \u0026output_file])\r\n        .output()\r\n    {\r\n        Ok(_) =\u003e {\r\n            println!(\"Cell relationship diagram generated as {}\", output_file);\r\n            // Try to open the image with the default viewer\r\n            #[cfg(target_os = \"windows\")]\r\n            let _ = Command::new(\"cmd\").args([\"/C\", \u0026output_file]).spawn();\r\n\r\n            #[cfg(target_os = \"macos\")]\r\n            let _ = Command::new(\"open\").arg(\u0026output_file).spawn();\r\n\r\n            #[cfg(target_os = \"linux\")]\r\n            let _ = Command::new(\"xdg-open\").arg(\u0026output_file).spawn();\r\n        }\r\n        Err(_) =\u003e {\r\n            println!(\"Graphviz not found. You can manually convert the .dot file to an image.\");\r\n            println!(\"For instance: dot -Tpng {} -o {}\", temp_file, output_file);\r\n        }\r\n    }\r\n\r\n    // Print textual representation of the relationships\r\n    println!(\"\\nCell {}{}:\", spreadsheet.get_column_name(col), row + 1);\r\n\r\n    // Show parents\r\n    if let Some(meta) = spreadsheet.cell_meta.get(\u0026cell_key) {\r\n        println!(\"  Parents:\");\r\n        let mut has_parents = false;\r\n\r\n        for parent_key in [meta.parent1, meta.parent2].iter().filter(|\u0026\u0026k| k \u003e= 0) {\r\n            has_parents = true;\r\n            let (r, c) = spreadsheet.get_row_col(*parent_key);\r\n            println!(\r\n                \"    - {}{}: {}\",\r\n                spreadsheet.get_column_name(c),\r\n                r + 1,\r\n                match spreadsheet.grid[*parent_key as usize] {\r\n                    CellValue::Integer(val) =\u003e val.to_string(),\r\n                    CellValue::Error =\u003e \"ERROR\".to_string(),\r\n                }\r\n            );\r\n        }\r\n\r\n        if !has_parents {\r\n            println!(\"    (none)\");\r\n        }\r\n    }\r\n\r\n    // Show children\r\n    println!(\"  Children:\");\r\n    if let Some(children) = spreadsheet.get_cell_children(cell_key) {\r\n        if !children.is_empty() {\r\n            for \u0026child_key in children {\r\n                let (r, c) = spreadsheet.get_row_col(child_key);\r\n                println!(\r\n                    \"    - {}{}: {}\",\r\n                    spreadsheet.get_column_name(c),\r\n                    r + 1,\r\n                    match spreadsheet.grid[child_key as usize] {\r\n                        CellValue::Integer(val) =\u003e val.to_string(),\r\n                        CellValue::Error =\u003e \"ERROR\".to_string(),\r\n                    }\r\n                );\r\n            }\r\n        } else {\r\n            println!(\"    (none)\");\r\n        }\r\n    } else {\r\n        println!(\"    (none)\");\r\n    }\r\n\r\n    CommandStatus::CmdOk\r\n}\r\n","traces":[{"line":10,"address":[175885,170640,172113],"length":1,"stats":{"Line":1}},{"line":16,"address":[170734,170685],"length":1,"stats":{"Line":2}},{"line":17,"address":[170721],"length":1,"stats":{"Line":1}},{"line":21,"address":[170778],"length":1,"stats":{"Line":1}},{"line":24,"address":[170814],"length":1,"stats":{"Line":1}},{"line":25,"address":[170827],"length":1,"stats":{"Line":1}},{"line":28,"address":[170882],"length":1,"stats":{"Line":2}},{"line":29,"address":[267904],"length":1,"stats":{"Line":1}},{"line":30,"address":[267947],"length":1,"stats":{"Line":1}},{"line":31,"address":[268245,268074,267981,268228],"length":1,"stats":{"Line":3}},{"line":34,"address":[268081,268030],"length":1,"stats":{"Line":1}},{"line":35,"address":[268110],"length":1,"stats":{"Line":1}},{"line":36,"address":[268210,268150],"length":1,"stats":{"Line":2}},{"line":37,"address":[268235,268183],"length":1,"stats":{"Line":0}},{"line":43,"address":[170890],"length":1,"stats":{"Line":1}},{"line":44,"address":[171037,170957],"length":1,"stats":{"Line":2}},{"line":45,"address":[171065],"length":1,"stats":{"Line":1}},{"line":48,"address":[175904],"length":1,"stats":{"Line":1}},{"line":58,"address":[176048],"length":1,"stats":{"Line":1}},{"line":63,"address":[176073],"length":1,"stats":{"Line":1}},{"line":65,"address":[176137,176644],"length":1,"stats":{"Line":1}},{"line":66,"address":[268528,268538],"length":1,"stats":{"Line":0}},{"line":68,"address":[176815,176881],"length":1,"stats":{"Line":0}},{"line":69,"address":[176874],"length":1,"stats":{"Line":0}},{"line":71,"address":[176898],"length":1,"stats":{"Line":0}},{"line":72,"address":[176916],"length":1,"stats":{"Line":0}},{"line":73,"address":[176952],"length":1,"stats":{"Line":0}},{"line":74,"address":[176963],"length":1,"stats":{"Line":0}},{"line":78,"address":[176975],"length":1,"stats":{"Line":0}},{"line":79,"address":[177006],"length":1,"stats":{"Line":0}},{"line":82,"address":[177036],"length":1,"stats":{"Line":0}},{"line":85,"address":[177095],"length":1,"stats":{"Line":0}},{"line":98,"address":[176197,176084],"length":1,"stats":{"Line":1}},{"line":99,"address":[176213],"length":1,"stats":{"Line":0}},{"line":101,"address":[176402,176328],"length":1,"stats":{"Line":0}},{"line":102,"address":[176395],"length":1,"stats":{"Line":0}},{"line":104,"address":[176414],"length":1,"stats":{"Line":0}},{"line":105,"address":[176437],"length":1,"stats":{"Line":0}},{"line":106,"address":[176468],"length":1,"stats":{"Line":0}},{"line":107,"address":[176484],"length":1,"stats":{"Line":0}},{"line":111,"address":[176496],"length":1,"stats":{"Line":0}},{"line":112,"address":[176527],"length":1,"stats":{"Line":0}},{"line":115,"address":[176557],"length":1,"stats":{"Line":0}},{"line":133,"address":[171095],"length":1,"stats":{"Line":1}},{"line":147,"address":[171236],"length":1,"stats":{"Line":1}},{"line":161,"address":[171366],"length":1,"stats":{"Line":1}},{"line":164,"address":[171417],"length":1,"stats":{"Line":1}},{"line":165,"address":[171575,171622],"length":1,"stats":{"Line":2}},{"line":166,"address":[171635],"length":1,"stats":{"Line":1}},{"line":167,"address":[171679],"length":1,"stats":{"Line":0}},{"line":168,"address":[171711,175710],"length":1,"stats":{"Line":0}},{"line":169,"address":[175781],"length":1,"stats":{"Line":0}},{"line":173,"address":[171761,171672],"length":1,"stats":{"Line":2}},{"line":174,"address":[171986,171921],"length":1,"stats":{"Line":0}},{"line":175,"address":[172057],"length":1,"stats":{"Line":0}},{"line":178,"address":[172138],"length":1,"stats":{"Line":1}},{"line":181,"address":[172232],"length":1,"stats":{"Line":1}},{"line":182,"address":[172374,172706],"length":1,"stats":{"Line":2}},{"line":183,"address":[172449,172549],"length":1,"stats":{"Line":2}},{"line":187,"address":[172799,172875],"length":1,"stats":{"Line":0}},{"line":196,"address":[172946],"length":1,"stats":{"Line":0}},{"line":199,"address":[172806,173119],"length":1,"stats":{"Line":2}},{"line":200,"address":[173154],"length":1,"stats":{"Line":1}},{"line":205,"address":[173297],"length":1,"stats":{"Line":1}},{"line":208,"address":[173576],"length":1,"stats":{"Line":1}},{"line":209,"address":[173727,173672],"length":1,"stats":{"Line":0}},{"line":210,"address":[173754],"length":1,"stats":{"Line":0}},{"line":212,"address":[173762,174007],"length":1,"stats":{"Line":0}},{"line":213,"address":[174028],"length":1,"stats":{"Line":0}},{"line":214,"address":[174036,174123],"length":1,"stats":{"Line":0}},{"line":215,"address":[174318],"length":1,"stats":{"Line":0}},{"line":226,"address":[173983],"length":1,"stats":{"Line":0}},{"line":227,"address":[174055],"length":1,"stats":{"Line":0}},{"line":232,"address":[173698,174621],"length":1,"stats":{"Line":2}},{"line":233,"address":[174648],"length":1,"stats":{"Line":1}},{"line":234,"address":[174730,174774],"length":1,"stats":{"Line":0}},{"line":235,"address":[174951,174793,174829],"length":1,"stats":{"Line":0}},{"line":236,"address":[174972],"length":1,"stats":{"Line":0}},{"line":237,"address":[175241,175301],"length":1,"stats":{"Line":0}},{"line":248,"address":[174800,175504],"length":1,"stats":{"Line":0}},{"line":251,"address":[174741,175528],"length":1,"stats":{"Line":2}},{"line":254,"address":[174917],"length":1,"stats":{"Line":1}}],"covered":40,"coverable":82}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>